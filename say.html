<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google" content="notranslate">
  <meta name="googlebot" content="notranslate">
  <title>Say Planning & Wireframe</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --muted: #94a3b8;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 24px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 16px;
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }

    .title span {
      color: var(--muted);
      font-size: 14px;
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .tab-btn {
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: #eff6ff;
      box-shadow: var(--shadow);
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 18px;
    }

    .grid.catalog {
      grid-template-columns: 280px minmax(0, 1fr);
    }

    .grid.use {
      grid-template-columns: minmax(0, 1fr) 320px;
    }

    .grid.settings {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
      font-size: 12px;
      color: var(--muted);
    }

    .header-meta a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    .log-panel {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: #f8fafc;
      display: none;
      font-size: 12px;
      color: var(--text);
    }

    .log-panel.active { display: block; }

    .card {
      background: var(--surface);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .category-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .category-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
      cursor: pointer;
      display: grid;
      gap: 6px;
    }

    .category-item.active {
      border-color: var(--accent);
      background: #eff6ff;
    }

    .category-item strong {
      font-size: 14px;
    }

    .subcategory {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toggle-group {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden;
      background: #f8fafc;
    }

    .toggle-btn {
      border: none;
      background: transparent;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
    }

    .toggle-btn.active {
      background: #eff6ff;
      color: var(--accent);
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 12px;
      font-weight: 600;
    }

    .chip.active { border-color: var(--accent); color: var(--accent); }

    .card-list {
      display: grid;
      gap: 12px;
    }

    .card-item {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      display: grid;
      gap: 10px;
      background: #ffffff;
    }

    .card-item .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-item textarea {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      padding: 6px 8px;
      resize: vertical;
      min-height: 44px;
      font-family: inherit;
      background: #f8fafc;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .language-block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #f8fafc;
      display: grid;
      gap: 8px;
    }

    .language-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--muted);
    }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 10px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn.active { border-color: var(--accent); color: var(--accent); }

    .icon-btn.small {
      padding: 4px 6px;
      font-size: 12px;
    }

    .card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-top: 1px solid var(--border);
      padding-top: 10px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .footer-toggle {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .back-translation {
      margin-top: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      background: #f1f5f9;
      font-size: 12px;
      color: #475569;
      display: none;
    }

    .mindmap {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 16px;
      background: #f8fafc;
      display: none;
    }

    .mindmap.active { display: block; }

    .mindmap-body {
      display: grid;
      grid-template-columns: 180px minmax(0, 1fr);
      gap: 20px;
      align-items: center;
    }

    .mindmap-hub {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--accent);
      display: grid;
      place-items: center;
      font-weight: 700;
      text-align: center;
      padding: 12px;
    }

    .mindmap-spokes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      position: relative;
    }

    .mindmap-node {
      position: relative;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      cursor: pointer;
    }

    .mindmap-node::before {
      content: '';
      position: absolute;
      left: -18px;
      top: 50%;
      width: 16px;
      height: 2px;
      background: var(--border);
    }

    .mindmap-popover {
      position: absolute;
      left: 10px;
      top: calc(100% + 8px);
      width: 220px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      display: none;
      z-index: 5;
    }

    .mindmap-node:hover .mindmap-popover,
    .mindmap-node.active .mindmap-popover {
      display: block;
    }

    .mindmap-popover p {
      margin: 0 0 6px;
      font-size: 12px;
    }

    .back-translation.visible { display: block; }

    .use-list {
      display: grid;
      gap: 12px;
    }

    .use-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .use-item small { color: var(--muted); }

    .history-item {
      display: grid;
      gap: 6px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .history-item a {
      color: var(--accent);
      text-decoration: none;
      font-size: 12px;
    }

    .stepper {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .step {
      flex: 1;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .step.active {
      border-color: var(--accent);
      color: var(--accent);
      background: #eff6ff;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .primary-btn {
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
    }

    .secondary-btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }

    .notice {
      font-size: 12px;
      color: var(--muted);
    }

    .advanced {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #f8fafc;
      margin: 12px 0;
    }

    .advanced summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .advanced[open] summary {
      color: var(--accent);
    }

    .empty-state {
      padding: 18px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }

    .version-list {
      display: grid;
      gap: 8px;
    }

    .version-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
    }

    footer {
      margin-top: 24px;
      font-size: 12px;
      color: var(--muted);
    }

    .floating-gear {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 24px;
    }

    .modal.active { display: flex; }

    .modal-card {
      width: min(960px, 100%);
      max-height: 90vh;
      overflow: auto;
      background: var(--surface);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    @media (max-width: 900px) {
      .grid.catalog,
      .grid.use { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }

    @media (max-width: 700px) {
      .language-grid { grid-template-columns: 1fr; }
      .mindmap-body { grid-template-columns: 1fr; }
      .mindmap-node::before { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Say — Catalogs, Cards, Live Use</h1>
        <span>Workflow-first layout aligned to chat.html patterns: side-by-side language fields, voice controls, usage logging.</span>
      </div>
      <div class="header-meta">
        <span class="status-pill">Offline prototype</span>
        <div>Last used: 2 hours ago · <a href="#" id="logToggle">View log</a></div>
        <div class="log-panel" id="logPanel">Ready. Usage entries show here.</div>
      </div>
    </header>

    <nav class="tabs" aria-label="Primary">
      <button class="tab-btn active" data-tab="catalogs">Catalogs</button>
      <button class="tab-btn" data-tab="cards">Cards</button>
      <button class="tab-btn" data-tab="live">Live Use</button>
    </nav>

    <!-- Single source of truth:
      - Card is atomic and assigned to a catalog.
      - Catalogs group cards; cards can be reassigned across catalogs.
      - Back-translation is editable; chevron reveals preview.
      - Usage increments on play/speak and logs to global history.
      - Sorting: alpha, last used, created, updated, priority.
      - Favorites are catalog-scoped; history is global with deep links.
      - Export versioning keeps latest + last 5; merge default with replace option.
    -->

    <section class="panel active" id="catalogs">
      <div class="grid catalog">
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Catalogs</div>
              <div class="notice">Create, rename, or remove catalogs.</div>
            </div>
            <div class="control-group">
              <input id="newCatalogName" placeholder="New catalog name">
              <button class="primary-btn" id="addCatalogBtn">Create</button>
            </div>
          </div>
          <div class="category-list" id="catalogList"></div>
        </div>
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Selected catalog</div>
              <div id="selectedCatalog">Travel</div>
            </div>
            <div class="control-group">
              <button class="secondary-btn" id="renameCatalogBtn">Rename</button>
              <button class="secondary-btn" id="deleteCatalogBtn">Delete</button>
            </div>
          </div>
          <div class="form-grid">
            <div>
              <label for="catalogNameInput">Catalog name</label>
              <input id="catalogNameInput">
            </div>
            <div>
              <label for="catalogNoteInput">Focus / notes</label>
              <input id="catalogNoteInput" placeholder="Optional tags or travel context">
            </div>
          </div>
          <div class="notice" id="catalogSummary"></div>
        </div>
      </div>
    </section>

    <section class="panel" id="cards">
      <div class="card">
        <div class="controls">
          <div>
            <div class="section-label">Selected catalog</div>
            <div id="selectedCatalogLabel">Travel</div>
          </div>
          <div class="control-group">
            <input id="cardSearch" placeholder="Search cards">
            <button class="secondary-btn" id="addCardBtn">+ New card</button>
          </div>
        </div>
        <details class="advanced" open>
          <summary>Advanced options</summary>
          <div class="controls">
            <div class="control-group">
              <div class="toggle-group" role="group" aria-label="Catalog view">
                <button class="toggle-btn active" data-view="list">Card list</button>
                <button class="toggle-btn" data-view="mindmap">Mind map</button>
              </div>
            </div>
            <div class="control-group">
              <div class="toggle-group" role="group" aria-label="Language direction">
                <button class="toggle-btn active" data-direction="source-target">Source → Target</button>
                <button class="toggle-btn" data-direction="target-source">Target → Source</button>
              </div>
            </div>
            <div class="control-group">
              <label for="sortSelect" class="section-label" style="margin:0;">Sort</label>
              <select id="sortSelect" aria-label="Sort cards">
                <option>Alpha</option>
                <option>Last used</option>
                <option>Created</option>
                <option>Updated</option>
                <option>Priority</option>
              </select>
            </div>
          </div>
        </details>
        <details class="advanced" id="composerDetails">
          <summary>Create new card</summary>
          <div class="form-grid">
            <div>
              <label for="newSourceText">Source phrase</label>
              <input id="newSourceText" placeholder="Enter the phrase to say">
            </div>
            <div>
              <label for="newTargetText">Target translation</label>
              <input id="newTargetText" placeholder="Enter the translation">
            </div>
            <div>
              <label for="newBackTranslation">Back-translation</label>
              <input id="newBackTranslation" placeholder="Optional back-translation">
            </div>
            <div>
              <label for="newCardCatalog">Assign catalog</label>
              <select id="newCardCatalog"></select>
            </div>
            <div>
              <label for="newCardPriority">Priority</label>
              <select id="newCardPriority">
                <option>Standard</option>
                <option>High</option>
                <option>Custom (manual order)</option>
              </select>
            </div>
          </div>
          <div class="controls" style="margin-top:16px;">
            <button class="secondary-btn" id="resetComposerBtn">Clear</button>
            <button class="primary-btn" id="createCardBtn">Add card</button>
          </div>
        </details>
        <div class="mindmap" id="mindmapView"></div>
        <div class="card-list" id="cardList"></div>
      </div>
    </section>

    <section class="panel" id="live">
      <div class="grid use">
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Favorites</div>
              <div class="notice" id="liveCatalogLabel">Travel favorites</div>
            </div>
            <button class="secondary-btn" id="playLatestBtn">▶ Play latest</button>
          </div>
          <div class="use-list" id="favoriteList"></div>
        </div>
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Usage history</div>
              <div class="notice">Recent plays across catalogs.</div>
            </div>
            <button class="secondary-btn" id="clearHistoryBtn">Clear history</button>
          </div>
          <div class="use-list" id="historyList"></div>
        </div>
      </div>
    </section>

    <footer>
      Prototype only. Events update UI state to represent persistence and usage tracking.
    </footer>
  </div>

  <button class="floating-gear" id="settingsOpen" aria-label="Open settings">
    <span class="material-symbols-outlined">settings</span>
  </button>

  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="settingsTitle">Settings</h2>
        <button class="icon-btn" id="settingsClose" aria-label="Close settings">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="grid settings">
        <div class="card">
          <h2>Language Pair</h2>
          <div class="form-grid">
            <div>
              <label for="sourceLang">Source</label>
              <select id="sourceLang">
                <option>English</option>
                <option>French</option>
                <option>Japanese</option>
              </select>
            </div>
            <div>
              <label for="targetLang">Target</label>
              <select id="targetLang">
                <option>Spanish</option>
                <option>Italian</option>
                <option>German</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Voice per language</h2>
          <div class="form-grid">
            <div>
              <label for="sourceVoice">Source voice</label>
              <select id="sourceVoice">
                <option>Female · Warm</option>
                <option>Male · Crisp</option>
              </select>
            </div>
            <div>
              <label for="targetVoice">Target voice</label>
              <select id="targetVoice">
                <option>Female · Calm</option>
                <option>Male · Bright</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Export / Import</h2>
          <p class="notice">Merge default, or replace entire catalog.</p>
          <div class="controls">
            <button class="secondary-btn">Export JSON</button>
            <button class="secondary-btn">Import (merge)</button>
            <button class="secondary-btn">Import (replace)</button>
          </div>
        </div>
        <div class="card">
          <h2>Versions</h2>
          <div class="version-list" id="versionList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const catalogs = [
      { id: 'catalog-travel', name: 'Travel', note: 'Airport + transit', createdAt: Date.now() - 1000 * 60 * 60 * 24 * 3 },
      { id: 'catalog-food', name: 'Food', note: 'Dining + groceries', createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2 },
      { id: 'catalog-care', name: 'Care', note: 'Medical + pharmacy', createdAt: Date.now() - 1000 * 60 * 60 * 24 }
    ];

    const cards = [
      {
        id: 'card-travel-1',
        catalogId: 'catalog-travel',
        source: 'Where is the baggage claim?',
        target: '¿Dónde está la cinta de equipaje?',
        backTranslation: 'Where is the luggage belt?',
        usage: 24,
        favorite: true,
        priority: 'High',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 2,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 3
      },
      {
        id: 'card-travel-2',
        catalogId: 'catalog-travel',
        source: 'I need a taxi to the hotel.',
        target: 'Necesito un taxi al hotel.',
        backTranslation: 'I need a taxi to the hotel.',
        usage: 13,
        favorite: false,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 5,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 4
      },
      {
        id: 'card-food-1',
        catalogId: 'catalog-food',
        source: 'Do you have vegetarian options?',
        target: '¿Tiene opciones vegetarianas?',
        backTranslation: 'Do you have vegetarian options?',
        usage: 9,
        favorite: true,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 6,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 9
      },
      {
        id: 'card-care-1',
        catalogId: 'catalog-care',
        source: 'I need a doctor.',
        target: 'Necesito un médico.',
        backTranslation: 'I need a doctor.',
        usage: 6,
        favorite: false,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24,
        updatedAt: Date.now() - 1000 * 60 * 60 * 6,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 12
      }
    ];

    const history = [
      {
        id: 'history-1',
        cardId: 'card-travel-1',
        catalogId: 'catalog-travel',
        source: 'Where is the baggage claim?',
        target: '¿Dónde está la cinta de equipaje?',
        action: 'Played',
        timestamp: Date.now() - 1000 * 60 * 60 * 2
      },
      {
        id: 'history-2',
        cardId: 'card-food-1',
        catalogId: 'catalog-food',
        source: 'Do you have vegetarian options?',
        target: '¿Tiene opciones vegetarianas?',
        action: 'Played',
        timestamp: Date.now() - 1000 * 60 * 60 * 24
      }
    ];

    const versions = [
      { label: 'Latest (auto)', date: 'Today 09:12', status: 'Active' },
      { label: 'v1.14', date: 'Yesterday', status: 'Backup' },
      { label: 'v1.13', date: '2 days ago', status: 'Backup' },
      { label: 'v1.12', date: '3 days ago', status: 'Backup' },
      { label: 'v1.11', date: '4 days ago', status: 'Backup' },
      { label: 'v1.10', date: '5 days ago', status: 'Backup' }
    ];

    let activeCatalogId = catalogs[0]?.id || null;
    let languageDirection = 'source-target';
    let catalogView = 'list';
    let sortMode = 'Alpha';
    let searchTerm = '';

    const catalogList = document.getElementById('catalogList');
    const cardList = document.getElementById('cardList');
    const mindmapView = document.getElementById('mindmapView');
    const selectedCatalog = document.getElementById('selectedCatalog');
    const selectedCatalogLabel = document.getElementById('selectedCatalogLabel');
    const liveCatalogLabel = document.getElementById('liveCatalogLabel');
    const favoriteList = document.getElementById('favoriteList');
    const historyList = document.getElementById('historyList');
    const versionList = document.getElementById('versionList');
    const newCatalogName = document.getElementById('newCatalogName');
    const catalogNameInput = document.getElementById('catalogNameInput');
    const catalogNoteInput = document.getElementById('catalogNoteInput');
    const catalogSummary = document.getElementById('catalogSummary');
    const newCardCatalog = document.getElementById('newCardCatalog');
    const cardSearch = document.getElementById('cardSearch');
    const sortSelect = document.getElementById('sortSelect');
    const logPanel = document.getElementById('logPanel');
    const sourceLangSelect = document.getElementById('sourceLang');
    const targetLangSelect = document.getElementById('targetLang');
    const composerDetails = document.getElementById('composerDetails');
    const newSourceText = document.getElementById('newSourceText');
    const newTargetText = document.getElementById('newTargetText');
    const newBackTranslation = document.getElementById('newBackTranslation');
    const newCardPriority = document.getElementById('newCardPriority');

    function getLanguageConfig() {
      const sourceLabel = sourceLangSelect?.value || 'English';
      const targetLabel = targetLangSelect?.value || 'Spanish';
      if (languageDirection === 'target-source') {
        return {
          primaryKey: 'target',
          secondaryKey: 'source',
          primaryLabel: targetLabel,
          secondaryLabel: sourceLabel,
          oppositeVoice: 'source'
        };
      }
      return {
        primaryKey: 'source',
        secondaryKey: 'target',
        primaryLabel: sourceLabel,
        secondaryLabel: targetLabel,
        oppositeVoice: 'target'
      };
    }

    function createId(prefix = 'id') {
      if (crypto.randomUUID) {
        return `${prefix}-${crypto.randomUUID()}`;
      }
      return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
    }

    function escapeHtml(text) {
      return (text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderMarkdown(text) {
      let html = escapeHtml(text || '');
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/\n/g, '<br>');
      return html;
    }

    function formatDate(timestamp) {
      if (!timestamp) return '—';
      return new Date(timestamp).toLocaleString();
    }

    function getActiveCatalog() {
      return catalogs.find(catalog => catalog.id === activeCatalogId) || catalogs[0] || null;
    }

    function getCardsForCatalog(catalogId) {
      return cards.filter(card => card.catalogId === catalogId);
    }

    function renderCatalogOptions(select, selectedId) {
      select.innerHTML = '';
      catalogs.forEach(catalog => {
        const option = document.createElement('option');
        option.value = catalog.id;
        option.textContent = catalog.name;
        if (catalog.id === selectedId) {
          option.selected = true;
        }
        select.appendChild(option);
      });
    }

    function renderCatalogs() {
      catalogList.innerHTML = '';
      catalogs.forEach(catalog => {
        const item = document.createElement('div');
        const count = getCardsForCatalog(catalog.id).length;
        item.className = `category-item ${catalog.id === activeCatalogId ? 'active' : ''}`;
        item.innerHTML = `
          <strong>${catalog.name}</strong>
          <div class="subcategory">${catalog.note || 'No notes'} · ${count} cards</div>
        `;
        item.addEventListener('click', () => {
          activeCatalogId = catalog.id;
          renderAll();
        });
        catalogList.appendChild(item);
      });
    }

    function renderCatalogDetails() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      selectedCatalog.textContent = catalog.name;
      selectedCatalogLabel.textContent = catalog.name;
      liveCatalogLabel.textContent = `${catalog.name} favorites`;
      catalogNameInput.value = catalog.name;
      catalogNoteInput.value = catalog.note || '';
      catalogSummary.textContent = `${getCardsForCatalog(catalog.id).length} cards · Created ${formatDate(catalog.createdAt)}`;
      renderCatalogOptions(newCardCatalog, catalog.id);
    }

    function getFilteredCards() {
      const activeCards = getCardsForCatalog(activeCatalogId);
      const term = searchTerm.trim().toLowerCase();
      const filtered = term
        ? activeCards.filter(card => [card.source, card.target, card.backTranslation].some(value => value && value.toLowerCase().includes(term)))
        : activeCards;
      const sorted = [...filtered];
      const priorityWeight = { High: 0, Standard: 1, 'Custom (manual order)': 2 };
      const mode = sortMode || sortSelect.value;
      sorted.sort((a, b) => {
        if (mode === 'Alpha') {
          return (a.source || '').localeCompare(b.source || '');
        }
        if (mode === 'Last used') {
          return (b.lastUsedAt || 0) - (a.lastUsedAt || 0);
        }
        if (mode === 'Created') {
          return (b.createdAt || 0) - (a.createdAt || 0);
        }
        if (mode === 'Updated') {
          return (b.updatedAt || 0) - (a.updatedAt || 0);
        }
        if (mode === 'Priority') {
          return (priorityWeight[a.priority] ?? 3) - (priorityWeight[b.priority] ?? 3);
        }
        return 0;
      });
      return sorted;
    }

    function renderCards() {
      const languageConfig = getLanguageConfig();
      const filteredCards = getFilteredCards();
      cardList.innerHTML = '';
      if (!filteredCards.length) {
        cardList.innerHTML = '<div class="empty-state">No cards found. Create a new card or adjust filters.</div>';
        renderFavorites();
        renderMindmap();
        return;
      }
      filteredCards.forEach(card => {
        const primaryText = languageConfig.primaryKey === 'source' ? card.source : card.target;
        const secondaryText = languageConfig.secondaryKey === 'source' ? card.source : card.target;
        const cardItem = document.createElement('div');
        cardItem.className = 'card-item';
        cardItem.innerHTML = `
          <div class="card-head">
            <div class="meta">Usage ${card.usage} · Updated ${formatDate(card.updatedAt)}</div>
            <div class="card-actions">
              <button class="icon-btn ${card.favorite ? 'active' : ''}" data-action="favorite" data-id="${card.id}">
                <span class="material-symbols-outlined">star</span>
                Favorite
              </button>
              <button class="icon-btn" data-action="play" data-id="${card.id}">
                <span class="material-symbols-outlined">play_arrow</span>
                Play
              </button>
            </div>
          </div>
          <div class="language-grid">
            <div class="language-block">
              <div class="language-header">
                ${languageConfig.primaryLabel}
                <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.primaryKey}">
                  <span class="material-symbols-outlined">volume_up</span>
                  Speak
                </button>
              </div>
              <textarea data-field="${languageConfig.primaryKey}"></textarea>
            </div>
            <div class="language-block">
              <div class="language-header">
                ${languageConfig.secondaryLabel}
                <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.secondaryKey}">
                  <span class="material-symbols-outlined">volume_up</span>
                  Speak
                </button>
              </div>
              <textarea data-field="${languageConfig.secondaryKey}"></textarea>
            </div>
          </div>
          <details class="advanced">
            <summary>Card options</summary>
            <div class="form-grid">
              <div>
                <label>Assign catalog</label>
                <select data-field="catalogId"></select>
              </div>
              <div>
                <label>Priority</label>
                <select data-field="priority">
                  <option>Standard</option>
                  <option>High</option>
                  <option>Custom (manual order)</option>
                </select>
              </div>
              <div>
                <label>Back-translation</label>
                <textarea data-field="backTranslation"></textarea>
              </div>
            </div>
            <div class="controls" style="margin-top:12px;">
              <button class="secondary-btn" data-action="delete" data-id="${card.id}">Delete card</button>
            </div>
          </details>
          <div class="back-translation" id="bt-${card.id}">${escapeHtml(card.backTranslation || 'No back-translation yet.')}</div>
          <div class="card-footer">
            <span>Back-translation preview</span>
            <button class="footer-toggle" data-action="back" data-id="${card.id}">
              <span class="material-symbols-outlined">expand_more</span>
              Reveal
            </button>
          </div>
        `;
        const primaryArea = cardItem.querySelector(`textarea[data-field="${languageConfig.primaryKey}"]`);
        const secondaryArea = cardItem.querySelector(`textarea[data-field="${languageConfig.secondaryKey}"]`);
        primaryArea.value = primaryText || '';
        secondaryArea.value = secondaryText || '';

        const catalogSelect = cardItem.querySelector('select[data-field="catalogId"]');
        renderCatalogOptions(catalogSelect, card.catalogId);
        const prioritySelect = cardItem.querySelector('select[data-field="priority"]');
        prioritySelect.value = card.priority || 'Standard';
        const backTranslationArea = cardItem.querySelector('textarea[data-field="backTranslation"]');
        const backTranslationPreview = cardItem.querySelector(`#bt-${card.id}`);
        backTranslationArea.value = card.backTranslation || '';

        [primaryArea, secondaryArea, backTranslationArea].forEach(area => {
          area.addEventListener('input', () => {
            card[area.dataset.field] = area.value;
            card.updatedAt = Date.now();
            if (area.dataset.field === 'backTranslation' && backTranslationPreview) {
              backTranslationPreview.textContent = area.value || 'No back-translation yet.';
            }
            renderFavorites();
          });
        });

        catalogSelect.addEventListener('change', () => {
          card.catalogId = catalogSelect.value;
          card.updatedAt = Date.now();
          renderAll();
        });

        prioritySelect.addEventListener('change', () => {
          card.priority = prioritySelect.value;
          card.updatedAt = Date.now();
        });

        cardItem.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => handleCardAction(card, btn));
        });
        cardList.appendChild(cardItem);
      });
      renderFavorites();
      renderMindmap();
    }

    function handleCardAction(card, button) {
      const action = button.dataset.action;
      if (action === 'favorite') {
        card.favorite = !card.favorite;
        button.classList.toggle('active', card.favorite);
        renderFavorites();
        console.log('Favorite toggled', card.id, card.favorite);
      }
      if (action === 'back') {
        const panel = document.getElementById(`bt-${card.id}`);
        panel.classList.toggle('visible');
        console.log('Back-translation reveal', card.id);
      }
      if (action === 'speak' || action === 'play') {
        logUsage(card, action === 'play' ? 'Played' : 'Spoken');
        renderCards();
        console.log('Usage logged', card.id);
      }
      if (action === 'delete') {
        const confirmed = confirm('Delete this card?');
        if (!confirmed) return;
        const index = cards.findIndex(item => item.id === card.id);
        if (index !== -1) {
          cards.splice(index, 1);
        }
        renderAll();
      }
    }

    function renderFavorites() {
      const favorites = getCardsForCatalog(activeCatalogId).filter(card => card.favorite);
      favoriteList.innerHTML = '';
      if (!favorites.length) {
        favoriteList.innerHTML = '<div class="empty-state">No favorites yet. Star cards to surface them here.</div>';
        return;
      }
      favorites.forEach(card => {
        const item = document.createElement('div');
        item.className = 'use-item';
        item.innerHTML = `
          <div>
            <strong>${renderMarkdown(card.source)}</strong>
            <small>${renderMarkdown(card.target)}</small>
          </div>
          <div class="card-actions">
            <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="source">
              <span class="material-symbols-outlined">volume_up</span>
              Source
            </button>
            <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="target">
              <span class="material-symbols-outlined">volume_up</span>
              Target
            </button>
          </div>
        `;
        item.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', () => handleCardAction(card, button));
        });
        favoriteList.appendChild(item);
      });
    }

    function renderMindmap() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const languageConfig = getLanguageConfig();
      const nodes = getFilteredCards().map(card => {
        const primaryText = languageConfig.primaryKey === 'source' ? card.source : card.target;
        const secondaryText = languageConfig.secondaryKey === 'source' ? card.source : card.target;
        return `
          <div class="mindmap-node" data-id="${card.id}">
            <strong>${primaryText}</strong>
            <div class="mindmap-popover">
              <p><strong>${languageConfig.primaryLabel}:</strong> ${primaryText}</p>
              <p><strong>${languageConfig.secondaryLabel}:</strong> ${secondaryText}</p>
              <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.oppositeVoice}">
                <span class="material-symbols-outlined">volume_up</span>
                Speak opposite
              </button>
            </div>
          </div>
        `;
      }).join('');

      mindmapView.innerHTML = `
        <div class="section-label">Summary mind map</div>
        <div class="mindmap-body">
          <div class="mindmap-hub">${catalog.name}</div>
          <div class="mindmap-spokes">${nodes}</div>
        </div>
      `;

      mindmapView.querySelectorAll('.mindmap-node').forEach(node => {
        node.addEventListener('click', () => {
          node.classList.toggle('active');
        });
      });

      mindmapView.querySelectorAll('button').forEach(button => {
        const card = cards.find(item => item.id === button.dataset.id);
        if (card) {
          button.addEventListener('click', event => {
            event.stopPropagation();
            handleCardAction(card, button);
          });
        }
      });
    }

    function renderHistory() {
      historyList.innerHTML = '';
      if (!history.length) {
        historyList.innerHTML = '<div class="empty-state">No usage yet. Play a card to build history.</div>';
        return;
      }
      history.forEach(entry => {
        const catalog = catalogs.find(item => item.id === entry.catalogId);
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <strong>${renderMarkdown(entry.source)}</strong>
          <small>${renderMarkdown(entry.target)}</small>
          <div>${entry.action} · ${formatDate(entry.timestamp)}</div>
          <a href="#cards?card=${entry.cardId}">Open in cards</a>
          <div class="notice">${catalog ? catalog.name : 'Unknown catalog'}</div>
        `;
        historyList.appendChild(item);
      });
    }

    function renderVersions() {
      versionList.innerHTML = '';
      versions.forEach(version => {
        const item = document.createElement('div');
        item.className = 'version-item';
        item.innerHTML = `
          <div>
            <strong>${version.label}</strong>
            <div>${version.date}</div>
          </div>
          <span>${version.status}</span>
        `;
        versionList.appendChild(item);
      });
    }

    function setupTabs() {
      const buttons = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.panel');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          buttons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          panels.forEach(panel => panel.classList.remove('active'));
          document.getElementById(button.dataset.tab).classList.add('active');
        });
      });
    }

    function setupCatalogToggles() {
      const viewButtons = document.querySelectorAll('[data-view]');
      const directionButtons = document.querySelectorAll('[data-direction]');

      viewButtons.forEach(button => {
        button.addEventListener('click', () => {
          viewButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          catalogView = button.dataset.view;
          updateCatalogView();
        });
      });

      directionButtons.forEach(button => {
        button.addEventListener('click', () => {
          directionButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          languageDirection = button.dataset.direction;
          renderCards();
        });
      });
    }

    function updateCatalogView() {
      const isMindmap = catalogView === 'mindmap';
      mindmapView.classList.toggle('active', isMindmap);
      cardList.style.display = isMindmap ? 'none' : 'grid';
    }

    function setupModal() {
      const modal = document.getElementById('settingsModal');
      const openBtn = document.getElementById('settingsOpen');
      const closeBtn = document.getElementById('settingsClose');

      function openModal() {
        modal.classList.add('active');
      }

      function closeModal() {
        modal.classList.remove('active');
      }

      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', event => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    function logUsage(card, action) {
      card.usage += 1;
      card.lastUsedAt = Date.now();
      card.updatedAt = Date.now();
      history.unshift({
        id: createId('history'),
        cardId: card.id,
        catalogId: card.catalogId,
        source: card.source,
        target: card.target,
        action,
        timestamp: Date.now()
      });
      if (history.length > 40) {
        history.pop();
      }
      logPanel.textContent = `${action} · ${card.source}`;
      renderHistory();
    }

    function resetComposer() {
      newSourceText.value = '';
      newTargetText.value = '';
      newBackTranslation.value = '';
      newCardPriority.value = 'Standard';
    }

    function createCard() {
      const source = newSourceText.value.trim();
      const target = newTargetText.value.trim();
      if (!source && !target) {
        alert('Add a source or target phrase to create a card.');
        return;
      }
      const card = {
        id: createId('card'),
        catalogId: newCardCatalog.value || activeCatalogId,
        source,
        target,
        backTranslation: newBackTranslation.value.trim(),
        usage: 0,
        favorite: false,
        priority: newCardPriority.value || 'Standard',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        lastUsedAt: null
      };
      cards.unshift(card);
      resetComposer();
      composerDetails.open = false;
      renderAll();
    }

    function renderAll() {
      renderCatalogs();
      renderCatalogDetails();
      renderCards();
      renderHistory();
      renderVersions();
      updateCatalogView();
    }

    document.getElementById('addCardBtn').addEventListener('click', () => {
      composerDetails.open = true;
      newSourceText.focus();
    });

    document.getElementById('resetComposerBtn').addEventListener('click', resetComposer);
    document.getElementById('createCardBtn').addEventListener('click', createCard);

    document.getElementById('addCatalogBtn').addEventListener('click', () => {
      const name = newCatalogName.value.trim();
      if (!name) {
        alert('Name the catalog first.');
        return;
      }
      const catalog = {
        id: createId('catalog'),
        name,
        note: '',
        createdAt: Date.now()
      };
      catalogs.push(catalog);
      activeCatalogId = catalog.id;
      newCatalogName.value = '';
      renderAll();
    });

    document.getElementById('renameCatalogBtn').addEventListener('click', () => {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const name = catalogNameInput.value.trim();
      if (!name) {
        alert('Catalog name cannot be empty.');
        return;
      }
      catalog.name = name;
      catalog.note = catalogNoteInput.value.trim();
      renderAll();
    });

    document.getElementById('deleteCatalogBtn').addEventListener('click', () => {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const confirmed = confirm(`Delete the ${catalog.name} catalog and its cards?`);
      if (!confirmed) return;
      const catalogIndex = catalogs.findIndex(item => item.id === catalog.id);
      if (catalogIndex !== -1) {
        catalogs.splice(catalogIndex, 1);
      }
      for (let i = cards.length - 1; i >= 0; i -= 1) {
        if (cards[i].catalogId === catalog.id) {
          cards.splice(i, 1);
        }
      }
      activeCatalogId = catalogs[0]?.id || null;
      if (!activeCatalogId) {
        const fallbackCatalog = { id: createId('catalog'), name: 'New Catalog', note: '', createdAt: Date.now() };
        catalogs.push(fallbackCatalog);
        activeCatalogId = fallbackCatalog.id;
      }
      renderAll();
    });

    catalogNoteInput.addEventListener('input', () => {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      catalog.note = catalogNoteInput.value;
      renderCatalogs();
    });

    cardSearch.addEventListener('input', () => {
      searchTerm = cardSearch.value;
      renderCards();
    });

    sortSelect.addEventListener('change', () => {
      sortMode = sortSelect.value;
      renderCards();
    });

    document.getElementById('playLatestBtn').addEventListener('click', () => {
      const catalogCards = getCardsForCatalog(activeCatalogId);
      if (!catalogCards.length) return;
      const latest = catalogCards.reduce((current, next) => {
        if (!current) return next;
        return (next.lastUsedAt || 0) > (current.lastUsedAt || 0) ? next : current;
      }, null);
      if (latest) {
        logUsage(latest, 'Played');
        renderCards();
      }
    });

    document.getElementById('logToggle').addEventListener('click', event => {
      event.preventDefault();
      document.getElementById('logPanel').classList.toggle('active');
      console.log('Usage log toggled');
    });

    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      history.length = 0;
      renderHistory();
      logPanel.textContent = 'History cleared.';
    });

    [sourceLangSelect, targetLangSelect].forEach(select => {
      select.addEventListener('change', renderCards);
    });

    setupTabs();
    setupCatalogToggles();
    setupModal();
    renderAll();
  </script>
</body>
</html>
