<!DOCTYPE html>
<html lang="en" translate="no">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="google" content="notranslate">
  <meta name="googlebot" content="notranslate">
  <title>Say Planning & Wireframe</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
      --bg: #f8fafc;
      --surface: #ffffff;
      --border: #e2e8f0;
      --muted: #94a3b8;
      --text: #0f172a;
      --accent: #2563eb;
      --accent-soft: #dbeafe;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: 'Inter', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .app {
      max-width: 1200px;
      margin: 32px auto;
      padding: 0 24px 48px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      gap: 16px;
    }

    .title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title h1 {
      margin: 0;
      font-size: 28px;
      font-weight: 700;
    }

    .title span {
      color: var(--muted);
      font-size: 14px;
    }

    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
    }

    .tabs {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }

    .tab-btn {
      padding: 12px 16px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-weight: 600;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      border-color: var(--accent);
      color: var(--accent);
      background: #eff6ff;
      box-shadow: var(--shadow);
    }

    .panel {
      display: none;
    }

    .panel.active {
      display: block;
    }

    .grid {
      display: grid;
      gap: 18px;
    }

    .grid.catalog {
      grid-template-columns: 280px minmax(0, 1fr);
    }

    .grid.use {
      grid-template-columns: minmax(0, 1fr) 320px;
    }

    .grid.settings {
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: flex-end;
      text-align: right;
      font-size: 12px;
      color: var(--muted);
    }

    .header-meta a {
      color: var(--accent);
      font-weight: 600;
      text-decoration: none;
    }

    .log-panel {
      margin-top: 6px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: #f8fafc;
      display: none;
      font-size: 12px;
      color: var(--text);
    }

    .log-panel.active { display: block; }

    .card {
      background: var(--surface);
      border-radius: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 18px;
    }

    .card h2 {
      margin: 0 0 12px;
      font-size: 18px;
    }

    .section-label {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .category-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .category-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
      cursor: pointer;
      display: grid;
      gap: 6px;
    }

    .category-item.active {
      border-color: var(--accent);
      background: #eff6ff;
    }

    .category-item strong {
      font-size: 14px;
    }

    .subcategory {
      font-size: 12px;
      color: var(--muted);
    }

    .controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .control-group {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .toggle-group {
      display: inline-flex;
      border: 1px solid var(--border);
      border-radius: 999px;
      overflow: hidden;
      background: #f8fafc;
    }

    .toggle-btn {
      border: none;
      background: transparent;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      color: var(--muted);
    }

    .toggle-btn.active {
      background: #eff6ff;
      color: var(--accent);
    }

    .chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 12px;
      font-weight: 600;
    }

    .chip.active { border-color: var(--accent); color: var(--accent); }

    .card-list {
      display: grid;
      gap: 12px;
    }

    .card-item {
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 12px 14px;
      display: grid;
      gap: 10px;
      background: #ffffff;
    }

    .card-item .meta {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      flex-wrap: wrap;
    }

    .card-header .meta {
      flex-direction: column;
      gap: 4px;
    }

    .catalog-chips {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .catalog-chip {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: #f8fafc;
    }

    .card-item textarea {
      width: 100%;
      border: 1px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      padding: 6px 8px;
      resize: vertical;
      min-height: 44px;
      font-family: inherit;
      background: #f8fafc;
    }

    .language-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .language-block {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: #f8fafc;
      display: grid;
      gap: 8px;
    }

    .language-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      color: var(--muted);
    }

    .card-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .card-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }

    .icon-btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 10px;
      padding: 6px 8px;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .icon-btn.active { border-color: var(--accent); color: var(--accent); }

    .icon-btn.small {
      padding: 4px 6px;
      font-size: 12px;
    }

    .card-footer {
      display: grid;
      gap: 10px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .footer-toggle {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    .back-translation {
      padding: 8px 10px;
      border-radius: 10px;
      background: #f1f5f9;
      font-size: 12px;
      color: #475569;
      display: none;
    }

    .back-translation.visible { display: block; }

    .inline-input {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 13px;
      font-family: inherit;
      background: #ffffff;
      resize: vertical;
      min-height: 48px;
    }

    .card-footer-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .checkbox-list {
      display: grid;
      gap: 6px;
      font-size: 12px;
      color: var(--text);
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f8fafc;
    }

    .checkbox-item input { accent-color: var(--accent); }

    .say-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .translation-status {
      font-size: 12px;
      color: var(--muted);
    }

    .mindmap {
      border: 1px dashed var(--border);
      border-radius: 16px;
      padding: 16px;
      background: #f8fafc;
      display: none;
    }

    .mindmap.active { display: block; }

    .mindmap-body {
      display: grid;
      grid-template-columns: 180px minmax(0, 1fr);
      gap: 20px;
      align-items: center;
    }

    .mindmap-hub {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: var(--surface);
      border: 2px solid var(--accent);
      display: grid;
      place-items: center;
      font-weight: 700;
      text-align: center;
      padding: 12px;
    }

    .mindmap-spokes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      position: relative;
    }

    .mindmap-node {
      position: relative;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      font-size: 12px;
      cursor: pointer;
    }

    .mindmap-node::before {
      content: '';
      position: absolute;
      left: -18px;
      top: 50%;
      width: 16px;
      height: 2px;
      background: var(--border);
    }

    .mindmap-popover {
      position: absolute;
      left: 10px;
      top: calc(100% + 8px);
      width: 220px;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      display: none;
      z-index: 5;
    }

    .mindmap-node:hover .mindmap-popover,
    .mindmap-node.active .mindmap-popover {
      display: block;
    }

    .mindmap-popover p {
      margin: 0 0 6px;
      font-size: 12px;
    }

    .use-list {
      display: grid;
      gap: 12px;
    }

    .use-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .use-item small { color: var(--muted); }

    .history-item {
      display: grid;
      gap: 6px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      padding: 10px 12px;
    }

    .history-item a {
      color: var(--accent);
      text-decoration: none;
      font-size: 12px;
    }

    .stepper {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }

    .step {
      flex: 1;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: #f8fafc;
      font-size: 12px;
      font-weight: 600;
      text-align: center;
    }

    .step.active {
      border-color: var(--accent);
      color: var(--accent);
      background: #eff6ff;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    label {
      font-size: 12px;
      color: var(--muted);
      display: block;
      margin-bottom: 6px;
    }

    input,
    select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 14px;
      font-family: inherit;
    }

    .primary-btn {
      border: none;
      background: var(--accent);
      color: white;
      font-weight: 600;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
    }

    .secondary-btn {
      border: 1px solid var(--border);
      background: #f8fafc;
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      font-weight: 600;
    }

    .notice {
      font-size: 12px;
      color: var(--muted);
    }

    .advanced {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      background: #f8fafc;
      margin: 12px 0;
    }

    .advanced summary {
      cursor: pointer;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
    }

    .advanced[open] summary {
      color: var(--accent);
    }

    .empty-state {
      padding: 18px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      text-align: center;
      font-size: 13px;
      color: var(--muted);
    }

    .version-list {
      display: grid;
      gap: 8px;
    }

    .version-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
    }

    footer {
      margin-top: 24px;
      font-size: 12px;
      color: var(--muted);
    }

    .floating-gear {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: var(--surface);
      box-shadow: var(--shadow);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 20;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 24px;
    }

    .modal.active { display: flex; }

    .modal-card {
      width: min(960px, 100%);
      max-height: 90vh;
      overflow: auto;
      background: var(--surface);
      border-radius: 20px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    @media (max-width: 900px) {
      .grid.catalog,
      .grid.use { grid-template-columns: 1fr; }
      header { flex-direction: column; align-items: flex-start; gap: 8px; }
    }

    @media (max-width: 700px) {
      .language-grid { grid-template-columns: 1fr; }
      .mindmap-body { grid-template-columns: 1fr; }
      .mindmap-node::before { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="title">
        <h1>Say — Catalogs, Cards, Live Use</h1>
        <span>Workflow-first layout aligned to chat.html patterns: side-by-side language fields, voice controls, usage logging.</span>
      </div>
      <div class="header-meta">
        <span class="status-pill">Offline prototype</span>
        <div>Last used: 2 hours ago · <a href="#" id="logToggle">View log</a></div>
        <div class="log-panel" id="logPanel">Ready. Usage entries show here.</div>
      </div>
    </header>

    <nav class="tabs" aria-label="Primary">
      <button class="tab-btn active" data-tab="say">Say</button>
      <button class="tab-btn" data-tab="cards">Cards</button>
      <button class="tab-btn" data-tab="catalogs">Catalogs</button>
      <button class="tab-btn" data-tab="live">Live Use</button>
    </nav>

    <!-- Single source of truth:
      - Card is atomic and assigned to a catalog.
      - Catalogs group cards; cards can be reassigned across catalogs.
      - Back-translation is editable; chevron reveals preview.
      - Usage increments on play/speak and logs to global history.
      - Sorting: alpha, last used, created, updated, priority.
      - Favorites are catalog-scoped; history is global with deep links.
      - Export versioning keeps latest + last 5; merge default with replace option.
    -->

    <section class="panel active" id="say">
      <div class="card">
        <div class="controls">
          <div>
            <div class="section-label">Create on the fly</div>
            <div class="notice">Speak or type to translate. Approve back-translation and save as a card.</div>
          </div>
          <div class="control-group">
            <button class="secondary-btn" id="swapLangBtn">Swap languages</button>
            <button class="secondary-btn" id="clearSayBtn">Clear</button>
          </div>
        </div>
        <div class="form-grid">
          <div>
            <label for="saySourceLang">From</label>
            <select id="saySourceLang"></select>
          </div>
          <div>
            <label for="sayTargetLang">To</label>
            <select id="sayTargetLang"></select>
          </div>
        </div>
        <div class="language-grid" style="margin-top:16px;">
          <div class="language-block">
            <div class="language-header">
              <span id="saySourceLabel">Source</span>
              <button class="icon-btn small" id="saySourceSpeak">
                <span class="material-symbols-outlined">mic</span>
                Speak
              </button>
            </div>
            <textarea id="saySourceText" placeholder="Type or speak your phrase"></textarea>
          </div>
          <div class="language-block">
            <div class="language-header">
              <span id="sayTargetLabel">Translation</span>
              <button class="icon-btn small" id="sayTargetSpeak">
                <span class="material-symbols-outlined">volume_up</span>
                Speak
              </button>
            </div>
            <textarea id="sayTargetText" placeholder="Translation appears here"></textarea>
          </div>
        </div>
        <div class="card-footer" style="margin-top:16px;">
          <div class="card-footer-bar">
            <span>Back-translation</span>
            <div class="say-actions">
              <span class="translation-status" id="sayStatus">Ready.</span>
              <button class="footer-toggle" id="toggleSayBack">
                <span class="material-symbols-outlined">expand_more</span>
                Reveal
              </button>
            </div>
          </div>
          <div class="back-translation" id="sayBackPanel">
            <textarea class="inline-input" id="sayBackText" placeholder="Back-translation appears here"></textarea>
            <label style="margin-top:8px; display:flex; gap:8px; align-items:center;">
              <input type="checkbox" id="sayApproveBack">
              Approve back-translation
            </label>
          </div>
        </div>
        <details class="advanced" open>
          <summary>Save as card</summary>
          <div>
            <label>Assign to catalogs (optional)</label>
            <div class="checkbox-list" id="sayCatalogList"></div>
          </div>
          <div class="controls" style="margin-top:12px;">
            <button class="primary-btn" id="saveSayCardBtn">Save card</button>
          </div>
        </details>
      </div>
    </section>

    <section class="panel" id="catalogs">
      <div class="grid catalog">
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Catalogs</div>
              <div class="notice">Create, rename, or remove catalogs.</div>
            </div>
            <div class="control-group">
              <input id="newCatalogName" placeholder="New catalog name">
              <button class="primary-btn" id="addCatalogBtn">Create</button>
            </div>
          </div>
          <div class="category-list" id="catalogList"></div>
        </div>
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Selected catalog</div>
              <div id="selectedCatalog">Travel</div>
            </div>
            <div class="control-group">
              <button class="secondary-btn" id="renameCatalogBtn">Rename</button>
              <button class="secondary-btn" id="deleteCatalogBtn">Delete</button>
            </div>
          </div>
          <div class="form-grid">
            <div>
              <label for="catalogNameInput">Catalog name</label>
              <input id="catalogNameInput">
            </div>
            <div>
              <label for="catalogNoteInput">Focus / notes</label>
              <input id="catalogNoteInput" placeholder="Optional tags or travel context">
            </div>
          </div>
          <div class="notice" id="catalogSummary"></div>
        </div>
      </div>
    </section>

    <section class="panel" id="cards">
      <div class="card">
        <div class="controls">
          <div>
            <div class="section-label">Selected catalog</div>
            <div id="selectedCatalogLabel">Travel</div>
          </div>
          <div class="control-group">
            <input id="cardSearch" placeholder="Search cards">
            <button class="secondary-btn" id="addCardBtn">+ New card</button>
          </div>
        </div>
        <details class="advanced" open>
          <summary>Advanced options</summary>
          <div class="controls">
            <div class="control-group">
              <div class="toggle-group" role="group" aria-label="Catalog view">
                <button class="toggle-btn active" data-view="list">Card list</button>
                <button class="toggle-btn" data-view="mindmap">Mind map</button>
              </div>
            </div>
            <div class="control-group">
              <div class="toggle-group" role="group" aria-label="Scope">
                <button class="toggle-btn active" data-scope="catalog">Catalog</button>
                <button class="toggle-btn" data-scope="all">All cards</button>
                <button class="toggle-btn" data-scope="orphans">Orphans</button>
              </div>
            </div>
            <div class="control-group">
              <div class="toggle-group" role="group" aria-label="Language direction">
                <button class="toggle-btn active" data-direction="source-target">Source → Target</button>
                <button class="toggle-btn" data-direction="target-source">Target → Source</button>
              </div>
            </div>
            <div class="control-group">
              <label for="sortSelect" class="section-label" style="margin:0;">Sort</label>
              <select id="sortSelect" aria-label="Sort cards">
                <option>Alpha</option>
                <option>Last used</option>
                <option>Created</option>
                <option>Updated</option>
                <option>Priority</option>
              </select>
            </div>
          </div>
        </details>
        <details class="advanced" id="composerDetails">
          <summary>Create new card</summary>
          <div class="form-grid">
            <div>
              <label for="newSourceText">Source phrase</label>
              <input id="newSourceText" placeholder="Enter the phrase to say">
            </div>
            <div>
              <label for="newTargetText">Target translation</label>
              <input id="newTargetText" placeholder="Enter the translation">
            </div>
            <div>
              <label for="newBackTranslation">Back-translation</label>
              <input id="newBackTranslation" placeholder="Optional back-translation">
            </div>
            <div>
              <label>Assign to catalogs</label>
              <div class="checkbox-list" id="newCardCatalogList"></div>
            </div>
            <div>
              <label for="newCardPriority">Priority</label>
              <select id="newCardPriority">
                <option>Standard</option>
                <option>High</option>
                <option>Custom (manual order)</option>
              </select>
            </div>
          </div>
          <div class="controls" style="margin-top:16px;">
            <button class="secondary-btn" id="resetComposerBtn">Clear</button>
            <button class="primary-btn" id="createCardBtn">Add card</button>
          </div>
        </details>
        <div class="mindmap" id="mindmapView"></div>
        <div class="card-list" id="cardList"></div>
      </div>
    </section>

    <section class="panel" id="live">
      <div class="grid use">
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Favorites</div>
              <div class="notice" id="liveCatalogLabel">Travel favorites</div>
            </div>
            <button class="secondary-btn" id="playLatestBtn">▶ Play latest</button>
          </div>
          <div class="use-list" id="favoriteList"></div>
        </div>
        <div class="card">
          <div class="controls">
            <div>
              <div class="section-label">Usage history</div>
              <div class="notice">Recent plays across catalogs.</div>
            </div>
            <button class="secondary-btn" id="clearHistoryBtn">Clear history</button>
          </div>
          <div class="use-list" id="historyList"></div>
        </div>
      </div>
    </section>

    <footer>
      Prototype only. Events update UI state to represent persistence and usage tracking.
    </footer>
  </div>

  <button class="floating-gear" id="settingsOpen" aria-label="Open settings">
    <span class="material-symbols-outlined">settings</span>
  </button>

  <input id="catalogImportInput" type="file" accept="application/json" hidden>

  <div class="modal" id="settingsModal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <div class="modal-card">
      <div class="modal-header">
        <h2 id="settingsTitle">Settings</h2>
        <button class="icon-btn" id="settingsClose" aria-label="Close settings">
          <span class="material-symbols-outlined">close</span>
        </button>
      </div>
      <div class="grid settings">
        <div class="card">
          <h2>Language Pair</h2>
          <div class="form-grid">
            <div>
              <label for="sourceLang">Source</label>
              <select id="sourceLang">
                <option>English</option>
                <option>French</option>
                <option>Japanese</option>
              </select>
            </div>
            <div>
              <label for="targetLang">Target</label>
              <select id="targetLang">
                <option>Spanish</option>
                <option>Italian</option>
                <option>German</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Voice per language</h2>
          <div class="form-grid">
            <div>
              <label for="sourceVoice">Source voice</label>
              <select id="sourceVoice">
                <option>Female · Warm</option>
                <option>Male · Crisp</option>
              </select>
            </div>
            <div>
              <label for="targetVoice">Target voice</label>
              <select id="targetVoice">
                <option>Female · Calm</option>
                <option>Male · Bright</option>
              </select>
            </div>
          </div>
        </div>
        <div class="card">
          <h2>Export / Import</h2>
          <p class="notice">Export the active catalog and import new ones.</p>
          <div class="controls">
            <button class="secondary-btn" id="exportCatalogBtn">Export catalog</button>
            <button class="secondary-btn" id="importCatalogBtn">Import catalog</button>
          </div>
        </div>
        <div class="card">
          <h2>Versions</h2>
          <div class="version-list" id="versionList"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const STORAGE_KEYS = {
      catalogs: 'say_catalogs',
      cards: 'say_cards',
      history: 'say_history',
      settings: 'say_settings'
    };

    const LANGUAGE_OPTIONS = [
      { code: 'en', label: 'English' },
      { code: 'es', label: 'Spanish' },
      { code: 'fr', label: 'French' },
      { code: 'de', label: 'German' },
      { code: 'it', label: 'Italian' },
      { code: 'ja', label: 'Japanese' },
      { code: 'ko', label: 'Korean' },
      { code: 'zh', label: 'Chinese' },
      { code: 'th', label: 'Thai' },
      { code: 'vi', label: 'Vietnamese' }
    ];

    const DEFAULT_SETTINGS = {
      sourceLang: 'en',
      targetLang: 'es',
      catalogScope: 'catalog',
      sayDraft: {
        sourceText: '',
        targetText: '',
        backText: '',
        approveBack: false
      }
    };

    const DEFAULT_CATALOGS = [
      { id: 'catalog-travel', name: 'Travel', note: 'Airport + transit', createdAt: Date.now() - 1000 * 60 * 60 * 24 * 3 },
      { id: 'catalog-food', name: 'Food', note: 'Dining + groceries', createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2 },
      { id: 'catalog-care', name: 'Care', note: 'Medical + pharmacy', createdAt: Date.now() - 1000 * 60 * 60 * 24 }
    ];

    const DEFAULT_CARDS = [
      {
        id: 'card-travel-1',
        catalogIds: ['catalog-travel'],
        source: 'Where is the baggage claim?',
        target: '¿Dónde está la cinta de equipaje?',
        backTranslation: 'Where is the luggage belt?',
        usage: 24,
        favorite: true,
        priority: 'High',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 2,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 3,
        backApproved: true
      },
      {
        id: 'card-travel-2',
        catalogIds: ['catalog-travel'],
        source: 'I need a taxi to the hotel.',
        target: 'Necesito un taxi al hotel.',
        backTranslation: 'I need a taxi to the hotel.',
        usage: 13,
        favorite: false,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 5,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 4,
        backApproved: true
      },
      {
        id: 'card-food-1',
        catalogIds: ['catalog-food'],
        source: 'Do you have vegetarian options?',
        target: '¿Tiene opciones vegetarianas?',
        backTranslation: 'Do you have vegetarian options?',
        usage: 9,
        favorite: true,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24 * 2,
        updatedAt: Date.now() - 1000 * 60 * 60 * 6,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 9,
        backApproved: true
      },
      {
        id: 'card-care-1',
        catalogIds: ['catalog-care'],
        source: 'I need a doctor.',
        target: 'Necesito un médico.',
        backTranslation: 'I need a doctor.',
        usage: 6,
        favorite: false,
        priority: 'Standard',
        createdAt: Date.now() - 1000 * 60 * 60 * 24,
        updatedAt: Date.now() - 1000 * 60 * 60 * 6,
        lastUsedAt: Date.now() - 1000 * 60 * 60 * 12,
        backApproved: true
      }
    ];

    const DEFAULT_HISTORY = [
      {
        id: 'history-1',
        cardId: 'card-travel-1',
        catalogId: 'catalog-travel',
        source: 'Where is the baggage claim?',
        target: '¿Dónde está la cinta de equipaje?',
        action: 'Played',
        timestamp: Date.now() - 1000 * 60 * 60 * 2
      },
      {
        id: 'history-2',
        cardId: 'card-food-1',
        catalogId: 'catalog-food',
        source: 'Do you have vegetarian options?',
        target: '¿Tiene opciones vegetarianas?',
        action: 'Played',
        timestamp: Date.now() - 1000 * 60 * 60 * 24
      }
    ];

    const versions = [
      { label: 'Latest (auto)', date: 'Today 09:12', status: 'Active' },
      { label: 'v1.14', date: 'Yesterday', status: 'Backup' },
      { label: 'v1.13', date: '2 days ago', status: 'Backup' },
      { label: 'v1.12', date: '3 days ago', status: 'Backup' },
      { label: 'v1.11', date: '4 days ago', status: 'Backup' },
      { label: 'v1.10', date: '5 days ago', status: 'Backup' }
    ];

    function readStorage(key) {
      try {
        return localStorage.getItem(key);
      } catch (_) {
        return null;
      }
    }

    function writeStorage(key, value) {
      try {
        localStorage.setItem(key, value);
      } catch (_) {}
    }

    function loadSettings() {
      const raw = readStorage(STORAGE_KEYS.settings);
      if (!raw) return { ...DEFAULT_SETTINGS };
      try {
        return { ...DEFAULT_SETTINGS, ...JSON.parse(raw) };
      } catch (_) {
        return { ...DEFAULT_SETTINGS };
      }
    }

    function saveSettings() {
      writeStorage(STORAGE_KEYS.settings, JSON.stringify(settings));
    }

    function loadCatalogs() {
      const raw = readStorage(STORAGE_KEYS.catalogs);
      if (!raw) return [...DEFAULT_CATALOGS];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) && parsed.length ? parsed : [...DEFAULT_CATALOGS];
      } catch (_) {
        return [...DEFAULT_CATALOGS];
      }
    }

    function saveCatalogs() {
      writeStorage(STORAGE_KEYS.catalogs, JSON.stringify(catalogs));
    }

    function normalizeCard(card) {
      if (Array.isArray(card.catalogIds)) return card;
      if (card.catalogId) {
        return { ...card, catalogIds: [card.catalogId] };
      }
      return { ...card, catalogIds: [] };
    }

    function loadCards() {
      const raw = readStorage(STORAGE_KEYS.cards);
      if (!raw) return DEFAULT_CARDS.map(normalizeCard);
      try {
        const parsed = JSON.parse(raw);
        if (Array.isArray(parsed)) {
          return parsed.map(normalizeCard);
        }
        return DEFAULT_CARDS.map(normalizeCard);
      } catch (_) {
        return DEFAULT_CARDS.map(normalizeCard);
      }
    }

    function saveCards() {
      writeStorage(STORAGE_KEYS.cards, JSON.stringify(cards));
    }

    function loadHistory() {
      const raw = readStorage(STORAGE_KEYS.history);
      if (!raw) return [...DEFAULT_HISTORY];
      try {
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [...DEFAULT_HISTORY];
      } catch (_) {
        return [...DEFAULT_HISTORY];
      }
    }

    function saveHistory() {
      writeStorage(STORAGE_KEYS.history, JSON.stringify(history));
    }

    let settings = loadSettings();
    let catalogs = loadCatalogs();
    let cards = loadCards();
    let history = loadHistory();
    let activeCatalogId = catalogs[0]?.id || null;
    let languageDirection = 'source-target';
    let catalogView = 'list';
    let sortMode = 'Alpha';
    let searchTerm = '';
    let catalogScope = settings.catalogScope || 'catalog';
    let sayTranslationTimer = null;
    let sayActiveField = 'source';
    let sayRecognizer = null;
    const translationCache = new Map();

    const catalogList = document.getElementById('catalogList');
    const cardList = document.getElementById('cardList');
    const mindmapView = document.getElementById('mindmapView');
    const selectedCatalog = document.getElementById('selectedCatalog');
    const selectedCatalogLabel = document.getElementById('selectedCatalogLabel');
    const liveCatalogLabel = document.getElementById('liveCatalogLabel');
    const favoriteList = document.getElementById('favoriteList');
    const historyList = document.getElementById('historyList');
    const versionList = document.getElementById('versionList');
    const newCatalogName = document.getElementById('newCatalogName');
    const catalogNameInput = document.getElementById('catalogNameInput');
    const catalogNoteInput = document.getElementById('catalogNoteInput');
    const catalogSummary = document.getElementById('catalogSummary');
    const newCardCatalogList = document.getElementById('newCardCatalogList');
    const cardSearch = document.getElementById('cardSearch');
    const sortSelect = document.getElementById('sortSelect');
    const logPanel = document.getElementById('logPanel');
    const sourceLangSelect = document.getElementById('sourceLang');
    const targetLangSelect = document.getElementById('targetLang');
    const composerDetails = document.getElementById('composerDetails');
    const newSourceText = document.getElementById('newSourceText');
    const newTargetText = document.getElementById('newTargetText');
    const newBackTranslation = document.getElementById('newBackTranslation');
    const newCardPriority = document.getElementById('newCardPriority');
    const saySourceLang = document.getElementById('saySourceLang');
    const sayTargetLang = document.getElementById('sayTargetLang');
    const saySourceText = document.getElementById('saySourceText');
    const sayTargetText = document.getElementById('sayTargetText');
    const sayBackText = document.getElementById('sayBackText');
    const sayApproveBack = document.getElementById('sayApproveBack');
    const sayStatus = document.getElementById('sayStatus');
    const saySourceLabel = document.getElementById('saySourceLabel');
    const sayTargetLabel = document.getElementById('sayTargetLabel');
    const swapLangBtn = document.getElementById('swapLangBtn');
    const clearSayBtn = document.getElementById('clearSayBtn');
    const saveSayCardBtn = document.getElementById('saveSayCardBtn');
    const sayCatalogList = document.getElementById('sayCatalogList');
    const saySourceSpeak = document.getElementById('saySourceSpeak');
    const sayTargetSpeak = document.getElementById('sayTargetSpeak');
    const toggleSayBack = document.getElementById('toggleSayBack');
    const exportCatalogBtn = document.getElementById('exportCatalogBtn');
    const importCatalogBtn = document.getElementById('importCatalogBtn');
    const catalogImportInput = document.getElementById('catalogImportInput');

    function getLanguageConfig() {
      const sourceCode = sourceLangSelect?.value || settings.sourceLang || 'en';
      const targetCode = targetLangSelect?.value || settings.targetLang || 'es';
      const sourceLabel = getLanguageLabel(sourceCode);
      const targetLabel = getLanguageLabel(targetCode);
      if (languageDirection === 'target-source') {
        return {
          primaryKey: 'target',
          secondaryKey: 'source',
          primaryLabel: targetLabel,
          secondaryLabel: sourceLabel,
          oppositeVoice: 'source'
        };
      }
      return {
        primaryKey: 'source',
        secondaryKey: 'target',
        primaryLabel: sourceLabel,
        secondaryLabel: targetLabel,
        oppositeVoice: 'target'
      };
    }

    function updateLanguageSelections(sourceCode, targetCode) {
      const nextSource = sourceCode || settings.sourceLang;
      const nextTarget = targetCode || settings.targetLang;
      settings.sourceLang = nextSource;
      settings.targetLang = nextTarget;
      renderLanguageOptions(sourceLangSelect, nextSource);
      renderLanguageOptions(targetLangSelect, nextTarget);
      renderLanguageOptions(saySourceLang, nextSource);
      renderLanguageOptions(sayTargetLang, nextTarget);
      saySourceLabel.textContent = getLanguageLabel(nextSource);
      sayTargetLabel.textContent = getLanguageLabel(nextTarget);
      saveSettings();
    }

    function persistAll() {
      saveCatalogs();
      saveCards();
      saveHistory();
      saveSettings();
    }

    function createId(prefix = 'id') {
      if (crypto.randomUUID) {
        return `${prefix}-${crypto.randomUUID()}`;
      }
      return `${prefix}-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`;
    }

    function downloadJson(filename, data) {
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      link.click();
      URL.revokeObjectURL(url);
    }

    function exportActiveCatalog() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const payload = {
        exportedAt: Date.now(),
        catalog,
        cards: cards.filter(card => card.catalogIds?.includes(catalog.id))
      };
      const safeName = catalog.name.toLowerCase().replace(/\s+/g, '-');
      downloadJson(`say-catalog-${safeName || 'export'}.json`, payload);
    }

    async function importCatalogFromFile(file) {
      if (!file) return;
      try {
        const text = await file.text();
        const data = JSON.parse(text);
        if (!data?.catalog) {
          alert('Invalid catalog file.');
          return;
        }
        const incomingCatalog = data.catalog;
        let catalogId = incomingCatalog.id || createId('catalog');
        if (catalogs.some(item => item.id === catalogId)) {
          catalogId = createId('catalog');
        }
        const newCatalog = {
          id: catalogId,
          name: incomingCatalog.name || 'Imported Catalog',
          note: incomingCatalog.note || '',
          createdAt: incomingCatalog.createdAt || Date.now()
        };
        catalogs.push(newCatalog);
        const incomingCards = Array.isArray(data.cards) ? data.cards : [];
        incomingCards.forEach(rawCard => {
          const normalized = normalizeCard(rawCard);
          const existing = cards.find(card => card.id === normalized.id);
          if (existing) {
            existing.catalogIds = Array.from(new Set([...(existing.catalogIds || []), catalogId]));
          } else {
            const newCard = {
              ...normalized,
              id: normalized.id || createId('card'),
              catalogIds: Array.from(new Set([...(normalized.catalogIds || []), catalogId]))
            };
            cards.push(newCard);
          }
        });
        activeCatalogId = catalogId;
        persistAll();
        renderAll();
        alert('Catalog imported.');
      } catch (error) {
        console.error(error);
        alert('Unable to import catalog.');
      }
    }

    function escapeHtml(text) {
      return (text || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function renderMarkdown(text) {
      let html = escapeHtml(text || '');
      html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      html = html.replace(/\n/g, '<br>');
      return html;
    }

    async function translateText(text, target, source = 'auto') {
      const clean = text?.trim();
      if (!clean) return '';
      const cacheKey = `${source}:${target}:${clean}`;
      if (translationCache.has(cacheKey)) {
        return translationCache.get(cacheKey);
      }
      try {
        const res = await fetch('https://libretranslate.de/translate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ q: clean, source, target, format: 'text' })
        });
        if (res.ok) {
          const data = await res.json();
          if (data?.translatedText) {
            translationCache.set(cacheKey, data.translatedText);
            return data.translatedText;
          }
        }
      } catch (_) {}

      try {
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${encodeURIComponent(source)}&tl=${encodeURIComponent(target)}&dt=t&q=${encodeURIComponent(clean)}`);
        const data = await res.json();
        const translated = Array.isArray(data?.[0])
          ? data[0].map(item => item[0]).join('')
          : null;
        if (translated) {
          translationCache.set(cacheKey, translated);
          return translated;
        }
      } catch (_) {}

      return '';
    }

    function formatDate(timestamp) {
      if (!timestamp) return '—';
      return new Date(timestamp).toLocaleString();
    }

    function getLanguageLabel(code) {
      return LANGUAGE_OPTIONS.find(option => option.code === code)?.label || code;
    }

    function renderLanguageOptions(select, selectedCode) {
      if (!select) return;
      select.innerHTML = '';
      LANGUAGE_OPTIONS.forEach(option => {
        const item = document.createElement('option');
        item.value = option.code;
        item.textContent = option.label;
        if (option.code === selectedCode) {
          item.selected = true;
        }
        select.appendChild(item);
      });
    }

    function getActiveCatalog() {
      return catalogs.find(catalog => catalog.id === activeCatalogId) || catalogs[0] || null;
    }

    function getCardsForCatalog(catalogId) {
      return cards.filter(card => card.catalogIds?.includes(catalogId));
    }

    function renderCatalogCheckboxes(container, selectedIds = []) {
      if (!container) return;
      container.innerHTML = '';
      catalogs.forEach(catalog => {
        const item = document.createElement('label');
        item.className = 'checkbox-item';
        item.innerHTML = `
          <input type="checkbox" value="${catalog.id}">
          ${catalog.name}
        `;
        const input = item.querySelector('input');
        input.checked = selectedIds.includes(catalog.id);
        container.appendChild(item);
      });
    }

    function getSelectedCatalogIds(container) {
      if (!container) return [];
      return Array.from(container.querySelectorAll('input[type="checkbox"]'))
        .filter(input => input.checked)
        .map(input => input.value);
    }

    function renderCatalogChips(container, selectedIds = []) {
      if (!container) return;
      container.innerHTML = '';
      if (!selectedIds.length) {
        const chip = document.createElement('span');
        chip.className = 'catalog-chip';
        chip.textContent = 'Orphan';
        container.appendChild(chip);
        return;
      }
      selectedIds.forEach(id => {
        const catalog = catalogs.find(item => item.id === id);
        const chip = document.createElement('span');
        chip.className = 'catalog-chip';
        chip.textContent = catalog ? catalog.name : 'Unknown';
        container.appendChild(chip);
      });
    }

    function renderCatalogs() {
      catalogList.innerHTML = '';
      catalogs.forEach(catalog => {
        const item = document.createElement('div');
        const count = getCardsForCatalog(catalog.id).length;
        item.className = `category-item ${catalog.id === activeCatalogId ? 'active' : ''}`;
        item.innerHTML = `
          <strong>${catalog.name}</strong>
          <div class="subcategory">${catalog.note || 'No notes'} · ${count} cards</div>
        `;
        item.addEventListener('click', () => {
          activeCatalogId = catalog.id;
          catalogScope = 'catalog';
          settings.catalogScope = catalogScope;
          saveSettings();
          renderAll();
        });
        catalogList.appendChild(item);
      });
    }

    function renderCatalogDetails() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      selectedCatalog.textContent = catalog.name;
      selectedCatalogLabel.textContent = catalog.name;
      liveCatalogLabel.textContent = `${catalog.name} favorites`;
      catalogNameInput.value = catalog.name;
      catalogNoteInput.value = catalog.note || '';
      const orphanCount = cards.filter(card => !card.catalogIds?.length).length;
      catalogSummary.textContent = `${getCardsForCatalog(catalog.id).length} cards · ${orphanCount} orphans · Created ${formatDate(catalog.createdAt)}`;
      renderCatalogCheckboxes(newCardCatalogList, [catalog.id]);
      renderCatalogCheckboxes(sayCatalogList, [catalog.id]);
      if (catalogScope === 'all') {
        selectedCatalogLabel.textContent = 'All cards';
      } else if (catalogScope === 'orphans') {
        selectedCatalogLabel.textContent = 'Orphans';
      }
    }

    function getFilteredCards() {
      let activeCards = [];
      if (catalogScope === 'all') {
        activeCards = [...cards];
      } else if (catalogScope === 'orphans') {
        activeCards = cards.filter(card => !card.catalogIds?.length);
      } else {
        activeCards = getCardsForCatalog(activeCatalogId);
      }
      const term = searchTerm.trim().toLowerCase();
      const filtered = term
        ? activeCards.filter(card => [card.source, card.target, card.backTranslation].some(value => value && value.toLowerCase().includes(term)))
        : activeCards;
      const sorted = [...filtered];
      const priorityWeight = { High: 0, Standard: 1, 'Custom (manual order)': 2 };
      const mode = sortMode || sortSelect.value;
      sorted.sort((a, b) => {
        if (mode === 'Alpha') {
          return (a.source || '').localeCompare(b.source || '');
        }
        if (mode === 'Last used') {
          return (b.lastUsedAt || 0) - (a.lastUsedAt || 0);
        }
        if (mode === 'Created') {
          return (b.createdAt || 0) - (a.createdAt || 0);
        }
        if (mode === 'Updated') {
          return (b.updatedAt || 0) - (a.updatedAt || 0);
        }
        if (mode === 'Priority') {
          return (priorityWeight[a.priority] ?? 3) - (priorityWeight[b.priority] ?? 3);
        }
        return 0;
      });
      return sorted;
    }

    function renderCards() {
      const languageConfig = getLanguageConfig();
      const filteredCards = getFilteredCards();
      cardList.innerHTML = '';
      if (!filteredCards.length) {
        cardList.innerHTML = '<div class="empty-state">No cards found. Create a new card or adjust filters.</div>';
        renderFavorites();
        renderMindmap();
        return;
      }
      filteredCards.forEach(card => {
        const primaryText = languageConfig.primaryKey === 'source' ? card.source : card.target;
        const secondaryText = languageConfig.secondaryKey === 'source' ? card.source : card.target;
        const cardItem = document.createElement('div');
        cardItem.className = 'card-item';
        cardItem.innerHTML = `
          <div class="card-header">
            <div class="meta">
              <div>Usage ${card.usage} · Updated ${formatDate(card.updatedAt)}</div>
              <div class="catalog-chips" data-catalogs="${card.id}"></div>
            </div>
            <div class="card-actions">
              <button class="icon-btn ${card.favorite ? 'active' : ''}" data-action="favorite" data-id="${card.id}">
                <span class="material-symbols-outlined">star</span>
                Favorite
              </button>
              <button class="icon-btn" data-action="play" data-id="${card.id}">
                <span class="material-symbols-outlined">play_arrow</span>
                Play
              </button>
            </div>
          </div>
          <div class="language-grid">
            <div class="language-block">
              <div class="language-header">
                ${languageConfig.primaryLabel}
                <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.primaryKey}">
                  <span class="material-symbols-outlined">volume_up</span>
                  Speak
                </button>
              </div>
              <textarea data-field="${languageConfig.primaryKey}"></textarea>
            </div>
            <div class="language-block">
              <div class="language-header">
                ${languageConfig.secondaryLabel}
                <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.secondaryKey}">
                  <span class="material-symbols-outlined">volume_up</span>
                  Speak
                </button>
              </div>
              <textarea data-field="${languageConfig.secondaryKey}"></textarea>
            </div>
          </div>
          <details class="advanced">
            <summary>Card options</summary>
            <div class="form-grid">
              <div>
                <label>Assign catalogs</label>
                <div class="checkbox-list" data-field="catalogIds"></div>
              </div>
              <div>
                <label>Priority</label>
                <select data-field="priority">
                  <option>Standard</option>
                  <option>High</option>
                  <option>Custom (manual order)</option>
                </select>
              </div>
              <div>
                <label>Back-translation</label>
                <textarea data-field="backTranslation"></textarea>
              </div>
            </div>
            <div class="controls" style="margin-top:12px;">
              <button class="secondary-btn" data-action="delete" data-id="${card.id}">Delete card</button>
            </div>
          </details>
          <div class="card-footer">
            <div class="card-footer-bar">
              <span>Back-translation</span>
              <button class="footer-toggle" data-action="back" data-id="${card.id}">
                <span class="material-symbols-outlined">expand_more</span>
                Reveal
              </button>
            </div>
            <div class="back-translation" id="bt-${card.id}">
              <textarea class="inline-input" data-field="backTranslation"></textarea>
              <label style="margin-top:8px; display:flex; gap:8px; align-items:center;">
                <input type="checkbox" data-field="backApproved">
                Approved
              </label>
            </div>
          </div>
        `;
        const primaryArea = cardItem.querySelector(`textarea[data-field="${languageConfig.primaryKey}"]`);
        const secondaryArea = cardItem.querySelector(`textarea[data-field="${languageConfig.secondaryKey}"]`);
        primaryArea.value = primaryText || '';
        secondaryArea.value = secondaryText || '';

        const catalogList = cardItem.querySelector('[data-field="catalogIds"]');
        renderCatalogCheckboxes(catalogList, card.catalogIds);
        const prioritySelect = cardItem.querySelector('select[data-field="priority"]');
        prioritySelect.value = card.priority || 'Standard';
        const backTranslationArea = cardItem.querySelector('textarea[data-field="backTranslation"]');
        const backApprovedToggle = cardItem.querySelector('input[data-field="backApproved"]');
        backTranslationArea.value = card.backTranslation || '';
        backApprovedToggle.checked = Boolean(card.backApproved);

        const catalogChipHolder = cardItem.querySelector(`[data-catalogs="${card.id}"]`);
        renderCatalogChips(catalogChipHolder, card.catalogIds);

        [primaryArea, secondaryArea, backTranslationArea].forEach(area => {
          area.addEventListener('blur', () => {
            card[area.dataset.field] = area.value;
            card.updatedAt = Date.now();
            persistAll();
            renderFavorites();
          });
        });

        catalogList.addEventListener('change', () => {
          card.catalogIds = getSelectedCatalogIds(catalogList);
          card.updatedAt = Date.now();
          persistAll();
          renderAll();
        });

        backApprovedToggle.addEventListener('change', () => {
          card.backApproved = backApprovedToggle.checked;
          card.updatedAt = Date.now();
          persistAll();
        });

        prioritySelect.addEventListener('change', () => {
          card.priority = prioritySelect.value;
          card.updatedAt = Date.now();
          persistAll();
        });

        cardItem.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => handleCardAction(card, btn));
        });
        cardList.appendChild(cardItem);
      });
      renderFavorites();
      renderMindmap();
    }

    function handleCardAction(card, button) {
      const action = button.dataset.action;
      if (action === 'favorite') {
        card.favorite = !card.favorite;
        button.classList.toggle('active', card.favorite);
        card.updatedAt = Date.now();
        persistAll();
        renderFavorites();
        console.log('Favorite toggled', card.id, card.favorite);
      }
      if (action === 'back') {
        const panel = document.getElementById(`bt-${card.id}`);
        panel.classList.toggle('visible');
        console.log('Back-translation reveal', card.id);
      }
      if (action === 'speak' || action === 'play') {
        logUsage(card, action === 'play' ? 'Played' : 'Spoken');
        renderCards();
        console.log('Usage logged', card.id);
      }
      if (action === 'delete') {
        const confirmed = confirm('Delete this card?');
        if (!confirmed) return;
        const index = cards.findIndex(item => item.id === card.id);
        if (index !== -1) {
          cards.splice(index, 1);
        }
        persistAll();
        renderAll();
      }
    }

    function renderFavorites() {
      const favorites = getCardsForCatalog(activeCatalogId).filter(card => card.favorite);
      favoriteList.innerHTML = '';
      if (!favorites.length) {
        favoriteList.innerHTML = '<div class="empty-state">No favorites yet. Star cards to surface them here.</div>';
        return;
      }
      favorites.forEach(card => {
        const item = document.createElement('div');
        item.className = 'use-item';
        item.innerHTML = `
          <div>
            <strong>${renderMarkdown(card.source)}</strong>
            <small>${renderMarkdown(card.target)}</small>
          </div>
          <div class="card-actions">
            <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="source">
              <span class="material-symbols-outlined">volume_up</span>
              Source
            </button>
            <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="target">
              <span class="material-symbols-outlined">volume_up</span>
              Target
            </button>
          </div>
        `;
        item.querySelectorAll('button').forEach(button => {
          button.addEventListener('click', () => handleCardAction(card, button));
        });
        favoriteList.appendChild(item);
      });
    }

    function renderMindmap() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const languageConfig = getLanguageConfig();
      const nodes = getFilteredCards().map(card => {
        const primaryText = languageConfig.primaryKey === 'source' ? card.source : card.target;
        const secondaryText = languageConfig.secondaryKey === 'source' ? card.source : card.target;
        return `
          <div class="mindmap-node" data-id="${card.id}">
            <strong>${primaryText}</strong>
            <div class="mindmap-popover">
              <p><strong>${languageConfig.primaryLabel}:</strong> ${primaryText}</p>
              <p><strong>${languageConfig.secondaryLabel}:</strong> ${secondaryText}</p>
              <button class="icon-btn small" data-action="speak" data-id="${card.id}" data-voice="${languageConfig.oppositeVoice}">
                <span class="material-symbols-outlined">volume_up</span>
                Speak opposite
              </button>
            </div>
          </div>
        `;
      }).join('');

      const hubLabel = catalogScope === 'all'
        ? 'All cards'
        : (catalogScope === 'orphans' ? 'Orphans' : catalog.name);

      mindmapView.innerHTML = `
        <div class="section-label">Summary mind map</div>
        <div class="mindmap-body">
          <div class="mindmap-hub">${hubLabel}</div>
          <div class="mindmap-spokes">${nodes}</div>
        </div>
      `;

      mindmapView.querySelectorAll('.mindmap-node').forEach(node => {
        node.addEventListener('click', () => {
          node.classList.toggle('active');
        });
      });

      mindmapView.querySelectorAll('button').forEach(button => {
        const card = cards.find(item => item.id === button.dataset.id);
        if (card) {
          button.addEventListener('click', event => {
            event.stopPropagation();
            handleCardAction(card, button);
          });
        }
      });
    }

    function renderHistory() {
      historyList.innerHTML = '';
      if (!history.length) {
        historyList.innerHTML = '<div class="empty-state">No usage yet. Play a card to build history.</div>';
        return;
      }
      history.forEach(entry => {
        const catalog = catalogs.find(item => item.id === entry.catalogId);
        const item = document.createElement('div');
        item.className = 'history-item';
        item.innerHTML = `
          <strong>${renderMarkdown(entry.source)}</strong>
          <small>${renderMarkdown(entry.target)}</small>
          <div>${entry.action} · ${formatDate(entry.timestamp)}</div>
          <a href="#cards?card=${entry.cardId}">Open in cards</a>
          <div class="notice">${catalog ? catalog.name : 'Orphan card'}</div>
        `;
        historyList.appendChild(item);
      });
    }

    function renderVersions() {
      versionList.innerHTML = '';
      versions.forEach(version => {
        const item = document.createElement('div');
        item.className = 'version-item';
        item.innerHTML = `
          <div>
            <strong>${version.label}</strong>
            <div>${version.date}</div>
          </div>
          <span>${version.status}</span>
        `;
        versionList.appendChild(item);
      });
    }

    function setupTabs() {
      const buttons = document.querySelectorAll('.tab-btn');
      const panels = document.querySelectorAll('.panel');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          buttons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          panels.forEach(panel => panel.classList.remove('active'));
          document.getElementById(button.dataset.tab).classList.add('active');
        });
      });
    }

    function setupCatalogToggles() {
      const viewButtons = document.querySelectorAll('[data-view]');
      const directionButtons = document.querySelectorAll('[data-direction]');
      const scopeButtons = document.querySelectorAll('[data-scope]');

      viewButtons.forEach(button => {
        button.addEventListener('click', () => {
          viewButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          catalogView = button.dataset.view;
          updateCatalogView();
        });
      });

      directionButtons.forEach(button => {
        button.addEventListener('click', () => {
          directionButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          languageDirection = button.dataset.direction;
          renderCards();
        });
      });

      scopeButtons.forEach(button => {
        button.addEventListener('click', () => {
          scopeButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          catalogScope = button.dataset.scope;
          settings.catalogScope = catalogScope;
          saveSettings();
          renderCatalogDetails();
          renderCards();
        });
      });
    }

    function updateCatalogView() {
      const isMindmap = catalogView === 'mindmap';
      mindmapView.classList.toggle('active', isMindmap);
      cardList.style.display = isMindmap ? 'none' : 'grid';
    }

    function saveSayDraft() {
      settings.sayDraft = {
        sourceText: saySourceText.value,
        targetText: sayTargetText.value,
        backText: sayBackText.value,
        approveBack: sayApproveBack.checked
      };
      saveSettings();
    }

    function loadSayDraft() {
      const draft = settings.sayDraft || DEFAULT_SETTINGS.sayDraft;
      saySourceText.value = draft.sourceText || '';
      sayTargetText.value = draft.targetText || '';
      sayBackText.value = draft.backText || '';
      sayApproveBack.checked = Boolean(draft.approveBack);
    }

    async function runSayTranslation() {
      const sourceLang = saySourceLang.value;
      const targetLang = sayTargetLang.value;
      const sourceText = saySourceText.value.trim();
      const targetText = sayTargetText.value.trim();

      if (!sourceText && !targetText) {
        sayStatus.textContent = 'Ready.';
        saveSayDraft();
        return;
      }

      sayStatus.textContent = 'Translating...';
      if (sayActiveField === 'source') {
        const translated = await translateText(sourceText, targetLang, sourceLang);
        if (translated) {
          sayTargetText.value = translated;
        }
        const back = translated ? await translateText(translated, sourceLang, targetLang) : '';
        if (back) {
          sayBackText.value = back;
        }
      } else {
        const translated = await translateText(targetText, sourceLang, targetLang);
        if (translated) {
          saySourceText.value = translated;
        }
        const back = translated ? await translateText(translated, targetLang, sourceLang) : '';
        if (back) {
          sayBackText.value = back;
        }
      }

      sayStatus.textContent = 'Updated just now.';
      saveSayDraft();
    }

    function scheduleSayTranslation() {
      if (sayTranslationTimer) {
        clearTimeout(sayTranslationTimer);
      }
      sayTranslationTimer = setTimeout(runSayTranslation, 600);
    }

    function startSpeechRecognition() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        alert('Speech recognition is not supported in this browser.');
        return;
      }
      if (sayRecognizer) {
        sayRecognizer.stop();
      }
      const recognizer = new SpeechRecognition();
      recognizer.lang = saySourceLang.value || 'en';
      recognizer.interimResults = false;
      recognizer.maxAlternatives = 1;
      recognizer.onresult = event => {
        const transcript = event.results?.[0]?.[0]?.transcript || '';
        saySourceText.value = transcript;
        sayActiveField = 'source';
        scheduleSayTranslation();
      };
      recognizer.onerror = () => {
        sayStatus.textContent = 'Speech recognition failed.';
      };
      recognizer.onend = () => {
        sayStatus.textContent = 'Ready.';
      };
      sayRecognizer = recognizer;
      sayStatus.textContent = 'Listening...';
      recognizer.start();
    }

    function speakText(text, lang) {
      if (!text) return;
      if (!('speechSynthesis' in window)) {
        alert('Speech synthesis is not supported in this browser.');
        return;
      }
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = lang || 'en';
      speechSynthesis.speak(utterance);
    }

    function syncScopeToggles() {
      document.querySelectorAll('[data-scope]').forEach(button => {
        button.classList.toggle('active', button.dataset.scope === catalogScope);
      });
    }

    function setupModal() {
      const modal = document.getElementById('settingsModal');
      const openBtn = document.getElementById('settingsOpen');
      const closeBtn = document.getElementById('settingsClose');

      function openModal() {
        modal.classList.add('active');
      }

      function closeModal() {
        modal.classList.remove('active');
      }

      openBtn.addEventListener('click', openModal);
      closeBtn.addEventListener('click', closeModal);
      modal.addEventListener('click', event => {
        if (event.target === modal) {
          closeModal();
        }
      });
    }

    function logUsage(card, action) {
      card.usage += 1;
      card.lastUsedAt = Date.now();
      card.updatedAt = Date.now();
      history.unshift({
        id: createId('history'),
        cardId: card.id,
        catalogId: card.catalogIds?.[0] || activeCatalogId || null,
        source: card.source,
        target: card.target,
        action,
        timestamp: Date.now()
      });
      if (history.length > 40) {
        history.pop();
      }
      logPanel.textContent = `${action} · ${card.source}`;
      persistAll();
      renderHistory();
    }

    function resetComposer() {
      newSourceText.value = '';
      newTargetText.value = '';
      newBackTranslation.value = '';
      newCardPriority.value = 'Standard';
      renderCatalogCheckboxes(newCardCatalogList, [activeCatalogId].filter(Boolean));
    }

    function createCard() {
      const source = newSourceText.value.trim();
      const target = newTargetText.value.trim();
      if (!source && !target) {
        alert('Add a source or target phrase to create a card.');
        return;
      }
      const selectedCatalogs = getSelectedCatalogIds(newCardCatalogList);
      const catalogIds = selectedCatalogs.length
        ? selectedCatalogs
        : (activeCatalogId ? [activeCatalogId] : []);
      const card = {
        id: createId('card'),
        catalogIds,
        source,
        target,
        backTranslation: newBackTranslation.value.trim(),
        usage: 0,
        favorite: false,
        priority: newCardPriority.value || 'Standard',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        lastUsedAt: null,
        backApproved: false
      };
      cards.unshift(card);
      persistAll();
      resetComposer();
      composerDetails.open = false;
      renderAll();
    }

    function saveSayCard() {
      const source = saySourceText.value.trim();
      const target = sayTargetText.value.trim();
      if (!source && !target) {
        alert('Add a phrase to save a card.');
        return;
      }
      const selectedCatalogs = getSelectedCatalogIds(sayCatalogList);
      const catalogIds = selectedCatalogs.length
        ? selectedCatalogs
        : (activeCatalogId ? [activeCatalogId] : []);
      const card = {
        id: createId('card'),
        catalogIds,
        source,
        target,
        backTranslation: sayBackText.value.trim(),
        usage: 0,
        favorite: false,
        priority: 'Standard',
        createdAt: Date.now(),
        updatedAt: Date.now(),
        lastUsedAt: null,
        backApproved: sayApproveBack.checked
      };
      cards.unshift(card);
      persistAll();
      renderAll();
      alert('Card saved to your inventory.');
    }

    function renderAll() {
      renderCatalogs();
      renderCatalogDetails();
      renderCards();
      renderHistory();
      renderVersions();
      updateCatalogView();
      syncScopeToggles();
    }

    document.getElementById('addCardBtn').addEventListener('click', () => {
      composerDetails.open = true;
      newSourceText.focus();
    });

    document.getElementById('resetComposerBtn').addEventListener('click', resetComposer);
    document.getElementById('createCardBtn').addEventListener('click', createCard);

    saySourceText.addEventListener('input', () => {
      sayActiveField = 'source';
      scheduleSayTranslation();
    });

    sayTargetText.addEventListener('input', () => {
      sayActiveField = 'target';
      scheduleSayTranslation();
    });

    [saySourceText, sayTargetText, sayBackText].forEach(field => {
      field.addEventListener('blur', saveSayDraft);
    });

    sayApproveBack.addEventListener('change', saveSayDraft);

    swapLangBtn.addEventListener('click', () => {
      const currentSource = saySourceLang.value;
      const currentTarget = sayTargetLang.value;
      const sourceText = saySourceText.value;
      saySourceLang.value = currentTarget;
      sayTargetLang.value = currentSource;
      updateLanguageSelections(saySourceLang.value, sayTargetLang.value);
      saySourceText.value = sayTargetText.value;
      sayTargetText.value = sourceText;
      sayActiveField = 'source';
      scheduleSayTranslation();
    });

    clearSayBtn.addEventListener('click', () => {
      saySourceText.value = '';
      sayTargetText.value = '';
      sayBackText.value = '';
      sayApproveBack.checked = false;
      sayStatus.textContent = 'Ready.';
      saveSayDraft();
    });

    toggleSayBack.addEventListener('click', () => {
      document.getElementById('sayBackPanel').classList.toggle('visible');
    });

    saveSayCardBtn.addEventListener('click', saveSayCard);

    saySourceSpeak.addEventListener('click', startSpeechRecognition);

    sayTargetSpeak.addEventListener('click', () => {
      speakText(sayTargetText.value, sayTargetLang.value);
    });

    exportCatalogBtn.addEventListener('click', exportActiveCatalog);

    importCatalogBtn.addEventListener('click', () => {
      catalogImportInput.click();
    });

    catalogImportInput.addEventListener('change', () => {
      const [file] = catalogImportInput.files;
      importCatalogFromFile(file);
      catalogImportInput.value = '';
    });

    document.getElementById('addCatalogBtn').addEventListener('click', () => {
      const name = newCatalogName.value.trim();
      if (!name) {
        alert('Name the catalog first.');
        return;
      }
      const catalog = {
        id: createId('catalog'),
        name,
        note: '',
        createdAt: Date.now()
      };
      catalogs.push(catalog);
      activeCatalogId = catalog.id;
      newCatalogName.value = '';
      persistAll();
      renderAll();
    });

    function saveCatalogEdits() {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const name = catalogNameInput.value.trim();
      if (!name) {
        alert('Catalog name cannot be empty.');
        return;
      }
      catalog.name = name;
      catalog.note = catalogNoteInput.value.trim();
      persistAll();
      renderAll();
    }

    document.getElementById('renameCatalogBtn').addEventListener('click', saveCatalogEdits);

    document.getElementById('deleteCatalogBtn').addEventListener('click', () => {
      const catalog = getActiveCatalog();
      if (!catalog) return;
      const confirmed = confirm(`Delete the ${catalog.name} catalog? Cards will remain as orphans.`);
      if (!confirmed) return;
      const catalogIndex = catalogs.findIndex(item => item.id === catalog.id);
      if (catalogIndex !== -1) {
        catalogs.splice(catalogIndex, 1);
      }
      cards.forEach(card => {
        card.catalogIds = (card.catalogIds || []).filter(id => id !== catalog.id);
      });
      activeCatalogId = catalogs[0]?.id || null;
      if (!activeCatalogId) {
        const fallbackCatalog = { id: createId('catalog'), name: 'New Catalog', note: '', createdAt: Date.now() };
        catalogs.push(fallbackCatalog);
        activeCatalogId = fallbackCatalog.id;
      }
      persistAll();
      renderAll();
    });

    catalogNameInput.addEventListener('blur', saveCatalogEdits);
    catalogNoteInput.addEventListener('blur', saveCatalogEdits);

    cardSearch.addEventListener('input', () => {
      searchTerm = cardSearch.value;
      renderCards();
    });

    sortSelect.addEventListener('change', () => {
      sortMode = sortSelect.value;
      renderCards();
    });

    document.getElementById('playLatestBtn').addEventListener('click', () => {
      const catalogCards = getCardsForCatalog(activeCatalogId);
      if (!catalogCards.length) return;
      const latest = catalogCards.reduce((current, next) => {
        if (!current) return next;
        return (next.lastUsedAt || 0) > (current.lastUsedAt || 0) ? next : current;
      }, null);
      if (latest) {
        logUsage(latest, 'Played');
        renderCards();
      }
    });

    document.getElementById('logToggle').addEventListener('click', event => {
      event.preventDefault();
      document.getElementById('logPanel').classList.toggle('active');
      console.log('Usage log toggled');
    });

    document.getElementById('clearHistoryBtn').addEventListener('click', () => {
      history.length = 0;
      renderHistory();
      logPanel.textContent = 'History cleared.';
      persistAll();
    });

    sourceLangSelect.addEventListener('change', () => {
      updateLanguageSelections(sourceLangSelect.value, targetLangSelect.value);
      renderCards();
      scheduleSayTranslation();
    });

    targetLangSelect.addEventListener('change', () => {
      updateLanguageSelections(sourceLangSelect.value, targetLangSelect.value);
      renderCards();
      scheduleSayTranslation();
    });

    saySourceLang.addEventListener('change', () => {
      updateLanguageSelections(saySourceLang.value, sayTargetLang.value);
      renderCards();
      scheduleSayTranslation();
    });

    sayTargetLang.addEventListener('change', () => {
      updateLanguageSelections(saySourceLang.value, sayTargetLang.value);
      renderCards();
      scheduleSayTranslation();
    });

    setupTabs();
    setupCatalogToggles();
    setupModal();
    updateLanguageSelections(settings.sourceLang, settings.targetLang);
    loadSayDraft();
    renderAll();
  </script>
</body>
</html>
