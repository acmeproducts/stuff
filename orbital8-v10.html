<!-- Full updated HTML file with metadata extraction -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OneDrive Image Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
<style>
  html, body { margin: 0; font-family: sans-serif; height: 100%; }
  #status { white-space: pre-line; padding: 10px; background: #eee; display: none; }
  #statusToggle { cursor: pointer; padding: 10px; background: #ccc; }
  table { width: 100%; border-collapse: collapse; }
  th, td { border: 1px solid #ccc; padding: 6px; word-break: break-word; }
  th { background: #f0f0f0; cursor: pointer; }
  tr:hover { background: #f9f9f9; }
  #modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.9); display: none; flex-direction: column;
    z-index: 9999; justify-content: flex-start; align-items: center;
  }
  .controls { background: #222; color: #fff; width: 100%; text-align: center; padding: 10px; }
  #modal img { max-width: 95vw; max-height: 70vh; display: block; margin: auto; }
  #metadataPanel {
    background: #fff; width: 100%; max-height: 30vh;
    overflow-y: auto; display: none; border-top: 1px solid #ccc;
  }
  #metadataPanel table { width: 100%; }
  .copy-btn { background: none; border: none; cursor: pointer; }
  #modalCloseBtn {
    position: absolute; top: 10px; right: 16px;
    font-size: 24px; color: white; background: none; border: none; cursor: pointer;
  }
</style>
</head>
<body>
<h3 style="margin:10px;">OneDrive Image Viewer</h3>
<button id="signInBtn">Sign In</button>
<div id="statusToggle">â–¶ Debug</div>
<div id="status">Status: Ready</div>
<table>
  <thead><tr><th>Name</th><th>Size (MB)</th><th>Created</th><th>Modified</th></tr></thead>
  <tbody id="gridBody"></tbody>
</table>

<div id="modal">
  <div class="controls">
    <button onclick="prevImage()">Prev</button>
    <button onclick="nextImage()">Next</button>
    <button onclick="deleteImage()">Delete</button>
  </div>
  <button id="modalCloseBtn" onclick="closeModal()">âœ•</button>
  <img id="modalImage" />
  <div id="metadataPanel">
    <table id="metadataTable">
      <thead><tr><th>Key</th><th>Value</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
const wantedFields = ['Project_ID', 'Prompt', 'Model', 'Height', 'Width', 'Steps', 'Seed', 'CFG_Scale', 'Global_Hash'];
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let activeAccount = null, currentFolder = 'root', items = [], currentIndex = 0;

document.getElementById('signInBtn').onclick = async () => {
  log('Signing in...');
  try {
    const result = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All'] });
    activeAccount = result.account;
    msalInstance.setActiveAccount(activeAccount);
    log('Signed in as: ' + activeAccount.username);
    loadFolder('root');
  } catch (err) {
    log('Login failed: ' + err.message);
  }
};

document.getElementById('statusToggle').onclick = () => {
  const s = document.getElementById('status');
  s.style.display = s.style.display === 'none' ? 'block' : 'none';
};

function log(msg) {
  document.getElementById('status').textContent += '\n' + msg;
}

async function getToken() {
  const acct = msalInstance.getActiveAccount();
  try {
    const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All'], account: acct });
    return result.accessToken;
  } catch {
    const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All'], account: acct });
    return result.accessToken;
  }
}

function formatDate(str) {
  const d = new Date(str);
  const dd = String(d.getDate()).padStart(2,'0');
  const mon = d.toLocaleString('default',{month:'short'});
  const yy = String(d.getFullYear()).slice(-2);
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${dd}-${mon}-${yy} ${hh}:${mi}`;
}

async function loadFolder(id) {
  const token = await getToken();
  const res = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${id}/children`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await res.json();
  items = data.value;
  const body = document.getElementById('gridBody');
  body.innerHTML = '';
  items.forEach((item, i) => {
    const tr = document.createElement('tr');
    const name = item.name;
    const size = item.size ? (item.size / 1e6).toFixed(2) : '';
    const created = formatDate(item.createdDateTime);
    const modified = formatDate(item.lastModifiedDateTime);
    const link = document.createElement('a');
    link.href = '#';
    link.textContent = name;
    link.onclick = (e) => {
      e.preventDefault();
      currentIndex = i;
      showModal();
    };
    tr.appendChild(document.createElement('td')).appendChild(link);
    tr.appendChild(document.createElement('td')).textContent = size;
    tr.appendChild(document.createElement('td')).textContent = created;
    tr.appendChild(document.createElement('td')).textContent = modified;
    body.appendChild(tr);
  });
}

async function showModal() {
  document.getElementById('modal').style.display = 'flex';
  const image = document.getElementById('modalImage');
  const tableBody = document.querySelector('#metadataTable tbody');
  tableBody.innerHTML = '';
  const item = items[currentIndex];
  const url = item['@microsoft.graph.downloadUrl'];
  image.src = url;

  if (item.name.endsWith('.png')) {
    extractPNGText(url, tableBody);
  }
  document.getElementById('metadataPanel').style.display = 'block';
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
}

function prevImage() {
  if (currentIndex > 0) { currentIndex--; showModal(); }
}

function nextImage() {
  if (currentIndex < items.length - 1) { currentIndex++; showModal(); }
}

async function deleteImage() {
  if (!confirm('Delete this file?')) return;
  const item = items[currentIndex];
  const token = await getToken();
  await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${item.id}`, {
    method: 'DELETE',
    headers: { Authorization: 'Bearer ' + token }
  });
  closeModal();
  loadFolder(currentFolder);
}

async function extractPNGText(url, table) {
  const resp = await fetch(url);
  const buffer = await resp.arrayBuffer();
  const data = new DataView(buffer);
  let offset = 8;
  const decoder = new TextDecoder();

  while (offset < data.byteLength) {
    const len = data.getUint32(offset);
    const type = decoder.decode(new Uint8Array(buffer.slice(offset + 4, offset + 8)));
    const chunk = new Uint8Array(buffer.slice(offset + 8, offset + 8 + len));
    let key, value;

    if (type === 'tEXt') {
      const text = decoder.decode(chunk);
      [key, value] = text.split('=');
    } else if (type === 'zTXt') {
      const nul = chunk.indexOf(0);
      key = decoder.decode(chunk.slice(0, nul));
      value = new TextDecoder().decode(pako.inflate(chunk.slice(nul + 2)));
    } else if (type === 'iTXt') {
      const nul1 = chunk.indexOf(0);
      const nul2 = chunk.indexOf(0, nul1 + 1);
      const keyRaw = chunk.slice(0, nul1);
      const compFlag = chunk[nul1 + 1];
      const content = chunk.slice(nul2 + 5);
      key = decoder.decode(keyRaw);
      value = compFlag === 1 ? decoder.decode(pako.inflate(content)) : decoder.decode(content);
    }

    if (key && wantedFields.includes(key)) {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${key}</td><td>${value}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${value}\`)">ðŸ“‹</button></td>`;
      table.appendChild(tr);
    }
    offset += len + 12;
  }
}
</script>
</body>
</html>
