<!DOCTYPE html><html lang="en">
<head>
<meta charset="UTF-8" />
<title>OneDrive Metadata Browser - Dojo Edition</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
<style>
  html, body { height: 100%; margin: 0; font-family: sans-serif; }
  #statusContainer { margin: 20px; }
  #statusToggle { cursor: pointer; }
  #status { white-space: pre-line; max-height: 100px; overflow-y: auto; display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; word-break: break-word; }
  th { background: #f8f8f8; cursor: pointer; }
  tr:hover { background: #f2f2f2; }
  #breadcrumbs { margin: 20px; }
  #modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.92); display: none; flex-direction: column;
    z-index: 10000; justify-content: flex-start; align-items: center;
  }
  #modal .controls {
    width: 100%; background: #111a; color: #fff;
    display: flex; justify-content: center; align-items: center; padding: 8px 0; gap: 12px;
    position: sticky; top: 0;
  }
  #modal-content-row {
    flex: 1 1 auto; width: 100vw; display: flex; flex-direction: column; align-items: center;
    min-height: 0; min-width: 0; overflow-y: auto;
  }
  #modalImage {
    max-width: 95vw; max-height: 60vh; margin: 10px auto; border-radius: 8px; background: #000; display: block;
  }
  #metadataContainer {
    width: 90vw; max-height: 30vh; overflow-y: auto; background: #fff; margin: 10px; padding: 10px;
    border: 1px solid #ccc;
  }
  #metadataTable { width: 100%; border-collapse: collapse; }
  #metadataTable th, #metadataTable td {
    border: 1px solid #ccc; padding: 6px;
  }
  .copy-btn {
    background: none; border: none; cursor: pointer;
  }
  #modalCloseBtn {
    position: absolute; top: 10px; right: 14px; font-size: 24px;
    background: none; border: none; color: #fff; cursor: pointer;
  }
</style>
</head>
<body>
<h2 style="margin: 20px;">OneDrive Metadata Browser</h2>
<button id="signInBtn" style="margin-left: 20px;">Sign In</button>
<div id="statusContainer">
  <span id="statusToggle">â–¶ Debug</span>
  <div id="status">Status: Ready</div>
</div>
<div id="breadcrumbs"></div>
<table>
  <thead>
    <tr>
      <th onclick="sortTable(0)">Name</th>
      <th onclick="sortTable(1)">Size (MB)</th>
      <th onclick="sortTable(2)">Created</th>
      <th onclick="sortTable(3)">Modified</th>
    </tr>
  </thead>
  <tbody id="gridBody"></tbody>
</table>
<div id="modal">
  <div class="controls">
    <button onclick="prevImage()">Prev</button>
    <button onclick="nextImage()">Next</button>
    <button onclick="deleteImage()">Delete</button>
  </div>
  <button id="modalCloseBtn" onclick="closeModal()">âœ•</button>
  <div id="modal-content-row">
    <img id="modalImage" />
    <div id="metadataContainer">
      <table id="metadataTable">
        <thead><tr><th>Key</th><th>Value</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>
<script>
const wantedFields = ['Project_ID', 'Prompt', 'Model', 'Height', 'Width', 'Steps', 'Seed', 'CFG_Scale', 'Global_Hash'];
let activeAccount = null, currentFolder = 'root', items = [], currentIndex = 0, breadcrumbStack = [];
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);document.getElementById('signInBtn').addEventListener('click', async () => { try { const response = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] }); activeAccount = response.account; msalInstance.setActiveAccount(activeAccount); breadcrumbStack = [{ id: 'root', name: 'Root' }]; loadFolder('root'); } catch (err) { log('Sign-in error: ' + err.message); } });

document.getElementById('statusToggle').onclick = () => { const d = document.getElementById('status'); d.style.display = d.style.display === 'none' ? 'block' : 'none'; };

function log(msg) { const statusDiv = document.getElementById('status'); statusDiv.textContent += '\n' + msg; }

async function getToken() { const acct = msalInstance.getActiveAccount(); try { const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All', 'User.Read'], account: acct }); return result.accessToken; } catch { const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] }); return result.accessToken; } }

async function loadFolder(id) { currentFolder = id; const token = await getToken(); const resp = await fetch(https://graph.microsoft.com/v1.0/me/drive/items/${id}/children, { headers: { Authorization: 'Bearer ' + token } }); const data = await resp.json(); items = data.value; const tbody = document.getElementById('gridBody'); tbody.innerHTML = ''; const crumbs = breadcrumbStack.map((b, i) => <a href="#" onclick="goBack(${i})">${b.name}</a>).join(' / '); document.getElementById('breadcrumbs').innerHTML = crumbs; items.forEach((item, idx) => { const tr = document.createElement('tr'); const isFolder = item.folder !== undefined; const name = isFolder ? 'â–¶ ' + item.name : item.name; const sizeMB = isFolder ? '' : (item.size / 1e6).toFixed(2); const created = formatDate(item.createdDateTime); const modified = formatDate(item.lastModifiedDateTime); const link = document.createElement('a'); link.href = '#'; link.textContent = name; link.onclick = (e) => { e.preventDefault(); if (isFolder) { breadcrumbStack.push({ id: item.id, name: item.name }); loadFolder(item.id); } else { currentIndex = idx; showModal(); } }; const td1 = document.createElement('td'); td1.appendChild(link); const td2 = document.createElement('td'); td2.textContent = sizeMB; const td3 = document.createElement('td'); td3.textContent = created; const td4 = document.createElement('td'); td4.textContent = modified; tr.append(td1, td2, td3, td4); tbody.appendChild(tr); }); }

function formatDate(str) { const d = new Date(str); const dd = String(d.getDate()).padStart(2,'0'); const mon = d.toLocaleString('default',{month:'short'}); const yy = String(d.getFullYear()).slice(-2); const hh = String(d.getHours()).padStart(2,'0'); const mi = String(d.getMinutes()).padStart(2,'0'); return ${dd}-${mon}-${yy} ${hh}:${mi}; }

function goBack(i) { breadcrumbStack = breadcrumbStack.slice(0,i+1); loadFolder(breadcrumbStack[i].id); }

function sortTable(col) { const tbody = document.getElementById('gridBody'); const rows = Array.from(tbody.rows); const dir = document.querySelector('table').getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc'; rows.sort((a,b)=>{ let valA = a.cells[col].textContent.trim(); let valB = b.cells[col].textContent.trim(); if (!isNaN(valA) && !isNaN(valB)) { valA=parseFloat(valA); valB=parseFloat(valB); } return dir==='asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1); }); rows.forEach(r=>tbody.appendChild(r)); document.querySelector('table').setAttribute('data-sort-dir', dir); }

async function showModal() { const item = items[currentIndex]; const token = await getToken(); document.getElementById('modal').style.display = 'flex'; const viewer = document.getElementById('modalImage'); viewer.src = item['@microsoft.graph.downloadUrl']; const tableBody = document.querySelector('#metadataTable tbody'); tableBody.innerHTML = ''; extractAllPngChunks(viewer.src, tableBody); }

function closeModal() { document.getElementById('modal').style.display = 'none'; } function prevImage() { if (currentIndex > 0) { currentIndex--; showModal(); } } function nextImage() { if (currentIndex < items.length-1) { currentIndex++; showModal(); } } async function deleteImage() { const item = items[currentIndex]; if (!confirm('Delete ' + item.name + '?')) return; const token = await getToken(); await fetch(https://graph.microsoft.com/v1.0/me/drive/items/${item.id}, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } }); closeModal(); loadFolder(currentFolder); }

async function extractAllPngChunks(url, table) { const resp = await fetch(url); const buffer = await resp.arrayBuffer(); const view = new DataView(buffer); const decoder = new TextDecoder("utf-8"); let pos = 8; while (pos < buffer.byteLength) { const len = view.getUint32(pos); const type = decoder.decode(new Uint8Array(buffer, pos+4, 4)); if (["tEXt", "zTXt", "iTXt"].includes(type)) { let chunkData = new Uint8Array(buffer, pos + 8, len); let k = '', v = ''; if (type === "tEXt") { const txt = decoder.decode(chunkData); [k,v] = txt.split("="); } else if (type === "iTXt") { const nulls = []; for (let i=0;i<chunkData.length;i++) if (chunkData[i]===0) nulls.push(i); if (nulls.length>=2) { k = decoder.decode(chunkData.slice(0,nulls[0])); v = decoder.decode(chunkData.slice(nulls[1]+1)); } } else if (type === "zTXt") { const i = chunkData.indexOf(0); k = decoder.decode(chunkData.slice(0,i)); try { const blob = new Blob([chunkData.slice(i+2)], {type:"application/zlib"}); const buf = await blob.arrayBuffer(); v = new TextDecoder().decode(pako.inflate(new Uint8Array(buf))); } catch {} } if (k && v && wantedFields.includes(k)) { const tr = document.createElement('tr'); tr.innerHTML = <td>${k}</td><td>${v}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText(\${v}`)">ðŸ“‹</button></td>`; table.appendChild(tr); } } pos += len + 12; } } </script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script></body>
</html>
