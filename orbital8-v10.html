<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OneDrive Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
  <style>
    html, body { margin:0; padding:0; font-family:sans-serif; height:100%; }
    h2 { margin: 12px 20px; }
    #statusToggle { cursor:pointer; margin-left:20px; }
    #status { white-space:pre-line; margin: 10px 20px; display:none; max-height:100px; overflow-y:auto; background:#f9f9f9; padding:6px; border:1px solid #ccc; }
    #breadcrumbs { margin:10px 20px; }
    table { width:100%; border-collapse:collapse; margin:0 20px 20px; }
    th, td { padding:6px; border:1px solid #ccc; }
    th { background:#eee; cursor:pointer; }
    tr:hover { background:#f5f5f5; }

    #modal {
      position:fixed; top:0; left:0; width:100vw; height:100vh;
      background:#000c; display:none; flex-direction:column;
      z-index:1000; color:white;
    }
    #modalHeader {
      display:flex; justify-content:space-between; align-items:center;
      padding:10px; background:#111c;
    }
    #modalMain {
      flex:1; display:flex; overflow:hidden;
    }
    #modalImageArea {
      flex:1; display:flex; justify-content:center; align-items:center; overflow:auto;
    }
    #modalImage {
      max-width:95%; max-height:95%;
    }
    #modalOtherViewer {
      color:#eee; text-align:center; padding:20px;
    }
    #metadataPanel {
      width:360px; background:#fff; color:#000;
      overflow-y:auto; position:relative;
    }
    #metadataPanel.collapsed { display:none; }
    #metadataTable { width:100%; border-collapse:collapse; }
    #metadataTable th, #metadataTable td {
      border:1px solid #ccc; padding:6px; word-break:break-word;
    }
    .copy-btn { background:none; border:none; cursor:pointer; }
    #modalControls {
      padding:10px; background:#222; display:flex; justify-content:center; gap:10px;
    }
  </style>
</head>
<body>
  <h2>OneDrive Viewer</h2>
  <button id="signInBtn" style="margin-left:20px;">Sign In</button>
  <span id="statusToggle">&#x25B6; Debug</span>
  <div id="status">Status: Ready</div>
  <div id="breadcrumbs"></div>
  <table>
    <thead><tr><th onclick="sortTable(0)">Name</th><th onclick="sortTable(1)">Size (MB)</th><th onclick="sortTable(2)">Created</th><th onclick="sortTable(3)">Modified</th></tr></thead>
    <tbody id="gridBody"></tbody>
  </table>

  <div id="modal">
    <div id="modalHeader">
      <span>
        <button onclick="prevImage()">Prev</button>
        <button onclick="nextImage()">Next</button>
        <button onclick="deleteImage()">Delete</button>
        <button onclick="toggleMetadata()">Metadata</button>
      </span>
      <button onclick="closeModal()" style="background:none;color:white;font-size:20px;">âœ•</button>
    </div>
    <div id="modalMain">
      <div id="modalImageArea">
        <img id="modalImage" style="display:none;" />
        <div id="modalOtherViewer" style="display:none;"></div>
      </div>
      <div id="metadataPanel" class="collapsed">
        <table id="metadataTable"><thead><tr><th>Key</th><th>Value</th><th></th></tr></thead><tbody></tbody></table>
      </div>
    </div>
  </div>

<script>
const wantedFields = ['Project_ID','Prompt','Model','Height','Width','Steps','Seed','CFG_Scale','Global_Hash'];
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  }, cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let activeAccount = null, currentFolder = 'root', items = [], currentIndex = 0, breadcrumbStack = [];

document.getElementById('signInBtn').onclick = async () => {
  log('Signing in...');
  try {
    const result = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All','User.Read'] });
    activeAccount = result.account;
    msalInstance.setActiveAccount(activeAccount);
    log('Signed in as: ' + activeAccount.username);
    breadcrumbStack = [{id:'root',name:'Root'}];
    loadFolder('root');
  } catch (e) { log('Sign-in error: ' + e.message); }
};

function log(msg) {
  const s = document.getElementById('status');
  s.textContent += '\n' + msg;
}
document.getElementById('statusToggle').onclick = () => {
  const s = document.getElementById('status');
  s.style.display = s.style.display === 'none' ? 'block' : 'none';
};

async function getToken() {
  try {
    const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All'], account: msalInstance.getActiveAccount() });
    return result.accessToken;
  } catch {
    const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All'] });
    return result.accessToken;
  }
}

function formatDate(str) {
  const d = new Date(str);
  const dd = String(d.getDate()).padStart(2,'0');
  const mon = d.toLocaleString('default',{month:'short'});
  const yy = String(d.getFullYear()).slice(-2);
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${dd}-${mon}-${yy} ${hh}:${mi}`;
}

async function loadFolder(id) {
  currentFolder = id;
  log('Loading folder: ' + id);
  const token = await getToken();
  const resp = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${id}/children`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await resp.json();
  items = data.value;
  const tbody = document.getElementById('gridBody');
  tbody.innerHTML = '';
  const crumbs = breadcrumbStack.map((b, i) => `<a href="#" onclick="goBack(${i})">${b.name}</a>`).join(' / ');
  document.getElementById('breadcrumbs').innerHTML = crumbs;

  items.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const isFolder = item.folder !== undefined;
    const name = isFolder ? 'â–¶ ' + item.name : item.name;
    const sizeMB = isFolder ? '' : (item.size / 1e6).toFixed(2);
    const created = formatDate(item.createdDateTime);
    const modified = formatDate(item.lastModifiedDateTime);
    const link = document.createElement('a');
    link.href = '#';
    link.textContent = name;
    link.onclick = (e) => {
      e.preventDefault();
      if (isFolder) {
        breadcrumbStack.push({ id: item.id, name: item.name });
        loadFolder(item.id);
      } else {
        currentIndex = idx;
        showModal();
      }
    };
    tr.appendChild(Object.assign(document.createElement('td'), { appendChild:()=>tr.cells[0].appendChild(link) }));
    tr.innerHTML += `<td>${sizeMB}</td><td>${created}</td><td>${modified}</td>`;
    tbody.appendChild(tr);
  });
}

function goBack(i) {
  breadcrumbStack = breadcrumbStack.slice(0,i+1);
  loadFolder(breadcrumbStack[i].id);
}

function sortTable(col) {
  const tbody = document.getElementById('gridBody');
  const rows = Array.from(tbody.rows);
  const dir = document.querySelector('table').getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
  rows.sort((a,b)=>{
    let valA = a.cells[col].textContent.trim();
    let valB = b.cells[col].textContent.trim();
    if (!isNaN(valA) && !isNaN(valB)) { valA=parseFloat(valA); valB=parseFloat(valB); }
    return dir==='asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  rows.forEach(r=>tbody.appendChild(r));
  document.querySelector('table').setAttribute('data-sort-dir', dir);
}

async function showModal() {
  const item = items[currentIndex];
  const token = await getToken();
  const viewer = document.getElementById('modalImage');
  const alt = document.getElementById('modalOtherViewer');
  const tableBody = document.querySelector('#metadataTable tbody');
  document.getElementById('modal').style.display = 'flex';
  viewer.style.display = 'none'; alt.style.display = 'none';
  tableBody.innerHTML = '';
  const url = item['@microsoft.graph.downloadUrl'];
  const mime = item.file?.mimeType || '';

  if (mime.startsWith('image/')) {
    viewer.src = url;
    viewer.onload = () => viewer.style.display = 'block';
    extractPNGText(url, tableBody);
  } else {
    alt.innerHTML = `<p>MIME: ${mime}</p><p><a href="${url}" target="_blank" style="color:lightblue;">Open in new tab</a></p>`;
    alt.style.display = 'block';
  }
}

async function extractPNGText(url, table) {
  const resp = await fetch(url);
  const buffer = await resp.arrayBuffer();
  const data = new Uint8Array(buffer);
  const dec = new TextDecoder();
  let pos = 8;
  while (pos < data.length) {
    const len = (data[pos]<<24)|(data[pos+1]<<16)|(data[pos+2]<<8)|data[pos+3];
    const type = dec.decode(data.slice(pos+4, pos+8));
    if (type==='tEXt') {
      const chunk = dec.decode(data.slice(pos+8,pos+8+len));
      const [k,v] = chunk.split('=');
      if (!wantedFields.includes(k)) { pos += len+12; continue; }
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td>${v}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${v}\`)">ðŸ“‹</button></td>`;
      table.appendChild(tr);
    }
    pos += len + 12;
  }
}

function toggleMetadata() {
  document.getElementById('metadataPanel').classList.toggle('collapsed');
}
function closeModal() { document.getElementById('modal').style.display = 'none'; }
function prevImage() { if (currentIndex > 0) { currentIndex--; showModal(); } }
function nextImage() { if (currentIndex < items.length-1) { currentIndex++; showModal(); } }
async function deleteImage() {
  const item = items[currentIndex];
  if (!confirm('Delete ' + item.name + '?')) return;
  const token = await getToken();
  await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${item.id}`, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
  closeModal(); loadFolder(currentFolder);
}
</script>
</body>
</html>
