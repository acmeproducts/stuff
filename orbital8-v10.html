<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OneDrive Browser</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
<style>
  html, body { height: 100%; margin: 0; font-family: sans-serif; }
  #statusContainer { margin: 20px; }
  #statusToggle { cursor: pointer; }
  #status { white-space: pre-line; max-height: 100px; overflow-y: auto; display: none; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; word-break: break-word; }
  th { background: #f8f8f8; cursor: pointer; }
  tr:hover { background: #f2f2f2; }
  #breadcrumbs { margin: 20px; }
  #modal {
    position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: rgba(0,0,0,0.92); display: none; flex-direction: column;
    z-index: 10000; justify-content: flex-start; align-items: center;
  }
  #modal .controls {
    width: 100%; background: #111a; color: #fff;
    display: flex; justify-content: center; align-items: center; padding: 8px 0; gap: 12px;
    position: sticky; top: 0;
  }
  #modalImageWrapper {
    flex: 1 1 auto; display: flex; align-items: center; justify-content: center;
    overflow: auto; background: #222; width: 100%;
  }
  #modalImage, #modalOtherViewer {
    max-width: 95vw; max-height: 85vh;
    border-radius: 8px; background: #000;
    margin: auto; display: block;
  }
  #metadataPanel {
    width: 100%; max-height: 30vh; overflow-y: auto; background: #fff;
    transition: max-height 0.3s ease;
  }
  #metadataPanel.collapsed { max-height: 0; overflow: hidden; }
  #metadataToggle {
    background: #444; color: #fff; cursor: pointer;
    padding: 4px 8px; font-size: 14px;
  }
  #metadataTable { width: 100%; }
  #metadataTable th, #metadataTable td {
    border: 1px solid #ccc; padding: 6px;
  }
  .copy-btn { background: none; border: none; cursor: pointer; }
  #modalCloseBtn {
    position: absolute; top: 10px; right: 14px; font-size: 24px;
    background: none; border: none; color: #fff; cursor: pointer;
  }
</style>
</head>
<body>
<h2 style="margin: 20px;">OneDrive Browser</h2>
<button id="signInBtn" style="margin-left: 20px;">Sign In</button>
<div id="statusContainer">
  <span id="statusToggle">&#x25B6; Debug</span>
  <div id="status">Status: Ready</div>
</div>
<div id="breadcrumbs"></div>
<table>
  <thead>
    <tr>
      <th onclick="sortTable(0)">Name</th>
      <th onclick="sortTable(1)">Size (MB)</th>
      <th onclick="sortTable(2)">Created</th>
      <th onclick="sortTable(3)">Modified</th>
    </tr>
  </thead>
  <tbody id="gridBody"></tbody>
</table>

<div id="modal">
  <div class="controls">
    <button onclick="prevImage()">Prev</button>
    <button onclick="nextImage()">Next</button>
    <button onclick="deleteImage()">Delete</button>
  </div>
  <button id="modalCloseBtn" onclick="closeModal()">âœ•</button>
  <div id="modalImageWrapper">
    <img id="modalImage" style="display:none;" />
    <div id="modalOtherViewer" style="display:none;color:#eee;text-align:center;"></div>
  </div>
  <div id="metadataToggle" onclick="toggleMetadata()">â–¼ Metadata</div>
  <div id="metadataPanel" class="collapsed">
    <table id="metadataTable">
      <thead><tr><th>Key</th><th>Value</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<script>
  const wantedFields = ['Project_ID', 'Prompt', 'Model', 'Height', 'Width', 'Steps', 'Seed', 'CFG_Scale', 'Global_Hash'];
let modalOpen = false;
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let activeAccount = null, currentFolder = 'root', items = [], currentIndex = 0, breadcrumbStack = [];
document.getElementById('signInBtn').addEventListener('click', async () => {
  log('Signing in...');
  try {
    const response = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    activeAccount = response.account;
    msalInstance.setActiveAccount(activeAccount);
    log('Signed in as: ' + activeAccount.username);
    breadcrumbStack = [{ id: 'root', name: 'Root' }];
    loadFolder('root');
  } catch (err) { log('Sign-in error: ' + err.message); }
});
function log(msg) {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent += '\n' + msg;
}
function toggleMetadata() {
  const panel = document.getElementById('metadataPanel');
  const toggle = document.getElementById('metadataToggle');
  panel.classList.toggle('collapsed');
  toggle.textContent = panel.classList.contains('collapsed') ? 'â–¼ Metadata' : 'â–² Metadata';
}
async function getToken() {
  const acct = msalInstance.getActiveAccount();
  try {
    const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All', 'User.Read'], account: acct });
    return result.accessToken;
  } catch {
    const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    return result.accessToken;
  }
}

async function loadFolder(id) {
  currentFolder = id;
  log('Loading folder: ' + id);
  const token = await getToken();
  log('Access token retrieved.');
  const resp = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${id}/children`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await resp.json();
  items = data.value;
  const tbody = document.getElementById('gridBody');
  tbody.innerHTML = '';
  const crumbs = breadcrumbStack.map((b, i) => `<a href="#" onclick="goBack(${i})">${b.name}</a>`).join(' / ');
  document.getElementById('breadcrumbs').innerHTML = crumbs;

  items.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const isFolder = item.folder !== undefined;
    const name = isFolder ? 'â–¶ ' + item.name : item.name;
    const sizeMB = isFolder ? '' : (item.size / 1e6).toFixed(2);
    const created = formatDate(item.createdDateTime);
    const modified = formatDate(item.lastModifiedDateTime);

    const link = document.createElement('a');
    link.href = '#';
    link.textContent = name;
    link.onclick = (e) => {
      e.preventDefault();
      if (isFolder) {
        breadcrumbStack.push({ id: item.id, name: item.name });
        loadFolder(item.id);
      } else {
        currentIndex = idx;
        showModal();
      }
    };
    const td1 = document.createElement('td'); td1.appendChild(link);
    const td2 = document.createElement('td'); td2.textContent = sizeMB;
    const td3 = document.createElement('td'); td3.textContent = created;
    const td4 = document.createElement('td'); td4.textContent = modified;
    tr.append(td1, td2, td3, td4);
    tbody.appendChild(tr);
  });
}

function formatDate(str) {
  const d = new Date(str);
  const dd = String(d.getDate()).padStart(2,'0');
  const mon = d.toLocaleString('default',{month:'short'});
  const yy = String(d.getFullYear()).slice(-2);
  const hh = String(d.getHours()).padStart(2,'0');
  const mi = String(d.getMinutes()).padStart(2,'0');
  return `${dd}-${mon}-${yy} ${hh}:${mi}`;
}

function goBack(i) {
  breadcrumbStack = breadcrumbStack.slice(0,i+1);
  loadFolder(breadcrumbStack[i].id);
}

function sortTable(col) {
  const tbody = document.getElementById('gridBody');
  const rows = Array.from(tbody.rows);
  const dir = document.querySelector('table').getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
  rows.sort((a,b)=>{
    let valA = a.cells[col].textContent.trim();
    let valB = b.cells[col].textContent.trim();
    if (!isNaN(valA) && !isNaN(valB)) { valA=parseFloat(valA); valB=parseFloat(valB); }
    return dir==='asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  rows.forEach(r=>tbody.appendChild(r));
  document.querySelector('table').setAttribute('data-sort-dir', dir);
}

async function showModal() {
  const item = items[currentIndex];
  const token = await getToken();
  document.getElementById('modal').style.display = 'flex';
  const viewer = document.getElementById('modalImage');
  const alt = document.getElementById('modalOtherViewer');
  const tableBody = document.querySelector('#metadataTable tbody');
  viewer.style.display = 'none';
  alt.style.display = 'none';
  tableBody.innerHTML = '';
  const url = item['@microsoft.graph.downloadUrl'];
  const mime = item.file?.mimeType || '';

  if (mime.startsWith('image/')) {
    viewer.src = url; viewer.style.display = 'block';
    extractPNGText(url, tableBody);
  } else {
    alt.innerHTML = `<p>MIME: ${mime}</p><p><a href="${url}" target="_blank" style="color:lightblue;">Open in new tab</a></p>`;
    alt.style.display = 'block';
  }
}

async function extractPNGText(url, table) {
  const resp = await fetch(url);
  const buffer = await resp.arrayBuffer();
  const data = new DataView(buffer);
  const decoder = new TextDecoder("utf-8");
  let offset = 8;

  while (offset < buffer.byteLength) {
    const length = data.getUint32(offset);
    const type = decoder.decode(new Uint8Array(buffer, offset + 4, 4));
    if (type === "tEXt") {
      const bytes = new Uint8Array(buffer, offset + 8, length);
      const text = decoder.decode(bytes);
      const split = text.indexOf("=");
      if (split > 0) {
        const key = text.substring(0, split);
        const val = text.substring(split + 1);
        if (wantedFields.includes(key)) {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${key}</td><td>${val}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${val}\`)">ðŸ“‹</button></td>`;
          table.appendChild(tr);
        }
      }
    }
    offset += length + 12;
  }
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }
function prevImage() { if (currentIndex > 0) { currentIndex--; showModal(); } }
function nextImage() { if (currentIndex < items.length-1) { currentIndex++; showModal(); } }
async function deleteImage() {
  const item = items[currentIndex];
  if (!confirm('Delete ' + item.name + '?')) return;
  const token = await getToken();
  await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${item.id}`, { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } });
  closeModal(); loadFolder(currentFolder);
}
document.getElementById('statusToggle').onclick = () => {
  const d = document.getElementById('status');
  d.style.display = d.style.display === 'none' ? 'block' : 'none';
};
</script>
</body>
</html>
  
