<!-- Full HTML file with corrected modal, expandable/resizable metadata panel, zoom slider, and no scroll shifts -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>OneDrive Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
<style>
  html, body {
    margin: 0; padding: 0; font-family: sans-serif; height: 100%;
    overflow: hidden;
  }
  #appContainer {
    display: flex; flex-direction: column; height: 100vh;
  }
  #modal {
    display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
    background: #111; color: #fff; z-index: 9999; flex-direction: column;
  }
  #modal .controls {
    display: flex; justify-content: center; align-items: center; padding: 8px;
    background: #222; gap: 12px;
  }
  #modalZoom {
    margin-top: 4px;
  }
  #modalCloseBtn {
    position: absolute; top: 10px; right: 12px;
    font-size: 24px; cursor: pointer; background: none; border: none; color: #fff;
  }
  #modalContent {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
  }
  #modalViewer {
    flex: 1 1 auto; display: flex; justify-content: center; align-items: center; overflow: auto;
  }
  #modalImage {
    max-width: 95%; max-height: 95%; transition: transform 0.2s ease;
  }
  #metadataPanel {
    height: 200px; background: #fff; color: #000; overflow-y: auto;
    transition: height 0.2s ease;
  }
  #metadataHeader {
    background: #eee; padding: 4px 8px; cursor: pointer;
    display: flex; justify-content: space-between; align-items: center;
  }
  #metadataTable {
    width: 100%; border-collapse: collapse;
  }
  #metadataTable td, #metadataTable th {
    border: 1px solid #ccc; padding: 6px; word-break: break-word;
  }
  .copy-btn {
    background: none; border: none; cursor: pointer;
  }
</style>
</head>
<body>
<div id="appContainer">
  <button id="signInBtn" style="margin: 10px;">Sign In</button>
  <div id="modal">
    <div class="controls">
      <button onclick="prevImage()">Prev</button>
      <button onclick="nextImage()">Next</button>
      <button onclick="deleteImage()">Delete</button>
    </div>
    <input id="modalZoom" type="range" min="0.25" max="2.0" step="0.05" value="1" />
    <button id="modalCloseBtn" onclick="closeModal()">âœ•</button>
    <div id="modalContent">
      <div id="modalViewer"><img id="modalImage" src="" /></div>
      <div id="metadataPanel">
        <div id="metadataHeader" onclick="toggleMetadata()">
          <span>Metadata</span><span id="chevron">â–¼</span>
        </div>
        <table id="metadataTable"><tbody></tbody></table>
      </div>
    </div>
  </div>
</div>
<script>
const wantedFields = ['Project_ID', 'Prompt', 'Model', 'Height', 'Width', 'Steps', 'Seed', 'CFG_Scale', 'Global_Hash'];
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let activeAccount = null, items = [], currentIndex = 0, zoomLevel = 1, metadataVisible = true;

document.getElementById('signInBtn').onclick = async () => {
  try {
    const loginResp = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    activeAccount = loginResp.account;
    msalInstance.setActiveAccount(activeAccount);
    const token = await getToken();
    const resp = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
      headers: { Authorization: 'Bearer ' + token }
    });
    const data = await resp.json();
    items = data.value.filter(i => i.file && i.name.toLowerCase().endsWith('.png'));
    currentIndex = 0;
    showModal();
  } catch (e) {
    alert('Sign-in failed: ' + e.message);
  }
};

async function getToken() {
  try {
    const acct = msalInstance.getActiveAccount();
    const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All', 'User.Read'], account: acct });
    return result.accessToken;
  } catch {
    const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    return result.accessToken;
  }
}

function showModal() {
  const img = document.getElementById('modalImage');
  const item = items[currentIndex];
  const url = item['@microsoft.graph.downloadUrl'];
  img.src = url;
  document.getElementById('modal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
  img.style.transform = `scale(${zoomLevel})`;
  extractPNGText(url);
}

function closeModal() {
  document.getElementById('modal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

function prevImage() {
  if (currentIndex > 0) {
    currentIndex--;
    showModal();
  }
}
function nextImage() {
  if (currentIndex < items.length - 1) {
    currentIndex++;
    showModal();
  }
}

async function deleteImage() {
  if (!confirm('Delete this image?')) return;
  const token = await getToken();
  await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${items[currentIndex].id}`, {
    method: 'DELETE',
    headers: { Authorization: 'Bearer ' + token }
  });
  items.splice(currentIndex, 1);
  if (items.length === 0) {
    closeModal();
  } else {
    currentIndex = Math.max(0, currentIndex - 1);
    showModal();
  }
}

function toggleMetadata() {
  const panel = document.getElementById('metadataPanel');
  const chevron = document.getElementById('chevron');
  metadataVisible = !metadataVisible;
  panel.style.height = metadataVisible ? '200px' : '0px';
  chevron.textContent = metadataVisible ? 'â–¼' : 'â–²';
}

document.getElementById('modalZoom').oninput = (e) => {
  zoomLevel = parseFloat(e.target.value);
  document.getElementById('modalImage').style.transform = `scale(${zoomLevel})`;
};

async function extractPNGText(url) {
  const table = document.querySelector('#metadataTable tbody');
  table.innerHTML = '';
  const resp = await fetch(url);
  const buffer = await resp.arrayBuffer();
  const data = new Uint8Array(buffer);
  const dec = new TextDecoder();
  let pos = 8;
  while (pos < data.length) {
    const len = (data[pos]<<24)|(data[pos+1]<<16)|(data[pos+2]<<8)|data[pos+3];
    const type = dec.decode(data.slice(pos+4, pos+8));
    if (type==='tEXt') {
      const chunk = dec.decode(data.slice(pos+8,pos+8+len));
      const [k,v] = chunk.split('=');
      if (wantedFields.includes(k)) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${k}</td><td>${v}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText(\`${v}\`)">ðŸ“‹</button></td>`;
        table.appendChild(tr);
      }
    }
    pos += len + 12;
  }
}
</script>
</body>
</html>
