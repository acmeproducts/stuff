<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>OneDrive Browser</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
  <style>
    html, body { margin: 0; font-family: sans-serif; height: 100%; overflow: hidden; }
    #statusContainer { padding: 10px; background: #f0f0f0; border-bottom: 1px solid #ccc; }
    #status { white-space: pre-wrap; max-height: 100px; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 6px; }
    th { background: #eee; cursor: pointer; }
    tr:hover { background: #f8f8f8; }

    #modal {
      position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
      background: rgba(0,0,0,0.92); display: none; flex-direction: column;
      z-index: 10000;
    }
    #modalHeader {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; background: #222; color: white;
    }
    #modalContent {
      display: flex; flex-direction: column; flex: 1; overflow: hidden;
    }
    #metadata {
      max-height: 100vh; background: white; overflow-y: auto;
      border-top: 1px solid #ccc;
      display: block; /* Ensure metadata is always displayed */
    }
    #metadata h3 {
      margin: 0; padding: 8px; background: #333; color: white;
    }
    #metadataTable {
      width: 100%;
      border-collapse: collapse;
    }
    #metadataTable th, #metadataTable td {
      border: 1px solid #ccc;
      padding: 6px;
      word-break: break-word;
    }
    .copy-btn {
      background: none;
      border: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2 style="margin: 10px;">OneDrive Browser</h2>
  <button id="signInBtn" style="margin-left: 10px;">Sign In</button>
  <div id="statusContainer">
    <h3>Status:</h3>
    <div id="status">Status: Ready</div>
  </div>
  <div id="breadcrumbs"></div>
  <table>
    <thead>
      <tr>
        <th onclick="sortTable(0)">Name</th>
        <th onclick="sortTable(1)">Size (MB)</th>
        <th onclick="sortTable(2)">Created</th>
        <th onclick="sortTable(3)">Modified</th>
      </tr>
    </thead>
    <tbody id="gridBody"></tbody>
  </table>

  <div id="modal">
    <div id="modalHeader">
      <div>Metadata Viewer YO</div>
      <button onclick="closeModal()" style="background:none;border:none;font-size:24px;color:white;">âœ•</button>
    </div>
    <div id="modalContent">
      <div id="metadata">
        <h3>Metadata</h3>
        <table id="metadataTable">
          <thead><tr><th>Key</th><th>Value</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const msalConfig = {
  auth: {
    clientId: 'b407fd45-c551-4dbb-9da5-cab3a2c5a949',
    authority: 'https://login.microsoftonline.com/common',
    redirectUri: window.location.origin + window.location.pathname
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
let activeAccount = null, currentFolder = 'root', items = [], currentIndex = 0, breadcrumbStack = [];

document.getElementById('signInBtn').onclick = async () => {
  try {
    const response = await msalInstance.loginPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    activeAccount = response.account;
    msalInstance.setActiveAccount(activeAccount);
    breadcrumbStack = [{ id: 'root', name: 'Root' }];
    loadFolder('root');
  } catch (e) {
    log('Login failed: ' + e.message);
  }
};

function log(msg) {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent += '\n' + msg;
}

function sortTable(col) {
  const tbody = document.getElementById('gridBody');
  const rows = Array.from(tbody.rows);
  const dir = document.querySelector('table').getAttribute('data-sort-dir') === 'asc' ? 'desc' : 'asc';
  rows.sort((a,b)=>{
    let valA = a.cells[col].textContent.trim();
    let valB = b.cells[col].textContent.trim();
    if (!isNaN(valA) && !isNaN(valB)) { valA=parseFloat(valA); valB=parseFloat(valB); }
    return dir==='asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
  });
  rows.forEach(r=>tbody.appendChild(r));
  document.querySelector('table').setAttribute('data-sort-dir', dir);
}

async function getToken() {
  const acct = msalInstance.getActiveAccount();
  try {
    const result = await msalInstance.acquireTokenSilent({ scopes: ['Files.ReadWrite.All', 'User.Read'], account: acct });
    return result.accessToken;
  } catch {
    const result = await msalInstance.acquireTokenPopup({ scopes: ['Files.ReadWrite.All', 'User.Read'] });
    return result.accessToken;
  }
}

async function loadFolder(id) {
  currentFolder = id;
  const token = await getToken();
  const resp = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${id}/children`, {
    headers: { Authorization: 'Bearer ' + token }
  });
  const data = await resp.json();
  items = data.value;
  const tbody = document.getElementById('gridBody');
  tbody.innerHTML = '';
  const crumbs = breadcrumbStack.map((b, i) => `<a href="#" onclick="goBack(${i})">${b.name}</a>`).join(' / ');
  document.getElementById('breadcrumbs').innerHTML = crumbs;

  items.forEach((item, idx) => {
    const tr = document.createElement('tr');
    const isFolder = item.folder !== undefined;
    const name = isFolder ? 'â–¶ ' + item.name : item.name;
    const sizeMB = isFolder ? '' : (item.size / 1e6).toFixed(2);
    const created = formatDate(item.createdDateTime);
    const modified = formatDate(item.lastModifiedDateTime);

    const link = document.createElement('a');
    link.href = '#';
    link.textContent = name;
    link.onclick = (e) => {
      e.preventDefault();
      if (isFolder) {
        breadcrumbStack.push({ id: item.id, name: item.name });
        loadFolder(item.id);
      } else {
        currentIndex = idx;
        showMetadata();
      }
    };

    const td1 = document.createElement('td'); td1.appendChild(link);
    const td2 = document.createElement('td'); td2.textContent = sizeMB;
    const td3 = document.createElement('td'); td3.textContent = created;
    const td4 = document.createElement('td'); td4.textContent = modified;
    tr.append(td1, td2, td3, td4);
    tbody.appendChild(tr);
  });
}

function goBack(i) {
  breadcrumbStack = breadcrumbStack.slice(0,i+1);
  loadFolder(breadcrumbStack[i].id);
}

function formatDate(str) {
  const d = new Date(str);
  return d.toLocaleString();
}

async function showMetadata() {
  const item = items[currentIndex];
  const token = await getToken();
  const url = item['@microsoft.graph.downloadUrl'];
  document.getElementById('modal').style.display = 'flex';
  extractMetadata(url);
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

async function extractMetadata(url) {
  try {
    log('Starting to extract metadata...');
    const resp = await fetch(url);
    if (!resp.ok) {
      throw new Error('Failed to fetch image: ' + resp.statusText);
    }
    const blob = await resp.blob();
    const arrayBuffer = await blob.arrayBuffer();
    const data = new Uint8Array(arrayBuffer);
    const dec = new TextDecoder();
    let pos = 8;
    const tableBody = document.querySelector('#metadataTable tbody');
    tableBody.innerHTML = '';

    // Extract metadata from PNG files
    if (url.endsWith('.png')) {
      while (pos < data.length) {
        const len = (data[pos] << 24) | (data[pos + 1] << 16) | (data[pos + 2] << 8) | data[pos + 3];
        const type = dec.decode(data.slice(pos + 4, pos + 8));
        if (type === 'tEXt') {
          const chunk = dec.decode(data.slice(pos + 8, pos + 8 + len));
          const [k, v] = chunk.split('=');
          if (!k || !v) {
            pos += len + 12;
            continue;
          }
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${k}</td><td>${v}</td><td><button class="copy-btn" onclick="navigator.clipboard.writeText('${v}')">ðŸ“‹</button></td>`;
          tableBody.appendChild(tr);
        }
        pos += len + 12;
      }
      if (tableBody.innerHTML === '') {
        log('No metadata found.');
      }
    } else {
      log('File is not a PNG.');
    }
    log('Metadata extraction completed.');
  } catch (error) {
    log('Error extracting metadata: ' + error.message);
  }
}
</script>
</body>
</html>
