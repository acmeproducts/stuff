<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI Jobs Kanban</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{
  --bg:#f7f7f9;
  --panel:#ffffff;
  --text:#111;
  --muted:#666;
  --accent:#1f6feb;
  --border:#e3e3e8;
  --danger:#b3261e;
  --highlight:#ff7a00; /* solid orange for DnD target */
  --search:#14532d;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:20;background:var(--panel);border-bottom:1px solid var(--border);}
.toolbar{padding:10px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.searchbar{padding:10px 16px;border-top:1px solid var(--border);display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center}
#search{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:15px}
.btn{padding:10px 14px;border:1px solid var(--border);background:var(--panel);border-radius:10px;cursor:pointer;font-weight:600}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.btn.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
.btn.small{padding:6px 8px;font-size:12px}
.btn:disabled{opacity:.6;cursor:not-allowed}
main{
  padding:16px;
  display:grid;
  grid-template-columns:repeat(auto-fit, minmax(320px,1fr));
  gap:16px;
  align-items:start
}
.lane{background:var(--panel);border:1px solid var(--border);border-radius:14px;min-height:60vh;display:flex;flex-direction:column}
.lane-header{padding:10px 12px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;font-weight:700}
.lane-body{padding:8px;display:flex;flex-direction:column;gap:8px;min-height:120px}
.card{
  background:#fff;
  border:2px solid transparent;
  border-radius:999px; /* chip */
  display:flex;align-items:center;gap:10px;
  padding:8px 12px;
  cursor:grab;
  min-height:36px;
  box-shadow:0 1px 0 rgba(0,0,0,.03);
  -webkit-user-drag: element;
  user-select:none;
}
.card *{ -webkit-user-drag: none; }
.card.dragging{opacity:.5}
.card.search-hit{border-color:var(--search)}
.card-line{display:flex;align-items:center;gap:10px;flex-wrap:nowrap;width:100%;min-width:0}
.card-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.card-platform{font-size:12px;color:var(--muted);border:1px solid var(--border);padding:2px 8px;border-radius:999px;flex:0 0 auto}
.card-links a{font-size:12px;margin-left:8px;text-decoration:none}
.card-tags{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.drop-highlight{border-color:var(--highlight) !important}
.footer{padding:8px 16px;color:var(--muted);font-size:12px;text-align:right}
.hidden{display:none}
dialog{border:none;border-radius:14px;padding:0;width:min(720px,92vw)}
.modal{padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:14px}
.field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
.field input,.field textarea,.field select{border:1px solid var(--border);border-radius:10px;padding:10px;font-size:14px;width:100%}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.results{
  position:sticky;top:96px; /* under the header */
  margin:0 16px 8px 16px;
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:10px;
  max-height:260px; overflow:auto;
}
.result-item{padding:10px 12px;border-top:1px solid var(--border);cursor:pointer}
.result-item:first-child{border-top:none}
.result-item:hover{background:#f1f5ff}
.muted{color:var(--muted);font-size:12px}
@media (max-width:900px){main{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="toolbar">
    <button id="btnNew" class="btn">New</button>
    <button id="btnSettings" class="btn">Settings</button>
    <button id="btnExport" class="btn">Export</button>
    <button id="btnImport" class="btn">Import</button>
    <input id="fileImport" type="file" accept="application/json" class="hidden"/>
  </div>
  <div class="searchbar">
    <input id="search" placeholder="Search everything…" aria-label="Omni search"/>
    <span class="muted" id="searchCount"></span>
  </div>
</header>

<div id="resultsContainer"></div>
<main id="board" aria-live="polite"></main>
<div class="footer" id="status"></div>

<!-- Editor -->
<dialog id="editDialog">
  <form method="dialog" class="modal" id="editForm">
    <h3 id="editTitle">Card</h3>
    <div class="grid-2">
      <div class="field">
        <label for="fPlatform">Platform</label>
        <select id="fPlatform"></select>
      </div>
      <div class="field">
        <label for="fStage">Lane</label>
        <select id="fStage"></select>
      </div>
    </div>
    <div class="field">
      <label for="fTitle">Title</label>
      <input id="fTitle" placeholder="Short title"/>
    </div>
    <div class="grid-2">
      <div class="field">
        <label for="fDev">Dev Link</label>
        <input id="fDev" type="url" placeholder="https://…"/>
      </div>
      <div class="field">
        <label for="fLive">Live Link</label>
        <input id="fLive" type="url" placeholder="https://…"/>
      </div>
    </div>
    <div class="field">
      <label for="fTags">Tags (comma-separated)</label>
      <input id="fTags" placeholder="eval, draft, v1"/>
    </div>
    <div class="field">
      <label for="fNotes">Notes</label>
      <textarea id="fNotes" rows="4" placeholder="Multi-line notes"></textarea>
    </div>
    <div class="row">
      <button class="btn primary" value="save" id="btnSave">Save</button>
      <button class="btn" value="cancel" id="btnCancel">Cancel</button>
      <button id="btnDelete" class="btn danger" value="delete">Delete</button>
    </div>
  </form>
</dialog>

<!-- Search Modal -->
<dialog id="searchDialog">
  <form method="dialog" class="modal">
    <h3>Search results</h3>
    <div id="searchList" style="max-height:60vh; overflow:auto;"></div>
    <div class="row" style="margin-top:10px;">
      <button class="btn" value="close">Close</button>
    </div>
  </form>
</dialog>

<!-- Settings -->
<dialog id="settingsDialog">
  <form method="dialog" class="modal" id="settingsForm">
    <h3>Settings</h3>
    <div class="field">
      <label for="sPlatforms">Platforms (comma-separated)</label>
      <input id="sPlatforms" value="Gemini, Claude, ChatGPT, Perplexity"/>
    </div>
    <div class="field">
      <label for="sStages">Stages (left→right, top→bottom order)</label>
      <input id="sStages" value="Done, Doing, Next"/>
    </div>
    <div class="row">
      <button class="btn primary" value="save">Apply</button>
      <button class="btn" value="cancel">Cancel</button>
      <button class="btn danger" id="btnReset" value="reset">Reset Board</button>
    </div>
  </form>
</dialog>

<script>
/* State */
const storageKey = "ai_jobs_kanban_v7"; // keep same to preserve data
let state = {
  stages: ["Done","Doing","Next"],
  platforms: ["Gemini","Claude","ChatGPT","Perplexity"],
  cards: [] // {id,title,platform,stage,dev,live,tags[],notes,pos:number,createdAt,updatedAt}
};
const $ = s=>document.querySelector(s);
const $$ = s=>Array.from(document.querySelectorAll(s));
function uid(){return Math.random().toString(36).slice(2,10)}

/* Persistence */
function save(){localStorage.setItem(storageKey, JSON.stringify(state)); setStatus("Saved");}
function load(){
  const raw = localStorage.getItem(storageKey);
  if(raw){ try{ state = JSON.parse(raw);}catch(e){ console.error(e);} }
}

/* Ordering helpers */
function stageCards(stage){
  return state.cards.filter(c=>c.stage===stage).sort((a,b)=>{
    const pa = (typeof a.pos==="number")?a.pos:0;
    const pb = (typeof b.pos==="number")?b.pos:0;
    return pa - pb || (a.createdAt - b.createdAt);
  });
}
function nextPos(stage){
  const list = stageCards(stage);
  if(list.length===0) return 1000;
  return (list[list.length-1].pos ?? 0) + 1000;
}
function topPos(stage){
  const list = stageCards(stage);
  if(list.length===0) return 1000;
  return (list[0].pos ?? 1000) - 1000;
}
function moveToStageAt(id, stage, index){
  const c = state.cards.find(x=>x.id===id); if(!c) return;
  const list = stageCards(stage);
  let pos;
  if(index <= 0 || list.length===0){
    pos = (list[0]?.pos ?? 1000) - 1000;
  }else if(index >= list.length){
    pos = (list[list.length-1].pos ?? 1000) + 1000;
  }else{
    const prev = list[index-1];
    const next = list[index];
    pos = ((prev.pos ?? 0) + (next.pos ?? 0)) / 2;
  }
  c.stage = stage;
  c.pos = pos;
  c.updatedAt = Date.now();
  maybeRebalance(stage);
  save(); render(); focusCard(id);
}
function maybeRebalance(stage){
  const list = stageCards(stage);
  if(list.length<2) return;
  let need = false;
  for(let i=1;i<list.length;i++){
    if(Math.abs(list[i].pos - list[i-1].pos) < 0.5){ need = true; break; }
  }
  if(need){
    list.forEach((c,i)=>{ c.pos = (i+1)*1000; });
  }
}

/* Rendering */
let draggingId = null;
let highlightEl = null;
function render(){
  const board = $("#board");
  board.innerHTML = "";
  state.stages.forEach(stage=>{
    const lane = document.createElement("section");
    lane.className = "lane";
    lane.dataset.stage = stage;
    const head = document.createElement("div");
    head.className = "lane-header";
    head.innerHTML = `<span>${stage}</span><span>${state.cards.filter(c=>c.stage===stage).length}</span>`;
    const body = document.createElement("div");
    body.className = "lane-body";

    body.addEventListener("dragenter", e=>{ e.preventDefault(); });
    body.addEventListener("dragover", e=>{
      e.preventDefault();
      const {index, targetEl} = getDropTarget(body, e.clientY);
      body.dataset.dropIndex = index;
      setHighlight(targetEl);
      if(e.dataTransfer){ e.dataTransfer.dropEffect = "move"; }
    });
    body.addEventListener("dragleave", e=>{
      if(!body.contains(e.relatedTarget)){ setHighlight(null); }
    });
    body.addEventListener("drop", e=>{
      e.preventDefault();
      const id = draggingId || e.dataTransfer.getData("text/id") || e.dataTransfer.getData("text/plain");
      if(!id){ setHighlight(null); return; }
      const idx = Number(body.dataset.dropIndex ?? 0);
      moveToStageAt(id, stage, idx);
      setHighlight(null);
    });

    stageCards(stage).forEach(c=> body.appendChild(renderCard(c)));
    lane.append(head, body);
    board.appendChild(lane);
  });
  refillSelects();
  // Apply search filter after rendering
  applySearch($("#search").value);
}

// Global preventDefault keeps drops active across the page
document.addEventListener("dragover", e=> e.preventDefault());

function setHighlight(el){
  if(highlightEl && highlightEl!==el){ highlightEl.classList.remove("drop-highlight"); }
  highlightEl = el;
  if(highlightEl){ highlightEl.classList.add("drop-highlight"); }
}

function getDropTarget(body, clientY){
  const cards = [...body.querySelectorAll(".card")].filter(x=> x.dataset.id !== draggingId);
  if(cards.length===0){
    return {index:0, targetEl:null}; // nothing to highlight
  }
  let index = cards.length;
  for(let i=0;i<cards.length;i++){
    const rect = cards[i].getBoundingClientRect();
    const mid = rect.top + rect.height/2;
    if(clientY < mid){ index = i; break; }
  }
  const targetEl = (index>=cards.length) ? cards[cards.length-1] : cards[index];
  return {index, targetEl};
}

function renderCard(card){
  const el = document.createElement("article");
  el.className = "card";
  el.draggable = true;
  el.dataset.id = card.id;
  el.addEventListener("dragstart", e=>{
    draggingId = card.id;
    el.classList.add("dragging");
    el.querySelectorAll("a").forEach(a=> a.style.pointerEvents = "none");
    e.dataTransfer.setData("text/id", card.id);
    e.dataTransfer.setData("text/plain", card.id);
    e.dataTransfer.effectAllowed = "move";
    const di = makeDragImage(el);
    document.body.appendChild(di);
    e.dataTransfer.setDragImage(di, di.offsetWidth/2, di.offsetHeight/2);
    setTimeout(()=> di.remove(), 0);
  });
  el.addEventListener("dragend", ()=>{
    draggingId = null;
    el.classList.remove("dragging");
    el.querySelectorAll("a").forEach(a=> a.style.pointerEvents = "");
    setHighlight(null);
  });
  el.addEventListener("click", ()=> openEditor(card.id));

  const line = document.createElement("div");
  line.className = "card-line";
  const p = document.createElement("span");
  p.className = "card-platform";
  p.textContent = card.platform;
  const title = document.createElement("span");
  title.className = "card-title";
  title.textContent = card.title || "(untitled)";
  const links = document.createElement("span");
  links.className = "card-links";
  links.innerHTML = `${card.dev? `<a href="${card.dev}" target="_blank" rel="noopener">dev</a>`:""}${card.live? `<a href="${card.live}" target="_blank" rel="noopener">live</a>`:""}`;
  const tags = document.createElement("span");
  tags.className = "card-tags";
  tags.textContent = card.tags?.length ? " #" + card.tags.join(" #") : "";
  line.append(p,title,links,tags);
  el.append(line);
  return el;
}

function makeDragImage(el){
  const di = document.createElement("div");
  di.style.position = "absolute";
  di.style.top = "-1000px";
  di.style.left = "-1000px";
  di.style.pointerEvents = "none";
  di.style.padding = "6px 10px";
  di.style.border = "2px solid var(--highlight)";
  di.style.borderRadius = "999px";
  di.style.background = "#fff";
  di.style.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto";
  di.textContent = el.querySelector(".card-title")?.textContent || "Card";
  return di;
}

/* Card Ops */
function createCard(data){
  const now = Date.now();
  const stage = data.stage || state.stages[0] || "Next";
  const c = {
    id: uid(),
    title: (data.title||"").trim(),
    platform: data.platform || state.platforms[0] || "General",
    stage,
    dev: (data.dev||"").trim(),
    live: (data.live||"").trim(),
    tags: normalizeTags(data.tags),
    notes: (data.notes||"").trim(),
    pos: topPos(stage), // insert at top
    createdAt: now,
    updatedAt: now
  };
  state.cards.push(c);
  save(); render(); focusCard(c.id);
  return c.id;
}
function updateCard(id, patch){
  const c = state.cards.find(x=>x.id===id); if(!c) return;
  Object.assign(c, patch);
  c.tags = normalizeTags(c.tags);
  c.updatedAt = Date.now();
  save(); render(); focusCard(c.id);
}
function deleteCard(id){
  state.cards = state.cards.filter(x=>x.id!==id);
  save(); render();
}
function focusCard(id){
  const el = $(`.card[data-id="${id}"]`);
  if(el){ el.scrollIntoView({behavior:"smooth",block:"center",inline:"center"}); el.animate([{transform:"scale(1)"},{transform:"scale(1.02)"},{transform:"scale(1)"}],{duration:450}); }
}
function normalizeTags(tags){
  if(Array.isArray(tags)) return tags.filter(Boolean).map(s=>s.trim()).filter(Boolean);
  if(typeof tags==="string") return tags.split(",").map(s=>s.trim()).filter(Boolean);
  return [];
}

/* Editor Modal */
const editDialog = $("#editDialog");
let editingId = null;

function openEditor(id=null, presetStage=null){
  editingId = id;
  $("#editTitle").textContent = id? "Edit Card" : "New Card";
  const c = id ? state.cards.find(x=>x.id===id) : null;
  $("#fPlatform").value = c?.platform || (state.platforms[0]||"General");
  $("#fStage").value = c?.stage || (presetStage || state.stages[0] || "Next");
  $("#fTitle").value = c?.title || "";
  $("#fDev").value = c?.dev || "";
  $("#fLive").value = c?.live || "";
  $("#fTags").value = c?.tags?.join(", ") || "";
  $("#fNotes").value = c?.notes || "";
  $("#btnDelete").classList.toggle("hidden", !id);
  editDialog.showModal();
}

editDialog.addEventListener("close", ()=>{
  const action = editDialog.returnValue;
  if(action==="cancel"){ editingId=null; return; }
  if(action==="delete" && editingId){ deleteCard(editingId); editingId=null; return; }
  if(action==="save"){
    const titleVal = $("#fTitle").value.trim();
    if(!titleVal){ alert("Title is required."); editDialog.showModal(); return; }
    const data = {
      platform: $("#fPlatform").value,
      stage: $("#fStage").value,
      title: titleVal,
      dev: $("#fDev").value.trim(),
      live: $("#fLive").value.trim(),
      tags: $("#fTags").value,
      notes: $("#fNotes").value
    };
    if(editingId){
      updateCard(editingId, data);
    }else{
      createCard(data);
    }
    editingId=null;
  }
});

/* Settings */
const settingsDialog = $("#settingsDialog");
$("#btnSettings").onclick = ()=>{
  $("#sPlatforms").value = state.platforms.join(", ");
  $("#sStages").value = state.stages.join(", ");
  settingsDialog.showModal();
};
settingsDialog.addEventListener("close", ()=>{
  const v = settingsDialog.returnValue;
  if(v==="cancel") return;
  if(v==="reset"){ if(confirm("Remove all cards?")){ state.cards=[]; save(); render(); } return; }
  if(v==="save"){
    const platforms = $("#sPlatforms").value.split(",").map(s=>s.trim()).filter(Boolean);
    const stages = $("#sStages").value.split(",").map(s=>s.trim()).filter(Boolean);
    if(stages.length){
      const newFirst = stages[0];
      state.cards.forEach(c=>{
        if(!stages.includes(c.stage)){ c.stage = newFirst; c.pos = topPos(newFirst); }
      });
      state.stages = stages;
    }
    if(platforms.length){ state.platforms = platforms; }
    save(); render();
  }
});

/* New, Import, Export */
$("#btnNew").onclick = ()=> openEditor(null, state.stages[0] || "Next");

$("#btnExport").onclick = ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.download = "ai-jobs-kanban.json"; a.click();
  URL.revokeObjectURL(url);
};
$("#btnImport").onclick = ()=> $("#fileImport").click();
$("#fileImport").onchange = (e)=>{
  const f = e.target.files?.[0]; if(!f) return;
  const r = new FileReader();
  r.onload = ()=>{
    try{
      const obj = JSON.parse(r.result);
      if(Array.isArray(obj.cards) && Array.isArray(obj.platforms) && Array.isArray(obj.stages)){
        state = obj;
        state.stages.forEach(st=>{
          const list = state.cards.filter(c=>c.stage===st);
          list.sort((a,b)=> (a.pos??0)-(b.pos??0) || (a.createdAt-b.createdAt));
          list.forEach((c,i)=>{ if(typeof c.pos!=="number") c.pos=(i+1)*1000; });
        });
        save(); render();
      }else{ alert("Invalid JSON structure."); }
    }catch(err){ alert("Failed to parse JSON."); }
  };
  r.readAsText(f);
};

/* Lane background double-click to add to that lane (top) */
$("#board").addEventListener("dblclick", (e)=>{
  const lane = e.target.closest(".lane"); if(!lane) return;
  const stage = lane.dataset.stage;
  openEditor(null, stage);
});

/* Omni Search: simple real-time match + Enter shows modal list */
const searchInput = $("#search");
let searchDebounce;
let currentMatches = [];
searchInput.addEventListener("input", ()=>{
  clearTimeout(searchDebounce);
  searchDebounce = setTimeout(()=> applySearch(searchInput.value), 120);
});
searchInput.addEventListener("keydown", (e)=>{
  if(e.key==="Escape"){ searchInput.value=""; applySearch(""); return; }
  if(e.key==="Enter"){
    e.preventDefault();
    openSearchModal(currentMatches);
  }
});

function applySearch(q){
  const term = (q||"").trim().toLowerCase();
  const all = state.cards.slice();
  currentMatches = term ? all.filter(c=> combinedHay(c).includes(term)) : all;
  highlightMatches(new Set(currentMatches.map(c=>c.id)), Boolean(term));
  renderResultsPreview(currentMatches.slice(0,120), term);
  $("#searchCount").textContent = term? `${currentMatches.length} match(es)` : "";
}
function combinedHay(c){
  return [c.title, c.platform, c.stage, c.notes, c.dev, c.live, ...(c.tags||[])].join(" ").toLowerCase();
}
function highlightMatches(idset, hasTerm){
  $$(".card").forEach(el=>{
    el.classList.toggle("search-hit", hasTerm && idset.has(el.dataset.id));
    el.style.opacity = hasTerm && !idset.has(el.dataset.id) ? 0.35 : 1;
  });
}
function renderResultsPreview(cards, term){
  const cont = $("#resultsContainer");
  cont.innerHTML = "";
  if(!term || cards.length===0) return;
  const box = document.createElement("div");
  box.className = "results";
  cards.forEach(c=>{
    const item = document.createElement("div");
    item.className = "result-item";
    item.innerHTML = `<strong>${escapeHtml(c.title)}</strong>
      <div class="muted">${escapeHtml(c.platform)} · ${escapeHtml(c.stage)}${c.tags?.length? " · #"+c.tags.join(" #"):""}</div>`;
    item.onclick = ()=>{ focusCard(c.id); };
    box.appendChild(item);
  });
  cont.appendChild(box);
}
function openSearchModal(cards){
  const dlg = $("#searchDialog");
  const list = $("#searchList");
  list.innerHTML = "";
  if(cards.length===0){
    list.innerHTML = "<div class='muted'>No results</div>";
  }else{
    cards.forEach(c=>{
      const row = document.createElement("div");
      row.className = "result-item";
      row.innerHTML = `<strong>${escapeHtml(c.title)}</strong>
        <div class="muted">${escapeHtml(c.platform)} · ${escapeHtml(c.stage)}${c.tags?.length? " · #"+c.tags.join(" #"):""}</div>`;
      row.onclick = ()=>{ dlg.close("close"); focusCard(c.id); };
      list.appendChild(row);
    });
  }
  dlg.showModal();
}
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

/* Helpers */
function setStatus(t){ $("#status").textContent = t; }
function refillSelects(){
  const pSel = $("#fPlatform");
  const sSel = $("#fStage");
  pSel.innerHTML = state.platforms.map(p=>`<option>${p}</option>`).join("");
  sSel.innerHTML = state.stages.map(s=>`<option>${s}</option>`).join("");
}

/* Init */
load(); render(); setStatus("Simple search enabled. Type to filter live; press Enter to open results modal and jump to a card.");
</script>
</body>
</html>
