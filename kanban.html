<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI Jobs Kanban — Persistent JSON Boards (v2)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--bg:#f7f7f9;--panel:#fff;--border:#d0d0d5;--text:#111;--accent:#1f6feb;}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:8px;display:flex;flex-wrap:wrap;align-items:center;gap:6px;}
button{border:1px solid var(--border);border-radius:6px;background:#fff;padding:6px 10px;cursor:pointer;}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
main{padding:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:10px;}
.lane{background:var(--panel);border:1px solid var(--border);border-radius:10px;display:flex;flex-direction:column;}
.lane h3{margin:0;padding:6px 8px;border-bottom:1px solid var(--border);}
.lane-body{padding:6px;display:flex;flex-direction:column;gap:6px;}
.card{background:#fff;border:2px solid var(--border);border-radius:8px;padding:5px 8px;cursor:grab;}
.card.dragging{opacity:.8;border-color:#000;}
footer{font-size:12px;padding:6px 10px;color:#555;text-align:right;border-top:1px solid var(--border);}
</style>
</head>
<body>
<header>
  <button id="btnNew" class="primary">New</button>
  <button id="btnImport">Import</button>
  <button id="btnExport">Export</button>
  <button id="btnArchive">Archive</button>
  <span id="status" style="margin-left:auto;">Loading…</span>
</header>
<main id="board"></main>
<footer id="footer">Loaded: Default Dataset</footer>
<script>
(function(){
const LANES=["Done","Doing","Next"];
const STORAGE_KEY="ai_jobs_kanban_state_v2";
const FOOTER=document.querySelector("#footer");
function $(s){return document.querySelector(s);}
function uid(){return Math.random().toString(36).slice(2,10);}
function now(){return new Date().toLocaleString();}
function defaultData(){return {meta:{name:"Default Board",createdAt:now()},cards:[]};}
function loadState(){
 let s=localStorage.getItem(STORAGE_KEY);
 if(s){try{return JSON.parse(s);}catch{return defaultData();}}
 return defaultData();
}
function saveState(){
 localStorage.setItem(STORAGE_KEY,JSON.stringify(state));
 FOOTER.textContent="Saved: "+(state.meta?.name||"Unnamed")+" @ "+now();
}
let state=loadState();
function render(){
 const board=$("#board");board.innerHTML="";
 LANES.forEach(stage=>{
  const sec=document.createElement("section");
  sec.className="lane";
  sec.innerHTML=`<h3>${stage}</h3><div class="lane-body" data-stage="${stage}"></div>`;
  board.appendChild(sec);
  const body=sec.querySelector(".lane-body");
  state.cards.filter(c=>c.stage===stage).forEach(c=>body.appendChild(renderCard(c)));
  body.addEventListener("dragover",e=>e.preventDefault());
  body.addEventListener("drop",e=>{e.preventDefault();moveToStage(e.dataTransfer.getData("text/plain"),stage);});
 });
 $("#status").textContent="Ready ("+state.cards.length+" cards)";
}
function renderCard(c){
 const el=document.createElement("div");
 el.className="card";el.draggable=true;el.dataset.id=c.id;el.textContent=c.title;
 el.addEventListener("dragstart",e=>{el.classList.add("dragging");e.dataTransfer.setData("text/plain",c.id);});
 el.addEventListener("dragend",()=>el.classList.remove("dragging"));
 el.addEventListener("click",()=>{
  const t=prompt("Edit title",c.title);
  if(t===null)return;
  c.title=t.trim();saveState();render();
 });
 return el;
}
function moveToStage(id,stage){
 const card=state.cards.find(x=>x.id===id);
 if(!card)return;
 card.stage=stage;saveState();render();
}
$("#btnNew").onclick=()=>{
 const t=prompt("Card title");
 if(!t)return;
 state.cards.unshift({id:uid(),title:t.trim(),stage:"Next",createdAt:now()});
 saveState();render();
};
$("#btnImport").onclick=()=>{
 const inp=document.createElement("input");inp.type="file";inp.accept=".json";
 inp.onchange=e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      if(!obj.meta){obj.meta={name:file.name.replace(/\\.json$/,''),importedAt:now()};}
      if(!obj.cards){throw new Error("Missing cards array");}
      state=obj;saveState();
      FOOTER.textContent="Imported: "+(state.meta.name||file.name)+" @ "+now();
      render();
    }catch(err){alert("Import failed: "+err.message);}
  };
  reader.readAsText(file);
 };
 inp.click();
};
$("#btnExport").onclick=()=>{
 const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
 const ts=new Date().toISOString().replace(/[:T]/g,"_").slice(0,15);
 const a=document.createElement("a");
 a.href=URL.createObjectURL(blob);
 a.download=`ai-jobs-kanban-${ts}.json`;
 a.click();
 FOOTER.textContent="Exported: "+a.download;
};
$("#btnArchive").onclick=()=>{
 if(!confirm("Archive current board?"))return;
 localStorage.removeItem(STORAGE_KEY);
 state=defaultData();
 saveState();render();
};
render();
})();
</script>
</body>
</html>