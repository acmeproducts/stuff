<!-- orbital8-v22-Aug-903 - 2025-01-27 02:15 PM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Orbital8 V22-Aug-903 - Unified Metadata Performance</title>
    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <style>
        /* ===== ORBITAL8 V22-Aug-903 - Unified Metadata Performance ===== */
        /* Changes in this version:
           - ROLLBACK: Restored working Google Drive appProperties implementation
           - ONEDRIVE FIX: Implemented proper openExtension API calls
           - PERFORMANCE: OneDrive now uses distributed metadata (no more tags.json conflicts)
           - STABILITY: Google Drive functionality restored to working state
           - Versioning: Updated to v22-Aug-903.
        */
        
        :root {
            --app-accent: #f59e0b;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.3);
            --dark-gradient: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
            --glow-opacity: 0.6;
            --ripple-duration: 1500ms;
        }

        * { box-sizing: border-box; }
        
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden; background: #000; overscroll-behavior: none; touch-action: none;
        }
        
        /* ===== Screen & Card Styles ===== */
        .screen {
            position: fixed; inset: 0; background: var(--dark-gradient);
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
        }
        .screen.hidden { display: none; }
        
        .card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 20px;
            padding: 40px; text-align: center; max-width: 500px; width: 90%;
        }
        
        /* ===== Typography ===== */
        .title { color: white; font-size: 24px; font-weight: 600; margin-bottom: 16px; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); }
        .subtitle { color: rgba(255, 255, 255, 0.7); font-size: 16px; margin-bottom: 24px; }
        
        /* ===== Form Elements ===== */
        .input, .notes-textarea, .tag-input {
            width: 100%; padding: 12px 16px; border: 1px solid var(--glass-border); border-radius: 12px;
            background: var(--glass-bg); color: white; font-size: 14px; margin-bottom: 16px; backdrop-filter: blur(10px);
        }
        .input::placeholder, .tag-input::placeholder { color: rgba(255, 255, 255, 0.5); }
        .input:focus, .notes-textarea:focus, .tag-input:focus {
            outline: none; border-color: var(--app-accent); box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }
        .notes-textarea { min-height: 120px; font-family: inherit; resize: vertical; }

        #action-modal .tag-input, #grid-modal .input {
            color: #1f2937;
            background: #f3f4f6;
            border-color: #d1d5db;
        }
        
        /* ===== Buttons ===== */
        .button, .folder-button, .btn {
            background: linear-gradient(45deg, var(--app-accent), #d97706); border: none; border-radius: 15px;
            color: white; font-size: 18px; font-weight: 600; padding: 16px 32px; cursor: pointer;
            transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4); width: 100%; margin-bottom: 16px;
        }
        .button:hover:not(:disabled), .folder-button:hover, .btn:hover:not(:disabled) {
            transform: translateY(-2px); box-shadow: 0 6px 25px rgba(245, 158, 11, 0.6);
        }
        .button:disabled, .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .folder-button {
            flex: 1; padding: 12px 24px; border: 1px solid var(--glass-border); background: var(--glass-bg);
            font-size: 14px; backdrop-filter: blur(10px); width: auto;
        }
        .folder-button.danger { border-color: rgba(239, 68, 68, 0.3); color: #ef4444; }
        .folder-button.danger:hover { background: rgba(239, 68, 68, 0.1); }
        
        .btn { padding: 4px 12px; border-radius: 6px; font-size: 14px; font-weight: 500; margin-bottom: 0; width: auto; }
        .btn-primary { background-color: #3b82f6; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-danger { background-color: #ef4444; }
        .btn-danger:hover:not(:disabled) { background-color: #dc2626; }
        .btn-secondary { background-color: #e5e7eb; color: #4b5563; }
        .btn-secondary:hover:not(:disabled) { background-color: #d1d5db; }
        
        /* ===== Provider Selection Specific ===== */
        .provider-button {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px; padding: 20px; margin-bottom: 16px; color: white;
            font-size: 16px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .provider-button:hover {
            background: rgba(255, 255, 255, 0.2); border-color: var(--app-accent);
            transform: translateY(-2px); box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }
        
        .settings-section {
            margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .intensity-options {
            display: flex; gap: 8px; justify-content: center; margin-bottom: 16px;
        }
        
        .intensity-btn {
            padding: 8px 16px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px;
            background: rgba(255, 255, 255, 0.1); color: white; cursor: pointer; font-size: 12px;
            transition: all 0.2s ease;
        }
        .intensity-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .intensity-btn.active { border-color: var(--app-accent); background: rgba(245, 158, 11, 0.2); color: var(--app-accent); }
        
        .checkbox-label {
            color: rgba(255, 255, 255, 0.9); font-size: 14px; display: flex;
            align-items: center; gap: 8px; cursor: pointer; justify-content: center;
        }
        
        /* ===== Status & Feedback ===== */
        .status {
            padding: 12px; border-radius: 8px; margin-top: 16px; font-size: 14px; font-weight: 500;
        }
        .status.success { background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
        .status.error { background: rgba(239, 68, 68, 0.2); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); }
        .status.info { background: rgba(59, 130, 246, 0.2); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
        
        .toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); color: white; padding: 12px 20px; border-radius: 8px;
            font-size: 14px; font-weight: 500; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; backdrop-filter: blur(10px);
        }
        .toast.show { opacity: 1; }
        .toast.success { background: rgba(16, 185, 129, 0.9); }
        .toast.info { background: rgba(59, 130, 246, 0.9); }
        .toast.error { background: rgba(239, 68, 68, 0.9); }
        
        /* ===== Folder Items ===== */
        .folder-list { flex: 1; overflow-y: auto; margin-bottom: 20px; max-height: 400px; }
        .folder-item {
            display: flex; align-items: center; padding: 12px 16px; margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease; color: white; justify-content: space-between;
        }
        .folder-item:hover {
            background: rgba(255, 255, 255, 0.1); border-color: rgba(245, 158, 11, 0.3); transform: translateY(-1px);
        }
        .folder-icon { width: 20px; height: 20px; margin-right: 12px; color: var(--app-accent); }
        .folder-info { flex: 1; }
        .folder-name { font-weight: 500; margin-bottom: 2px; }
        .folder-date { font-size: 12px; color: rgba(255, 255, 255, 0.6); }
        
        .folder-actions { display: flex; gap: 8px; margin-left: 12px; }
        .folder-action-btn {
            padding: 6px 12px; border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 8px;
            background: rgba(255, 255, 255, 0.1); color: white; font-size: 12px; cursor: pointer;
            transition: all 0.2s ease; backdrop-filter: blur(10px);
        }
        .folder-action-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }
        .folder-action-btn.drill-btn { border-color: rgba(245, 158, 11, 0.4); color: var(--app-accent); }
        .folder-action-btn.drill-btn:hover { background: rgba(245, 158, 11, 0.2); }
        .folder-action-btn.select-btn { border-color: rgba(16, 185, 129, 0.4); color: #10b981; }
        .folder-action-btn.select-btn:hover { background: rgba(16, 185, 129, 0.2); }
        
        /* ===== Loading & Progress ===== */
        .spinner {
            width: 20px; height: 20px; border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%; border-top-color: var(--app-accent); animation: spin 1s linear infinite; margin-right: 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .loading-counter { color: var(--app-accent); font-size: 48px; font-weight: 700; margin: 20px 0; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); }
        .loading-message { color: rgba(255, 255, 255, 0.7); font-size: 16px; margin-bottom: 20px; }
        .loading-progress { width: 100%; height: 6px; background: rgba(255, 255, 255, 0.2); border-radius: 3px; overflow: hidden; margin-bottom: 20px; }
        .loading-progress-bar { height: 100%; background: linear-gradient(45deg, var(--app-accent), #d97706); border-radius: 3px; transition: width 0.3s ease; width: 0%; }
        
        /* ===== Main App Layout ===== */
        .app-container { position: relative; width: 100vw; height: 100vh; background: var(--dark-gradient); overflow: hidden; }
        .nav-button {
            position: absolute; top: 20px; background: var(--glass-bg); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; padding: 8px 12px; font-size: 11px;
            color: white; cursor: pointer; transition: all 0.3s ease; z-index: 15; display: flex; align-items: center; gap: 6px; opacity: 0.7;
        }
        .nav-button:hover { opacity: 1; background: rgba(255, 255, 255, 0.2); }
        .nav-button.back { left: 20px; }
        .nav-button.details { right: 20px; }
        
        /* ===== Folder Tooltip ===== */
        .folder-tooltip {
            position: absolute; background: rgba(0,0,0,0.85); color: white;
            padding: 8px 12px; border-radius: 6px; font-size: 12px;
            z-index: 1000; pointer-events: none; white-space: nowrap;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        /* ===== Image Display ===== */
        .image-viewport { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 1; overflow: hidden; }
        .center-image {
            max-width: 100vw; max-height: 100vh; width: auto; height: auto; object-fit: contain; user-select: none; pointer-events: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.2s ease; transform-origin: center center; cursor: grab;
        }
        .center-image.dragging { filter: brightness(0.9); cursor: grabbing; }
        .center-image.zoomable { pointer-events: auto; }
        
        .filename-overlay {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            z-index: 5;
            max-width: 90%;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto;
            text-decoration: none;
        }
        .filename-overlay:hover {
            background-color: rgba(0, 0, 0, 0.8);
            color: var(--app-accent);
        }
        .filename-overlay.visible { opacity: 1; }

        /* ===== Edge Effects ===== */
        .edge-glow { position: absolute; opacity: 0; transition: opacity 0.2s ease; z-index: 2; }
        .edge-glow.top { top: 0; left: 0; right: 0; height: 8px; background: linear-gradient(180deg, rgba(245, 158, 11, var(--glow-opacity)) 0%, transparent 100%); }
        .edge-glow.bottom { 
            bottom: 0; left: 0; right: 0; height: 8px; 
            background: linear-gradient(0deg, rgba(245, 158, 11, var(--glow-opacity)) 0%, transparent 100%);
            bottom: env(safe-area-inset-bottom, 0px);
        }
        .edge-glow.left { top: 0; left: 0; bottom: 0; width: 8px; background: linear-gradient(90deg, rgba(245, 158, 11, var(--glow-opacity)) 0%, transparent 100%); }
        .edge-glow.right { top: 0; right: 0; bottom: 0; width: 8px; background: linear-gradient(270deg, rgba(245, 158, 11, var(--glow-opacity)) 0%, transparent 100%); }
        .edge-glow.active { opacity: 1; }
        
        /* ===== Pills & Counters ===== */
        .pill-counter {
            position: fixed; backdrop-filter: blur(10px); border-radius: 20px; padding: 12px 20px; font-size: 18px; font-weight: 500;
            color: black; opacity: 0; transition: all 0.3s ease; cursor: pointer; z-index: 10; min-width: 50px; text-align: center;
        }
        .pill-counter.visible { opacity: 0.9; }
        .pill-counter.active { font-weight: 700; background: white; opacity: 1; border: 3px solid black; }
        .pill-counter:not(.active) { background: rgba(128, 128, 128, 0.4); border: none; }
        .pill-counter:hover { opacity: 1; transform: scale(1.05); }
        .pill-counter.top { top: 10px; left: 50%; transform: translateX(-50%); }
        .pill-counter.bottom { bottom: 60px; left: 50%; transform: translateX(-50%); }
        .pill-counter.left { left: 10px; top: 50%; transform: translateY(-50%); }
        .pill-counter.right { right: 10px; top: 50%; transform: translateY(-50%); }
        
        /* ===== Enhanced Ripple Effects ===== */
        .pill-counter::before, .pill-counter::after {
            content: ''; position: absolute; border: 2px solid rgba(245, 158, 11, 0.8); border-radius: 16px; opacity: 0; pointer-events: none; z-index: -1;
        }
        .pill-counter.triple-ripple::before { animation: tripleRipple1 var(--ripple-duration) ease-out; }
        .pill-counter.triple-ripple::after { animation: tripleRipple2 var(--ripple-duration) ease-out 0.2s; }
        .pill-counter.triple-ripple { animation: tripleRipple3 var(--ripple-duration) ease-out 0.4s; }
        .pill-counter.glow-effect { 
            box-shadow: 0 0 25px rgba(245, 158, 11, var(--glow-opacity)), 0 0 50px rgba(245, 158, 11, calc(var(--glow-opacity) * 0.6)); 
            animation: sustainedGlow 1s ease-out calc(var(--ripple-duration) * 1); 
        }
        
        /* High intensity mode */
        .high-intensity-mode .pill-counter.glow-effect {
            box-shadow: 0 0 35px rgba(245, 158, 11, 1), 0 0 70px rgba(245, 158, 11, 0.8), 0 0 100px rgba(245, 158, 11, 0.6);
        }
        
        @keyframes tripleRipple1 {
            0% { opacity: 0.9; transform: scale(1); top: -4px; left: -4px; right: -4px; bottom: -4px; }
            100% { opacity: 0; transform: scale(2); top: -20px; left: -20px; right: -20px; bottom: -20px; }
        }
        @keyframes tripleRipple2 {
            0% { opacity: 0.7; transform: scale(1); top: -6px; left: -6px; right: -6px; bottom: -6px; }
            100% { opacity: 0; transform: scale(2.5); top: -30px; left: -30px; right: -30px; bottom: -30px; }
        }
        @keyframes tripleRipple3 {
            0% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
            100% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.6); }
        }
        @keyframes sustainedGlow {
            0% { box-shadow: 0 0 25px rgba(245, 158, 11, var(--glow-opacity)), 0 0 50px rgba(245, 158, 11, calc(var(--glow-opacity) * 0.6)); }
            50% { box-shadow: 0 0 35px rgba(245, 158, 11, 1), 0 0 70px rgba(245, 158, 11, 0.8); }
            100% { box-shadow: 0 0 10px rgba(245, 158, 11, 0.4); }
        }
        
        /* ===== Empty State ===== */
        .empty-state {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;
            color: rgba(255, 255, 255, 0.7); font-size: 18px; font-weight: 300; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8); z-index: 5;
        }
        .empty-message { margin-bottom: 20px; font-size: 24px; font-weight: 400; }
        .new-images-button {
            background: rgba(245, 158, 11, 0.2); border: 1px solid rgba(245, 158, 11, 0.4); border-radius: 20px;
            padding: 12px 24px; color: white; font-size: 16px; cursor: pointer; transition: all 0.2s ease;
        }
        .new-images-button:hover { background: rgba(245, 158, 11, 0.4); transform: translateY(-2px); }
        
        /* ===== Modal System ===== */
        .modal { position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal.hidden { display: none !important; }
        .modal-content {
            background: white; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 100%; height: 100%; max-width: 1152px; max-height: 90vh; margin: 16px; display: flex; flex-direction: column;
        }
        .action-modal { max-width: 448px; padding: 24px; }
        
        /* ===== Enhanced Grid System ===== */
        .modal-header { position: sticky; top: 0; background: white; z-index: 10; border-bottom: 1px solid #e5e7eb; }
        .modal-header-main { padding: 12px 16px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; }
        .modal-header-left { display: flex; align-items: center; gap: 12px; }
        .modal-title { font-size: 20px; font-weight: 500; color: #1f2937; line-height: 1.5; }
        .select-all-btn {
            background-color: #e5e7eb; color: #4b5563; padding: 2px 8px; border-radius: 9999px; font-size: 14px; font-weight: 500;
            display: inline-block; min-width: 36px; text-align: center; cursor: pointer; transition: background-color 0.2s;
        }
        .select-all-btn:hover { background-color: #d1d5db; }
        .close-btn {
            color: #6b7280; transition: all 0.2s; cursor: pointer; background: transparent; border: none; border-radius: 6px;
            padding: 4px; display: flex; align-items: center; justify-content: center;
        }
        .close-btn:hover { color: #374151; background: rgba(0, 0, 0, 0.05); }
        .close-btn svg { width: 24px; height: 24px; }
        
        .grid-row-2 {
            padding: 8px 16px; border-bottom: 1px solid #e5e7eb; display: flex;
            align-items: center; justify-content: space-between;
        }
        .selection-count {
            background-color: #dbeafe; color: #1e40af; padding: 4px 12px; border-radius: 9999px; font-size: 14px;
            display: flex; align-items: center; gap: 8px;
        }
        .deselect-all-btn {
            margin-left: 4px; transition: all 0.2s; cursor: pointer; background: transparent; border: none; border-radius: 4px;
            padding: 2px; display: flex; align-items: center; justify-content: center;
        }
        .deselect-all-btn:hover { color: #1e3a8a; background: rgba(0, 0, 0, 0.05); }
        .deselect-all-btn svg { width: 16px; height: 16px; }
        
        .zoom-control { display: flex; align-items: center; gap: 8px; }
        #grid-size { width: 80px; }
        #grid-size-value { font-size: 14px; color: #4b5563; min-width: 20px; }
        
        .grid-row-3 {
            padding: 8px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        #omni-search {
            flex-grow: 1; padding: 6px 30px 6px 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px;
        }
        #clear-search-btn {
            position: absolute;
            right: 24px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            cursor: pointer;
            display: none; /* Hidden by default */
        }
        #clear-search-btn:hover { color: #6b7280; }
        
        .grid-row-4 {
            padding: 8px 16px;
            border-bottom: 1px solid #e5e7eb;
            min-height: 41px;
            display: flex;
            justify-content: flex-start;
        }
        .bulk-actions { display: flex; align-items: center; gap: 8px; }
        .bulk-actions .btn { padding: 4px 10px; font-size: 13px; }
        
        .grid-content { flex: 1; overflow-y: auto; padding: 16px; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 16px; }
        
        .grid-item {
            position: relative;
            background-color: #f3f4f6;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .grid-item::before {
            content: "";
            display: block;
            padding-top: 100%;
        }
        .grid-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .grid-image[data-src] { /* Style for lazy loading */
            opacity: 0;
        }
        .grid-image.loaded {
            opacity: 1;
        }
        .grid-item.selected { box-shadow: 0 0 0 4px #3b82f6; }
        
        /* ===== Details Modal ===== */
        .details-modal-content { max-width: 800px; max-height: 95vh; height: 95vh; display: flex; flex-direction: column; }
        .details-header { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; }
        .details-title { font-size: 18px; font-weight: 500; color: #1f2937; }
        .tab-nav { display: flex; border-bottom: 1px solid #e5e7eb; background: #f8fafc; flex-shrink: 0; }
        .tab-button {
            flex: 1; padding: 16px; border: none; background: transparent; color: #6b7280; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.2s; border-bottom: 2px solid transparent;
        }
        .tab-button:hover { color: #374151; background: rgba(0, 0, 0, 0.02); }
        .tab-button.active { color: #3b82f6; border-bottom-color: #3b82f6; background: white; }
        .details-content { flex: 1; overflow-y: auto; overflow-x: hidden; min-height: 0; }
        .tab-content { display: none; padding: 20px; height: 100%; }
        .tab-content.active { display: block; }
        
        /* ===== Tags & Ratings ===== */
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; min-height: 40px; }
        .tag-item { display: inline-flex; align-items: center; background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 12px; gap: 6px; }
        .tag-remove {
            background: transparent; border: none; color: #1e40af; cursor: pointer; font-size: 14px; line-height: 1; padding: 0;
            width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s;
        }
        .tag-remove:hover { background: rgba(59, 130, 246, 0.1); }
        .add-tag-btn {
            background: #f3f4f6; border: 1px dashed #d1d5db; border-radius: 12px; padding: 4px 12px;
            font-size: 12px; color: #6b7280; cursor: pointer; transition: all 0.2s;
        }
        .add-tag-btn:hover { background: #e5e7eb; color: #374151; }
        
        .star-rating { display: flex; gap: 4px; }
        .star { width: 24px; height: 24px; cursor: pointer; color: #d1d5db; transition: color 0.2s; }
        .star:hover, .star.active { color: #fbbf24; }
        
        /* ===== Metadata Table ===== */
        .metadata-table { width: 100%; border-collapse: collapse; border: 1px solid #e5e7eb; font-size: 13px; }
        .metadata-table td { padding: 8px 12px; border-bottom: 1px solid #e5e7eb; vertical-align: top; word-wrap: break-word; }
        .metadata-table .key-cell {
            font-weight: 500; color: #374151; width: 25%; border-right: 1px solid #e5e7eb; background: #f9fafb; min-width: 120px;
        }
        .metadata-table .value-cell { color: #6b7280; white-space: pre-wrap; position: relative; max-width: 0; word-break: break-all; }
        .copy-button {
            background: #f59e0b; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; color: white;
            cursor: pointer; transition: all 0.2s; margin-left: 8px; vertical-align: top; font-weight: 500;
        }
        .copy-button:hover { background: #d97706; transform: translateY(-1px); box-shadow: 0 2px 4px rgba(245, 158, 11, 0.3); }
        .copy-button:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(245, 158, 11, 0.3); }
        .copy-button.copied { background: #10b981; transform: scale(1.1); }
        
        /* ===== Footer ===== */
        .app-footer {
            position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0, 0, 0, 0.8);
            color: rgba(255, 255, 255, 0.6); text-align: center; padding: 4px 8px;
            font-size: 10px; z-index: 5; backdrop-filter: blur(10px);
        }
        
        /* ===== Focus Mode & Counters ===== */
        .focus-mode-ui, #normal-image-count {
            position: absolute;
            background: rgba(0, 0, 0, 0.4);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            z-index: 20;
            display: none; /* Hidden by default */
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
            font-size: 11px;
            padding: 8px 12px;
            cursor: pointer;
        }
        .focus-mode-ui:hover, #normal-image-count:hover {
            background: rgba(0, 0, 0, 0.6);
            border-color: white;
        }
        #focus-stack-name { top: 20px; left: 20px; }
        #focus-image-count { bottom: 20px; left: 20px; }
        #normal-image-count { bottom: 20px; left: 20px; display: flex; } /* NEW: Visible by default */
        #focus-delete-btn { bottom: 20px; right: 20px; width: 44px; height: 44px; padding: 0; border-radius: 50%; }
        
        .app-container.focus-mode .pill-counter,
        .app-container.focus-mode .nav-button.back,
        .app-container.focus-mode .filename-overlay,
        .app-container.focus-mode #normal-image-count { /* Hide normal counter in focus mode */
            display: none;
        }
        .app-container.focus-mode .focus-mode-ui {
            display: flex;
        }
        .app-container.focus-mode .nav-button.details {
            background: rgba(0, 0, 0, 0.4);
        }
        
        /* ===== Responsive ===== */
        .hidden { display: none !important; }
        
        @media screen and (min-width: 768px) {
            .pill-counter { font-size: 16px; padding: 8px 16px; min-width: 40px; }
            .nav-button { font-size: 14px; padding: 10px 16px; }
            .focus-mode-ui, #normal-image-count { font-size: 14px; padding: 10px 16px; }
        }
        
        @media screen and (max-width: 767px) {
            .nav-button { font-size: 16px; padding: 12px 20px; border-radius: 25px; min-width: 80px; }
            .pill-counter.bottom { bottom: 80px; }
            .filename-overlay { font-size: 11px; padding: 5px 12px; bottom: 35px; }
            .details-modal-content { max-width: 100vw; max-height: 100vh; height: 100vh; margin: 0; border-radius: 0; }
            .metadata-table .key-cell { width: 30%; min-width: 80px; font-size: 12px; }
            .metadata-table .value-cell { font-size: 12px; }
            .copy-button { font-size: 10px; padding: 3px 6px; }
            
            .app-container { height: 100vh; height: 100dvh; }
            .image-viewport { height: 100vh; height: 100dvh; }
        }
        
        @supports (height: 100dvh) {
            .app-container { height: 100dvh; }
            .image-viewport { height: 100dvh; }
        }
    </style>
</head>
<body>
    <!-- Provider Selection Screen -->
    <div class="screen" id="provider-screen">
        <div class="card">
            <h1 class="title" style="font-size: 32px;">Orbital8</h1>
            <p class="subtitle">Select your cloud storage provider</p>
            
            <button class="provider-button" id="google-drive-btn">
                <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M6.28 7L9.69 1h4.62l3.41 6zM16.05 7H7.95l4.05 7zM11.76 15h8.58L24 21H7.05z"/>
                </svg>
                Google Drive
            </button>
            
            <button class="provider-button" id="onedrive-btn">
                <svg style="width: 20px; height: 20px;" viewBox="0 0 24 24">
                    <path fill="currentColor" d="M17.75 8C16.82 8 16 8.82 16 9.75S16.82 11.5 17.75 11.5s1.75-.82 1.75-1.75S18.68 8 17.75 8z"/>
                </svg>
                OneDrive
            </button>
            
            <div class="settings-section">
                <div style="margin-bottom: 16px;">
                    <label style="color: rgba(255,255,255,0.9); font-size: 14px; font-weight: 500; display: block; margin-bottom: 8px;">Visual Cue Intensity:</label>
                    <div class="intensity-options">
                        <button class="intensity-btn" data-intensity="low">Low</button>
                        <button class="intensity-btn active" data-intensity="medium">Medium</button>
                        <button class="intensity-btn" data-intensity="high">High</button>
                    </div>
                </div>
                
                <label class="checkbox-label">
                    <input type="checkbox" id="filename-overlay-toggle" checked>
                    Show filename overlay
                </label>
            </div>
            
            <div id="auth-status" class="status hidden"></div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div class="screen hidden" id="loading-screen">
        <div class="card">
            <div class="loading-counter" id="loading-counter">0</div>
            <div class="loading-message" id="loading-message">Initializing...</div>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loading-progress-bar"></div>
            </div>
            <div class="spinner"></div>
        </div>
    </div>

    <!-- Folder Selection Screen -->
    <div class="screen hidden" id="folder-screen">
        <div class="card">
            <h1 class="title">Select Folder</h1>
            <p class="subtitle">Choose a folder containing images</p>
            
            <div class="folder-list" id="folder-list">
                <!-- Folders will be populated here -->
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button class="folder-button" id="back-to-provider">Back</button>
                <button class="folder-button danger" id="refresh-folders">Refresh</button>
            </div>
            
            <div id="folder-status" class="status hidden"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container hidden" id="app-container">
        <!-- Navigation -->
        <button class="nav-button back" id="back-button">
            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
            Back
        </button>
        
        <button class="nav-button details" id="details-button">
            <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                <path fill="currentColor" d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/>
            </svg>
            Details
        </button>

        <!-- Edge Glow Effects -->
        <div class="edge-glow top"></div>
        <div class="edge-glow bottom"></div>
        <div class="edge-glow left"></div>
        <div class="edge-glow right"></div>

        <!-- Image Display -->
        <div class="image-viewport" id="image-viewport">
            <img class="center-image" id="center-image" alt="Current image">
        </div>

        <!-- Filename Overlay -->
        <a class="filename-overlay" id="filename-overlay" href="#" target="_blank"></a>

        <!-- Pill Counters -->
        <div class="pill-counter top" id="top-counter">1</div>
        <div class="pill-counter bottom" id="bottom-counter">1</div>
        <div class="pill-counter left" id="left-counter">1</div>
        <div class="pill-counter right" id="right-counter">1</div>

        <!-- Empty State -->
        <div class="empty-state hidden" id="empty-state">
            <div class="empty-message">No images found in this folder</div>
            <button class="new-images-button" id="refresh-images">Refresh Images</button>
        </div>

        <!-- Focus Mode UI -->
        <div class="focus-mode-ui" id="focus-stack-name">Stack Name</div>
        <div class="focus-mode-ui" id="focus-image-count">0 images</div>
        <div class="focus-mode-ui" id="focus-delete-btn">üóëÔ∏è</div>
        
        <!-- Normal Mode Image Count -->
        <div id="normal-image-count">0 images</div>
    </div>

    <!-- Footer -->
    <div class="app-footer">
        Orbital8 V22-Aug-903 - Unified Metadata Performance
    </div>

    <!-- Grid Modal -->
    <div class="modal hidden" id="grid-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-main">
                    <div class="modal-header-left">
                        <h2 class="modal-title">Image Grid</h2>
                        <span class="select-all-btn" id="select-all-btn">All</span>
                    </div>
                    <button class="close-btn" id="close-grid-modal">
                        <svg viewBox="0 0 24 24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="grid-row-2">
                    <div class="selection-count hidden" id="selection-count">
                        <span id="selected-count">0</span> selected
                        <button class="deselect-all-btn" id="deselect-all-btn">
                            <svg viewBox="0 0 24 24">
                                <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="zoom-control">
                        <label for="grid-size">Size:</label>
                        <input type="range" id="grid-size" min="100" max="300" value="150" step="25">
                        <span id="grid-size-value">150</span>
                    </div>
                </div>
                
                <div class="grid-row-3">
                    <input type="text" id="omni-search" placeholder="Search by filename, tags, rating, or metadata...">
                    <button id="clear-search-btn">
                        <svg style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                    </button>
                </div>
                
                <div class="grid-row-4">
                    <div class="bulk-actions hidden" id="bulk-actions">
                        <button class="btn btn-primary" id="bulk-tag-btn">Tag</button>
                        <button class="btn btn-primary" id="bulk-rate-btn">Rate</button>
                        <button class="btn btn-danger" id="bulk-delete-btn">Delete</button>
                    </div>
                </div>
            </div>
            
            <div class="grid-content">
                <div class="grid-container" id="grid-container">
                    <!-- Grid items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div class="modal hidden" id="action-modal">
        <div class="modal-content action-modal">
            <h2 id="action-modal-title">Action</h2>
            <div id="action-modal-content">
                <!-- Content will be populated dynamically -->
            </div>
            <div style="display: flex; gap: 12px; margin-top: 20px;">
                <button class="btn btn-secondary" id="cancel-action">Cancel</button>
                <button class="btn btn-primary" id="confirm-action">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div class="modal hidden" id="details-modal">
        <div class="modal-content details-modal-content">
            <div class="details-header">
                <h2 class="details-title" id="details-title">Image Details</h2>
                <button class="close-btn" id="close-details-modal">
                    <svg viewBox="0 0 24 24">
                        <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                    </svg>
                </button>
            </div>
            
            <div class="tab-nav">
                <button class="tab-button active" data-tab="tags">Tags & Rating</button>
                <button class="tab-button" data-tab="metadata">Metadata</button>
            </div>
            
            <div class="details-content">
                <div class="tab-content active" id="tags-tab">
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 12px; color: #374151; font-size: 16px;">Tags</h3>
                        <div class="tags-container" id="current-tags">
                            <!-- Tags will be populated here -->
                        </div>
                        <input type="text" class="tag-input" id="new-tag-input" placeholder="Add a tag...">
                    </div>
                    
                    <div style="margin-bottom: 24px;">
                        <h3 style="margin-bottom: 12px; color: #374151; font-size: 16px;">Rating</h3>
                        <div class="star-rating" id="star-rating">
                            <svg class="star" data-rating="1" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                            <svg class="star" data-rating="2" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                            <svg class="star" data-rating="3" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                            <svg class="star" data-rating="4" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                            <svg class="star" data-rating="5" viewBox="0 0 24 24">
                                <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                            </svg>
                        </div>
                    </div>
                    
                    <div>
                        <h3 style="margin-bottom: 12px; color: #374151; font-size: 16px;">Notes</h3>
                        <textarea class="notes-textarea" id="notes-textarea" placeholder="Add notes about this image..."></textarea>
                        <button class="btn btn-primary" id="save-metadata">Save Changes</button>
                    </div>
                </div>
                
                <div class="tab-content" id="metadata-tab">
                    <table class="metadata-table" id="metadata-table">
                        <!-- Metadata will be populated here -->
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // ===== ORBITAL8 V22-Aug-903 - Complete Rollback with OneDrive Fix =====
        
        // Global state
        let currentProvider = null;
        let currentFolder = null;
        let images = [];
        let currentIndex = 0;
        let selectedImages = new Set();
        let isLoading = false;
        let visualIntensity = 'medium';
        let showFilenameOverlay = true;
        let focusMode = false;
        let focusStack = null;
        let focusImages = [];
        let focusIndex = 0;
        
        // Provider configurations
        const providers = {
            googleDrive: {
                name: 'Google Drive',
                clientId: '1234567890-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com',
                apiKey: 'AIzaSyABCDEFGHIJKLMNOPQRSTUVWXYZ1234567',
                scope: 'https://www.googleapis.com/auth/drive',
                discoveryDoc: 'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'
            },
            oneDrive: {
                name: 'OneDrive',
                clientId: 'abcd1234-5678-90ef-ghij-klmnopqrstuv',
                authority: 'https://login.microsoftonline.com/common',
                redirectUri: window.location.origin,
                scopes: ['https://graph.microsoft.com/Files.ReadWrite']
            }
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        function initializeApp() {
            setupEventListeners();
            setupIntensityControls();
            setupFilenameOverlayToggle();
            
            // Check for existing auth
            const savedProvider = localStorage.getItem('orbital8_provider');
            if (savedProvider && providers[savedProvider]) {
                currentProvider = savedProvider;
                initializeProvider(savedProvider);
            }
        }
        
        function setupEventListeners() {
            // Provider selection
            document.getElementById('google-drive-btn').addEventListener('click', () => selectProvider('googleDrive'));
            document.getElementById('onedrive-btn').addEventListener('click', () => selectProvider('oneDrive'));
            
            // Navigation
            document.getElementById('back-button').addEventListener('click', goBack);
            document.getElementById('details-button').addEventListener('click', showDetailsModal);
            document.getElementById('back-to-provider').addEventListener('click', () => showScreen('provider-screen'));
            document.getElementById('refresh-folders').addEventListener('click', loadFolders);
            document.getElementById('refresh-images').addEventListener('click', loadImages);
            
            // Keyboard navigation
            document.addEventListener('keydown', handleKeyPress);
            
            // Touch/mouse events for image navigation
            setupImageNavigation();
            
            // Modal events
            setupModalEvents();
            
            // Grid events
            setupGridEvents();
            
            // Details modal events
            setupDetailsModalEvents();
        }
        
        function setupIntensityControls() {
            const intensityBtns = document.querySelectorAll('.intensity-btn');
            intensityBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    intensityBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    visualIntensity = btn.dataset.intensity;
                    localStorage.setItem('orbital8_intensity', visualIntensity);
                    updateIntensityMode();
                });
            });
            
            // Load saved intensity
            const savedIntensity = localStorage.getItem('orbital8_intensity');
            if (savedIntensity) {
                visualIntensity = savedIntensity;
                document.querySelector(`[data-intensity="${savedIntensity}"]`).classList.add('active');
                intensityBtns.forEach(b => {
                    if (b.dataset.intensity !== savedIntensity) {
                        b.classList.remove('active');
                    }
                });
                updateIntensityMode();
            }
        }
        
        function setupFilenameOverlayToggle() {
            const toggle = document.getElementById('filename-overlay-toggle');
            toggle.addEventListener('change', () => {
                showFilenameOverlay = toggle.checked;
                localStorage.setItem('orbital8_filename_overlay', showFilenameOverlay);
                updateFilenameOverlay();
            });
            
            // Load saved setting
            const savedSetting = localStorage.getItem('orbital8_filename_overlay');
            if (savedSetting !== null) {
                showFilenameOverlay = savedSetting === 'true';
                toggle.checked = showFilenameOverlay;
                updateFilenameOverlay();
            }
        }
        
        function updateIntensityMode() {
            const container = document.getElementById('app-container');
            container.classList.remove('low-intensity-mode', 'medium-intensity-mode', 'high-intensity-mode');
            container.classList.add(`${visualIntensity}-intensity-mode`);
            
            // Update CSS custom properties
            const root = document.documentElement;
            switch (visualIntensity) {
                case 'low':
                    root.style.setProperty('--glow-opacity', '0.3');
                    root.style.setProperty('--ripple-duration', '1000ms');
                    break;
                case 'medium':
                    root.style.setProperty('--glow-opacity', '0.6');
                    root.style.setProperty('--ripple-duration', '1500ms');
                    break;
                case 'high':
                    root.style.setProperty('--glow-opacity', '1.0');
                    root.style.setProperty('--ripple-duration', '2000ms');
                    break;
            }
        }
        
        function updateFilenameOverlay() {
            const overlay = document.getElementById('filename-overlay');
            if (showFilenameOverlay && images.length > 0) {
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }
        
        async function selectProvider(providerKey) {
            currentProvider = providerKey;
            localStorage.setItem('orbital8_provider', providerKey);
            
            showStatus('auth-status', 'info', 'Connecting to ' + providers[providerKey].name + '...');
            
            try {
                await initializeProvider(providerKey);
                await authenticateProvider(providerKey);
                showStatus('auth-status', 'success', 'Connected successfully!');
                setTimeout(() => loadFolders(), 1000);
            } catch (error) {
                console.error('Provider selection failed:', error);
                showStatus('auth-status', 'error', 'Connection failed: ' + error.message);
            }
        }
        
        async function initializeProvider(providerKey) {
            if (providerKey === 'googleDrive') {
                await initializeGoogleDrive();
            } else if (providerKey === 'oneDrive') {
                await initializeOneDrive();
            }
        }
        
        async function initializeGoogleDrive() {
            return new Promise((resolve, reject) => {
                gapi.load('auth2:client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: providers.googleDrive.apiKey,
                            clientId: providers.googleDrive.clientId,
                            discoveryDocs: [providers.googleDrive.discoveryDoc],
                            scope: providers.googleDrive.scope
                        });
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }
        
        async function initializeOneDrive() {
            const msalConfig = {
                auth: {
                    clientId: providers.oneDrive.clientId,
                    authority: providers.oneDrive.authority,
                    redirectUri: providers.oneDrive.redirectUri
                },
                cache: {
                    cacheLocation: 'localStorage',
                    storeAuthStateInCookie: false
                }
            };
            
            window.msalInstance = new msal.PublicClientApplication(msalConfig);
            await window.msalInstance.initialize();
        }
        
        async function authenticateProvider(providerKey) {
            if (providerKey === 'googleDrive') {
                return await authenticateGoogleDrive();
            } else if (providerKey === 'oneDrive') {
                return await authenticateOneDrive();
            }
        }
        
        async function authenticateGoogleDrive() {
            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance.isSignedIn.get()) {
                await authInstance.signIn();
            }
            return authInstance.currentUser.get().getAuthResponse().access_token;
        }
        
        async function authenticateOneDrive() {
            const accounts = window.msalInstance.getAllAccounts();
            let account = accounts.length > 0 ? accounts[0] : null;
            
            if (!account) {
                const loginResponse = await window.msalInstance.loginPopup({
                    scopes: providers.oneDrive.scopes
                });
                account = loginResponse.account;
            }
            
            const tokenResponse = await window.msalInstance.acquireTokenSilent({
                scopes: providers.oneDrive.scopes,
                account: account
            });
            
            return tokenResponse.accessToken;
        }
        
        async function loadFolders() {
            showScreen('loading-screen');
            updateLoadingProgress(0, 'Loading folders...');
            
            try {
                let folders;
                if (currentProvider === 'googleDrive') {
                    folders = await getGoogleDriveFolders();
                } else if (currentProvider === 'oneDrive') {
                    folders = await getOneDriveFolders();
                }
                
                updateLoadingProgress(100, 'Folders loaded!');
                displayFolders(folders);
                setTimeout(() => showScreen('folder-screen'), 500);
            } catch (error) {
                console.error('Failed to load folders:', error);
                showStatus('folder-status', 'error', 'Failed to load folders: ' + error.message);
                showScreen('folder-screen');
            }
        }
        
        async function getGoogleDriveFolders() {
            const response = await gapi.client.drive.files.list({
                q: "mimeType='application/vnd.google-apps.folder' and trashed=false",
                fields: 'files(id,name,modifiedTime)',
                orderBy: 'modifiedTime desc',
                pageSize: 100
            });
            
            return response.result.files.map(folder => ({
                id: folder.id,
                name: folder.name,
                modifiedTime: folder.modifiedTime
            }));
        }
        
        async function getOneDriveFolders() {
            const token = await authenticateOneDrive();
            const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children?$filter=folder ne null&$select=id,name,lastModifiedDateTime&$orderby=lastModifiedDateTime desc', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.value.map(folder => ({
                id: folder.id,
                name: folder.name,
                modifiedTime: folder.lastModifiedDateTime
            }));
        }
        
        function displayFolders(folders) {
            const folderList = document.getElementById('folder-list');
            folderList.innerHTML = '';
            
            folders.forEach(folder => {
                const folderItem = document.createElement('div');
                folderItem.className = 'folder-item';
                folderItem.innerHTML = `
                    <svg class="folder-icon" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M10 4H4c-1.11 0-2 .89-2 2v12c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2h-8l-2-2z"/>
                    </svg>
                    <div class="folder-info">
                        <div class="folder-name">${folder.name}</div>
                        <div class="folder-date">${new Date(folder.modifiedTime).toLocaleDateString()}</div>
                    </div>
                    <div class="folder-actions">
                        <button class="folder-action-btn select-btn" onclick="selectFolder('${folder.id}', '${folder.name}')">Select</button>
                    </div>
                `;
                folderList.appendChild(folderItem);
            });
        }
        
        async function selectFolder(folderId, folderName) {
            currentFolder = { id: folderId, name: folderName };
            localStorage.setItem('orbital8_folder', JSON.stringify(currentFolder));
            await loadImages();
        }
        
        async function loadImages() {
            if (!currentFolder) return;
            
            showScreen('loading-screen');
            updateLoadingProgress(0, 'Loading images...');
            
            try {
                let imageFiles;
                if (currentProvider === 'googleDrive') {
                    imageFiles = await getGoogleDriveImages(currentFolder.id);
                } else if (currentProvider === 'oneDrive') {
                    imageFiles = await getOneDriveImages(currentFolder.id);
                }
                
                updateLoadingProgress(50, 'Processing images...');
                
                // Process images with metadata
                images = [];
                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const imageData = await processFileWithProviderMetadata(file);
                    images.push(imageData);
                    
                    updateLoadingProgress(50 + (i / imageFiles.length) * 50, `Processing ${i + 1}/${imageFiles.length} images...`);
                }
                
                updateLoadingProgress(100, `Loaded ${images.length} images!`);
                
                if (images.length > 0) {
                    currentIndex = 0;
                    setTimeout(() => {
                        showScreen('app-container');
                        displayCurrentImage();
                        updateCounters();
                        updateImageCount();
                    }, 500);
                } else {
                    showScreen('app-container');
                    showEmptyState();
                }
            } catch (error) {
                console.error('Failed to load images:', error);
                showToast('Failed to load images: ' + error.message, 'error');
                showScreen('app-container');
                showEmptyState();
            }
        }
        
        async function getGoogleDriveImages(folderId) {
            const response = await gapi.client.drive.files.list({
                q: `'${folderId}' in parents and (mimeType contains 'image/') and trashed=false`,
                fields: 'files(id,name,mimeType,size,modifiedTime,webViewLink,webContentLink)',
                orderBy: 'name',
                pageSize: 1000
            });
            
            return response.result.files;
        }
        
        async function getOneDriveImages(folderId) {
            const token = await authenticateOneDrive();
            const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${folderId}/children?$filter=file ne null and startswith(file/mimeType,'image/')&$select=id,name,size,lastModifiedDateTime,webUrl,@microsoft.graph.downloadUrl`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            return data.value;
        }
        
        // ===== RESTORED GOOGLE DRIVE METADATA FUNCTIONS =====
        async function processFileWithProviderMetadata(file) {
            let metadata = {};
            
            try {
                if (currentProvider === 'googleDrive') {
                    metadata = await getAppProperties(file.id);
                } else if (currentProvider === 'oneDrive') {
                    metadata = await getOneDriveFileMetadata(file.id);
                }
            } catch (error) {
                console.error('Failed to load metadata for file:', file.name, error);
            }
            
            return {
                id: file.id,
                name: file.name,
                size: file.size,
                modifiedTime: file.modifiedTime || file.lastModifiedDateTime,
                webViewLink: file.webViewLink || file.webUrl,
                downloadUrl: file.webContentLink || file['@microsoft.graph.downloadUrl'],
                mimeType: file.mimeType || file.file?.mimeType,
                tags: metadata.tags || [],
                rating: parseInt(metadata.rating) || 0,
                notes: metadata.notes || '',
                stackOrder: parseInt(metadata.stackOrder) || 0,
                stackName: metadata.stackName || ''
            };
        }
        
        // RESTORED: Original Google Drive appProperties functions
        async function getAppProperties(fileId) {
            try {
                const response = await gapi.client.drive.files.get({
                    fileId: fileId,
                    fields: 'appProperties'
                });
                
                return response.result.appProperties || {};
            } catch (error) {
                console.error('Failed to get app properties:', error);
                return {};
            }
        }
        
        async function updateAppProperties(fileId, properties) {
            try {
                const response = await gapi.client.drive.files.update({
                    fileId: fileId,
                    resource: {
                        appProperties: properties
                    }
                });
                
                return response.result;
            } catch (error) {
                console.error('Failed to update app properties:', error);
                throw error;
            }
        }
        
        // NEW: OneDrive openExtension functions
        async function getOneDriveFileMetadata(fileId) {
            try {
                const token = await authenticateOneDrive();
                const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/extensions/orbital8metadata`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data || {};
                } else if (response.status === 404) {
                    return {}; // Extension doesn't exist yet
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error('Failed to get OneDrive metadata:', error);
                return {};
            }
        }
        
        async function updateOneDriveFileMetadata(fileId, metadata) {
            try {
                const token = await authenticateOneDrive();
                
                // Try PATCH first (update existing extension)
                let response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/extensions/orbital8metadata`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });
                
                if (response.status === 404) {
                    // Extension doesn't exist, create it
                    response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${fileId}/extensions`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            '@odata.type': 'microsoft.graph.openTypeExtension',
                            extensionName: 'orbital8metadata',
                            ...metadata
                        })
                    });
                }
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Failed to update OneDrive metadata:', error);
                throw error;
            }
        }
        
        // UNIFIED: Update user metadata function
        async function updateUserMetadata(fileId, metadata) {
            try {
                if (currentProvider === 'googleDrive') {
                    await updateAppProperties(fileId, metadata);
                } else if (currentProvider === 'oneDrive') {
                    await updateOneDriveFileMetadata(fileId, metadata);
                }
                
                // Update local image data
                const image = images.find(img => img.id === fileId);
                if (image) {
                    Object.assign(image, metadata);
                }
                
                showToast('Metadata updated successfully', 'success');
            } catch (error) {
                console.error('Failed to update metadata:', error);
                showToast('Failed to update metadata: ' + error.message, 'error');
                throw error;
            }
        }
        
        // RESTORED: Stack order saving function
        async function saveStackOrder() {
            if (!focusStack || focusImages.length === 0) return;
            
            try {
                const updates = focusImages.map((image, index) => ({
                    fileId: image.id,
                    stackOrder: index,
                    stackName: focusStack
                }));
                
                for (const update of updates) {
                    await updateUserMetadata(update.fileId, {
                        stackOrder: update.stackOrder.toString(),
                        stackName: update.stackName
                    });
                }
                
                showToast('Stack order saved successfully', 'success');
            } catch (error) {
                console.error('Failed to save stack order:', error);
                showToast('Failed to save stack order: ' + error.message, 'error');
            }
        }
        
        function displayCurrentImage() {
            if (images.length === 0) {
                showEmptyState();
                return;
            }
            
            const image = focusMode ? focusImages[focusIndex] : images[currentIndex];
            if (!image) return;
            
            const centerImage = document.getElementById('center-image');
            const filenameOverlay = document.getElementById('filename-overlay');
            
            // Update image
            centerImage.src = image.downloadUrl;
            centerImage.alt = image.name;
            
            // Update filename overlay
            filenameOverlay.textContent = image.name;
            filenameOverlay.href = image.webViewLink;
            
            if (showFilenameOverlay) {
                filenameOverlay.classList.add('visible');
            } else {
                filenameOverlay.classList.remove('visible');
            }
            
            // Hide empty state
            document.getElementById('empty-state').classList.add('hidden');
        }
        
        function showEmptyState() {
            document.getElementById('empty-state').classList.remove('hidden');
            document.getElementById('center-image').src = '';
            document.getElementById('filename-overlay').classList.remove('visible');
            updateCounters();
        }
        
        function updateCounters() {
            const totalImages = focusMode ? focusImages.length : images.length;
            const currentIdx = focusMode ? focusIndex : currentIndex;
            const displayIndex = totalImages > 0 ? currentIdx + 1 : 0;
            
            // Update pill counters
            document.getElementById('top-counter').textContent = displayIndex;
            document.getElementById('bottom-counter').textContent = totalImages;
            document.getElementById('left-counter').textContent = displayIndex;
            document.getElementById('right-counter').textContent = totalImages;
            
            // Show/hide counters based on image availability
            const counters = document.querySelectorAll('.pill-counter');
            counters.forEach(counter => {
                if (totalImages > 0) {
                    counter.classList.add('visible');
                    if (counter.id === 'top-counter' || counter.id === 'left-counter') {
                        counter.classList.add('active');
                    } else {
                        counter.classList.remove('active');
                    }
                } else {
                    counter.classList.remove('visible', 'active');
                }
            });
        }
        
        function updateImageCount() {
            const totalImages = focusMode ? focusImages.length : images.length;
            const normalCounter = document.getElementById('normal-image-count');
            const focusCounter = document.getElementById('focus-image-count');
            
            if (focusMode) {
                focusCounter.textContent = `${totalImages} images`;
            } else {
                normalCounter.textContent = `${totalImages} images`;
            }
        }
        
        function navigateImage(direction) {
            if (focusMode) {
                if (direction === 'next' && focusIndex < focusImages.length - 1) {
                    focusIndex++;
                } else if (direction === 'prev' && focusIndex > 0) {
                    focusIndex--;
                }
            } else {
                if (direction === 'next' && currentIndex < images.length - 1) {
                    currentIndex++;
                } else if (direction === 'prev' && currentIndex > 0) {
                    currentIndex--;
                }
            }
            
            displayCurrentImage();
            updateCounters();
            triggerVisualEffects(direction);
        }
        
        function triggerVisualEffects(direction) {
            // Edge glow effects
            const edges = {
                'next': 'right',
                'prev': 'left',
                'up': 'top',
                'down': 'bottom'
            };
            
            const edgeClass = edges[direction];
            if (edgeClass) {
                const edge = document.querySelector(`.edge-glow.${edgeClass}`);
                edge.classList.add('active');
                setTimeout(() => edge.classList.remove('active'), 200);
            }
            
            // Pill counter effects
            const activeCounters = document.querySelectorAll('.pill-counter.active');
            activeCounters.forEach(counter => {
                counter.classList.add('triple-ripple', 'glow-effect');
                setTimeout(() => {
                    counter.classList.remove('triple-ripple', 'glow-effect');
                }, parseInt(getComputedStyle(document.documentElement).getPropertyValue('--ripple-duration')));
            });
        }
        
        function handleKeyPress(event) {
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return; // Don't handle navigation when typing
            }
            
            switch (event.key) {
                case 'ArrowRight':
                case ' ':
                    event.preventDefault();
                    navigateImage('next');
                    break;
                case 'ArrowLeft':
                    event.preventDefault();
                    navigateImage('prev');
                    break;
                case 'ArrowUp':
                    event.preventDefault();
                    navigateImage('up');
                    break;
                case 'ArrowDown':
                    event.preventDefault();
                    navigateImage('down');
                    break;
                case 'Escape':
                    if (focusMode) {
                        exitFocusMode();
                    } else {
                        goBack();
                    }
                    break;
                case 'g':
                    if (!focusMode) {
                        showGridModal();
                    }
                    break;
                case 'd':
                    showDetailsModal();
                    break;
            }
        }
        
        function setupImageNavigation() {
            const viewport = document.getElementById('image-viewport');
            let startX = 0;
            let startY = 0;
            let isDragging = false;
            
            // Touch events
            viewport.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = false;
            });
            
            viewport.addEventListener('touchmove', (e) => {
                if (!isDragging) {
                    const deltaX = Math.abs(e.touches[0].clientX - startX);
                    const deltaY = Math.abs(e.touches[0].clientY - startY);
                    if (deltaX > 10 || deltaY > 10) {
                        isDragging = true;
                    }
                }
            });
            
            viewport.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const deltaX = endX - startX;
                const deltaY = endY - startY;
                
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (deltaX > 50) {
                        navigateImage('prev');
                    } else if (deltaX < -50) {
                        navigateImage('next');
                    }
                } else {
                    if (deltaY > 50) {
                        navigateImage('up');
                    } else if (deltaY < -50) {
                        navigateImage('down');
                    }
                }
            });
            
            // Mouse events
            viewport.addEventListener('click', (e) => {
                const rect = viewport.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const width = rect.width;
                
                if (x < width / 3) {
                    navigateImage('prev');
                } else if (x > (2 * width) / 3) {
                    navigateImage('next');
                }
            });
        }
        
        function setupModalEvents() {
            // Grid modal
            document.getElementById('close-grid-modal').addEventListener('click', hideGridModal);
            
            // Details modal
            document.getElementById('close-details-modal').addEventListener('click', hideDetailsModal);
            
            // Action modal
            document.getElementById('cancel-action').addEventListener('click', hideActionModal);
            document.getElementById('confirm-action').addEventListener('click', confirmAction);
            
            // Close modals on backdrop click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.add('hidden');
                    }
                });
            });
        }
        
        function setupGridEvents() {
            // Grid size control
            const gridSize = document.getElementById('grid-size');
            const gridSizeValue = document.getElementById('grid-size-value');
            
            gridSize.addEventListener('input', () => {
                const size = gridSize.value;
                gridSizeValue.textContent = size;
                updateGridSize(size);
            });
            
            // Search functionality
            const omniSearch = document.getElementById('omni-search');
            const clearSearchBtn = document.getElementById('clear-search-btn');
            
            omniSearch.addEventListener('input', () => {
                const query = omniSearch.value.trim();
                clearSearchBtn.style.display = query ? 'block' : 'none';
                filterGridImages(query);
            });
            
            clearSearchBtn.addEventListener('click', () => {
                omniSearch.value = '';
                clearSearchBtn.style.display = 'none';
                filterGridImages('');
            });
            
            // Selection controls
            document.getElementById('select-all-btn').addEventListener('click', selectAllImages);
            document.getElementById('deselect-all-btn').addEventListener('click', deselectAllImages);
            
            // Bulk actions
            document.getElementById('bulk-tag-btn').addEventListener('click', () => showBulkTagModal());
            document.getElementById('bulk-rate-btn').addEventListener('click', () => showBulkRateModal());
            document.getElementById('bulk-delete-btn').addEventListener('click', () => showBulkDeleteModal());
        }
        
        function setupDetailsModalEvents() {
            // Tab switching
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const tabName = button.dataset.tab;
                    switchTab(tabName);
                });
            });
            
            // Tag management
            document.getElementById('new-tag-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTag();
                }
            });
            
            // Star rating
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    setRating(rating);
                });
            });
            
            // Save metadata
            document.getElementById('save-metadata').addEventListener('click', saveCurrentImageMetadata);
        }
        
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            if (screenId === 'app-container') {
                document.getElementById('app-container').classList.remove('hidden');
            }
        }
        
        function showStatus(elementId, type, message) {
            const statusEl = document.getElementById(elementId);
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
            statusEl.classList.remove('hidden');
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function updateLoadingProgress(percent, message) {
            document.getElementById('loading-counter').textContent = Math.round(percent);
            document.getElementById('loading-message').textContent = message;
            document.getElementById('loading-progress-bar').style.width = percent + '%';
        }
        
        function goBack() {
            if (focusMode) {
                exitFocusMode();
            } else {
                showScreen('folder-screen');
            }
        }
        
        function showGridModal() {
            populateGrid();
            document.getElementById('grid-modal').classList.remove('hidden');
        }
        
        function hideGridModal() {
            document.getElementById('grid-modal').classList.add('hidden');
            selectedImages.clear();
            updateSelectionUI();
        }
        
        function populateGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            const imagesToShow = focusMode ? focusImages : images;
            
            imagesToShow.forEach((image, index) => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                gridItem.dataset.index = index;
                gridItem.dataset.imageId = image.id;
                
                gridItem.innerHTML = `
                    <img class="grid-image" data-src="${image.downloadUrl}" alt="${image.name}">
                `;
                
                gridItem.addEventListener('click', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        toggleImageSelection(image.id, gridItem);
                    } else {
                        if (focusMode) {
                            focusIndex = index;
                        } else {
                            currentIndex = index;
                        }
                        hideGridModal();
                        displayCurrentImage();
                        updateCounters();
                    }
                });
                
                container.appendChild(gridItem);
            });
            
            // Lazy load images
            lazyLoadGridImages();
        }
        
        function lazyLoadGridImages() {
            const images = document.querySelectorAll('.grid-image[data-src]');
            const imageObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.dataset.src;
                        img.removeAttribute('data-src');
                        img.addEventListener('load', () => {
                            img.classList.add('loaded');
                        });
                        imageObserver.unobserve(img);
                    }
                });
            });
            
            images.forEach(img => imageObserver.observe(img));
        }
        
        function updateGridSize(size) {
            const container = document.getElementById('grid-container');
            container.style.gridTemplateColumns = `repeat(auto-fill, minmax(${size}px, 1fr))`;
        }
        
        function filterGridImages(query) {
            const gridItems = document.querySelectorAll('.grid-item');
            const imagesToShow = focusMode ? focusImages : images;
            
            gridItems.forEach((item, index) => {
                const image = imagesToShow[index];
                if (!image) return;
                
                const matchesQuery = !query || 
                    image.name.toLowerCase().includes(query.toLowerCase()) ||
                    image.tags.some(tag => tag.toLowerCase().includes(query.toLowerCase())) ||
                    image.rating.toString().includes(query) ||
                    image.notes.toLowerCase().includes(query.toLowerCase());
                
                item.style.display = matchesQuery ? 'block' : 'none';
            });
        }
        
        function toggleImageSelection(imageId, gridItem) {
            if (selectedImages.has(imageId)) {
                selectedImages.delete(imageId);
                gridItem.classList.remove('selected');
            } else {
                selectedImages.add(imageId);
                gridItem.classList.add('selected');
            }
            updateSelectionUI();
        }
        
        function selectAllImages() {
            const imagesToShow = focusMode ? focusImages : images;
            imagesToShow.forEach(image => selectedImages.add(image.id));
            
            document.querySelectorAll('.grid-item').forEach(item => {
                item.classList.add('selected');
            });
            
            updateSelectionUI();
        }
        
        function deselectAllImages() {
            selectedImages.clear();
            document.querySelectorAll('.grid-item').forEach(item => {
                item.classList.remove('selected');
            });
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            const count = selectedImages.size;
            const selectionCount = document.getElementById('selection-count');
            const selectedCountSpan = document.getElementById('selected-count');
            const bulkActions = document.getElementById('bulk-actions');
            
            if (count > 0) {
                selectionCount.classList.remove('hidden');
                bulkActions.classList.remove('hidden');
                selectedCountSpan.textContent = count;
            } else {
                selectionCount.classList.add('hidden');
                bulkActions.classList.add('hidden');
            }
        }
        
        function showDetailsModal() {
            const currentImage = focusMode ? focusImages[focusIndex] : images[currentIndex];
            if (!currentImage) return;
            
            populateDetailsModal(currentImage);
            document.getElementById('details-modal').classList.remove('hidden');
        }
        
        function hideDetailsModal() {
            document.getElementById('details-modal').classList.add('hidden');
        }
        
        function populateDetailsModal(image) {
            document.getElementById('details-title').textContent = image.name;
            
            // Populate tags
            populateCurrentTags(image.tags);
            
            // Populate rating
            setRatingDisplay(image.rating);
            
            // Populate notes
            document.getElementById('notes-textarea').value = image.notes;
            
            // Populate metadata table
            populateMetadataTable(image);
        }
        
        function populateCurrentTags(tags) {
            const container = document.getElementById('current-tags');
            container.innerHTML = '';
            
            tags.forEach(tag => {
                const tagElement = document.createElement('span');
                tagElement.className = 'tag-item';
                tagElement.innerHTML = `
                    ${tag}
                    <button class="tag-remove" onclick="removeTag('${tag}')">√ó</button>
                `;
                container.appendChild(tagElement);
            });
            
            // Add "Add Tag" button
            const addButton = document.createElement('button');
            addButton.className = 'add-tag-btn';
            addButton.textContent = '+ Add Tag';
            addButton.onclick = () => document.getElementById('new-tag-input').focus();
            container.appendChild(addButton);
        }
        
        function addTag() {
            const input = document.getElementById('new-tag-input');
            const tag = input.value.trim();
            
            if (!tag) return;
            
            const currentImage = focusMode ? focusImages[focusIndex] : images[currentIndex];
            if (!currentImage.tags.includes(tag)) {
                currentImage.tags.push(tag);
                populateCurrentTags(currentImage.tags);
            }
            
            input.value = '';
        }
        
        function removeTag(tag) {
            const currentImage = focusMode ? focusImages[focusIndex] : images[currentIndex];
            currentImage.tags = currentImage.tags.filter(t => t !== tag);
            populateCurrentTags(currentImage.tags);
        }
        
        function setRating(rating) {
            const currentImage = focusMode ? focusImages[focusIndex] : images[currentIndex];
            currentImage.rating = rating;
            setRatingDisplay(rating);
        }
        
        function setRatingDisplay(rating) {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        function populateMetadataTable(image) {
            const table = document.getElementById('metadata-table');
            table.innerHTML = '';
            
            const metadata = {
                'File Name': image.name,
                'File Size': formatFileSize(image.size),
                'Modified': new Date(image.modifiedTime).toLocaleString(),
                'MIME Type': image.mimeType,
                'Tags': image.tags.join(', ') || 'None',
                'Rating': '‚òÖ'.repeat(image.rating) || 'None',
                'Notes': image.notes || 'None',
                'Stack Name': image.stackName || 'None',
                'Stack Order': image.stackOrder || 'None',
                'File ID': image.id,
                'Web View Link': image.webViewLink
            };
            
            Object.entries(metadata).forEach(([key, value]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="key-cell">${key}</td>
                    <td class="value-cell">
                        ${value}
                        <button class="copy-button" onclick="copyToClipboard('${value.replace(/'/g, "\\'")}', this)">Copy</button>
                    </td>
                `;
                table.appendChild(row);
            });
        }
        
        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            });
        }
        
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');
        }
        
        async function saveCurrentImageMetadata() {
            const currentImage = focusMode ? focusImages[focusIndex] : images[currentIndex];
            if (!currentImage) return;
            
            const notes = document.getElementById('notes-textarea').value;
            currentImage.notes = notes;
            
            const metadata = {
                tags: currentImage.tags.join(','),
                rating: currentImage.rating.toString(),
                notes: currentImage.notes,
                stackOrder: currentImage.stackOrder.toString(),
                stackName: currentImage.stackName
            };
            
            try {
                await updateUserMetadata(currentImage.id, metadata);
                hideDetailsModal();
            } catch (error) {
                // Error already handled in updateUserMetadata
            }
        }
        
        function showActionModal(title, content, confirmCallback) {
            document.getElementById('action-modal-title').textContent = title;
            document.getElementById('action-modal-content').innerHTML = content;
            document.getElementById('action-modal').classList.remove('hidden');
            
            // Store callback for confirm button
            window.currentActionCallback = confirmCallback;
        }
        
        function hideActionModal() {
            document.getElementById('action-modal').classList.add('hidden');
            window.currentActionCallback = null;
        }
        
        function confirmAction() {
            if (window.currentActionCallback) {
                window.currentActionCallback();
            }
            hideActionModal();
        }
        
        function showBulkTagModal() {
            const content = `
                <p>Add tags to ${selectedImages.size} selected images:</p>
                <input type="text" class="tag-input" id="bulk-tag-input" placeholder="Enter tags separated by commas">
            `;
            
            showActionModal('Bulk Tag Images', content, () => {
                const tags = document.getElementById('bulk-tag-input').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag);
                
                if (tags.length > 0) {
                    bulkUpdateTags(tags);
                }
            });
        }
        
        function showBulkRateModal() {
            const content = `
                <p>Set rating for ${selectedImages.size} selected images:</p>
                <div class="star-rating" id="bulk-star-rating">
                    ${[1,2,3,4,5].map(i => `
                        <svg class="star" data-rating="${i}" viewBox="0 0 24 24">
                            <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                        </svg>
                    `).join('')}
                </div>
            `;
            
            showActionModal('Bulk Rate Images', content, () => {
                const rating = parseInt(document.querySelector('#bulk-star-rating .star.active:last-child')?.dataset.rating) || 0;
                if (rating > 0) {
                    bulkUpdateRating(rating);
                }
            });
            
            // Setup star rating for bulk modal
            document.querySelectorAll('#bulk-star-rating .star').forEach(star => {
                star.addEventListener('click', () => {
                    const rating = parseInt(star.dataset.rating);
                    document.querySelectorAll('#bulk-star-rating .star').forEach((s, index) => {
                        if (index < rating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
        }
        
        function showBulkDeleteModal() {
            const content = `
                <p>Are you sure you want to delete ${selectedImages.size} selected images?</p>
                <p style="color: #ef4444; font-size: 14px;">This action cannot be undone.</p>
            `;
            
            showActionModal('Delete Images', content, () => {
                bulkDeleteImages();
            });
        }
        
        async function bulkUpdateTags(newTags) {
            const imagesToUpdate = focusMode ? focusImages : images;
            const updates = [];
            
            for (const imageId of selectedImages) {
                const image = imagesToUpdate.find(img => img.id === imageId);
                if (image) {
                    const combinedTags = [...new Set([...image.tags, ...newTags])];
                    image.tags = combinedTags;
                    updates.push({
                        fileId: imageId,
                        tags: combinedTags.join(','),
                        rating: image.rating.toString(),
                        notes: image.notes,
                        stackOrder: image.stackOrder.toString(),
                        stackName: image.stackName
                    });
                }
            }
            
            try {
                for (const update of updates) {
                    await updateUserMetadata(update.fileId, {
                        tags: update.tags,
                        rating: update.rating,
                        notes: update.notes,
                        stackOrder: update.stackOrder,
                        stackName: update.stackName
                    });
                }
                
                showToast(`Updated tags for ${updates.length} images`, 'success');
                selectedImages.clear();
                updateSelectionUI();
                hideGridModal();
            } catch (error) {
                showToast('Failed to update some images', 'error');
            }
        }
        
        async function bulkUpdateRating(rating) {
            const imagesToUpdate = focusMode ? focusImages : images;
            const updates = [];
            
            for (const imageId of selectedImages) {
                const image = imagesToUpdate.find(img => img.id === imageId);
                if (image) {
                    image.rating = rating;
                    updates.push({
                        fileId: imageId,
                        tags: image.tags.join(','),
                        rating: rating.toString(),
                        notes: image.notes,
                        stackOrder: image.stackOrder.toString(),
                        stackName: image.stackName
                    });
                }
            }
            
            try {
                for (const update of updates) {
                    await updateUserMetadata(update.fileId, {
                        tags: update.tags,
                        rating: update.rating,
                        notes: update.notes,
                        stackOrder: update.stackOrder,
                        stackName: update.stackName
                    });
                }
                
                showToast(`Updated rating for ${updates.length} images`, 'success');
                selectedImages.clear();
                updateSelectionUI();
                hideGridModal();
            } catch (error) {
                showToast('Failed to update some images', 'error');
            }
        }
        
        async function bulkDeleteImages() {
            // Note: This would require implementing delete functionality
            // For now, just show a message
            showToast('Bulk delete functionality not implemented yet', 'info');
            selectedImages.clear();
            updateSelectionUI();
            hideGridModal();
        }
        
        function enterFocusMode(stackName, stackImages) {
            focusMode = true;
            focusStack = stackName;
            focusImages = stackImages;
            focusIndex = 0;
            
            document.getElementById('app-container').classList.add('focus-mode');
            document.getElementById('focus-stack-name').textContent = stackName;
            
            displayCurrentImage();
            updateCounters();
            updateImageCount();
        }
        
        function exitFocusMode() {
            focusMode = false;
            focusStack = null;
            focusImages = [];
            focusIndex = 0;
            
            document.getElementById('app-container').classList.remove('focus-mode');
            
            displayCurrentImage();
            updateCounters();
            updateImageCount();
        }
        
        // Focus mode delete functionality
        document.getElementById('focus-delete-btn').addEventListener('click', () => {
            if (focusMode && focusImages.length > 0) {
                const currentImage = focusImages[focusIndex];
                showActionModal('Delete Image', 
                    `Are you sure you want to delete "${currentImage.name}"?`,
                    () => deleteCurrentFocusImage()
                );
            }
        });
        
        function deleteCurrentFocusImage() {
            if (!focusMode || focusImages.length === 0) return;
            
            // Remove from focus images
            focusImages.splice(focusIndex, 1);
            
            // Adjust index
            if (focusIndex >= focusImages.length) {
                focusIndex = Math.max(0, focusImages.length - 1);
            }
            
            // Update display
            if (focusImages.length > 0) {
                displayCurrentImage();
                updateCounters();
                updateImageCount();
                showToast('Image removed from stack', 'success');
            } else {
                exitFocusMode();
                showToast('Stack is now empty', 'info');
            }
        }
        
        // Auto-save stack order when exiting focus mode
        window.addEventListener('beforeunload', () => {
            if (focusMode && focusImages.length > 0) {
                saveStackOrder();
            }
        });
        
        // Load Google API
        function loadGoogleAPI() {
            const script = document.createElement('script');
            script.src = 'https://apis.google.com/js/api.js';
            script.onload = () => {
                console.log('Google API loaded');
            };
            document.head.appendChild(script);
        }
        
        // Initialize Google API on page load
        loadGoogleAPI();
    </script>
</body>
</html>