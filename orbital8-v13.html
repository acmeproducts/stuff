<!-- orbital8-v22-Aug-122 - 2025-08 -23 02:00 AM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital8 v23-Aug-122 - OneDrive Integration Fix</title>
    <style>
        /* Reset and base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
        }

        .status-connected {
            background: rgba(34, 197, 94, 0.1);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status-disconnected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-1px);
        }

        .btn-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Main content area */
        .main-content {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .sidebar-section {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sidebar-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .search-box {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.8);
            color: #667eea;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .filter-btn:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .filter-btn.active:hover {
            background: #5a67d8;
        }

        /* File browser */
        .file-browser {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .browser-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .browser-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .view-toggle {
            display: flex;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 8px;
            padding: 4px;
        }

        .view-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 12px;
            font-weight: 500;
        }

        .view-btn.active {
            background: #667eea;
            color: white;
        }

        .sort-dropdown {
            padding: 8px 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            background: white;
            color: #667eea;
            font-size: 12px;
            cursor: pointer;
        }

        .file-actions {
            display: flex;
            gap: 10px;
        }

        /* File grid */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .file-item {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            min-height: 160px;
        }

        .file-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .file-item.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 24px;
        }

        .file-icon.image {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }

        .file-icon.video {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }

        .file-icon.document {
            background: linear-gradient(135deg, #45b7d1, #96c93d);
            color: white;
        }

        .file-icon.other {
            background: linear-gradient(135deg, #f39c12, #f1c40f);
            color: white;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
            word-break: break-word;
            line-height: 1.3;
        }

        .file-meta {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        /* File list view */
        .file-list {
            display: none;
            flex-direction: column;
            gap: 1px;
            flex: 1;
            overflow-y: auto;
        }

        .file-list.active {
            display: flex;
        }

        .file-grid.list-view {
            display: none;
        }

        .file-list-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-list-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .file-list-item.selected {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
        }

        .file-list-icon {
            width: 32px;
            height: 32px;
            margin-right: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 16px;
        }

        .file-list-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-list-name {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .file-list-meta {
            font-size: 12px;
            color: #6b7280;
            display: flex;
            gap: 15px;
        }

        /* Loading states */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
            color: #6b7280;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            gap: 20px;
            color: #6b7280;
            text-align: center;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #667eea;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .modal-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Provider selection */
        .provider-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .provider-card {
            padding: 20px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            background: rgba(255, 255, 255, 0.5);
        }

        .provider-card:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .provider-card.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .provider-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            font-size: 24px;
        }

        .provider-icon.google {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
        }

        .provider-icon.onedrive {
            background: linear-gradient(135deg, #0078d4, #106ebe);
            color: white;
        }

        .provider-name {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .provider-desc {
            font-size: 12px;
            color: #6b7280;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-left: 4px solid #667eea;
            z-index: 1001;
            transform: translateX(400px);
            transition: all 0.3s ease;
            max-width: 350px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            border-left-color: #dc2626;
        }

        .toast.success {
            border-left-color: #16a34a;
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
        }

        .toast-icon.info {
            background: #667eea;
        }

        .toast-icon.error {
            background: #dc2626;
        }

        .toast-icon.success {
            background: #16a34a;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .header-content {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .connection-status {
                justify-content: center;
            }

            .browser-header {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .browser-controls {
                justify-content: center;
            }

            .file-actions {
                justify-content: center;
            }

            .provider-grid {
                grid-template-columns: 1fr;
            }
        }

        /* File preview */
        .file-preview {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .file-preview.active {
            opacity: 1;
            visibility: visible;
        }

        .preview-content {
            max-width: 90%;
            max-height: 90%;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .preview-header {
            padding: 15px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
        }

        .preview-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .preview-close:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .preview-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .preview-image {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }

        .preview-video {
            width: 100%;
            max-height: 60vh;
            border-radius: 8px;
        }

        /* Drag and drop */
        .drop-zone {
            border: 2px dashed rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            color: #6b7280;
            transition: all 0.2s ease;
            margin: 20px 0;
        }

        .drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            color: #667eea;
        }

        .drop-zone-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 15px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #667eea;
        }

        /* Progress bar */
        .progress-container {
            width: 100%;
            height: 6px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Metadata panel */
        .metadata-panel {
            position: fixed;
            right: -400px;
            top: 0;
            bottom: 0;
            width: 400px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: -5px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 1500;
            transition: right 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .metadata-panel.active {
            right: 0;
        }

        .metadata-header {
            padding: 20px;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .metadata-title {
            font-size: 18px;
            font-weight: 600;
            color: #374151;
        }

        .metadata-body {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .metadata-section {
            margin-bottom: 25px;
        }

        .metadata-section-title {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 10px;
        }

        .metadata-field {
            margin-bottom: 15px;
        }

        .metadata-label {
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metadata-value {
            font-size: 14px;
            color: #374151;
            background: rgba(102, 126, 234, 0.05);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .metadata-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .metadata-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Toolbar */
        .toolbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toolbar-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toolbar-divider {
            width: 1px;
            height: 24px;
            background: rgba(102, 126, 234, 0.2);
            margin: 0 5px;
        }

        /* Selection info */
        .selection-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 20px;
            font-size: 12px;
            color: #667eea;
            font-weight: 500;
        }

        /* Context menu */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(102, 126, 234, 0.1);
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transform: scale(0.95);
            transition: all 0.2s ease;
            min-width: 180px;
        }

        .context-menu.active {
            opacity: 1;
            visibility: visible;
            transform: scale(1);
        }

        .context-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 14px;
            color: #374151;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .context-menu-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .context-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .context-menu-divider {
            height: 1px;
            background: rgba(102, 126, 234, 0.1);
            margin: 5px 0;
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .breadcrumb-item {
            font-size: 14px;
            color: #6b7280;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .breadcrumb-item:hover {
            color: #667eea;
        }

        .breadcrumb-item.active {
            color: #374151;
            font-weight: 500;
        }

        .breadcrumb-separator {
            font-size: 12px;
            color: #d1d5db;
        }

        /* Animations */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(-20px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }

        /* Utility classes */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .text-left {
            text-align: left;
        }

        .text-right {
            text-align: right;
        }

        .flex {
            display: flex;
        }

        .flex-column {
            flex-direction: column;
        }

        .flex-wrap {
            flex-wrap: wrap;
        }

        .items-center {
            align-items: center;
        }

        .justify-center {
            justify-content: center;
        }

        .justify-between {
            justify-content: space-between;
        }

        .gap-10 {
            gap: 10px;
        }

        .gap-15 {
            gap: 15px;
        }

        .gap-20 {
            gap: 20px;
        }

        .mb-10 {
            margin-bottom: 10px;
        }

        .mb-15 {
            margin-bottom: 15px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .mt-10 {
            margin-top: 10px;
        }

        .mt-15 {
            margin-top: 15px;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .p-10 {
            padding: 10px;
        }

        .p-15 {
            padding: 15px;
        }

        .p-20 {
            padding: 20px;
        }

        .w-full {
            width: 100%;
        }

        .h-full {
            height: 100%;
        }

        /* Performance optimizations */
        .file-item,
        .file-list-item {
            will-change: transform;
        }

        .modal {
            will-change: transform, opacity;
        }

        .toast {
            will-change: transform;
        }

        /* Focus styles for accessibility */
        .btn:focus,
        .filter-btn:focus,
        .view-btn:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        .file-item:focus,
        .file-list-item:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .file-item {
                border-width: 3px;
            }
            
            .btn {
                border-width: 2px;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <div class="logo">Orbital8</div>
                <div class="connection-status">
                    <div id="connectionStatus" class="status-indicator status-disconnected">
                        <div class="status-dot"></div>
                        <span>Not Connected</span>
                    </div>
                    <button id="connectBtn" class="btn btn-primary">Connect to Cloud</button>
                    <button id="settingsBtn" class="btn btn-secondary">⚙️ Settings</button>
                </div>
            </div>
        </header>

        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-content">
                <div class="toolbar-section">
                    <button id="refreshBtn" class="btn btn-secondary">🔄 Refresh</button>
                    <div class="toolbar-divider"></div>
                    <div class="view-toggle">
                        <button id="gridViewBtn" class="view-btn active">⊞ Grid</button>
                        <button id="listViewBtn" class="view-btn">☰ List</button>
                    </div>
                </div>
                <div class="toolbar-section">
                    <select id="sortSelect" class="sort-dropdown">
                        <option value="name">Sort by Name</option>
                        <option value="date">Sort by Date</option>
                        <option value="size">Sort by Size</option>
                        <option value="type">Sort by Type</option>
                    </select>
                    <div class="toolbar-divider"></div>
                    <div class="file-actions">
                        <button id="selectAllBtn" class="btn btn-secondary">Select All</button>
                        <button id="clearSelectionBtn" class="btn btn-secondary">Clear</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-section">
                    <h3 class="sidebar-title">File Browser</h3>
                    <input type="text" id="searchInput" class="search-box" placeholder="Search files...">
                </div>

                <div class="sidebar-section">
                    <h4 class="sidebar-title">Navigation</h4>
                    <div class="breadcrumb" id="breadcrumb">
                        <span class="breadcrumb-item active">Home</span>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h4 class="sidebar-title">Filters</h4>
                    <div class="filter-group">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-filter="all">All</button>
                            <button class="filter-btn" data-filter="images">Images</button>
                            <button class="filter-btn" data-filter="videos">Videos</button>
                            <button class="filter-btn" data-filter="documents">Documents</button>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h4 class="sidebar-title">File Type</h4>
                    <div class="filter-group">
                        <div class="filter-buttons">
                            <button class="filter-btn active" data-type="all">All</button>
                            <button class="filter-btn" data-type="jpg">JPG</button>
                            <button class="filter-btn" data-type="png">PNG</button>
                            <button class="filter-btn" data-type="mp4">MP4</button>
                            <button class="filter-btn" data-type="pdf">PDF</button>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- File browser -->
            <main class="file-browser">
                <div class="browser-header">
                    <div class="browser-controls">
                        <div class="selection-info" id="selectionInfo" style="display: none;">
                            <span id="selectionCount">0</span> files selected
                        </div>
                    </div>
                </div>

                <!-- File grid view -->
                <div id="fileGrid" class="file-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading files...</p>
                    </div>
                </div>

                <!-- File list view -->
                <div id="fileList" class="file-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Loading files...</p>
                    </div>
                </div>

                <!-- Empty state -->
                <div id="emptyState" class="empty-state hidden">
                    <div class="empty-icon">📁</div>
                    <h3>No files found</h3>
                    <p>Connect to a cloud provider to browse your files</p>
                </div>

                <!-- Drop zone -->
                <div id="dropZone" class="drop-zone hidden">
                    <div class="drop-zone-icon">⬆️</div>
                    <h3>Drop files here to upload</h3>
                    <p>Drag and drop files to upload them to your cloud storage</p>
                </div>
            </main>
        </div>
    </div>

    <!-- Provider Selection Modal -->
    <div id="providerModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Connect to Cloud Storage</h2>
                <button class="modal-close" onclick="hideModal('providerModal')">&times;</button>
            </div>
            <div class="modal-content">
                <p style="margin-bottom: 20px; color: #6b7280;">Choose your preferred cloud storage provider:</p>
                <div class="provider-grid">
                    <div class="provider-card" data-provider="google">
                        <div class="provider-icon google">G</div>
                        <div class="provider-name">Google Drive</div>
                        <div class="provider-desc">Access your Google Drive files</div>
                    </div>
                    <div class="provider-card" data-provider="onedrive">
                        <div class="provider-icon onedrive">⊞</div>
                        <div class="provider-name">OneDrive</div>
                        <div class="provider-desc">Access your Microsoft OneDrive files</div>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="hideModal('providerModal')">Cancel</button>
                    <button id="connectProviderBtn" class="btn btn-primary" disabled>Connect</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="modal-close" onclick="hideModal('settingsModal')">&times;</button>
            </div>
            <div class="modal-content">
                <div class="metadata-section">
                    <div class="metadata-section-title">Display Options</div>
                    <div class="metadata-field">
                        <label class="metadata-label">Items per page</label>
                        <select id="itemsPerPage" class="metadata-input">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="metadata-field">
                        <label class="metadata-label">Default view</label>
                        <select id="defaultView" class="metadata-input">
                            <option value="grid" selected>Grid</option>
                            <option value="list">List</option>
                        </select>
                    </div>
                </div>
                <div class="metadata-section">
                    <div class="metadata-section-title">Performance</div>
                    <div class="metadata-field">
                        <label class="metadata-label">
                            <input type="checkbox" id="enableCaching" checked> Enable file caching
                        </label>
                    </div>
                    <div class="metadata-field">
                        <label class="metadata-label">
                            <input type="checkbox" id="enableThumbnails" checked> Generate thumbnails
                        </label>
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="hideModal('settingsModal')">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- File Preview Modal -->
    <div id="filePreview" class="file-preview">
        <div class="preview-content">
            <div class="preview-header">
                <div class="preview-title" id="previewTitle">File Preview</div>
                <button class="preview-close" onclick="hideFilePreview()">&times;</button>
            </div>
            <div class="preview-body" id="previewBody">
                <!-- Preview content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Metadata Panel -->
    <div id="metadataPanel" class="metadata-panel">
        <div class="metadata-header">
            <div class="metadata-title">File Details</div>
            <button class="modal-close" onclick="hideMetadataPanel()">&times;</button>
        </div>
        <div class="metadata-body" id="metadataBody">
            <!-- Metadata content will be inserted here -->
        </div>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="context-menu">
        <div class="context-menu-item" onclick="previewFile()">👁️ Preview</div>
        <div class="context-menu-item" onclick="downloadFile()">⬇️ Download</div>
        <div class="context-menu-item" onclick="showMetadata()">ℹ️ Details</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="deleteFile()">🗑️ Delete</div>
    </div>

    <!-- Toast Container -->
    <div id="toastContainer"></div>

    <script>
        // Global state
        let currentProvider = null;
        let accessToken = null;
        let currentFiles = [];
        let selectedFiles = new Set();
        let currentView = 'grid';
        let currentSort = 'name';
        let currentFilter = 'all';
        let currentTypeFilter = 'all';
        let searchQuery = '';
        let currentFolder = null;
        let folderStack = [];

        // Cache for performance
        const fileCache = new Map();
        const thumbnailCache = new Map();

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            setupEventListeners();
            loadSettings();
            checkExistingAuth();
        }

        function setupEventListeners() {
            // Header buttons
            document.getElementById('connectBtn').addEventListener('click', showProviderModal);
            document.getElementById('settingsBtn').addEventListener('click', () => showModal('settingsModal'));
            document.getElementById('refreshBtn').addEventListener('click', refreshFiles);

            // View toggle
            document.getElementById('gridViewBtn').addEventListener('click', () => setView('grid'));
            document.getElementById('listViewBtn').addEventListener('click', () => setView('list'));

            // Sort and filter
            document.getElementById('sortSelect').addEventListener('change', handleSortChange);
            document.getElementById('searchInput').addEventListener('input', handleSearch);

            // Selection buttons
            document.getElementById('selectAllBtn').addEventListener('click', selectAllFiles);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', handleFilterClick);
            });

            // Provider selection
            document.querySelectorAll('.provider-card').forEach(card => {
                card.addEventListener('click', selectProvider);
            });
            document.getElementById('connectProviderBtn').addEventListener('click', connectToProvider);

            // Context menu
            document.addEventListener('click', hideContextMenu);
            document.addEventListener('contextmenu', handleRightClick);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Window events
            window.addEventListener('resize', handleResize);
        }

        // Provider management
        function showProviderModal() {
            showModal('providerModal');
        }

        function selectProvider(event) {
            document.querySelectorAll('.provider-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            const provider = event.currentTarget.dataset.provider;
            document.getElementById('connectProviderBtn').disabled = false;
            document.getElementById('connectProviderBtn').dataset.provider = provider;
        }

        function connectToProvider() {
            const provider = document.getElementById('connectProviderBtn').dataset.provider;
            if (!provider) return;

            hideModal('providerModal');
            
            if (provider === 'google') {
                connectToGoogleDrive();
            } else if (provider === 'onedrive') {
                connectToOneDrive();
            }
        }

        // Google Drive integration
        function connectToGoogleDrive() {
            showToast('Connecting to Google Drive...', 'info');
            
            // Google Drive API setup
            gapi.load('auth2', function() {
                gapi.auth2.init({
                    client_id: '1234567890-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com'
                }).then(function() {
                    const authInstance = gapi.auth2.getAuthInstance();
                    return authInstance.signIn({
                        scope: 'https://www.googleapis.com/auth/drive'
                    });
                }).then(function(user) {
                    accessToken = user.getAuthResponse().access_token;
                    currentProvider = 'google';
                    updateConnectionStatus(true, 'Google Drive');
                    loadGoogleDriveFiles();
                    showToast('Connected to Google Drive successfully!', 'success');
                }).catch(function(error) {
                    console.error('Google Drive connection error:', error);
                    showToast('Failed to connect to Google Drive', 'error');
                });
            });
        }

        function loadGoogleDriveFiles() {
            if (!accessToken) return;

            showLoading();
            
            const url = 'https://www.googleapis.com/drive/v3/files?' + new URLSearchParams({
                q: "mimeType contains 'image/' or mimeType contains 'video/'",
                fields: 'files(id,name,mimeType,size,modifiedTime,webViewLink,thumbnailLink)',
                pageSize: '100'
            });

            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.files) {
                    currentFiles = data.files.map(file => ({
                        id: file.id,
                        name: file.name,
                        type: file.mimeType,
                        size: file.size,
                        modifiedTime: file.modifiedTime,
                        thumbnailUrl: file.thumbnailLink,
                        webViewLink: file.webViewLink,
                        provider: 'google'
                    }));
                    displayFiles();
                    loadStackOrder();
                } else {
                    showError('Failed to load files from Google Drive');
                }
            })
            .catch(error => {
                console.error('Error loading Google Drive files:', error);
                showError('Failed to load files from Google Drive');
            });
        }

        function loadStackOrder() {
            if (currentProvider !== 'google' || !accessToken) return;

            fetch('https://www.googleapis.com/drive/v3/about?fields=appProperties', {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.appProperties && data.appProperties.stackOrder) {
                    try {
                        const stackOrder = JSON.parse(data.appProperties.stackOrder);
                        applyStackOrder(stackOrder);
                    } catch (error) {
                        console.error('Error parsing stack order:', error);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading stack order:', error);
            });
        }

        function saveStackOrder() {
            if (currentProvider !== 'google' || !accessToken) return;

            const stackOrder = currentFiles.map(file => file.id);
            
            const requestBody = {
                appProperties: {
                    stackOrder: JSON.stringify(stackOrder)
                }
            };

            fetch('https://www.googleapis.com/drive/v3/about', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Stack order saved successfully', 'success');
                } else {
                    throw new Error('Failed to save stack order');
                }
            })
            .catch(error => {
                console.error('Error saving stack order:', error);
                showToast('Failed to save stack order', 'error');
            });
        }

        function applyStackOrder(stackOrder) {
            if (!Array.isArray(stackOrder)) return;

            const orderedFiles = [];
            const fileMap = new Map(currentFiles.map(file => [file.id, file]));

            // Add files in the saved order
            stackOrder.forEach(fileId => {
                if (fileMap.has(fileId)) {
                    orderedFiles.push(fileMap.get(fileId));
                    fileMap.delete(fileId);
                }
            });

            // Add any remaining files that weren't in the saved order
            fileMap.forEach(file => {
                orderedFiles.push(file);
            });

            currentFiles = orderedFiles;
            displayFiles();
        }

        // OneDrive integration - FIXED VERSION
        function connectToOneDrive() {
            showToast('Connecting to OneDrive...', 'info');
            
            const clientId = 'your-onedrive-client-id';
            const redirectUri = window.location.origin;
            const scopes = 'files.readwrite offline_access';
            
            const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
                `client_id=${clientId}&` +
                `response_type=token&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `scope=${encodeURIComponent(scopes)}`;
            
            window.location.href = authUrl;
        }

        function loadOneDriveFiles() {
            if (!accessToken) return;

            showLoading();
            
            const url = 'https://graph.microsoft.com/v1.0/me/drive/root/children?' + new URLSearchParams({
                '$filter': "file ne null and (startswith(file/mimeType,'image/') or startswith(file/mimeType,'video/'))",
                '$select': 'id,name,file,size,lastModifiedDateTime,webUrl,thumbnails'
            });

            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.value) {
                    currentFiles = data.value.map(file => ({
                        id: file.id,
                        name: file.name,
                        type: file.file.mimeType,
                        size: file.size,
                        modifiedTime: file.lastModifiedDateTime,
                        thumbnailUrl: file.thumbnails && file.thumbnails.length > 0 ? file.thumbnails[0].medium.url : null,
                        webViewLink: file.webUrl,
                        provider: 'onedrive'
                    }));
                    displayFiles();
                    loadOneDriveStackOrder();
                } else {
                    showError('Failed to load files from OneDrive');
                }
            })
            .catch(error => {
                console.error('Error loading OneDrive files:', error);
                showError('Failed to load files from OneDrive');
            });
        }

        // FIXED: OneDrive metadata using openExtension
        function loadOneDriveStackOrder() {
            if (currentProvider !== 'onedrive' || !accessToken) return;

            // Try to get the openExtension for stack order
            const extensionId = 'com.orbital8.stackOrder';
            const url = `https://graph.microsoft.com/v1.0/me/drive/root/extensions/${extensionId}`;

            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else if (response.status === 404) {
                    // Extension doesn't exist yet, that's okay
                    return null;
                } else {
                    throw new Error('Failed to load stack order');
                }
            })
            .then(data => {
                if (data && data.stackOrder) {
                    try {
                        const stackOrder = JSON.parse(data.stackOrder);
                        applyStackOrder(stackOrder);
                    } catch (error) {
                        console.error('Error parsing OneDrive stack order:', error);
                    }
                }
            })
            .catch(error => {
                console.error('Error loading OneDrive stack order:', error);
            });
        }

        function saveOneDriveStackOrder() {
            if (currentProvider !== 'onedrive' || !accessToken) return;

            const stackOrder = currentFiles.map(file => file.id);
            const extensionId = 'com.orbital8.stackOrder';
            
            // First try to update existing extension
            const updateUrl = `https://graph.microsoft.com/v1.0/me/drive/root/extensions/${extensionId}`;
            const extensionData = {
                '@odata.type': 'microsoft.graph.openTypeExtension',
                extensionName: extensionId,
                stackOrder: JSON.stringify(stackOrder)
            };

            fetch(updateUrl, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(extensionData)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Stack order saved successfully', 'success');
                } else if (response.status === 404) {
                    // Extension doesn't exist, create it
                    return createOneDriveStackOrderExtension(stackOrder);
                } else {
                    throw new Error('Failed to save stack order');
                }
            })
            .catch(error => {
                console.error('Error saving OneDrive stack order:', error);
                showToast('Failed to save stack order', 'error');
            });
        }

        function createOneDriveStackOrderExtension(stackOrder) {
            const extensionId = 'com.orbital8.stackOrder';
            const createUrl = `https://graph.microsoft.com/v1.0/me/drive/root/extensions`;
            
            const extensionData = {
                '@odata.type': 'microsoft.graph.openTypeExtension',
                extensionName: extensionId,
                stackOrder: JSON.stringify(stackOrder)
            };

            return fetch(createUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(extensionData)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Stack order saved successfully', 'success');
                } else {
                    throw new Error('Failed to create stack order extension');
                }
            });
        }

        // File management
        function displayFiles() {
            const filteredFiles = filterFiles(currentFiles);
            const sortedFiles = sortFiles(filteredFiles);
            
            if (currentView === 'grid') {
                displayGridView(sortedFiles);
            } else {
                displayListView(sortedFiles);
            }
            
            updateSelectionInfo();
        }

        function filterFiles(files) {
            let filtered = files;

            // Apply search filter
            if (searchQuery) {
                filtered = filtered.filter(file => 
                    file.name.toLowerCase().includes(searchQuery.toLowerCase())
                );
            }

            // Apply category filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(file => {
                    const type = file.type.toLowerCase();
                    switch (currentFilter) {
                        case 'images':
                            return type.startsWith('image/');
                        case 'videos':
                            return type.startsWith('video/');
                        case 'documents':
                            return type.includes('document') || type.includes('pdf') || type.includes('text');
                        default:
                            return true;
                    }
                });
            }

            // Apply type filter
            if (currentTypeFilter !== 'all') {
                filtered = filtered.filter(file => 
                    file.type.toLowerCase().includes(currentTypeFilter.toLowerCase())
                );
            }

            return filtered;
        }

        function sortFiles(files) {
            return [...files].sort((a, b) => {
                switch (currentSort) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'date':
                        return new Date(b.modifiedTime) - new Date(a.modifiedTime);
                    case 'size':
                        return (b.size || 0) - (a.size || 0);
                    case 'type':
                        return a.type.localeCompare(b.type);
                    default:
                        return 0;
                }
            });
        }

        function displayGridView(files) {
            const grid = document.getElementById('fileGrid');
            const list = document.getElementById('fileList');
            
            grid.classList.remove('list-view');
            list.classList.remove('active');
            
            if (files.length === 0) {
                grid.innerHTML = '<div class="empty-state"><div class="empty-icon">📁</div><h3>No files found</h3><p>No files match your current filters</p></div>';
                return;
            }

            grid.innerHTML = files.map(file => `
                <div class="file-item ${selectedFiles.has(file.id) ? 'selected' : ''}" 
                     data-file-id="${file.id}" 
                     onclick="toggleFileSelection('${file.id}')"
                     ondblclick="previewFile('${file.id}')">
                    <div class="file-icon ${getFileCategory(file.type)}">
                        ${getFileIcon(file.type)}
                    </div>
                    <div class="file-name">${escapeHtml(file.name)}</div>
                    <div class="file-meta">
                        <span>${formatFileSize(file.size)}</span>
                        <span>${formatDate(file.modifiedTime)}</span>
                    </div>
                </div>
            `).join('');
        }

        function displayListView(files) {
            const grid = document.getElementById('fileGrid');
            const list = document.getElementById('fileList');
            
            grid.classList.add('list-view');
            list.classList.add('active');
            
            if (files.length === 0) {
                list.innerHTML = '<div class="empty-state"><div class="empty-icon">📁</div><h3>No files found</h3><p>No files match your current filters</p></div>';
                return;
            }

            list.innerHTML = files.map(file => `
                <div class="file-list-item ${selectedFiles.has(file.id) ? 'selected' : ''}" 
                     data-file-id="${file.id}" 
                     onclick="toggleFileSelection('${file.id}')"
                     ondblclick="previewFile('${file.id}')">
                    <div class="file-list-icon ${getFileCategory(file.type)}">
                        ${getFileIcon(file.type)}
                    </div>
                    <div class="file-list-info">
                        <div class="file-list-name">${escapeHtml(file.name)}</div>
                        <div class="file-list-meta">
                            <span>${formatFileSize(file.size)}</span>
                            <span>${formatDate(file.modifiedTime)}</span>
                            <span>${file.type}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // File selection
        function toggleFileSelection(fileId) {
            if (selectedFiles.has(fileId)) {
                selectedFiles.delete(fileId);
            } else {
                selectedFiles.add(fileId);
            }
            
            updateFileSelectionUI();
            updateSelectionInfo();
        }

        function updateFileSelectionUI() {
            document.querySelectorAll('.file-item, .file-list-item').forEach(item => {
                const fileId = item.dataset.fileId;
                if (selectedFiles.has(fileId)) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectAllFiles() {
            const filteredFiles = filterFiles(currentFiles);
            filteredFiles.forEach(file => selectedFiles.add(file.id));
            updateFileSelectionUI();
            updateSelectionInfo();
        }

        function clearSelection() {
            selectedFiles.clear();
            updateFileSelectionUI();
            updateSelectionInfo();
        }

        function updateSelectionInfo() {
            const selectionInfo = document.getElementById('selectionInfo');
            const selectionCount = document.getElementById('selectionCount');
            
            if (selectedFiles.size > 0) {
                selectionCount.textContent = selectedFiles.size;
                selectionInfo.style.display = 'flex';
            } else {
                selectionInfo.style.display = 'none';
            }
        }

        // View management
        function setView(view) {
            currentView = view;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            if (view === 'grid') {
                document.getElementById('gridViewBtn').classList.add('active');
            } else {
                document.getElementById('listViewBtn').classList.add('active');
            }
            
            displayFiles();
            saveSettings();
        }

        // Event handlers
        function handleSortChange(event) {
            currentSort = event.target.value;
            displayFiles();
            saveSettings();
        }

        function handleSearch(event) {
            searchQuery = event.target.value;
            displayFiles();
        }

        function handleFilterClick(event) {
            const btn = event.target;
            const filterType = btn.dataset.filter || btn.dataset.type;
            
            // Remove active class from siblings
            btn.parentElement.querySelectorAll('.filter-btn').forEach(sibling => {
                sibling.classList.remove('active');
            });
            
            btn.classList.add('active');
            
            if (btn.dataset.filter) {
                currentFilter = filterType;
            } else if (btn.dataset.type) {
                currentTypeFilter = filterType;
            }
            
            displayFiles();
        }

        function handleRightClick(event) {
            const fileItem = event.target.closest('.file-item, .file-list-item');
            if (fileItem) {
                event.preventDefault();
                showContextMenu(event.clientX, event.clientY, fileItem.dataset.fileId);
            }
        }

        function handleKeyboardShortcuts(event) {
            if (event.ctrlKey || event.metaKey) {
                switch (event.key) {
                    case 'a':
                        event.preventDefault();
                        selectAllFiles();
                        break;
                    case 'r':
                        event.preventDefault();
                        refreshFiles();
                        break;
                }
            }
            
            if (event.key === 'Escape') {
                hideContextMenu();
                hideFilePreview();
                hideMetadataPanel();
            }
        }

        function handleResize() {
            hideContextMenu();
        }

        // Context menu
        function showContextMenu(x, y, fileId) {
            const contextMenu = document.getElementById('contextMenu');
            contextMenu.dataset.fileId = fileId;
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('active');
        }

        function hideContextMenu() {
            document.getElementById('contextMenu').classList.remove('active');
        }

        // File operations
        function previewFile(fileId) {
            hideContextMenu();
            
            const file = currentFiles.find(f => f.id === (fileId || document.getElementById('contextMenu').dataset.fileId));
            if (!file) return;

            const preview = document.getElementById('filePreview');
            const title = document.getElementById('previewTitle');
            const body = document.getElementById('previewBody');
            
            title.textContent = file.name;
            
            if (file.type.startsWith('image/')) {
                body.innerHTML = `<img src="${file.thumbnailUrl || file.webViewLink}" alt="${escapeHtml(file.name)}" class="preview-image">`;
            } else if (file.type.startsWith('video/')) {
                body.innerHTML = `<video src="${file.webViewLink}" controls class="preview-video"></video>`;
            } else {
                body.innerHTML = `<p>Preview not available for this file type.</p><a href="${file.webViewLink}" target="_blank" class="btn btn-primary">Open in ${currentProvider === 'google' ? 'Google Drive' : 'OneDrive'}</a>`;
            }
            
            preview.classList.add('active');
        }

        function hideFilePreview() {
            document.getElementById('filePreview').classList.remove('active');
        }

        function downloadFile(fileId) {
            hideContextMenu();
            
            const file = currentFiles.find(f => f.id === (fileId || document.getElementById('contextMenu').dataset.fileId));
            if (!file) return;

            showToast('Starting download...', 'info');
            
            if (currentProvider === 'google') {
                const downloadUrl = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
                
                fetch(downloadUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('Download completed', 'success');
                })
                .catch(error => {
                    console.error('Download error:', error);
                    showToast('Download failed', 'error');
                });
            } else if (currentProvider === 'onedrive') {
                // For OneDrive, use the download URL
                const downloadUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`;
                
                fetch(downloadUrl, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = file.name;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    showToast('Download completed', 'success');
                })
                .catch(error => {
                    console.error('Download error:', error);
                    showToast('Download failed', 'error');
                });
            }
        }

        function deleteFile(fileId) {
            hideContextMenu();
            
            const file = currentFiles.find(f => f.id === (fileId || document.getElementById('contextMenu').dataset.fileId));
            if (!file) return;

            if (!confirm(`Are you sure you want to delete "${file.name}"?`)) return;

            showToast('Deleting file...', 'info');
            
            let deleteUrl;
            if (currentProvider === 'google') {
                deleteUrl = `https://www.googleapis.com/drive/v3/files/${file.id}`;
            } else if (currentProvider === 'onedrive') {
                deleteUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${file.id}`;
            }

            fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            })
            .then(response => {
                if (response.ok) {
                    currentFiles = currentFiles.filter(f => f.id !== file.id);
                    selectedFiles.delete(file.id);
                    displayFiles();
                    showToast('File deleted successfully', 'success');
                } else {
                    throw new Error('Failed to delete file');
                }
            })
            .catch(error => {
                console.error('Delete error:', error);
                showToast('Failed to delete file', 'error');
            });
        }

        function refreshFiles() {
            if (currentProvider === 'google') {
                loadGoogleDriveFiles();
            } else if (currentProvider === 'onedrive') {
                loadOneDriveFiles();
            }
        }

        // Metadata panel
        function showMetadata(fileId) {
            hideContextMenu();
            
            const file = currentFiles.find(f => f.id === (fileId || document.getElementById('contextMenu').dataset.fileId));
            if (!file) return;

            const panel = document.getElementById('metadataPanel');
            const body = document.getElementById('metadataBody');
            
            body.innerHTML = `
                <div class="metadata-section">
                    <div class="metadata-section-title">Basic Information</div>
                    <div class="metadata-field">
                        <div class="metadata-label">Name</div>
                        <div class="metadata-value">${escapeHtml(file.name)}</div>
                    </div>
                    <div class="metadata-field">
                        <div class="metadata-label">Type</div>
                        <div class="metadata-value">${file.type}</div>
                    </div>
                    <div class="metadata-field">
                        <div class="metadata-label">Size</div>
                        <div class="metadata-value">${formatFileSize(file.size)}</div>
                    </div>
                    <div class="metadata-field">
                        <div class="metadata-label">Modified</div>
                        <div class="metadata-value">${formatDate(file.modifiedTime)}</div>
                    </div>
                    <div class="metadata-field">
                        <div class="metadata-label">Provider</div>
                        <div class="metadata-value">${currentProvider === 'google' ? 'Google Drive' : 'OneDrive'}</div>
                    </div>
                </div>
                <div class="metadata-section">
                    <div class="metadata-section-title">Actions</div>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn btn-primary" onclick="previewFile('${file.id}')">👁️ Preview</button>
                        <button class="btn btn-secondary" onclick="downloadFile('${file.id}')">⬇️ Download</button>
                        <button class="btn btn-danger" onclick="deleteFile('${file.id}')">🗑️ Delete</button>
                    </div>
                </div>
            `;
            
            panel.classList.add('active');
        }

        function hideMetadataPanel() {
            document.getElementById('metadataPanel').classList.remove('active');
        }

        // Utility functions
        function getFileCategory(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType.startsWith('video/')) return 'video';
            if (mimeType.includes('document') || mimeType.includes('pdf') || mimeType.includes('text')) return 'document';
            return 'other';
        }

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return '🖼️';
            if (mimeType.startsWith('video/')) return '🎥';
            if (mimeType.includes('pdf')) return '📄';
            if (mimeType.includes('document')) return '📝';
            if (mimeType.includes('text')) return '📄';
            return '📁';
        }

        function formatFileSize(bytes) {
            if (!bytes) return 'Unknown';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // UI state management
        function showLoading() {
            const grid = document.getElementById('fileGrid');
            const list = document.getElementById('fileList');
            
            grid.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading files...</p></div>';
            list.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading files...</p></div>';
        }

        function showError(message) {
            const grid = document.getElementById('fileGrid');
            const list = document.getElementById('fileList');
            
            const errorHtml = `<div class="empty-state"><div class="empty-icon">⚠️</div><h3>Error</h3><p>${escapeHtml(message)}</p></div>`;
            grid.innerHTML = errorHtml;
            list.innerHTML = errorHtml;
        }

        function updateConnectionStatus(connected, providerName) {
            const status = document.getElementById('connectionStatus');
            const connectBtn = document.getElementById('connectBtn');
            
            if (connected) {
                status.className = 'status-indicator status-connected';
                status.innerHTML = `<div class="status-dot"></div><span>Connected to ${providerName}</span>`;
                connectBtn.textContent = 'Disconnect';
                connectBtn.onclick = disconnect;
            } else {
                status.className = 'status-indicator status-disconnected';
                status.innerHTML = '<div class="status-dot"></div><span>Not Connected</span>';
                connectBtn.textContent = 'Connect to Cloud';
                connectBtn.onclick = showProviderModal;
            }
        }

        function disconnect() {
            currentProvider = null;
            accessToken = null;
            currentFiles = [];
            selectedFiles.clear();
            
            updateConnectionStatus(false);
            showError('Disconnected from cloud storage');
            showToast('Disconnected successfully', 'info');
        }

        // Modal management
        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Toast notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const iconMap = {
                info: 'ℹ️',
                success: '✅',
                error: '❌'
            };
            
            toast.innerHTML = `
                <div class="toast-content">
                    <div class="toast-icon ${type}">${iconMap[type]}</div>
                    <div class="toast-message">${escapeHtml(message)}</div>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => toast.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Settings management
        function loadSettings() {
            const settings = localStorage.getItem('orbital8-settings');
            if (settings) {
                try {
                    const parsed = JSON.parse(settings);
                    currentView = parsed.defaultView || 'grid';
                    currentSort = parsed.defaultSort || 'name';
                    
                    // Apply settings to UI
                    setView(currentView);
                    document.getElementById('sortSelect').value = currentSort;
                    document.getElementById('defaultView').value = currentView;
                    document.getElementById('itemsPerPage').value = parsed.itemsPerPage || '50';
                    document.getElementById('enableCaching').checked = parsed.enableCaching !== false;
                    document.getElementById('enableThumbnails').checked = parsed.enableThumbnails !== false;
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }
        }

        function saveSettings() {
            const settings = {
                defaultView: currentView,
                defaultSort: currentSort,
                itemsPerPage: document.getElementById('itemsPerPage').value,
                enableCaching: document.getElementById('enableCaching').checked,
                enableThumbnails: document.getElementById('enableThumbnails').checked
            };
            
            localStorage.setItem('orbital8-settings', JSON.stringify(settings));
            showToast('Settings saved', 'success');
            hideModal('settingsModal');
        }

        // Authentication check
        function checkExistingAuth() {
            // Check for existing tokens in localStorage or URL hash
            const hash = window.location.hash;
            if (hash.includes('access_token')) {
                const params = new URLSearchParams(hash.substring(1));
                const token = params.get('access_token');
                if (token) {
                    accessToken = token;
                    currentProvider = 'onedrive'; // Assuming OneDrive based on OAuth flow
                    updateConnectionStatus(true, 'OneDrive');
                    loadOneDriveFiles();
                    // Clean up URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                }
            }
        }

        // Drag and drop functionality
        function setupDragAndDrop() {
            const dropZone = document.getElementById('dropZone');
            const fileBrowser = document.querySelector('.file-browser');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                fileBrowser.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                fileBrowser.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                fileBrowser.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropZone.classList.add('drag-over');
                dropZone.classList.remove('hidden');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('drag-over');
                dropZone.classList.add('hidden');
            }
            
            fileBrowser.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFiles(files);
            }
        }

        function handleFiles(files) {
            ([...files]).forEach(uploadFile);
        }

        function uploadFile(file) {
            showToast(`Uploading ${file.name}...`, 'info');
            
            // Implementation would depend on the provider
            if (currentProvider === 'google') {
                uploadToGoogleDrive(file);
            } else if (currentProvider === 'onedrive') {
                uploadToOneDrive(file);
            }
        }

        function uploadToGoogleDrive(file) {
            const metadata = {
                name: file.name,
                parents: currentFolder ? [currentFolder] : undefined
            };

            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                },
                body: form
            })
            .then(response => response.json())
            .then(data => {
                showToast(`${file.name} uploaded successfully`, 'success');
                refreshFiles();
            })
            .catch(error => {
                console.error('Upload error:', error);
                showToast(`Failed to upload ${file.name}`, 'error');
            });
        }

        function uploadToOneDrive(file) {
            const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(file.name)}:/content`;
            
            fetch(uploadUrl, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': file.type
                },
                body: file
            })
            .then(response => response.json())
            .then(data => {
                showToast(`${file.name} uploaded successfully`, 'success');
                refreshFiles();
            })
            .catch(error => {
                console.error('Upload error:', error);
                showToast(`Failed to upload ${file.name}`, 'error');
            });
        }

        // Performance monitoring
        function measurePerformance(operation, fn) {
            const start = performance.now();
            const result = fn();
            const end = performance.now();
            console.log(`${operation} took ${end - start} milliseconds`);
            return result;
        }

        // Error handling
        function handleError(error, context) {
            console.error(`Error in ${context}:`, error);
            showToast(`Error: ${error.message}`, 'error');
        }

        // Initialize drag and drop when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setupDragAndDrop();
        });

        // Load Google API
        function loadGoogleAPI() {
            if (typeof gapi !== 'undefined') return Promise.resolve();
            
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.onload = () => {
                    gapi.load('auth2', resolve);
                };
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Initialize Google API when needed
        function initializeGoogleAPI() {
            return loadGoogleAPI().then(() => {
                return gapi.auth2.init({
                    client_id: '1234567890-abcdefghijklmnopqrstuvwxyz.apps.googleusercontent.com'
                });
            });
        }

        // Enhanced file operations for stack order management
        function moveFileUp(fileId) {
            const index = currentFiles.findIndex(f => f.id === fileId);
            if (index > 0) {
                [currentFiles[index], currentFiles[index - 1]] = [currentFiles[index - 1], currentFiles[index]];
                displayFiles();
                saveStackOrder();
            }
        }

        function moveFileDown(fileId) {
            const index = currentFiles.findIndex(f => f.id === fileId);
            if (index < currentFiles.length - 1) {
                [currentFiles[index], currentFiles[index + 1]] = [currentFiles[index + 1], currentFiles[index]];
                displayFiles();
                saveStackOrder();
            }
        }

        function moveFileToTop(fileId) {
            const index = currentFiles.findIndex(f => f.id === fileId);
            if (index > 0) {
                const file = currentFiles.splice(index, 1)[0];
                currentFiles.unshift(file);
                displayFiles();
                saveStackOrder();
            }
        }

        function moveFileToBottom(fileId) {
            const index = currentFiles.findIndex(f => f.id === fileId);
            if (index < currentFiles.length - 1) {
                const file = currentFiles.splice(index, 1)[0];
                currentFiles.push(file);
                displayFiles();
                saveStackOrder();
            }
        }

        // Enhanced context menu with stack order options
        function showContextMenu(x, y, fileId) {
            const contextMenu = document.getElementById('contextMenu');
            const file = currentFiles.find(f => f.id === fileId);
            const index = currentFiles.findIndex(f => f.id === fileId);
            
            let menuItems = `
                <div class="context-menu-item" onclick="previewFile('${fileId}')">👁️ Preview</div>
                <div class="context-menu-item" onclick="downloadFile('${fileId}')">⬇️ Download</div>
                <div class="context-menu-item" onclick="showMetadata('${fileId}')">ℹ️ Details</div>
                <div class="context-menu-divider"></div>
            `;
            
            // Add stack order options if there are multiple files
            if (currentFiles.length > 1) {
                menuItems += `
                    <div class="context-menu-item" onclick="moveFileToTop('${fileId}')" ${index === 0 ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>⬆️ Move to Top</div>
                    <div class="context-menu-item" onclick="moveFileUp('${fileId}')" ${index === 0 ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>↑ Move Up</div>
                    <div class="context-menu-item" onclick="moveFileDown('${fileId}')" ${index === currentFiles.length - 1 ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>↓ Move Down</div>
                    <div class="context-menu-item" onclick="moveFileToBottom('${fileId}')" ${index === currentFiles.length - 1 ? 'style="opacity: 0.5; pointer-events: none;"' : ''}>⬇️ Move to Bottom</div>
                    <div class="context-menu-divider"></div>
                `;
            }
            
            menuItems += `<div class="context-menu-item" onclick="deleteFile('${fileId}')">🗑️ Delete</div>`;
            
            contextMenu.innerHTML = menuItems;
            contextMenu.dataset.fileId = fileId;
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';
            contextMenu.classList.add('active');
        }

        // Save stack order based on current provider
        function saveStackOrder() {
            if (currentProvider === 'google') {
                saveGoogleDriveStackOrder();
            } else if (currentProvider === 'onedrive') {
                saveOneDriveStackOrder();
            }
        }

        function saveGoogleDriveStackOrder() {
            if (!accessToken) return;

            const stackOrder = currentFiles.map(file => file.id);
            
            // Use Google Drive's appProperties to store stack order
            const requestBody = {
                appProperties: {
                    stackOrder: JSON.stringify(stackOrder)
                }
            };

            fetch('https://www.googleapis.com/drive/v3/about', {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => {
                if (response.ok) {
                    showToast('Stack order saved successfully', 'success');
                } else {
                    throw new Error('Failed to save stack order');
                }
            })
            .catch(error => {
                console.error('Error saving Google Drive stack order:', error);
                showToast('Failed to save stack order', 'error');
            });
        }

        // Keyboard shortcuts for stack order
        document.addEventListener('keydown', function(event) {
            if (selectedFiles.size === 1 && !event.target.matches('input, textarea, select')) {
                const fileId = Array.from(selectedFiles)[0];
                
                if (event.ctrlKey || event.metaKey) {
                    switch (event.key) {
                        case 'ArrowUp':
                            event.preventDefault();
                            if (event.shiftKey) {
                                moveFileToTop(fileId);
                            } else {
                                moveFileUp(fileId);
                            }
                            break;
                        case 'ArrowDown':
                            event.preventDefault();
                            if (event.shiftKey) {
                                moveFileToBottom(fileId);
                            } else {
                                moveFileDown(fileId);
                            }
                            break;
                    }
                }
            }
        });

        // Enhanced error handling with retry logic
        function makeApiCall(url, options, retries = 3) {
            return fetch(url, options)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .catch(error => {
                    if (retries > 0 && (error.message.includes('network') || error.message.includes('timeout'))) {
                        console.log(`Retrying API call... ${retries} attempts remaining`);
                        return new Promise(resolve => {
                            setTimeout(() => {
                                resolve(makeApiCall(url, options, retries - 1));
                            }, 1000);
                        });
                    }
                    throw error;
                });
        }

        // Cache management
        function getCachedData(key) {
            if (!document.getElementById('enableCaching').checked) return null;
            
            const cached = fileCache.get(key);
            if (cached && Date.now() - cached.timestamp < 300000) { // 5 minutes
                return cached.data;
            }
            return null;
        }

        function setCachedData(key, data) {
            if (!document.getElementById('enableCaching').checked) return;
            
            fileCache.set(key, {
                data: data,
                timestamp: Date.now()
            });
        }

        // Enhanced file loading with caching
        function loadFilesWithCache() {
            const cacheKey = `${currentProvider}-files`;
            const cached = getCachedData(cacheKey);
            
            if (cached) {
                currentFiles = cached;
                displayFiles();
                return;
            }
            
            if (currentProvider === 'google') {
                loadGoogleDriveFiles();
            } else if (currentProvider === 'onedrive') {
                loadOneDriveFiles();
            }
        }

        // Thumbnail generation
        function generateThumbnail(file) {
            if (!document.getElementById('enableThumbnails').checked) return null;
            
            const cached = thumbnailCache.get(file.id);
            if (cached) return cached;
            
            if (file.type.startsWith('image/')) {
                // Use existing thumbnail if available
                if (file.thumbnailUrl) {
                    thumbnailCache.set(file.id, file.thumbnailUrl);
                    return file.thumbnailUrl;
                }
            }
            
            return null;
        }

        // Performance optimization: Virtual scrolling for large file lists
        function setupVirtualScrolling() {
            // Implementation would go here for handling large numbers of files
            // This is a placeholder for future enhancement
        }

        // Accessibility enhancements
        function setupAccessibility() {
            // Add ARIA labels and roles
            document.querySelectorAll('.file-item').forEach((item, index) => {
                item.setAttribute('role', 'button');
                item.setAttribute('tabindex', '0');
                item.setAttribute('aria-label', `File ${index + 1}`);
            });
            
            // Add keyboard navigation for file items
            document.addEventListener('keydown', function(event) {
                const focusedElement = document.activeElement;
                if (focusedElement && focusedElement.classList.contains('file-item')) {
                    switch (event.key) {
                        case 'Enter':
                        case ' ':
                            event.preventDefault();
                            focusedElement.click();
                            break;
                        case 'ArrowRight':
                        case 'ArrowDown':
                            event.preventDefault();
                            const next = focusedElement.nextElementSibling;
                            if (next) next.focus();
                            break;
                        case 'ArrowLeft':
                        case 'ArrowUp':
                            event.preventDefault();
                            const prev = focusedElement.previousElementSibling;
                            if (prev) prev.focus();
                            break;
                    }
                }
            });
        }

        // Initialize accessibility features
        document.addEventListener('DOMContentLoaded', setupAccessibility);

        // Advanced search functionality
        function setupAdvancedSearch() {
            let searchTimeout;
            const searchInput = document.getElementById('searchInput');
            
            searchInput.addEventListener('input', function(event) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = event.target.value;
                    displayFiles();
                }, 300); // Debounce search
            });
        }

        // Initialize advanced search
        document.addEventListener('DOMContentLoaded', setupAdvancedSearch);

        // File type detection and categorization
        function getDetailedFileInfo(file) {
            const extension = file.name.split('.').pop().toLowerCase();
            const mimeType = file.type.toLowerCase();
            
            let category = 'other';
            let icon = '📁';
            
            if (mimeType.startsWith('image/')) {
                category = 'image';
                icon = '🖼️';
            } else if (mimeType.startsWith('video/')) {
                category = 'video';
                icon = '🎥';
            } else if (mimeType.includes('pdf')) {
                category = 'document';
                icon = '📄';
            } else if (mimeType.includes('document') || mimeType.includes('text')) {
                category = 'document';
                icon = '📝';
            }
            
            return { category, icon, extension };
        }

        // Enhanced file display with better categorization
        function createFileElement(file) {
            const fileInfo = getDetailedFileInfo(file);
            const thumbnail = generateThumbnail(file);
            
            return {
                id: file.id,
                name: file.name,
                type: file.type,
                size: file.size,
                modifiedTime: file.modifiedTime,
                category: fileInfo.category,
                icon: fileInfo.icon,
                thumbnailUrl: thumbnail || file.thumbnailUrl,
                webViewLink: file.webViewLink,
                provider: file.provider
            };
        }

        // Batch operations
        function performBatchOperation(operation) {
            if (selectedFiles.size === 0) {
                showToast('No files selected', 'info');
                return;
            }
            
            const selectedFileIds = Array.from(selectedFiles);
            const promises = selectedFileIds.map(fileId => {
                const file = currentFiles.find(f => f.id === fileId);
                return operation(file);
            });
            
            Promise.allSettled(promises)
                .then(results => {
                    const successful = results.filter(r => r.status === 'fulfilled').length;
                    const failed = results.filter(r => r.status === 'rejected').length;
                    
                    if (failed === 0) {
                        showToast(`Operation completed successfully for ${successful} files`, 'success');
                    } else {
                        showToast(`Operation completed: ${successful} successful, ${failed} failed`, 'info');
                    }
                    
                    refreshFiles();
                });
        }

        // Batch download
        function batchDownload() {
            performBatchOperation(downloadFile);
        }

        // Batch delete
        function batchDelete() {
            if (!confirm(`Are you sure you want to delete ${selectedFiles.size} selected files?`)) return;
            performBatchOperation(deleteFile);
        }

        // Export functionality
        function exportFileList() {
            const filteredFiles = filterFiles(currentFiles);
            const csvContent = [
                ['Name', 'Type', 'Size', 'Modified', 'Provider'].join(','),
                ...filteredFiles.map(file => [
                    `"${file.name}"`,
                    `"${file.type}"`,
                    file.size || 0,
                    `"${file.modifiedTime}"`,
                    `"${file.provider}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `orbital8-files-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast('File list exported successfully', 'success');
        }

        // Advanced sorting options
        function setupAdvancedSorting() {
            const sortSelect = document.getElementById('sortSelect');
            
            // Add more sorting options
            sortSelect.innerHTML = `
                <option value="name">Sort by Name</option>
                <option value="date">Sort by Date</option>
                <option value="size">Sort by Size</option>
                <option value="type">Sort by Type</option>
                <option value="extension">Sort by Extension</option>
                <option value="custom">Custom Order</option>
            `;
        }

        // Initialize advanced sorting
        document.addEventListener('DOMContentLoaded', setupAdvancedSorting);

        // Theme management
        function setupThemeToggle() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const savedTheme = localStorage.getItem('orbital8-theme');
            const theme = savedTheme || (prefersDark ? 'dark' : 'light');
            
            applyTheme(theme);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('orbital8-theme', theme);
        }

        // Initialize theme
        document.addEventListener('DOMContentLoaded', setupThemeToggle);

        // Progressive Web App features
        function setupPWA() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            }
        }

        // Initialize PWA features
        document.addEventListener('DOMContentLoaded', setupPWA);

        // Analytics and usage tracking
        function trackUsage(action, details = {}) {
            // Implementation would go here for usage analytics
            console.log('Usage tracked:', action, details);
        }

        // Enhanced error reporting
        function reportError(error, context) {
            const errorReport = {
                message: error.message,
                stack: error.stack,
                context: context,
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                url: window.location.href
            };
            
            console.error('Error report:', errorReport);
            
            // In a real application, you might send this to an error tracking service
        }

        // Global error handler
        window.addEventListener('error', function(event) {
            reportError(event.error, 'Global error handler');
        });

        window.addEventListener('unhandledrejection', function(event) {
            reportError(new Error(event.reason), 'Unhandled promise rejection');
        });

        // Performance monitoring
        function setupPerformanceMonitoring() {
            if ('performance' in window) {
                window.addEventListener('load', function() {
                    setTimeout(() => {
                        const perfData = performance.getEntriesByType('navigation')[0];
                        console.log('Page load performance:', {
                            loadTime: perfData.loadEventEnd - perfData.loadEventStart,
                            domContentLoaded: perfData.domContentLoadedEventEnd - perfData.domContentLoadedEventStart,
                            totalTime: perfData.loadEventEnd - perfData.fetchStart
                        });
                    }, 0);
                });
            }
        }

        // Initialize performance monitoring
        document.addEventListener('DOMContentLoaded', setupPerformanceMonitoring);

        // Memory management
        function cleanupResources() {
            // Clear caches periodically
            if (fileCache.size > 100) {
                const oldestEntries = Array.from(fileCache.entries())
                    .sort((a, b) => a[1].timestamp - b[1].timestamp)
                    .slice(0, 50);
                
                oldestEntries.forEach(([key]) => fileCache.delete(key));
            }
            
            if (thumbnailCache.size > 50) {
                const oldestThumbnails = Array.from(thumbnailCache.entries()).slice(0, 25);
                oldestThumbnails.forEach(([key]) => thumbnailCache.delete(key));
            }
        }

        // Run cleanup every 5 minutes
        setInterval(cleanupResources, 300000);

        // Enhanced file operations with progress tracking
        function uploadFileWithProgress(file) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                
                xhr.upload.addEventListener('progress', function(event) {
                    if (event.lengthComputable) {
                        const percentComplete = (event.loaded / event.total) * 100;
                        updateUploadProgress(file.name, percentComplete);
                    }
                });
                
                xhr.addEventListener('load', function() {
                    if (xhr.status === 200) {
                        resolve(JSON.parse(xhr.responseText));
                    } else {
                        reject(new Error(`Upload failed: ${xhr.statusText}`));
                    }
                });
                
                xhr.addEventListener('error', function() {
                    reject(new Error('Upload failed: Network error'));
                });
                
                // Configure request based on provider
                if (currentProvider === 'google') {
                    const metadata = { name: file.name };
                    const form = new FormData();
                    form.append('metadata', new Blob([JSON.stringify(metadata)], {type: 'application/json'}));
                    form.append('file', file);
                    
                    xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                    xhr.send(form);
                } else if (currentProvider === 'onedrive') {
                    const uploadUrl = `https://graph.microsoft.com/v1.0/me/drive/root:/${encodeURIComponent(file.name)}:/content`;
                    
                    xhr.open('PUT', uploadUrl);
                    xhr.setRequestHeader('Authorization', `Bearer ${accessToken}`);
                    xhr.setRequestHeader('Content-Type', file.type);
                    xhr.send(file);
                }
            });
        }

        function updateUploadProgress(fileName, percent) {
            // Implementation for showing upload progress
            console.log(`Upload progress for ${fileName}: ${percent.toFixed(1)}%`);
        }

        // Initialize all features
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupDragAndDrop();
            setupAccessibility();
            setupAdvancedSearch();
            setupAdvancedSorting();
            setupThemeToggle();
            setupPWA();
            setupPerformanceMonitoring();
        });
    </script>

    <!-- Load Google APIs -->
    <script src="https://apis.google.com/js/api.js"></script>
</body>
</html>