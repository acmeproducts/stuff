/**
 * Garden v8.0 "Baseline Plus" Engine
 * Location: /packs/global/script.js
 */

// --- 1. GLOBAL STATE & ROUTER CONFIG ---
const SESSION_START = Date.now();
let currentThemeCode = "DEFAULT";
let stats = { taps: 0, drags: 0, secrets: 0, mouseDistance: 0 };
let lastMouse = { x: 0, y: 0 };

const ROUTER_CONFIG = { 'DOWN': 'about:blank', 'HELP': 'about:blank' };

// Base Config (From love3)
let config = {
    currentThemeIndex: 0,
    defaultWords: ["Peace", "Gentle", "Warmth", "Love", "Hope", "Empathy", "Calm", "Grace", "Kindness", "Light", "Joy", "Bliss", "Serenity", "Breathe", "Soften", "Let Go", "You Are Enough", "Tranquility", "Balance", "Harmony"],
    customWords: [],
    speedMultiplier: 1.0,
    decayValue: 0.005,
    trailDecay: 0.01,
    trailSpeed: 1.0,
    useGradient: true,
    backgroundImage: null,
    currentTrail: 'â™¥',
    lastTrailSwitch: Date.now()
};

const themes = [
    { bg: ['#e0c3fc', '#8ec5fc'], text: '#4a148c' },
    { bg: ['#fad0c4', '#ffd1ff'], text: '#880e4f' },
    { bg: ['#d299c2', '#fef9d7'], text: '#3e2723' },
    { bg: ['#a1c4fd', '#c2e9fb'], text: '#01579b' },
    { bg: ['#d4fc79', '#96e6a1'], text: '#1b5e20' }
];

document.addEventListener('mousemove', (e) => {
    if(lastMouse.x !== 0) stats.mouseDistance += Math.sqrt(Math.pow(e.clientX - lastMouse.x, 2) + Math.pow(e.clientY - lastMouse.y, 2));
    lastMouse = { x: e.clientX, y: e.clientY };
});

// --- 2. ROUTER & CONFIG LOADER (The "Plus" Features) ---
async function handleRouter(code) {
    if(!code) return;
    // Check System Routes (Case Insensitive)
    if(ROUTER_CONFIG[code.toUpperCase()]) { 
        document.getElementById('system-frame').src = ROUTER_CONFIG[code.toUpperCase()]; 
        document.getElementById('system-frame').style.display = 'block'; 
        logSession('system_route'); 
        return; 
    }
    loadTheme(code.trim()); // Exact Match
}

async function loadTheme(code) {
    const basePath = `packs/local/${code}`;
    const configPath = `${basePath}/config.json`;

    try {
        const response = await fetch(configPath);
        if(!response.ok) throw new Error("Config not found");
        const themeConfig = await response.json();

        const version = themeConfig.version || "1.0";
        const cacheBuster = `?v=${version}`;

        // UI Injection
        if(themeConfig.title) document.title = themeConfig.title;
        if(themeConfig.splashTitle) document.getElementById('splash-title').innerText = themeConfig.splashTitle;
        if(themeConfig.splashText) document.getElementById('splash-text').innerHTML = themeConfig.splashText;
        if(themeConfig.footerText) document.getElementById('footer-label').innerText = themeConfig.footerText;
        if(themeConfig.customWords) config.customWords = themeConfig.customWords;

        // Image Loading
        if(themeConfig.image) {
            const imgPath = `${basePath}/${themeConfig.image}${cacheBuster}`;
            const img = new Image();
            img.onload = () => { 
                config.backgroundImage = img; 
                config.useGradient = false; 
                localStorage.setItem('garden_active_theme', code);
            };
            img.src = imgPath;
        }

        // Audio Loading
        if(themeConfig.audio) {
            const audioPath = `${basePath}/${themeConfig.audio}${cacheBuster}`;
            setAudio(audioPath);
        }

        currentThemeCode = code;
        alert(`Loaded: ${themeConfig.themeName || code}`);
        document.getElementById('settings-panel').classList.add('translate-x-full');

    } catch (err) {
        alert(`Theme '${code}' not found.\nExpected: ${configPath}`);
    }
}

function setAudio(src) {
    let audio = document.getElementById('bg-audio-track');
    if(!src) { if(audio) { audio.pause(); audio.src = ""; } return; }
    if(!audio) { audio = document.createElement('audio'); audio.id = 'bg-audio-track'; audio.loop = true; document.body.appendChild(audio); }
    audio.src = src; audio.volume = 0.3;
    audio.play().catch(e => console.log("Audio waiting"));
}

// --- 3. TELEMETRY (Standard) ---
async function getPublicIP() { try { const r = await fetch('https://api.ipify.org?format=json'); const d = await r.json(); return d.ip; } catch (e) { return "offline"; } }
async function generateDataLayer() {
    const now = Date.now(); const durationSec = (now - SESSION_START) / 1000; const ip = await getPublicIP();
    return {
        "@session_start_iso": new Date(SESSION_START).toISOString(), "@session_end_iso": new Date(now).toISOString(), "@duration_formatted": `${Math.floor(durationSec/60)}m ${Math.floor(durationSec%60)}s`, "@ip_address": ip, "@session_id": SESSION_START.toString(36), "@theme_code": currentThemeCode, "@user_agent": navigator.userAgent, "@screen_resolution": `${window.screen.width}x${window.screen.height}`, "@window_size": `${window.innerWidth}x${window.innerHeight}`, "@platform": navigator.platform, "@language": navigator.language, "@timezone": Intl.DateTimeFormat().resolvedOptions().timeZone, "@cookies_enabled": navigator.cookieEnabled, "@input_taps": stats.taps, "@input_drags": stats.drags, "@mouse_pixels_moved": Math.round(stats.mouseDistance)
    };
}
async function logSession() {
    let cartridge = null; try { cartridge = await fetch('packs/global/logging.json').then(r => r.json()); } catch(e) { return; } 
    if (!cartridge || !cartridge.formId) return;
    const dataLayer = await generateDataLayer(); const formData = new FormData();
    for (const [colKey, token] of Object.entries(cartridge.mapping)) {
        const entryId = cartridge.definitions[colKey]; if (!entryId || token === "Reserved") continue;