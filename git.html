<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GitHub Tablet Editor ‚Äî v12</title>
<style>
  :root{
    --gap:8px;--pad:12px;--border:1px solid #d0d7de;--radius:8px;
    --bg:#f6f8fa;--fg:#24292f;--muted:#57606a;--accent:#0969da;--ok:#1a7f37;--err:#d1242f;
    --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:14px}
  .wrap{height:100vh;display:flex;flex-direction:column;gap:var(--gap);padding:var(--pad);overflow:hidden}
  h1{margin:0 0 4px 0;font-size:16px;font-weight:600}
  .muted{color:var(--muted);font-size:11px;line-height:1.3}
  .card{background:#fff;border:var(--border);border-radius:var(--radius);padding:var(--pad)}
  .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center}
  .col{display:flex;flex-direction:column;gap:var(--gap)}
  label{font-size:11px;color:var(--muted);display:block;margin-bottom:3px;font-weight:500}
  input[type=text],input[type=search],select{padding:8px 10px;border:var(--border);border-radius:6px;background:#fff;font-size:14px;min-width:0;flex:1}
  button{padding:8px 12px;border:var(--border);border-radius:6px;background:#fff;font-weight:500;cursor:pointer;font-size:13px;white-space:nowrap;min-height:36px}
  button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  button.secondary{background:#f3f4f6;border-color:#d1d5db}
  button.success{background:var(--ok);color:#fff;border-color:var(--ok)}
  .icon{padding:6px 8px;min-width:36px}
  .upload-btn{position:relative;overflow:hidden}
  .upload-btn input[type=file]{position:absolute;left:-9999px;opacity:0}
  
  /* Inline dropdown for omni search */
  .omni-wrap{position:relative;flex:1;min-width:0}
  .omni-list{
    position:absolute; top:100%; left:0; right:0; z-index:50;
    background:#fff; border:var(--border); border-radius:6px; margin-top:4px;
    max-height:40vh; overflow:auto; display:none;
  }
  .omni-item{padding:8px 10px; border-bottom:var(--border); font-family:var(--mono); font-size:11px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; cursor:pointer}
  .omni-item:last-child{border-bottom:none}
  .omni-item:hover{background:#f0f3f6}
  
  /* Mobile-first responsive grid */
  .grid{display:flex;flex-direction:column;gap:var(--gap);height:calc(100vh - 140px);min-height:0}
  
  @media (min-width: 768px) {
    :root{--gap:12px;--pad:16px}
    body{font-size:15px}
    h1{font-size:18px}
    .muted{font-size:12px}
    .wrap{padding:var(--pad)}
    .grid{height:calc(100vh - 180px)}
  }
  
  @media (min-width: 1024px) {
    .grid{display:grid;grid-template-columns:1fr 1fr;height:calc(100vh - 200px)}
  }
  
  .pane{display:flex;flex-direction:column;min-height:0;flex:1}
  .pane .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .header-title{font-size:13px;font-weight:600;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .header-actions{display:flex;gap:6px;align-items:center}
  .chev{font-weight:700;cursor:pointer;border:none;background:transparent;font-size:16px;line-height:1;padding:4px;min-width:28px;color:var(--muted)}
  .chev:hover{color:var(--fg)}
  
  .textarea-wrap{display:flex;flex-direction:column;gap:6px;min-height:0;flex:1}
  textarea{width:100%;border:var(--border);border-radius:6px;font-family:var(--mono);font-size:12px;line-height:1.4;resize:vertical;min-height:120px;overflow:auto;padding:10px}
  .controls{display:flex;gap:6px;align-items:center;flex-wrap:wrap;justify-content:center}
  
  /* Mobile controls optimization */
  @media (max-width: 767px) {
    .controls{gap:4px}
    .controls button{flex:1;min-width:0;padding:10px 8px;font-size:12px}
  }
  
  .collapsed .textarea-wrap{display:none}
  .collapsed .header-title::after{content:" (collapsed)"; color:var(--muted); font-weight:400; font-size:11px}
  
  /* Original pane mobile optimization */
  #originalBox {height: 100px; resize: none;}
  #paneOriginal .textarea-wrap {flex: none;}
  @media (min-width: 768px) {
    #originalBox {height: 120px;}
  }
  
  /* Filename inputs responsive layout */
  .filename-row{display:flex;gap:var(--gap);align-items:end}
  .filename-main{flex:3;min-width:0}
  .filename-ext{flex:1;min-width:60px;max-width:100px}
  
  @media (max-width: 567px) {
    .filename-row{flex-direction:column;align-items:stretch}
    .filename-ext{max-width:none}
  }
  
  /* Repository inputs responsive */
  .repo-row{display:grid;grid-template-columns:1fr 1fr 2fr;gap:var(--gap);align-items:end}
  @media (max-width: 767px) {
    .repo-row{grid-template-columns:1fr;gap:8px}
  }
  @media (min-width: 768px) and (max-width: 1023px) {
    .repo-row{grid-template-columns:1fr 2fr;gap:var(--gap)}
    .repo-row .omni-wrap{grid-column:1/-1}
  }
  
  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px;z-index:9990}
  .modal.open{display:flex}
  .panel{background:#fff;border:var(--border);border-radius:var(--radius);overflow:auto;padding:16px;display:flex;flex-direction:column;max-height:90vh;width:90vw;max-width:1000px}
  
  @media (min-width: 768px) {
    .panel{width:80vw;max-width:1200px}
    #diffModal .panel, #previewModal .panel {height:80vh}
  }
  
  .panel header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-shrink:0}
  .panel header h2{margin:0;font-size:16px;font-weight:600}
  .panel header button{border:none;background:transparent;font-weight:700;font-size:18px;cursor:pointer;padding:4px;min-width:32px}
  pre.diff{background:#0b1021;color:#e6edf3;padding:12px;border-radius:6px;overflow:auto;flex-grow:1;font-size:11px;line-height:1.3}
  #previewFrame{width:100%;height:60vh;border:var(--border);border-radius:6px;flex-grow:1}
  @media (min-width: 768px) {
    #previewFrame{height:100%}
  }
  
  .status-ok{color:var(--ok)} .status-err{color:var(--err)}
  .status-ok a { color: var(--ok); text-decoration: underline; }
  
  /* Launch link styling */
  .launch-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .launch-btn{background:var(--ok);color:#fff;border-color:var(--ok);text-decoration:none;display:inline-flex;align-items:center;gap:4px}
  .launch-btn:hover{background:#0d7033}
  
  /* Toast */
  .toast-wrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:grid;gap:6px;z-index:9999;max-width:90vw}
  .toast{background:#111827;color:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);font-size:13px;text-align:center}
  .warn{background:#c81e1e}
  
  /* Utility classes */
  .center{display:flex;justify-content:center}
  .hidden{display:none !important}
</style>
</head>
<body>
<div class="wrap">
  <div>
    <h1>GitHub Tablet Editor</h1>
    <div class="muted">Mobile-optimized editor with file upload support and direct launch links to GitHub Pages.</div>
  </div>

  <div class="card" id="repoCard">
    <div class="repo-row">
      <div>
        <label for="userInput">User</label>
        <input type="text" id="userInput" value="acmeproducts">
      </div>
      <div>
        <label for="repoSelect">Repository</label>
        <select id="repoSelect" disabled><option>Loading‚Ä¶</option></select>
      </div>
      <div class="omni-wrap">
        <label for="searchInput">Search Files</label>
        <input type="search" id="searchInput" placeholder="Type to search files‚Ä¶" autocomplete="off">
        <div id="omniList" class="omni-list" role="listbox" aria-label="File results"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <!-- Original -->
    <div class="pane card collapsed" id="paneOriginal">
      <div class="header">
        <strong class="header-title" id="originalTitle">(no file selected)</strong>
        <button class="chev" id="chevOriginal" title="Toggle" type="button">‚ñ∂</button>
      </div>
      <div class="textarea-wrap">
        <textarea id="originalBox" readonly placeholder="Original file content will appear here‚Ä¶"></textarea>
      </div>
      <div class="center controls">
        <button id="copyOriginal" type="button">Copy</button>
        <button id="previewOriginal" type="button">Preview</button>
        <button id="reloadOriginal" type="button">Reload</button>
      </div>
    </div>

    <!-- Updated -->
    <div class="pane card" id="paneUpdated">
      <div class="header">
        <strong class="header-title">Updated</strong>
        <div class="header-actions">
          <button class="upload-btn secondary" id="uploadBtn" type="button" title="Upload file">
            üìÅ Upload
            <input type="file" id="fileInput" accept="*/*">
          </button>
          <button class="chev" id="chevUpdated" title="Toggle" type="button">‚ñº</button>
        </div>
      </div>
      <div class="col">
        <div class="filename-row">
          <div class="filename-main">
            <label for="filenameInput">Filename</label>
            <input type="text" id="filenameInput" placeholder="Enter filename">
          </div>
          <div class="filename-ext">
            <label for="fileExtInput">Extension</label>
            <input type="text" id="fileExtInput" placeholder=".html">
          </div>
        </div>
        <div class="center controls">
          <button id="pasteBtn" type="button">üìã Paste</button>
          <button id="diffBtn" type="button">üëÅ Diff</button>
          <button id="commitBtn" class="primary" type="button">‚úì Commit</button>
        </div>
        <div class="textarea-wrap">
          <textarea id="updatedBox" placeholder="Paste updated content here or upload a file above‚Ä¶"></textarea>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Commit Modal -->
<div id="commitModal" class="modal" role="dialog" aria-modal="true" aria-label="Commit status">
  <div class="panel">
    <header>
      <h2>Commit Status</h2>
      <button id="commitClose" title="Close" type="button">‚úï</button>
    </header>
    <ol id="commitSteps"></ol>
    <div id="commitActions" class="center" style="margin-top: 16px;">
      <button id="copyCommitLogBtn" type="button">Copy Log</button>
    </div>
  </div>
</div>

<!-- Diff Modal -->
<div id="diffModal" class="modal" role="dialog" aria-modal="true" aria-label="Diff view">
  <div class="panel">
    <header>
      <h2>Diff Preview</h2>
      <button id="diffClose" title="Close" type="button">‚úï</button>
    </header>
    <pre id="diffOutput" class="diff"></pre>
  </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal" role="dialog" aria-modal="true" aria-label="Preview">
  <div class="panel">
    <header>
      <h2>Preview</h2>
      <button id="previewClose" title="Close" type="button">‚úï</button>
    </header>
    <iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe>
  </div>
</div>

<!-- Paste Fallback Modal -->
<div id="pasteModal" class="modal" role="dialog" aria-modal="true" aria-label="Paste content">
  <div class="panel">
    <header>
      <h2>Paste Content</h2>
      <button id="pasteClose" title="Close" type="button">‚úï</button>
    </header>
    <div class="muted" style="margin-bottom:8px">Clipboard read not permitted. Paste here and confirm.</div>
    <textarea id="pasteArea" style="width:100%;height:40vh;min-height:200px"></textarea>
    <div class="center" style="margin-top:10px">
      <button id="pasteConfirm" class="primary" type="button">Use This Content</button>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  
let GITHUB_TOKEN = localStorage.getItem('github_pat');
// This loop ensures a token is provided before the app runs.
while (!GITHUB_TOKEN || GITHUB_TOKEN.trim() === '') {
  const input = prompt("Enter your GitHub Personal Access Token:");
  if (input && input.trim()) {
    GITHUB_TOKEN = input.trim();
    localStorage.setItem('github_pat', GITHUB_TOKEN);
  }
}

  const DEFAULT_USER = "acmeproducts";
  const DEFAULT_REPO_HINT = "stuff";

  // Elements
  const userInput = document.getElementById('userInput');
  const repoSelect = document.getElementById('repoSelect');
  const searchInput = document.getElementById('searchInput');
  const omniList = document.getElementById('omniList');

  const paneOriginal = document.getElementById('paneOriginal');
  const chevOriginal = document.getElementById('chevOriginal');
  const originalTitle = document.getElementById('originalTitle');
  const originalBox = document.getElementById('originalBox');
  const copyOriginalBtn = document.getElementById('copyOriginal');
  const previewOriginalBtn = document.getElementById('previewOriginal');
  const reloadOriginalBtn = document.getElementById('reloadOriginal');

  const paneUpdated = document.getElementById('paneUpdated');
  const chevUpdated = document.getElementById('chevUpdated');
  const updatedBox = document.getElementById('updatedBox');
  const filenameInput = document.getElementById('filenameInput');
  const fileExtInput = document.getElementById('fileExtInput');
  const uploadBtn = document.getElementById('uploadBtn');
  const fileInput = document.getElementById('fileInput');
  const pasteBtn = document.getElementById('pasteBtn');
  const diffBtn = document.getElementById('diffBtn');
  const commitBtn = document.getElementById('commitBtn');

  const commitModal = document.getElementById('commitModal');
  const commitClose = document.getElementById('commitClose');
  const commitSteps = document.getElementById('commitSteps');
  const commitActions = document.getElementById('commitActions');
  const copyCommitLogBtn = document.getElementById('copyCommitLogBtn');
  const diffModal = document.getElementById('diffModal');
  const diffClose = document.getElementById('diffClose');
  const diffOutput = document.getElementById('diffOutput');
  const previewModal = document.getElementById('previewModal');
  const previewClose = document.getElementById('previewClose');
  const previewFrame = document.getElementById('previewFrame');
  const pasteModal = document.getElementById('pasteModal');
  const pasteClose = document.getElementById('pasteClose');
  const pasteArea = document.getElementById('pasteArea');
  const pasteConfirm = document.getElementById('pasteConfirm');
  const toasts = document.getElementById('toasts');

  // State
  let currentUser = DEFAULT_USER;
  let currentRepo = null;
  let repoDefaultBranch = 'main';
  let treeCache = []; // {path, sha}
  let currentPath = null;
  let currentSha = null;

  // --- Helpers ---
  const headers = () => ({
    "Authorization": "token " + GITHUB_TOKEN,
    "Accept": "application/vnd.github.v3+json"
  });

  const isSecure = window.isSecureContext;

  /**
   * Displays a toast message at the bottom of the screen.
   * @param {string} msg The message to display.
   * @param {number} ms Duration in milliseconds.
   * @param {string} cls CSS class ('warn' for errors).
   */
  function toast(msg, ms=2200, cls=''){
    const div = document.createElement('div');
    div.className = 'toast' + (cls ? ' '+cls : '');
    div.textContent = msg;
    toasts.appendChild(div);
    setTimeout(()=>{ div.remove(); }, ms);
  }

  /**
   * Centralized error handler to display issues to the user via toasts.
   * @param {Error} error The error object.
   * @param {string} context A user-friendly message describing the failed action.
   */
  function handleError(error, context) {
      console.error(context, error); // Log for developers if console is available
      const message = `${context}: ${error.message || 'An unknown error occurred.'}`;
      toast(message, 4500, 'warn');
  }

  function setPaneCollapsed(el, chev, collapsed){
    el.classList.toggle('collapsed', collapsed);
    chev.innerHTML = collapsed ? '‚ñ∂' : '‚ñº';
  }

  function b64EncodeUnicode(str){
    const bytes = new TextEncoder().encode(str);
    let bin=''; bytes.forEach(b=>bin+=String.fromCharCode(b));
    return btoa(bin);
  }
  function b64DecodeUnicode(b64){
    const bin = atob(b64);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }

  /**
   * Normalizes text content for reliable diffing.
   * @param {string} text The input text.
   * @returns {string} The normalized text.
   */
  function canonicalize(text){
    if(text == null) return '';
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1); // Remove BOM
    text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n'); // Normalize newlines
    text = text.split('\n').map(l => l.replace(/[\t ]+$/,'')).join('\n'); // Trim trailing whitespace
    return text;
  }

  // --- GitHub API Functions ---
  
  /**
   * Generic fetch wrapper for GitHub API calls with error handling.
   * @param {string} url The API URL to fetch.
   * @param {object} options The fetch options.
   * @returns {Promise<any>} The JSON response.
   */
  async function githubFetch(url, options = {}) {
      const res = await fetch(url, { ...options, headers: headers() });
      if (!res.ok) {
          const errorBody = await res.text();
          throw new Error(`GitHub API Error (${res.status}): ${errorBody}`);
      }
      // Handle cases with no JSON body (e.g., 204 No Content)
      if (res.status === 204) return null;
      return res.json();
  }

  async function fetchReposForIdentity(identity){
    // This function fetches from multiple endpoints, so we handle errors internally.
    const collected = new Map();
    const urls = [
        `https://api.github.com/users/${encodeURIComponent(identity)}/repos?per_page=100&type=owner&sort=updated`,
        `https://api.github.com/orgs/${encodeURIComponent(identity)}/repos?per_page=100&type=all&sort=updated`,
        `https://api.github.com/user/repos?per_page=100&sort=updated`
    ];
    const tasks = urls.map(url => 
        githubFetch(url).then(data => {
            (data || []).forEach(r => {
                if (r.owner && r.owner.login.toLowerCase() === identity.toLowerCase() && !collected.has(r.name)) {
                    collected.set(r.name, r);
                }
            });
        }).catch(() => { /* Ignore individual fetch failures */ })
    );
    await Promise.all(tasks);
    return Array.from(collected.values()).sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));
  }
  async function fetchRepoInfo(user, repo){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}`;
    return githubFetch(url);
  }
  async function fetchRepoTree(user, repo, branch){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/git/trees/${encodeURIComponent(branch)}?recursive=1`;
    const data = await githubFetch(url);
    if(!data.tree) throw new Error('Invalid tree response');
    return data.tree.filter(e=>e.type==='blob').map(e=>({path:e.path,sha:e.sha}));
  }
  async function fetchFileContent(user, repo, path, ref){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}${ref?`?ref=${encodeURIComponent(ref)}`:''}`;
    try {
        const data = await githubFetch(url);
        const content = b64DecodeUnicode((data.content||'').replace(/\n/g,''));
        return {content, sha:data.sha, path:data.path};
    } catch (error) {
        // A 404 is a valid case when checking for a new file, return null.
        if (error.message.includes("404")) return null;
        throw error; // Re-throw other errors.
    }
  }
  async function putFileContent(user, repo, path, message, newContent, branch, sha){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const payload = {message, content:b64EncodeUnicode(newContent), branch};
    if (sha) payload.sha = sha;
    return githubFetch(url, {
      method:'PUT', body:JSON.stringify(payload)
    });
  }

  // --- Diff Generation ---
  function renderUnifiedDiff(oldText, newText, filename) {
    const oldLines = canonicalize(oldText || '').split('\n');
    const newLines = canonicalize(newText || '').split('\n');
    
    // Simple line-by-line diff
    let diff = `--- a/${filename}\n+++ b/${filename}\n`;
    
    for (let i = 0; i < Math.max(oldLines.length, newLines.length); i++) {
      const oldLine = oldLines[i] || '';
      const newLine = newLines[i] || '';
      
      if (oldLine !== newLine) {
        if (oldLines[i] !== undefined) {
          diff += `-${oldLine}\n`;
        }
        if (newLines[i] !== undefined) {
          diff += `+${newLine}\n`;
        }
      } else {
        diff += ` ${oldLine}\n`;
      }
    }
    
    return diff;
  }

  // --- UI and Event Handlers ---

  function hideOmni(){ omniList.style.display='none'; }
  function showOmni(){ omniList.style.display='block'; }
  function clearOmni(){ omniList.innerHTML=''; }

  function filterResultsInline(){
    const q=(searchInput.value||'').toLowerCase().trim();
    clearOmni();
    if(!q){ hideOmni(); return; }
    let items = treeCache.filter(e=> e.path.toLowerCase().includes(q));
    items = items.slice().sort((a,b)=>{
      const qa = a.path.toLowerCase().endsWith(q) ? 0 : a.path.length;
      const qb = b.path.toLowerCase().endsWith(q) ? 0 : b.path.length;
      return qa - qb;
    }).slice(0,300);
    if(!items.length){ hideOmni(); return; }
    for(const it of items){
      const div=document.createElement('div');
      div.className='omni-item'; div.textContent=it.path; div.title=it.path;
      div.addEventListener('click',()=>{ onSelectPath(it.path); hideOmni(); });
      omniList.appendChild(div);
    }
    showOmni();
  }

  function populateFilenameFields(path) {
    if (!path) {
        filenameInput.value = '';
        fileExtInput.value = '';
        return;
    }
    const lastDot = path.lastIndexOf('.');
    const lastSlash = path.lastIndexOf('/');
    if (lastDot > -1 && lastDot > lastSlash) {
        filenameInput.value = path.substring(0, lastDot);
        fileExtInput.value = path.substring(lastDot);
    } else {
        filenameInput.value = path;
        fileExtInput.value = '';
    }
  }

  async function onSelectPath(path){
    try{
      const fileData = await fetchFileContent(currentUser, currentRepo, path, repoDefaultBranch);
      if (!fileData) throw new Error("File not found in repository.");
      currentPath = path; currentSha = fileData.sha;
      originalTitle.textContent = path;
      originalBox.value = fileData.content;
      updatedBox.value = '';
      populateFilenameFields(path);
      setPaneCollapsed(paneOriginal, chevOriginal, true);
      toast('File loaded');
    }catch(e){ handleError(e, `Failed to load ${path}`); }
  }

  async function refreshRepoContext(){
    try {
        currentUser = userInput.value.trim();
        currentRepo = repoSelect.value.trim();
        if(!currentUser){ toast('User required', 2500, 'warn'); return; }
        if(!currentRepo){ toast('Select a repository', 2500, 'warn'); return; }
        const info = await fetchRepoInfo(currentUser, currentRepo);
        repoDefaultBranch = info.default_branch || 'main';
        treeCache = await fetchRepoTree(currentUser, currentRepo, repoDefaultBranch);
        hideOmni(); clearOmni(); searchInput.value='';
        currentPath=null; currentSha=null; originalBox.value=''; updatedBox.value=''; originalTitle.textContent='(no file selected)';
        populateFilenameFields(null);
    } catch(e) {
        handleError(e, "Failed to refresh repository context");
    }
  }

  async function populateRepos(identity, prefer){
    repoSelect.disabled = true;
    repoSelect.innerHTML = '<option>Loading‚Ä¶</option>';
    try{
      const repos = await fetchReposForIdentity(identity);
      repoSelect.innerHTML = '';
      if(!repos.length){
        repoSelect.innerHTML = '<option value="">No repositories found</option>';
        toast('No repositories found for '+identity, 3500, 'warn');
      } else {
        repos.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.name; opt.textContent = r.name;
          if(prefer && r.name.toLowerCase()===prefer.toLowerCase()) opt.selected = true;
          repoSelect.appendChild(opt);
        });
      }
    }catch(e){
      repoSelect.innerHTML = '<option value="">Error loading repos</option>';
      handleError(e, "Failed to load repositories");
    }finally{
      repoSelect.disabled = false;
    }
  }

  // File upload handler
  async function handleFileUpload(file) {
    try {
      // Extract filename and extension
      const fileName = file.name;
      const lastDot = fileName.lastIndexOf('.');
      const lastSlash = fileName.lastIndexOf('/');
      
      if (lastDot > -1 && lastDot > lastSlash) {
        filenameInput.value = fileName.substring(0, lastDot);
        fileExtInput.value = fileName.substring(lastDot);
      } else {
        filenameInput.value = fileName;
        fileExtInput.value = '';
      }

      // Read file content
      const content = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(new Error('Failed to read file'));
        reader.readAsText(file);
      });

      updatedBox.value = content;
      setPaneCollapsed(paneUpdated, chevUpdated, false);
      toast(`File "${fileName}" uploaded successfully`);
      
    } catch (error) {
      handleError(error, "Failed to upload file");
    }
  }

  // Clipboard helpers
  async function robustCopy(text){
    try{
      await navigator.clipboard.writeText(text);
      toast('Copied');
    }catch{
      try {
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
        ta.focus(); ta.select(); document.execCommand('copy'); ta.remove();
        toast('Copied');
      } catch (e) {
        handleError(e, "Failed to copy text");
      }
    }
  }

  async function robustPaste(){
    if(isSecure){
      try{
        return await navigator.clipboard.readText();
      }catch{
        return await modalPaste();
      }
    } else {
      return await modalPaste();
    }
  }
  function modalPaste(){
    pasteArea.value='';
    pasteModal.classList.add('open');
    return new Promise((resolve)=>{
      const onConfirm = () => { cleanup(); resolve(pasteArea.value); };
      const onClose = () => { cleanup(); resolve(''); };
      const cleanup = () => {
        pasteModal.classList.remove('open');
        pasteConfirm.removeEventListener('click', onConfirm);
        pasteClose.removeEventListener('click', onClose);
      };
      pasteConfirm.addEventListener('click', onConfirm);
      pasteClose.addEventListener('click', onClose);
    });
  }

  // Create launch link
  function createLaunchLink(user, repo, filePath) {
    const launchUrl = `https://${user}.github.io/${repo}/${filePath}`;
    const launchLink = document.createElement('a');
    launchLink.href = launchUrl;
    launchLink.target = '_blank';
    launchLink.rel = 'noopener noreferrer';
    launchLink.className = 'launch-btn';
    launchLink.innerHTML = 'üöÄ Launch';
    launchLink.title = `Open ${launchUrl}`;
    return launchLink;
  }

  // --- Event Listeners ---
  chevOriginal.addEventListener('click',()=> setPaneCollapsed(paneOriginal, chevOriginal, !paneOriginal.classList.contains('collapsed')));
  chevUpdated.addEventListener('click',()=> setPaneCollapsed(paneUpdated, chevUpdated, !paneUpdated.classList.contains('collapsed')));

  copyOriginalBtn.addEventListener('click', () => robustCopy(originalBox.value||''));
  reloadOriginalBtn.addEventListener('click', () => {
    if(currentPath) {
      toast('Reloading...');
      onSelectPath(currentPath);
    } else {
      toast('No file selected to reload', 2500, 'warn');
    }
  });

  previewOriginalBtn.addEventListener('click', ()=>{
    const html = originalBox.value || '';
    // If content already includes html/head/body, use as-is; otherwise wrap
    const hasHtml = /<html[\s>]/i.test(html);
    const finalHtml = hasHtml ? html : `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Preview</title></head><body>${html}</body></html>`;
    previewFrame.srcdoc = finalHtml;
    previewModal.classList.add('open');
  });
  previewClose.addEventListener('click',()=> {
    previewModal.classList.remove('open');
    previewFrame.srcdoc = ''; // Clear content to stop scripts/videos
  });

  // Upload button and file input
  uploadBtn.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) {
      handleFileUpload(file);
    }
  });

  pasteBtn.addEventListener('click', async ()=>{
    setPaneCollapsed(paneUpdated, chevUpdated, false);
    updatedBox.focus();
    const text = await robustPaste();
    if(text !== undefined && text !== null){
      updatedBox.value = text;
      if(text) toast('Pasted');
    }
  });

  diffBtn.addEventListener('click', ()=>{
    if(!currentPath && !filenameInput.value){ toast('No file selected or named', 2500, 'warn'); return; }
    const newPath = (filenameInput.value || '') + (fileExtInput.value || '');
    const diff = renderUnifiedDiff(originalBox.value||'', updatedBox.value||'', newPath || currentPath);
    diffOutput.textContent = diff;
    diffModal.classList.add('open');
  });
  diffClose.addEventListener('click',()=> diffModal.classList.remove('open'));

  function setStatus(text, cls){
    const li=document.createElement('li'); li.textContent=text; if(cls) li.className=cls;
    commitSteps.appendChild(li); commitSteps.scrollTop = commitSteps.scrollHeight;
  }

  commitBtn.addEventListener('click', async ()=>{
    const newPath = (filenameInput.value.trim() + fileExtInput.value.trim());
    if (!newPath) {
        toast('Filename cannot be empty.', 2500, 'warn');
        return;
    }

    commitSteps.innerHTML=''; 
    // Reset commit actions to just show copy button initially
    commitActions.innerHTML = '<button id="copyCommitLogBtn" type="button">Copy Log</button>';
    commitModal.classList.add('open');
    
    setStatus('Validating selection‚Ä¶');
    setStatus(`Preparing commit to ${currentUser}/${currentRepo}@${repoDefaultBranch}`);
    
    try {
        setStatus(`Checking for existing file at "${newPath}"...`);
        const existingFile = await fetchFileContent(currentUser, currentRepo, newPath, repoDefaultBranch);
        
        const shaForCommit = existingFile ? existingFile.sha : null;
        const message = existingFile ? `Update ${newPath}` : `Create ${newPath}`;
        setStatus(existingFile ? `File exists. Preparing to update.` : `File does not exist. Preparing to create.`);

        setStatus('Pushing commit via GitHub API‚Ä¶');
        const resp = await putFileContent(currentUser, currentRepo, newPath, message, updatedBox.value, repoDefaultBranch, shaForCommit);
        const csha = resp.commit && resp.commit.sha ? resp.commit.sha.substring(0,7) : 'unknown';
        
        const li = document.createElement('li');
        li.className = 'status-ok';
        const a = document.createElement('a');
        a.href = `https://github.com/${currentUser}/${currentRepo}/commit/${resp.commit.sha}`;
        a.target = '_blank';
        a.rel = 'noopener noreferrer';
        a.textContent = `Commit succeeded: ${csha}`;
        li.appendChild(a);
        commitSteps.appendChild(li);
        
        // Add deployment status link
        const deployLi = document.createElement('li');
        deployLi.className = 'status-ok';
        const deployLink = document.createElement('a');
        deployLink.href = `https://github.com/${currentUser}/${currentRepo}/actions/workflows/static.yml`;
        deployLink.target = '_blank';
        deployLink.rel = 'noopener noreferrer';
        deployLink.textContent = `View deployment status ‚Üí`;
        deployLi.appendChild(deployLink);
        commitSteps.appendChild(deployLi);
        
        commitSteps.scrollTop = commitSteps.scrollHeight;
      
        // Add launch link to commit actions
        const launchActions = document.createElement('div');
        launchActions.className = 'launch-actions';
        
        const copyBtn = document.createElement('button');
        copyBtn.id = 'copyCommitLogBtn';
        copyBtn.textContent = 'Copy Log';
        copyBtn.addEventListener('click', () => {
          const logText = Array.from(commitSteps.querySelectorAll('li')).map(li => li.textContent).join('\n');
          robustCopy(logText);
        });
        
        const launchLink = createLaunchLink(currentUser, currentRepo, newPath);
        
        launchActions.appendChild(copyBtn);
        launchActions.appendChild(launchLink);
        commitActions.innerHTML = '';
        commitActions.appendChild(launchActions);
      
        originalBox.value = updatedBox.value;
        currentPath = newPath;
        currentSha = resp.content.sha;
        originalTitle.textContent = newPath;
        populateFilenameFields(newPath);
      
        fetchRepoTree(currentUser, currentRepo, repoDefaultBranch).then(tree => treeCache = tree);
        toast('Committed');
    } catch(e) {
        setStatus('Commit failed','status-err');
        setStatus(e.message||String(e),'status-err');
        handleError(e, "Commit failed");
    }
  });
  commitClose.addEventListener('click',()=> commitModal.classList.remove('open'));

  repoSelect.addEventListener('change', refreshRepoContext);
  userInput.addEventListener('change', async ()=>{
    const identity = userInput.value.trim();
    await populateRepos(identity, DEFAULT_REPO_HINT);
    await refreshRepoContext();
  });

  searchInput.addEventListener('input', filterResultsInline);
  document.addEventListener('click',(e)=>{ if(!e.target.closest('.omni-wrap')) hideOmni(); });

  // Bootstrap
  (async function init(){
    setPaneCollapsed(paneOriginal, chevOriginal, true);
    setPaneCollapsed(paneUpdated, chevUpdated, false);
    try{
      userInput.value = DEFAULT_USER;
      await populateRepos(DEFAULT_USER, DEFAULT_REPO_HINT);
      await refreshRepoContext();
    }catch(e){
      handleError(e, "Failed to initialize application");
    }
  })();
})();
</script>
</body>
</html>
