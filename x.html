<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v23</title>
    <style>
        :root {
            --primary: #202124;
            --accent: #1a73e8;
            --bg: #f8f9fa;
            --console-bg: #242424;
            --console-text: #eee;
            --border: #dadce0;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        /* --- Nav Bar --- */
        .nav-bar {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .home-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 16px;
            font-weight: 500;
            color: #5f6368;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .home-btn:hover { background: #f1f3f4; color: #202124; }

        input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            background: #f1f3f4;
        }
        input[type="text"]:focus { background: #fff; box-shadow: 0 1px 6px rgba(32,33,36,0.28); }

        .go-btn {
            padding: 10px 24px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        .go-btn:disabled { background-color: #bdc1c6; cursor: wait; }

        /* --- Tabs --- */
        .tab-bar {
            display: flex;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 3px solid transparent;
        }
        .tab-btn.active {
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        /* --- Content Areas --- */
        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
        }
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }

        iframe { width: 100%; height: 100%; border: none; }
        
        .browser-toolbar {
            padding: 8px 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reader-btn {
            background: #34a853;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }
        .reader-btn:disabled { background: #dadce0; color: #888; cursor: not-allowed; }

        /* --- Console Tab --- */
        #panel-console {
            background: var(--console-bg);
            color: var(--console-text);
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-y: auto;
            padding: 10px;
        }
        .console-row { border-bottom: 1px solid #333; padding: 4px 0; word-wrap: break-word; }
        .log-info { color: #8ab4f8; }
        .log-warn { color: #fdd663; background: rgba(253, 214, 99, 0.1); }
        .log-error { color: #f28b82; background: rgba(242, 139, 130, 0.1); }

        /* --- Bookmarks Modal --- */
        #bookmarks-modal {
            position: absolute;
            top: 60px;
            left: 10px;
            width: 250px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
        }
        .bookmark-item {
            padding: 12px 16px;
            text-align: left;
            background: none;
            border: none;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            font-size: 14px;
            color: #3c4043;
        }
        .bookmark-item:hover { background: #f8f9fa; color: var(--accent); }

        /* --- Overlays --- */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #5f6368;
            flex-direction: column;
            gap: 15px;
        }

        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-header { padding: 15px; background: #f1f3f4; border-bottom: 1px solid #dadce0; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { flex: 1; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #202124; }
        .speaking { background-color: #fce8b2; border-left: 5px solid #fbbc04; padding-left: 10px; }

        /* --- System Logs & Source --- */
        .log-container {
            flex: 1;
            background: #202124;
            color: #5bb974;
            padding: 15px;
            font-family: monospace;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #3c4043; padding-bottom: 2px; }
        .sys-nav { color: #fbbc04; }
        .sys-err { color: #ea4335; }
        
        textarea.source-viewer {
            flex: 1; width: 100%; padding: 15px; background: #282c34; color: #abb2bf; font-family: monospace; border: none; resize: none;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px;">üîÑ</div>
        <div id="loading-text">Fetching Content...</div>
    </div>

    <div id="bookmarks-modal">
        <button class="bookmark-item" onclick="useBookmark('https://google.com')">üîç Google Search</button>
        <button class="bookmark-item" onclick="useBookmark('https://news.google.com')">üì∞ Google News</button>
        <button class="bookmark-item" onclick="useBookmark('https://npr.org')">üìª NPR.org</button>
    </div>

    <nav class="nav-bar">
        <button class="home-btn" id="btnHome" onclick="toggleBookmarks()">
            <span>‚≠ê</span> Bookmarks
        </button>
        <input type="text" id="urlInput" placeholder="Enter URL or Search Query" />
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" onclick="switchTab('console')">Console</button>
        <button class="tab-btn" id="tabSource" onclick="switchTab('source')">Source Code</button>
        <button class="tab-btn" onclick="switchTab('logs')">System Logs</button>
    </div>

    <div class="content-area">
        
        <div id="panel-browser" class="panel active">
            <div class="browser-toolbar">
                <div id="status-indicator" style="font-size:12px; color:#5f6368;">Ready</div>
                <button class="reader-btn" id="btnReaderOpen">üìñ Read Page</button>
            </div>
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div id="reader-overlay">
                <div class="reader-header">
                    <strong>Reader Mode</strong>
                    <div style="display:flex; gap: 8px;">
                        <button class="reader-btn" onclick="startAudio()">üîä Play</button>
                        <button class="reader-btn" style="background:#ea4335; display:none;" id="btnStopAudio" onclick="stopAudio()">‚èπ Stop</button>
                        <button class="home-btn" onclick="closeReader()">Close</button>
                    </div>
                </div>
                <div id="reader-content" class="reader-body"></div>
            </div>
        </div>

        <div id="panel-console" class="panel">
            <div class="console-row log-info"><i>Console ready... logs from the page will appear here.</i></div>
        </div>

        <div id="panel-source" class="panel">
            <div style="padding:10px; background:#f1f3f4; text-align:right; border-bottom:1px solid #ccc;">
                <button class="go-btn" style="padding:5px 15px;" id="btnCopySource" onclick="copySource()">Copy Code</button>
            </div>
            <textarea id="source-code" class="source-viewer" spellcheck="false"></textarea>
        </div>

        <div id="panel-logs" class="panel">
            <div class="log-container" id="log-output">
                <div class="log-entry">System Ready. v23 Smart Hub + Console.</div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const PROXIES = [
            { name: "CodeTabs", url: t => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(t)}` },
            { name: "CORSProxy", url: t => `https://corsproxy.io/?${encodeURIComponent(t)}` },
            { name: "AllOrigins", url: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}` }
        ];

        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let currentAudioIndex = 0;

        // --- UTILS ---
        function sysLog(msg, type="info") {
            const container = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'sys-err' : (type === 'nav' ? 'sys-nav' : '');
            container.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="${color}">${msg}</span></div>`;
            container.scrollTop = container.scrollHeight;
        }

        function consoleLog(msg, type='info') {
            const container = document.getElementById('panel-console');
            const div = document.createElement('div');
            div.className = `console-row log-${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            if (tabName === 'source') {
                document.getElementById('source-code').value = fetchedHtml || "Source not available.";
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- BOOKMARKS ---
        function toggleBookmarks() {
            const el = document.getElementById('bookmarks-modal');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        function useBookmark(url) {
            toggleBookmarks();
            loadUrl(url);
        }

        // --- URL LOGIC ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) {
                return `https://www.google.com/search?q=${encodeURIComponent(url)}`;
            }
            if (!url.startsWith('http')) url = 'https://' + url;
            return url;
        }

        // --- MASTER FETCH LOGIC ---
        async function loadUrl(urlOverride) {
            const raw = urlOverride || document.getElementById('urlInput').value;
            const url = fixUrl(raw);
            if(!url) return alert("Invalid URL");

            stopAudio();
            document.getElementById('urlInput').value = url;
            document.getElementById('status-indicator').textContent = "Fetching...";
            document.getElementById('status-indicator').style.color = "#e67e22";
            document.getElementById('panel-console').innerHTML = ""; // Clear console
            toggleLoading(true);
            
            fetchedHtml = ""; 
            sysLog(`Fetching: ${url}`);

            let success = false;

            // SPECIAL CASE: Google News often requires specific proxy handling
            let proxyListToUse = PROXIES;
            if(url.includes('news.google.com')) {
                sysLog("Optimizing proxy order for Google News...", "nav");
                proxyListToUse = [PROXIES[1], PROXIES[0], PROXIES[2]]; // CORSProxy first
            }

            for (let proxy of proxyListToUse) {
                if(success) break;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(proxy.url(url), { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let text = await res.text();
                    if(!text || text.length < 500) throw new Error("Empty/Short content");

                    // --- CLEANUP ---
                    text = cleanHTML(text);

                    // --- INJECTION ---
                    const baseTag = `<base href="${url}" target="_self">`;
                    
                    // THE "SMART HUB" INJECTOR SCRIPT
                    // 1. Intercepts clicks (NPR PJAX + Google Unwrapping)
                    // 2. Intercepts Console logs (for the new tab)
                    const hubScript = `
                        <script>
                        (function() {
                            // --- CONSOLE SPY ---
                            const originalLog = console.log;
                            const originalWarn = console.warn;
                            const originalError = console.error;
                            
                            function sendLog(type, args) {
                                try {
                                    const msg = Array.from(args).map(a => typeof a==='object'? JSON.stringify(a): String(a)).join(' ');
                                    window.parent.postMessage({type: 'console_forward', level: type, msg: msg}, '*');
                                } catch(e){}
                            }

                            console.log = function(...args) { originalLog.apply(console, args); sendLog('info', args); };
                            console.warn = function(...args) { originalWarn.apply(console, args); sendLog('warn', args); };
                            console.error = function(...args) { originalError.apply(console, args); sendLog('error', args); };

                            // --- CLICK INTERCEPTOR (Capture Phase) ---
                            window.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href && !link.href.startsWith('javascript') && !link.href.startsWith('#')) {
                                    // STOP NPR Scripts (PJAX)
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    
                                    // SEND URL TO PARENT
                                    window.parent.postMessage({ type: 'internal_nav', url: link.href }, '*');
                                }
                            }, true);
                        })();
                        <\/script>
                    `;

                    // CSS Fixes (Shield Removal)
                    const unifiedCss = `
                        <style>
                            div[role="dialog"], div[aria-modal="true"], #lb, .bErdLd { display: none !important; }
                            #onetrust-consent-sdk, #onetrust-banner-sdk, .onetrust-pc-dark-filter, .optanon-alert-box-wrapper { display: none !important; pointer-events: none !important; }
                            html, body { overflow: auto !important; position: static !important; }
                        </style>
                    `;

                    if(text.includes('<head>')) {
                        fetchedHtml = text.replace('<head>', `<head>${baseTag}${hubScript}${unifiedCss}`);
                    } else {
                        fetchedHtml = baseTag + hubScript + unifiedCss + text;
                    }

                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    document.getElementById('status-indicator').textContent = "Proxy Active";
                    document.getElementById('status-indicator').style.color = "#27ae60";
                    sysLog(`Loaded via ${proxy.name}`, 'nav');
                    success = true;

                } catch(err) {
                    sysLog(`${proxy.name} failed: ${err.message}`, 'error');
                }
            }

            if(!success) {
                sysLog("All proxies failed. Fallback to Direct Mode.", 'error');
                document.getElementById('main-frame').src = url;
                document.getElementById('status-indicator').textContent = "Direct Mode";
                document.getElementById('status-indicator').style.color = "#ea4335";
                document.getElementById('btnReaderOpen').disabled = true;
            } else {
                document.getElementById('btnReaderOpen').disabled = false;
            }

            toggleLoading(false);
        }

        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            ['video', 'audio', 'embed', 'object', 'iframe'].forEach(tag => doc.querySelectorAll(tag).forEach(el => el.remove()));
            doc.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(el => el.remove());
            return doc.documentElement.outerHTML;
        }

        // --- PARENT MESSAGE HUB ---
        window.addEventListener('message', (event) => {
            const data = event.data;
            
            // 1. Handle Navigation
            if (data.type === 'internal_nav') {
                let targetUrl = data.url;
                
                // UNWRAP GOOGLE LINKS
                if (targetUrl.includes('google.com/url') || targetUrl.includes('google.co.uk/url')) {
                    try {
                        const urlObj = new URL(targetUrl);
                        const realUrl = urlObj.searchParams.get('q') || urlObj.searchParams.get('url');
                        if (realUrl) {
                            sysLog(`Unwrapped Google Link`, 'sys');
                            targetUrl = realUrl;
                        }
                    } catch (e) {}
                }

                sysLog(`Navigating: ${targetUrl}`, 'nav');
                loadUrl(targetUrl);
            }

            // 2. Handle Console Forwarding
            if (data.type === 'console_forward') {
                consoleLog(data.msg, data.level);
            }
        });

        // --- HYBRID READER ---
        document.getElementById('btnReaderOpen').onclick = () => {
            if(!fetchedHtml) return alert("Content unavailable.");
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');

            ['script','style','nav','footer','header','aside','svg','button','form', 'noscript'].forEach(t => doc.querySelectorAll(t).forEach(e => e.remove()));

            let contentHTML = "";
            let lastText = "";
            
            // 1. GOOGLE SEARCH MODE
            if(document.getElementById('urlInput').value.includes('google')) {
                const items = doc.querySelectorAll('h3, .VwiC3b, .BNeawe'); 
                items.forEach(node => {
                    let text = node.innerText.trim();
                    if(text.length > 10 && text !== lastText) {
                        if(node.tagName === 'H3' || node.classList.contains('BNeawe')) {
                            contentHTML += `<h3>${text}</h3>`;
                        } else {
                            contentHTML += `<p>${text}</p><hr>`;
                        }
                        lastText = text;
                    }
                });
            } 
            
            // 2. ARTICLE MODE
            if (!contentHTML) {
                const nodes = doc.querySelectorAll('h1, h2, h3, p, article, .story-text, .story-body');
                const badPhrases = ["Getty Images", "Source:", "Copyright", "All rights reserved", "enlarge image", "toggle caption"];

                nodes.forEach(node => {
                    let text = node.innerText.trim().replace(/\s+/g, ' ');
                    if(text.length > 25 && !badPhrases.some(b => text.toLowerCase().includes(b.toLowerCase())) && text !== lastText) {
                        contentHTML += `<p>${text}</p>`;
                        lastText = text;
                    }
                });
            }

            if(!contentHTML) contentHTML = "<p>No readable text found.</p>";
            document.getElementById('reader-content').innerHTML = contentHTML;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        function closeReader() {
            stopAudio();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // --- AUDIO ---
        function startAudio() {
            const selectors = document.getElementById('urlInput').value.includes('google') ? 'h3, p' : 'p';
            const paras = document.querySelectorAll(`#reader-content ${selectors}`);
            if(paras.length === 0) return;
            stopAudio();
            audioQueue = Array.from(paras);
            currentAudioIndex = 0;
            isReading = true;
            document.getElementById('btnStopAudio').style.display = 'inline-block';
            playNextChunk();
        }

        function playNextChunk() {
            if(!isReading || currentAudioIndex >= audioQueue.length) {
                stopAudio();
                return;
            }
            const p = audioQueue[currentAudioIndex];
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({ behavior: "smooth", block: "center" });

            const u = new SpeechSynthesisUtterance(p.innerText);
            const enVoice = synth.getVoices().find(v => v.lang.startsWith('en'));
            if(enVoice) u.voice = enVoice;

            u.onend = () => { currentAudioIndex++; playNextChunk(); };
            u.onerror = () => { currentAudioIndex++; playNextChunk(); };
            synth.speak(u);
        }

        function stopAudio() {
            isReading = false;
            synth.cancel();
            document.getElementById('btnStopAudio').style.display = 'none';
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
        }

        function copySource() {
            const el = document.getElementById('source-code');
            el.select();
            document.execCommand('copy');
        }

        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl(); });
        
        // AUTO LOAD GOOGLE
        window.addEventListener('DOMContentLoaded', () => loadUrl('https://google.com'));

    </script>
</body>
</html>