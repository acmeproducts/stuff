<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Reader & Source Tool v4</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --primary: #007aff;
            --success: #34c759;
            --danger: #ff3b30;
            --text: #333;
        }

        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* Top Bar */
        .toolbar {
            background: white;
            padding: 12px;
            display: flex;
            gap: 8px;
            border-bottom: 1px solid #ccc;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            align-items: center;
        }

        input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
        }

        button {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            background: var(--primary);
            white-space: nowrap;
        }
        button:hover { opacity: 0.9; }
        button.success { background: var(--success); }
        button.danger { background: var(--danger); }
        button:disabled { background: #ccc; cursor: default; }

        /* Main Workspace */
        .workspace {
            flex: 1;
            position: relative;
            background: #e5e5e5;
            overflow: hidden;
        }

        iframe#main-frame {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        /* Log Console (New) */
        #console-log {
            height: 100px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            overflow-y: auto;
            font-size: 12px;
            border-top: 2px solid #444;
            display: none; /* Hidden unless needed */
        }

        /* Reader Mode Overlay */
        .overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: white;
            z-index: 100;
            display: none;
            flex-direction: column;
        }

        .overlay-header {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f9f9f9;
        }

        .overlay-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
            font-size: 18px;
            color: #222;
        }

        /* Source Code Textarea */
        textarea#source-code {
            width: 100%;
            height: 100%;
            background: #282c34;
            color: #abb2bf;
            border: none;
            padding: 15px;
            font-family: monospace;
            resize: none;
            box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="text" id="urlInput" placeholder="google.com" />
        <button id="btnGo">Go</button>
        <button id="btnReader" class="success">Reader View</button>
        <button id="btnSource" style="background: #5856d6;">Source</button>
        <button id="btnLogs" style="background: #8e8e93; font-size: 0.8em;">Logs</button>
    </div>

    <div class="workspace">
        <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>

        <div id="reader-overlay" class="overlay">
            <div class="overlay-header">
                <strong>Reader Mode</strong>
                <div style="display:flex; gap:5px;">
                    <button id="btnSpeak" class="success">üîä Read</button>
                    <button id="btnStop" class="danger" style="display:none;">‚èπ Stop</button>
                    <button onclick="document.getElementById('reader-overlay').style.display='none'">Close</button>
                </div>
            </div>
            <div id="reader-content" class="overlay-content"></div>
        </div>

        <div id="source-overlay" class="overlay">
            <div class="overlay-header">
                <strong>Source Editor</strong>
                <div style="display:flex; gap:5px;">
                    <button id="btnCopy" class="success">Copy</button>
                    <button id="btnPreview" style="background:#ff9500;">Run Preview</button>
                    <button onclick="document.getElementById('source-overlay').style.display='none'">Close</button>
                </div>
            </div>
            <div style="flex:1;">
                <textarea id="source-code" spellcheck="false"></textarea>
            </div>
        </div>
    </div>

    <div id="console-log"></div>

    <script>
        // --- Configuration ---
        const PROXY_URL = "https://corsproxy.io/?"; 
        
        // --- State ---
        let fetchedHtml = "";
        let currentUrl = "";
        const logBox = document.getElementById('console-log');

        // --- Logger ---
        function log(msg, type="info") {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'red' : '#0f0';
            logBox.innerHTML += `<div style="color:${color}">[${time}] ${msg}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }

        document.getElementById('btnLogs').onclick = () => {
            logBox.style.display = logBox.style.display === 'block' ? 'none' : 'block';
        };

        // --- URL Processor ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) {
                url += '.com';
            }
            if (!url.startsWith('http')) {
                url = 'https://' + url;
            }
            return url;
        }

        // --- Main Loader ---
        async function loadUrl() {
            const rawInput = document.getElementById('urlInput').value;
            const url = fixUrl(rawInput);
            
            if (!url) {
                alert("Please enter a valid URL");
                return;
            }

            currentUrl = url;
            fetchedHtml = ""; // Reset
            log(`Starting load for: ${url}`);
            document.getElementById('btnGo').textContent = "Loading...";
            document.getElementById('btnGo').disabled = true;

            try {
                // Method A: Try Proxy Fetch
                const target = PROXY_URL + encodeURIComponent(url);
                log(`Fetching via proxy: ${target}`);
                
                const response = await fetch(target);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                let text = await response.text();
                log("Data received. Processing...");

                // Inject Base Tag (Crucial for images/css to load)
                // This makes the browser look for "logo.png" at "google.com/logo.png"
                const baseTag = `<base href="${url}" target="_blank">`;
                if (text.includes('<head>')) {
                    text = text.replace('<head>', `<head>${baseTag}`);
                } else {
                    text = baseTag + text;
                }

                fetchedHtml = text;
                
                // Render to Iframe
                const frame = document.getElementById('main-frame');
                frame.srcdoc = text;
                log("Rendered to iframe via srcdoc.");

            } catch (err) {
                log(`Proxy failed: ${err.message}`, "error");
                log("Attempting direct load (Warning: X-Frame-Options may block this).");
                
                // Fallback: Direct SRC (Will fail on Google/Amazon)
                document.getElementById('main-frame').removeAttribute('srcdoc');
                document.getElementById('main-frame').src = url;
            } finally {
                document.getElementById('btnGo').textContent = "Go";
                document.getElementById('btnGo').disabled = false;
            }
        }

        // --- Reader Mode ---
        document.getElementById('btnReader').onclick = () => {
            if (!fetchedHtml) {
                alert("Please load a URL first (must be via Proxy).");
                return;
            }

            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');

            // Clean Junk
            const junk = ['script', 'style', 'iframe', 'nav', 'footer', 'noscript', 'svg'];
            junk.forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            // Extract Text
            // We look for P and H tags specifically
            let content = "";
            doc.querySelectorAll('h1, h2, h3, p, article').forEach(el => {
                if(el.innerText.trim().length > 20) { // Filter short nonsense
                    content += `<${el.tagName}>${el.innerText}</${el.tagName}>`;
                }
            });

            if(!content) content = "<p>Could not extract text. The site might be purely Javascript.</p>";

            document.getElementById('reader-content').innerHTML = content;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        // --- Text to Speech ---
        const synth = window.speechSynthesis;
        document.getElementById('btnSpeak').onclick = () => {
            const text = document.getElementById('reader-content').innerText;
            const utter = new SpeechSynthesisUtterance(text);
            
            document.getElementById('btnSpeak').style.display = 'none';
            document.getElementById('btnStop').style.display = 'inline-block';
            
            utter.onend = () => {
                document.getElementById('btnSpeak').style.display = 'inline-block';
                document.getElementById('btnStop').style.display = 'none';
            };
            
            synth.speak(utter);
        };

        document.getElementById('btnStop').onclick = () => {
            synth.cancel();
            document.getElementById('btnSpeak').style.display = 'inline-block';
            document.getElementById('btnStop').style.display = 'none';
        };

        // --- Source Mode ---
        document.getElementById('btnSource').onclick = () => {
            if(!fetchedHtml) return alert("Load a URL first");
            document.getElementById('source-code').value = fetchedHtml;
            document.getElementById('source-overlay').style.display = 'flex';
        };

        document.getElementById('btnCopy').onclick = () => {
            document.getElementById('source-code').select();
            document.execCommand('copy');
            log("Source copied to clipboard");
        };

        document.getElementById('btnPreview').onclick = () => {
            const newCode = document.getElementById('source-code').value;
            fetchedHtml = newCode;
            document.getElementById('main-frame').srcdoc = newCode;
            document.getElementById('source-overlay').style.display = 'none';
            log("Preview updated with edited code");
        };

        // --- Inputs ---
        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') loadUrl();
        });
        document.getElementById('btnGo').onclick = loadUrl;

    </script>
</body>
</html>