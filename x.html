<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v15</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --bg: #f4f4f9;
            --tab-active: #ffffff;
            --tab-inactive: #e0e0e0;
            --border: #ccc;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        /* --- UI Components --- */
        .nav-bar {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
        }

        .home-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 18px;
        }
        .home-btn:hover { background: #eee; }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            outline: none;
        }

        .go-btn {
            padding: 10px 20px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
        }
        .go-btn:disabled { background-color: #95a5a6; cursor: not-allowed; }

        .tab-bar {
            display: flex;
            background: var(--tab-inactive);
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-right: 1px solid #d1d1d1;
        }
        .tab-btn.active {
            background: var(--tab-active);
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }

        iframe { width: 100%; height: 100%; border: none; }
        
        .browser-toolbar {
            padding: 5px 10px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 40px;
        }
        
        .reader-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
        }
        .reader-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Overlays */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: #333;
            flex-direction: column;
            gap: 15px;
            font-weight: bold;
        }

        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-header { padding: 15px; background: #ecf0f1; border-bottom: 1px solid #bdc3c7; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { flex: 1; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #111; }
        .speaking { background-color: #fff3cd; border-left: 5px solid #f1c40f; padding-left: 10px; }

        /* Logs */
        .log-container {
            flex: 1;
            background: #1e1e1e;
            color: #00ff9d;
            padding: 15px;
            font-family: monospace;
            overflow-y: auto;
            font-size: 13px;
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-time { color: #888; margin-right: 10px; }
        .log-err { color: #ff6b6b; }
        .log-nav { color: #f1c40f; }

        /* Source View */
        textarea.source-viewer {
            flex: 1; width: 100%; padding: 15px; background: #282c34; color: #abb2bf; font-family: monospace; border: none; resize: none;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px;">üîÑ</div>
        <div id="loading-text">Fetching Content...</div>
    </div>

    <nav class="nav-bar">
        <button class="home-btn" id="btnHome" title="Home (NPR.org)">üè†</button>
        <input type="text" id="urlInput" placeholder="Enter URL" />
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" id="tabSource" onclick="switchTab('source')">Source Code</button>
        <button class="tab-btn" onclick="switchTab('logs')">System Logs</button>
    </div>

    <div class="content-area">
        
        <div id="panel-browser" class="panel active">
            <div class="browser-toolbar">
                <div id="status-indicator" style="font-size:12px; color:#666;">Ready</div>
                <button class="reader-btn" id="btnReaderOpen">üìñ Open Reader & Audio</button>
            </div>
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div id="reader-overlay">
                <div class="reader-header">
                    <strong>Reader Mode</strong>
                    <div style="display:flex; gap: 8px;">
                        <button class="reader-btn" onclick="startAudio()">üîä Play</button>
                        <button class="reader-btn" style="background:#c0392b; display:none;" id="btnStopAudio" onclick="stopAudio()">‚èπ Stop</button>
                        <button class="home-btn" onclick="closeReader()">Close</button>
                    </div>
                </div>
                <div id="reader-content" class="reader-body"></div>
            </div>
        </div>

        <div id="panel-source" class="panel">
            <div style="padding:10px; background:#eee; text-align:right; border-bottom:1px solid #ccc;">
                <button class="go-btn" style="padding:5px 15px;" id="btnCopySource" onclick="copySource()">Copy to Clipboard</button>
            </div>
            <textarea id="source-code" class="source-viewer" spellcheck="false"></textarea>
        </div>

        <div id="panel-logs" class="panel">
            <div class="log-container" id="log-output">
                <div class="log-entry">System Ready. V15 Aggressive Interceptor.</div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const PROXIES = [
            { name: "CodeTabs", url: t => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(t)}` },
            { name: "AllOrigins", url: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}` },
            { name: "CORSProxy", url: t => `https://corsproxy.io/?${encodeURIComponent(t)}` }
        ];

        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let currentAudioIndex = 0;

        // --- UI & LOGS ---
        function log(msg, type="info") {
            const container = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'log-err' : (type === 'nav' ? 'log-nav' : '');
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `<span class="log-time">[${time}]</span><span class="${color}">${msg}</span>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            if (tabName === 'source') {
                document.getElementById('source-code').value = fetchedHtml || "Source not available in Direct Mode.";
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- URL LOGIC ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) url += '.com';
            if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;
            return url;
        }

        async function loadUrl(urlOverride) {
            const raw = urlOverride || document.getElementById('urlInput').value;
            const url = fixUrl(raw);
            if(!url) return alert("Invalid URL");

            // --- RESET STATE ---
            stopAudio();
            document.getElementById('urlInput').value = url;
            document.getElementById('status-indicator').textContent = "Fetching via Proxy...";
            document.getElementById('status-indicator').style.color = "#e67e22";
            toggleLoading(true);
            
            fetchedHtml = ""; // CRITICAL: Wipe memory so we don't show old pages
            
            log(`Fetching: ${url}`);

            let success = false;

            for (let proxy of PROXIES) {
                if(success) break;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(proxy.url(url), { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let text = await res.text();
                    if(!text || text.length < 500) throw new Error("Empty/Short content");

                    // --- CLEANUP ---
                    text = cleanHTML(text);

                    // --- INJECTION ---
                    const baseTag = `<base href="${url}" target="_self">`;
                    
                    // THE AGGRESSIVE INTERCEPTOR
                    // We use { capture: true } to catch the event BEFORE NPR's scripts
                    const navScript = `
                        <script>
                            window.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href && !link.href.startsWith('javascript') && !link.href.startsWith('#')) {
                                    // STOP EVERYTHING
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    
                                    console.log("Interceptor: Caught click to " + link.href);
                                    window.parent.postMessage({ type: 'internal_nav', url: link.href }, '*');
                                }
                            }, true); // <--- TRUE IS CRITICAL (Capture Phase)
                        <\/script>
                    `;

                    if(text.includes('<head>')) {
                        fetchedHtml = text.replace('<head>', `<head>${baseTag}${navScript}`);
                    } else {
                        fetchedHtml = baseTag + navScript + text;
                    }

                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    document.getElementById('status-indicator').textContent = "Proxy Active";
                    document.getElementById('status-indicator').style.color = "#27ae60";
                    log(`Loaded via ${proxy.name}`, 'nav');
                    success = true;

                } catch(err) {
                    log(`${proxy.name} failed: ${err.message}`, 'error');
                }
            }

            if(!success) {
                log("All proxies failed. Falling back to Direct Mode (Reader Disabled).", 'error');
                document.getElementById('main-frame').src = url;
                document.getElementById('status-indicator').textContent = "Direct Mode (No Reader)";
                document.getElementById('status-indicator').style.color = "#c0392b";
                document.getElementById('btnReaderOpen').disabled = true;
            } else {
                document.getElementById('btnReaderOpen').disabled = false;
            }

            toggleLoading(false);
        }

        // --- HELPER: CLEANER ---
        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            
            // Remove Heavy Media
            ['video', 'audio', 'embed', 'object'].forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.replaceWith('[MEDIA REMOVED]'));
            });

            // Remove CSP Meta Tags to allow our Interceptor
            doc.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(el => el.remove());

            return doc.documentElement.outerHTML;
        }

        // --- NAVIGATION LISTENER ---
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'internal_nav') {
                log(`Interceptor Caught: ${event.data.url}`, 'nav');
                loadUrl(event.data.url);
            }
        });

        // --- HOME BUTTON ---
        document.getElementById('btnHome').onclick = () => {
            log("Navigating Home (NPR.org)...");
            loadUrl('https://npr.org');
        };

        // --- READER MODE ---
        document.getElementById('btnReaderOpen').onclick = () => {
            if(!fetchedHtml) return alert("Content unavailable.");
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');

            ['script','style','iframe','nav','footer','header','aside','svg','button','form'].forEach(t => doc.querySelectorAll(t).forEach(e => e.remove()));

            let contentHTML = "";
            let lastText = "";
            const nodes = doc.querySelectorAll('h1, h2, h3, p, article');
            const badPhrases = ["Getty Images", "Source:", "Copyright", "All rights reserved", "enlarge image", "toggle caption"];

            nodes.forEach(node => {
                let text = node.innerText.trim().replace(/\s+/g, ' ');
                if(text.length > 25 && !badPhrases.some(b => text.toLowerCase().includes(b.toLowerCase())) && text !== lastText) {
                    contentHTML += `<p>${text}</p>`;
                    lastText = text;
                }
            });

            if(!contentHTML) contentHTML = "<p>No readable text found.</p>";
            document.getElementById('reader-content').innerHTML = contentHTML;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        function closeReader() {
            stopAudio();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // --- AUDIO ENGINE ---
        function startAudio() {
            const paras = document.querySelectorAll('#reader-content p');
            if(paras.length === 0) return;
            stopAudio();
            audioQueue = Array.from(paras);
            currentAudioIndex = 0;
            isReading = true;
            document.getElementById('btnStopAudio').style.display = 'inline-block';
            playNextChunk();
        }

        function playNextChunk() {
            if(!isReading || currentAudioIndex >= audioQueue.length) {
                stopAudio();
                return;
            }
            const p = audioQueue[currentAudioIndex];
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({ behavior: "smooth", block: "center" });

            const u = new SpeechSynthesisUtterance(p.innerText);
            const enVoice = synth.getVoices().find(v => v.lang.startsWith('en'));
            if(enVoice) u.voice = enVoice;

            u.onend = () => { currentAudioIndex++; playNextChunk(); };
            u.onerror = () => { currentAudioIndex++; playNextChunk(); };
            synth.speak(u);
        }

        function stopAudio() {
            isReading = false;
            synth.cancel();
            document.getElementById('btnStopAudio').style.display = 'none';
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
        }

        function copySource() {
            const el = document.getElementById('source-code');
            el.select();
            document.execCommand('copy');
            const btn = document.getElementById('btnCopySource');
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = "Copy to Clipboard", 1500);
        }

        // --- INIT ---
        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl(); });
        
        // Auto-load Home
        window.addEventListener('DOMContentLoaded', () => {
             // loadUrl('https://npr.org'); 
        });

    </script>
</body>
</html>