<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v25</title>
    <style>
        :root {
            --primary: #202124;
            --accent: #d93025;
            --bg: #f8f9fa;
            --border: #dadce0;
            --item-hover: #f1f3f4;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        /* --- Nav Bar --- */
        .nav-bar {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .icon-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            color: #5f6368;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .icon-btn:hover { background: var(--item-hover); color: var(--primary); }

        input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 16px;
            outline: none;
            background: #f1f3f4;
        }
        input[type="text"]:focus { background: #fff; box-shadow: 0 1px 6px rgba(0,0,0,0.1); }

        .go-btn {
            padding: 8px 20px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Tabs --- */
        .tab-bar {
            display: flex;
            background: #fff;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* --- Content Areas --- */
        .content-area { flex: 1; position: relative; overflow: hidden; background: white; }
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }
        iframe { width: 100%; height: 100%; border: none; }

        .browser-toolbar {
            padding: 8px 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reader-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 18px;
            cursor: pointer;
            font-weight: bold;
            font-size: 13px;
        }

        /* --- Bookmarks Modal --- */
        #bookmarks-modal {
            position: absolute;
            top: 60px;
            left: 10px;
            width: 300px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 100;
            max-height: 70vh;
            overflow-y: auto;
        }

        .bookmark-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #f1f3f4;
            background: white;
            cursor: pointer;
            user-select: none;
        }
        .bookmark-item:hover { background: #f8f9fa; }
        .drag-handle { cursor: grab; padding-right: 10px; color: #ccc; font-size: 20px; }
        .bm-name { flex: 1; font-size: 14px; color: #3c4043; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .bm-delete { color: #ea4335; font-weight: bold; padding: 5px 10px; cursor: pointer; font-size: 16px;}
        .bm-delete:hover { background: #fee; border-radius: 4px; }
        
        .bookmark-item.dragging { opacity: 0.5; background: #e8f0fe; }

        /* --- Reader Overlay --- */
        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-header {
            padding: 10px 15px;
            background: #f1f3f4;
            border-bottom: 1px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .audio-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .audio-btn {
            background: white;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .audio-btn:active { background: #eee; transform: translateY(1px); }
        .audio-btn.active { background: #e6f4ea; border-color: #34a853; color: #34a853; }
        
        .reader-body { flex: 1; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #202124; }
        .speaking { background-color: #fce8b2; border-left: 5px solid #fbbc04; padding-left: 10px; scroll-margin-top: 100px; }

        /* --- Logs & Source --- */
        .log-container {
            flex: 1; background: #202124; color: #5bb974; padding: 15px; font-family: monospace; overflow-y: auto; font-size: 12px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #3c4043; padding-bottom: 2px; }
        .sys-nav { color: #fbbc04; } .sys-err { color: #ea4335; }
        
        textarea.source-viewer {
            flex: 1; width: 100%; padding: 15px; background: #282c34; color: #abb2bf; font-family: monospace; border: none; resize: none;
        }
        
        /* Overlays */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95); z-index: 50; display: none; align-items: center; justify-content: center; font-size: 18px; color: #5f6368; flex-direction: column; gap: 15px;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px;">üîÑ</div>
        <div id="loading-text">Fetching Content...</div>
    </div>

    <div id="bookmarks-modal"></div>

    <nav class="nav-bar">
        <button class="icon-btn" id="btnBookmarks" onclick="toggleBookmarks()" title="Bookmarks">
            üîñ
        </button>
        <input type="text" id="urlInput" placeholder="Enter URL or Search Query" />
        <button class="icon-btn" onclick="addCurrentToBookmarks()" title="Add Bookmark">‚ûï</button>
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" onclick="switchTab('console')">Console</button>
        <button class="tab-btn" id="tabSource" onclick="switchTab('source')">Source Code</button>
        <button class="tab-btn" onclick="switchTab('logs')">System Logs</button>
    </div>

    <div class="content-area">
        
        <div id="panel-browser" class="panel active">
            <div class="browser-toolbar">
                <div id="status-indicator" style="font-size:12px; color:#5f6368;">Ready</div>
                <button class="reader-btn" id="btnReaderOpen">üìñ Read Page</button>
            </div>
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div id="reader-overlay">
                <div class="reader-header">
                    <strong>Reader Mode</strong>
                    
                    <div class="audio-controls">
                        <button class="audio-btn" onclick="audioPrev()" title="Previous Paragraph">‚è™</button>
                        <button class="audio-btn" id="btnPlayPause" onclick="audioToggle()" title="Play/Pause">‚ñ∂</button>
                        <button class="audio-btn" onclick="audioNext()" title="Next Paragraph">‚è©</button>
                    </div>

                    <button class="icon-btn" onclick="closeReader()" title="Close Reader">‚ùå</button>
                </div>
                <div id="reader-content" class="reader-body"></div>
            </div>
        </div>

        <div id="panel-console" class="panel" style="background:#242424; color:#eee; padding:10px; font-family:monospace; overflow-y:auto;">
            <div class="console-row" style="color:#8ab4f8;"><i>Console ready...</i></div>
        </div>

        <div id="panel-source" class="panel">
            <div style="padding:10px; background:#f1f3f4; text-align:right; border-bottom:1px solid #ccc;">
                <button class="go-btn" style="padding:5px 15px;" id="btnCopySource" onclick="copySource()">Copy Code</button>
            </div>
            <textarea id="source-code" class="source-viewer" spellcheck="false"></textarea>
        </div>

        <div id="panel-logs" class="panel">
            <div class="log-container" id="log-output">
                <div class="log-entry">System Ready. v25 News Suite.</div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG & STATE ---
        const PROXIES = [
            { name: "CodeTabs", url: t => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(t)}` },
            { name: "CORSProxy", url: t => `https://corsproxy.io/?${encodeURIComponent(t)}` },
            { name: "AllOrigins", url: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}` },
            { name: "CorsFix", url: t => `https://proxy.corsfix.com/?${encodeURIComponent(t)}` }
        ];

        // Default Bookmarks
        const DEFAULT_BOOKMARKS = [
            { name: "NPR", url: "https://npr.org" },
            { name: "BBC News", url: "https://bbc.com/news" },
            { name: "PBS News", url: "https://pbs.org/newshour" },
            { name: "CBC", url: "https://cbc.ca" },
            { name: "Reuters", url: "https://reuters.com" },
            { name: "The Verge", url: "https://theverge.com" },
            { name: "Alterslash", url: "https://alterslash.org" },
            { name: "Google", url: "https://google.com" }
        ];

        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let currentAudioIndex = 0;
        let bookmarks = [];

        // --- BOOKMARK MANAGER ---
        function loadBookmarks() {
            const saved = localStorage.getItem('uwt_bookmarks');
            bookmarks = saved ? JSON.parse(saved) : DEFAULT_BOOKMARKS;
            renderBookmarks();
        }

        function saveBookmarks() {
            localStorage.setItem('uwt_bookmarks', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        function renderBookmarks() {
            const container = document.getElementById('bookmarks-modal');
            container.innerHTML = '';
            
            bookmarks.forEach((bm, index) => {
                const div = document.createElement('div');
                div.className = 'bookmark-item';
                div.draggable = true;
                div.dataset.index = index;
                div.innerHTML = `
                    <span class="drag-handle">‚â°</span>
                    <span class="bm-name" onclick="useBookmark('${bm.url}')">${bm.name}</span>
                    <span class="bm-delete" onclick="removeBookmark(event, ${index})">‚úï</span>
                `;
                
                // Drag Events
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                
                container.appendChild(div);
            });
        }

        function addCurrentToBookmarks() {
            const url = document.getElementById('urlInput').value;
            if(!url) return;
            // Simple prompt for name
            const name = prompt("Bookmark Name:", new URL(url).hostname);
            if(name) {
                bookmarks.push({name, url});
                saveBookmarks();
                alert("Bookmarked!");
            }
        }

        function removeBookmark(e, index) {
            e.stopPropagation(); // Don't click the link
            if(confirm(`Delete "${bookmarks[index].name}"?`)) {
                bookmarks.splice(index, 1);
                saveBookmarks();
            }
        }

        function useBookmark(url) {
            document.getElementById('bookmarks-modal').style.display = 'none';
            loadUrl(url);
        }

        function toggleBookmarks() {
            const el = document.getElementById('bookmarks-modal');
            el.style.display = el.style.display === 'flex' ? 'none' : 'flex';
        }

        // --- DRAG AND DROP LOGIC ---
        let dragSrcEl = null;

        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            const targetEl = e.target.closest('.bookmark-item');
            
            if (dragSrcEl !== targetEl) {
                const oldIndex = parseInt(dragSrcEl.dataset.index);
                const newIndex = parseInt(targetEl.dataset.index);
                
                // Reorder array
                const item = bookmarks.splice(oldIndex, 1)[0];
                bookmarks.splice(newIndex, 0, item);
                saveBookmarks();
            }
            dragSrcEl.classList.remove('dragging');
            return false;
        }

        // --- UTILS ---
        function sysLog(msg, type="info") {
            const container = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'sys-err' : (type === 'nav' ? 'sys-nav' : '');
            container.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="${color}">${msg}</span></div>`;
            container.scrollTop = container.scrollHeight;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            if (tabName === 'source') document.getElementById('source-code').value = fetchedHtml || "Source not available.";
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) {
                return `https://www.google.com/search?q=${encodeURIComponent(url)}`;
            }
            if (!url.startsWith('http')) url = 'https://' + url;
            return url;
        }

        // --- CORE LOAD LOGIC ---
        async function loadUrl(urlOverride) {
            const raw = urlOverride || document.getElementById('urlInput').value;
            const url = fixUrl(raw);
            if(!url) return alert("Invalid URL");

            audioStop(); // Use updated stop logic
            document.getElementById('urlInput').value = url;
            document.getElementById('status-indicator').textContent = "Fetching...";
            document.getElementById('status-indicator').style.color = "#e67e22";
            document.getElementById('panel-console').innerHTML = ""; 
            toggleLoading(true);
            
            fetchedHtml = ""; 
            sysLog(`Fetching: ${url}`);

            let success = false;
            let proxyListToUse = PROXIES;
            if(url.includes('news.google.com')) proxyListToUse = [PROXIES[1], PROXIES[0], PROXIES[2]];

            for (let proxy of proxyListToUse) {
                if(success) break;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(proxy.url(url), { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let text = await res.text();
                    if(!text || text.length < 500) throw new Error("Empty/Short content");

                    text = cleanHTML(text);

                    const baseTag = `<base href="${url}" target="_self">`;
                    const hubScript = `
                        <script>
                        (function() {
                            const send = (t, m) => window.parent.postMessage({type: t, msg: m}, '*');
                            const originalLog = console.log;
                            console.log = function(...args) { originalLog.apply(console, args); send('console_forward', args.join(' ')); };
                            
                            window.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href && !link.href.startsWith('javascript') && !link.href.startsWith('#')) {
                                    e.preventDefault(); e.stopPropagation(); e.stopImmediatePropagation();
                                    send('internal_nav', link.href);
                                }
                            }, true);
                        })();
                        <\/script>
                    `;
                    const unifiedCss = `<style>div[role="dialog"], #onetrust-consent-sdk, .optanon-alert-box-wrapper { display: none !important; } html, body { overflow: auto !important; }</style>`;

                    if(text.includes('<head>')) {
                        fetchedHtml = text.replace('<head>', `<head>${baseTag}${hubScript}${unifiedCss}`);
                    } else {
                        fetchedHtml = baseTag + hubScript + unifiedCss + text;
                    }

                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    document.getElementById('status-indicator').textContent = "Proxy Active";
                    document.getElementById('status-indicator').style.color = "#27ae60";
                    sysLog(`Loaded via ${proxy.name}`, 'nav');
                    success = true;

                } catch(err) {
                    sysLog(`${proxy.name} failed: ${err.message}`, 'error');
                }
            }

            if(!success) {
                sysLog("All proxies failed. Fallback to Direct.", 'error');
                document.getElementById('main-frame').src = url;
                document.getElementById('status-indicator').textContent = "Direct Mode";
                document.getElementById('status-indicator').style.color = "#ea4335";
                document.getElementById('btnReaderOpen').disabled = true;
            } else {
                document.getElementById('btnReaderOpen').disabled = false;
            }

            toggleLoading(false);
        }

        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            ['video', 'audio', 'embed', 'object', 'iframe'].forEach(tag => doc.querySelectorAll(tag).forEach(el => el.remove()));
            doc.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(el => el.remove());
            return doc.documentElement.outerHTML;
        }

        window.addEventListener('message', (event) => {
            if (event.data.type === 'internal_nav') {
                let targetUrl = event.data.msg;
                if (targetUrl.includes('google.com/url')) {
                    try { targetUrl = new URL(targetUrl).searchParams.get('url') || targetUrl; } catch (e) {}
                }
                sysLog(`Navigating: ${targetUrl}`, 'nav');
                loadUrl(targetUrl);
            }
            if (event.data.type === 'console_forward') {
                const el = document.getElementById('panel-console');
                el.innerHTML += `<div style="border-bottom:1px solid #444;">${event.data.msg}</div>`;
            }
        });

        // --- READER MODE ---
        document.getElementById('btnReaderOpen').onclick = () => {
            if(!fetchedHtml) return alert("Content unavailable.");
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');
            
            // Cleanup
            ['script','style','nav','footer','header','aside','svg','button','form', 'noscript'].forEach(t => doc.querySelectorAll(t).forEach(e => e.remove()));

            let contentHTML = "";
            let lastText = "";
            
            // Search Mode vs Article Mode logic
            if(document.getElementById('urlInput').value.includes('google')) {
                doc.querySelectorAll('h3, .VwiC3b, .BNeawe').forEach(node => {
                    let text = node.innerText.trim();
                    if(text.length > 10 && text !== lastText) {
                        contentHTML += node.tagName === 'H3' || node.classList.contains('BNeawe') ? `<h3>${text}</h3>` : `<p>${text}</p><hr>`;
                        lastText = text;
                    }
                });
            } else {
                doc.querySelectorAll('h1, h2, h3, p, article').forEach(node => {
                    let text = node.innerText.trim().replace(/\s+/g, ' ');
                    const bad = ["Getty Images", "Source:", "Copyright", "enlarge image", "toggle caption"];
                    if(text.length > 25 && !bad.some(b => text.includes(b)) && text !== lastText) {
                        contentHTML += `<p>${text}</p>`;
                        lastText = text;
                    }
                });
            }

            if(!contentHTML) contentHTML = "<p>No text found.</p>";
            document.getElementById('reader-content').innerHTML = contentHTML;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        function closeReader() {
            audioStop();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // --- AUDIO ENGINE (MANUAL CONTROL) ---
        
        function updateAudioUI() {
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = isReading && !synth.paused ? "‚è∏" : "‚ñ∂";
        }

        function startAudio() {
            // Re-scan paragraphs
            const selectors = document.getElementById('urlInput').value.includes('google') ? 'h3, p' : 'p';
            audioQueue = Array.from(document.querySelectorAll(`#reader-content ${selectors}`));
            if(audioQueue.length === 0) return;
            
            currentAudioIndex = 0;
            isReading = true;
            synth.cancel();
            speakCurrentIndex();
        }

        function speakCurrentIndex() {
            if (currentAudioIndex < 0 || currentAudioIndex >= audioQueue.length) {
                audioStop();
                return;
            }

            const p = audioQueue[currentAudioIndex];
            
            // Visuals
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({ behavior: "smooth", block: "center" });

            const u = new SpeechSynthesisUtterance(p.innerText);
            const enVoice = synth.getVoices().find(v => v.lang.startsWith('en'));
            if(enVoice) u.voice = enVoice;

            u.onend = () => {
                if (isReading) {
                    currentAudioIndex++;
                    speakCurrentIndex();
                }
            };
            
            u.onerror = () => {
                // Skip errors
                if (isReading) {
                    currentAudioIndex++;
                    speakCurrentIndex();
                }
            };

            synth.speak(u);
            updateAudioUI();
        }

        function audioToggle() {
            if (!isReading) {
                startAudio();
                return;
            }
            if (synth.paused) {
                synth.resume();
            } else {
                synth.pause();
            }
            updateAudioUI();
        }

        function audioNext() {
            if (!isReading) return;
            synth.cancel(); // Stop current, onend will fire but we handle index manually
            // Wait slight delay to let cancel propagate? No, just force logic.
            // Actually, cancel triggers onend. We need to prevent double jump.
            // We'll rely on onend logic: we increment index there.
            // But cancel acts async. Best way:
            // 1. Pause isReading flag temporarily to stop onend from auto-advancing
            isReading = false; 
            synth.cancel();
            // 2. Advance index manually
            currentAudioIndex++;
            // 3. Resume
            isReading = true;
            speakCurrentIndex();
        }

        function audioPrev() {
            if (!isReading) return;
            isReading = false;
            synth.cancel();
            currentAudioIndex = Math.max(0, currentAudioIndex - 1);
            isReading = true;
            speakCurrentIndex();
        }

        function audioStop() {
            isReading = false;
            synth.cancel();
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            updateAudioUI();
        }

        function copySource() {
            const el = document.getElementById('source-code');
            el.select();
            document.execCommand('copy');
        }

        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl(); });
        
        // INIT
        loadBookmarks();
        window.addEventListener('DOMContentLoaded', () => loadUrl('https://npr.org'));

    </script>
</body>
</html>