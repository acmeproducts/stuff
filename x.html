<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v20</title>
    <style>
        :root {
            --primary: #222;
            --accent: #007bff;
            --bg: #f4f7f6;
            --border: #ced4da;
            --console-bg: #1e1e1e;
            --console-text: #d4d4d4;
        }

        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: -apple-system, sans-serif; background: var(--bg); overflow: hidden; }

        /* Navigation */
        .nav-bar { background: #fff; padding: 8px 10px; display: flex; gap: 8px; border-bottom: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .home-btn { background: none; border: 1px solid var(--border); border-radius: 4px; padding: 8px; font-size: 18px; cursor: pointer; }
        input { flex: 1; padding: 10px; border: 1px solid var(--border); border-radius: 20px; outline: none; font-size: 16px; }
        .go-btn { padding: 8px 20px; background: var(--accent); color: white; border: none; border-radius: 20px; font-weight: bold; cursor: pointer; }
        .go-btn:disabled { background: #6c757d; }

        /* Tabs */
        .tab-bar { display: flex; background: #e9ecef; border-bottom: 1px solid var(--border); overflow-x: auto; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: none; font-weight: 600; color: #6c757d; min-width: 80px; white-space: nowrap; cursor: pointer; }
        .tab-btn.active { background: #fff; color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* Panels */
        .content-area { flex: 1; position: relative; overflow: hidden; background: white; }
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }

        iframe { width: 100%; height: 100%; border: none; }

        /* Console Tab */
        #panel-console { background: var(--console-bg); color: var(--console-text); font-family: monospace; font-size: 12px; overflow-y: auto; padding: 10px; }
        .console-entry { padding: 4px 0; border-bottom: 1px solid #333; word-wrap: break-word; }
        .log-info { color: #87cefa; }
        .log-warn { color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
        .log-error { color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }
        .log-nav { color: #2ecc71; font-weight: bold; border-top: 1px solid #444; margin-top: 5px; padding-top: 5px; }

        /* Developer Tab */
        #panel-dev { padding: 15px; background: #f8f9fa; }
        .dev-toolbar { display: flex; gap: 10px; margin-bottom: 10px; }
        textarea.code-editor { flex: 1; width: 100%; padding: 15px; background: #282c34; color: #abb2bf; font-family: monospace; border: 1px solid #ccc; border-radius: 4px; resize: none; font-size: 14px; }
        .run-btn { background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }

        /* Overlays */
        #loading-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.9); z-index: 50; display: none; align-items: center; justify-content: center; flex-direction: column; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 30px;">üîÑ</div>
        <div>Loading...</div>
    </div>

    <nav class="nav-bar">
        <button class="home-btn" id="btnHome" title="Reset">üè†</button>
        <input type="text" id="urlInput" placeholder="URL or Search" />
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" onclick="switchTab('console')">Console <span id="console-badge"></span></button>
        <button class="tab-btn" onclick="switchTab('dev')">Developer</button>
        <button class="tab-btn" onclick="switchTab('source')">Source</button>
    </div>

    <div class="content-area">
        <div id="panel-browser" class="panel active">
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
        </div>

        <div id="panel-console">
            <div class="console-entry log-nav">System: Console Ready</div>
        </div>

        <div id="panel-dev" class="panel">
            <div class="dev-toolbar">
                <button class="run-btn" onclick="runDevCode()">‚ñ∂ Run Code</button>
                <button class="home-btn" onclick="document.getElementById('dev-code').value=''" title="Clear">üóëÔ∏è</button>
            </div>
            <textarea id="dev-code" class="code-editor" spellcheck="false" placeholder="// Write JavaScript here to inject into the page
// Example: alert(document.title);
document.body.style.background = 'red';"></textarea>
        </div>

        <div id="panel-source" class="panel">
            <textarea id="source-code" class="code-editor" spellcheck="false" style="height:100%; border:none;"></textarea>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://api.codetabs.com/v1/proxy?quest=";
        let fetchedHtml = "";

        // --- TABS ---
        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${name}`).classList.add('active');
            
            // Auto-refresh source view
            if(name === 'source') document.getElementById('source-code').value = fetchedHtml;
        }

        // --- LOGGER ---
        function logToConsole(msg, type='info') {
            const panel = document.getElementById('panel-console');
            const div = document.createElement('div');
            div.className = `console-entry log-${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
        }

        // --- CORE LOAD LOGIC ---
        async function loadUrl(urlOverride) {
            let url = urlOverride || document.getElementById('urlInput').value.trim();
            if (!url) return;

            // Smart Fix
            if (!url.includes('.') && !url.includes('://')) url = 'https://www.google.com/search?q=' + encodeURIComponent(url);
            else if (!url.startsWith('http')) url = 'https://' + url;

            document.getElementById('urlInput').value = url;
            document.getElementById('loading-overlay').style.display = 'flex';
            logToConsole(`Navigating to: ${url}`, 'nav');

            try {
                // 1. Fetch Source
                const res = await fetch(PROXY_URL + encodeURIComponent(url));
                const text = await res.text();
                
                // 2. Inject Magic Scripts
                const baseTag = `<base href="${url}" target="_self">`;
                
                // CONSOLE INTERCEPTOR: Steals logs from the iframe and sends them to us
                const consoleScript = `
                    <script>
                        (function() {
                            const oldLog = console.log;
                            const oldWarn = console.warn;
                            const oldError = console.error;
                            
                            function send(type, args) {
                                try {
                                    // Convert objects to string for safe message passing
                                    const msg = Array.from(args).map(a => 
                                        typeof a === 'object' ? JSON.stringify(a) : String(a)
                                    ).join(' ');
                                    window.parent.postMessage({type: 'console_forward', level: type, msg: msg}, '*');
                                } catch(e) {}
                            }

                            console.log = function(...args) { oldLog.apply(console, args); send('info', args); };
                            console.warn = function(...args) { oldWarn.apply(console, args); send('warn', args); };
                            console.error = function(...args) { oldError.apply(console, args); send('error', args); };
                            
                            // Click Interceptor (from v19)
                            window.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href && !link.href.startsWith('javascript')) {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    window.parent.postMessage({ type: 'internal_nav', url: link.href }, '*');
                                }
                            }, true);
                        })();
                    <\/script>
                `;

                const cleanHtml = text
                    .replace(/<head>/i, `<head>${baseTag}${consoleScript}`)
                    .replace(/Content-Security-Policy/gi, 'X-Disabled-CSP'); // Nuke CSP

                fetchedHtml = cleanHtml;
                document.getElementById('main-frame').srcdoc = cleanHtml;

            } catch (err) {
                logToConsole(`Load Error: ${err.message}`, 'error');
                // Fallback for strict sites (Google, etc)
                document.getElementById('main-frame').src = url; 
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // --- DEVELOPER TAB: RUN CODE ---
        function runDevCode() {
            const code = document.getElementById('dev-code').value;
            const frame = document.getElementById('main-frame');
            
            try {
                // We access the iframe's internal window to run the code there
                frame.contentWindow.eval(code);
                logToConsole("Executed custom script", 'info');
            } catch (err) {
                logToConsole(`Script Error: ${err.message}`, 'error');
            }
        }

        // --- MESSAGE HANDLER (The Bridge) ---
        window.addEventListener('message', (e) => {
            // Handle Navigation
            if (e.data.type === 'internal_nav') {
                // Unwrap Google Links
                let target = e.data.url;
                if(target.includes('google.com/url')) {
                    try { target = new URL(target).searchParams.get('url') || target; } catch(err){}
                }
                loadUrl(target);
            }
            // Handle Console Logs from Iframe
            if (e.data.type === 'console_forward') {
                logToConsole(e.data.msg, e.data.level);
            }
        });

        // Init
        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl() });
        document.getElementById('btnHome').onclick = () => loadUrl('https://startpage.com');

    </script>
</body>
</html>