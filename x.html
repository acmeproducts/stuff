<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Reader v8 (Stable)</title>
    <style>
        :root { --primary: #007aff; --bg: #f4f4f9; --text: #333; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); }
        
        /* Toolbar */
        .toolbar { background: white; padding: 12px; display: flex; gap: 10px; border-bottom: 1px solid #ccc; align-items: center; }
        input { flex: 1; padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 16px; background: var(--primary); color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: 600; white-space: nowrap; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: default; }
        .btn-green { background: #34c759; }
        .btn-red { background: #ff3b30; }

        /* Workspace */
        .workspace { flex: 1; position: relative; display: flex; flex-direction: column; }
        iframe { width: 100%; height: 100%; border: none; background: white; flex: 1; }

        /* Reader Overlay */
        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-header { padding: 15px; background: #f9f9f9; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { flex: 1; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #111; }
        
        /* Audio Highlight */
        .speaking { background-color: #fff3cd; box-shadow: -4px 0 0 #ffc107; padding-left: 8px; }

        /* Minimal Status Bar */
        #status-bar { padding: 8px; background: #333; color: white; font-size: 12px; text-align: center; display: none;}
    </style>
</head>
<body>

    <div class="toolbar">
        <input type="text" id="urlInput" placeholder="e.g. cnn (auto-adds .com)" />
        <button id="btnGo">Go</button>
        <button id="btnReader" class="btn-green">Reader View</button>
        <button id="btnSource" style="background:#5856d6">Source</button>
    </div>

    <div id="status-bar"></div>

    <div class="workspace">
        <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms"></iframe>

        <div id="reader-overlay">
            <div class="reader-header">
                <strong>Reader Mode</strong>
                <div style="display:flex; gap: 10px;">
                    <button id="btnPlay" class="btn-green" onclick="startAudio()">üîä Read Aloud</button>
                    <button id="btnStop" class="btn-red" onclick="stopAudio()" style="display:none;">‚èπ Stop</button>
                    <button onclick="closeReader()" style="background:#666;">Close</button>
                </div>
            </div>
            <div id="reader-content" class="reader-body"></div>
        </div>

        <div id="source-overlay" style="display:none; position:absolute; inset:0; background:rgba(0,0,0,0.8); z-index:200; align-items:center; justify-content:center;">
            <div style="background:white; width:90%; height:90%; display:flex; flex-direction:column; border-radius:8px; overflow:hidden;">
                <div style="padding:10px; background:#eee; display:flex; justify-content:space-between;">
                    <strong>Source Code</strong>
                    <button onclick="document.getElementById('source-overlay').style.display='none'" class="btn-red">Close</button>
                </div>
                <textarea id="source-code" style="flex:1; width:100%; resize:none; padding:10px; font-family:monospace; background:#222; color:#eee; border:none;"></textarea>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        // The robust proxy list from v5
        const PROXIES = [
            { name: "AllOrigins", url: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}` },
            { name: "CORSProxy", url: t => `https://corsproxy.io/?${encodeURIComponent(t)}` }
        ];

        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let currentAudioIndex = 0;

        // --- URL LOGIC (Restored) ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            // 1. Auto-add .com if missing tld
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) {
                url += '.com';
            }
            // 2. Auto-add https://
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            return url;
        }

        // --- FETCH LOGIC (Restored) ---
        async function loadUrl() {
            const raw = document.getElementById('urlInput').value;
            const url = fixUrl(raw);
            
            if(!url) return showStatus("Please enter a URL");
            
            // Visual feedback
            document.getElementById('urlInput').value = url; 
            showStatus(`Loading ${url}...`);
            document.getElementById('btnGo').disabled = true;

            let success = false;
            
            // Try proxies sequentially
            for(let proxy of PROXIES) {
                if(success) break;
                try {
                    const res = await fetch(proxy.url(url));
                    if(!res.ok) throw new Error("HTTP Error");
                    let text = await res.text();
                    
                    if(text.length < 100) throw new Error("Empty content");

                    // Inject Base Tag (Crucial for images)
                    const base = `<base href="${url}" target="_blank">`;
                    fetchedHtml = text.replace('<head>', `<head>${base}`);
                    
                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    success = true;
                    showStatus("Loaded successfully via " + proxy.name);
                } catch(e) {
                    console.warn(proxy.name + " failed.");
                }
            }

            if(!success) {
                showStatus("Proxies failed. Trying direct load (may be blocked).");
                document.getElementById('main-frame').src = url;
            }
            document.getElementById('btnGo').disabled = false;
        }

        function showStatus(msg) {
            const el = document.getElementById('status-bar');
            el.textContent = msg;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // --- READER LOGIC ---
        document.getElementById('btnReader').onclick = () => {
            if(!fetchedHtml) return showStatus("Load a URL first!");
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');

            // 1. Clean Garbage
            ['script','style','iframe','nav','footer','svg','noscript','button','form','aside'].forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            // 2. Extract Meaningful Text
            // We look for P and H tags that have substantial length
            let contentHTML = "";
            const nodes = doc.querySelectorAll('h1, h2, h3, p, article');
            
            const badPhrases = ["Getty Images", "Source:", "Copyright", "All rights reserved"];

            nodes.forEach(node => {
                const text = node.innerText.trim();
                // Filter logic: Must be > 20 chars, and not contain bad phrases
                if(text.length > 20 && !badPhrases.some(bad => text.includes(bad))) {
                    contentHTML += `<p>${text}</p>`;
                }
            });

            if(!contentHTML) contentHTML = "<p>Could not extract text automatically. The site might be purely Javascript.</p>";

            document.getElementById('reader-content').innerHTML = contentHTML;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        function closeReader() {
            stopAudio();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // --- AUDIO ENGINE (Robust) ---
        function startAudio() {
            stopAudio();
            
            const paras = document.querySelectorAll('#reader-content p');
            if(paras.length === 0) return;

            audioQueue = Array.from(paras);
            currentAudioIndex = 0;
            isReading = true;

            document.getElementById('btnPlay').style.display = 'none';
            document.getElementById('btnStop').style.display = 'inline-block';

            speakNext();
        }

        function speakNext() {
            if(!isReading || currentAudioIndex >= audioQueue.length) {
                stopAudio();
                return;
            }

            const p = audioQueue[currentAudioIndex];
            
            // Visual Highlight
            document.querySelectorAll('.speaking').forEach(el => el.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({behavior: "smooth", block: "center"});

            // Create Utterance
            const u = new SpeechSynthesisUtterance(p.innerText);
            u.rate = 1.0;
            
            // "Next" trigger
            u.onend = () => {
                currentAudioIndex++;
                speakNext();
            };
            
            // Error handling (skip bad para)
            u.onerror = () => {
                currentAudioIndex++;
                speakNext();
            };

            synth.speak(u);
        }

        function stopAudio() {
            isReading = false;
            synth.cancel();
            document.querySelectorAll('.speaking').forEach(el => el.classList.remove('speaking'));
            document.getElementById('btnPlay').style.display = 'inline-block';
            document.getElementById('btnStop').style.display = 'none';
        }

        // --- SOURCE LOGIC ---
        document.getElementById('btnSource').onclick = () => {
            if(!fetchedHtml) return showStatus("Load a URL first!");
            document.getElementById('source-code').value = fetchedHtml;
            document.getElementById('source-overlay').style.display = 'flex';
        };

        // --- EVENTS ---
        document.getElementById('btnGo').onclick = loadUrl;
        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if(e.key === 'Enter') loadUrl();
        });

    </script>
</body>
</html>