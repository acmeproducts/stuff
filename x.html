<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v19</title>
    <style>
        :root {
            --primary: #222;
            --accent: #007bff;
            --bg: #f4f7f6;
            --tab-active: #fff;
            --tab-inactive: #e9ecef;
            --border: #ced4da;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        /* --- UI Components --- */
        .nav-bar {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 10px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .home-btn {
            background: none;
            border: 1px solid var(--border);
            border-radius: 4px;
            cursor: pointer;
            padding: 8px 12px;
            font-size: 18px;
            transition: 0.2s;
        }
        .home-btn:hover { background: #eee; }

        input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 16px;
            outline: none;
            background: #f8f9fa;
        }
        input[type="text"]:focus { background: #fff; border-color: var(--accent); }

        .go-btn {
            padding: 10px 24px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }
        .go-btn:disabled { background-color: #6c757d; cursor: wait; }

        .tab-bar {
            display: flex;
            background: var(--tab-inactive);
            border-bottom: 1px solid var(--border);
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            border-right: 1px solid var(--border);
        }
        .tab-btn.active {
            background: var(--tab-active);
            color: var(--accent);
            border-bottom: 3px solid var(--accent);
        }

        .content-area {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: white;
        }

        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }

        iframe { width: 100%; height: 100%; border: none; }
        
        .browser-toolbar {
            padding: 8px 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reader-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        .reader-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Overlays */
        #loading-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.92);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #333;
            flex-direction: column;
            gap: 10px;
        }

        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-header { padding: 15px; background: #f8f9fa; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .reader-body { flex: 1; padding: 40px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #212529; }
        .speaking { background-color: #ffeeba; border-left: 5px solid #ffc107; padding-left: 10px; }

        /* Logs */
        .log-container {
            flex: 1;
            background: #343a40;
            color: #28a745;
            padding: 15px;
            font-family: monospace;
            overflow-y: auto;
            font-size: 12px;
        }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #495057; padding-bottom: 2px; }
        .log-time { color: #adb5bd; margin-right: 10px; }
        .log-err { color: #dc3545; }
        .log-nav { color: #ffc107; }
        .log-sys { color: #17a2b8; }

        /* Source View */
        textarea.source-viewer {
            flex: 1; width: 100%; padding: 15px; background: #212529; color: #f8f9fa; font-family: monospace; border: none; resize: none;
        }

        #master-footer {
            height: 30px;
            background-color: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            border-top: 1px solid #ccc;
        }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 30px;">üîÑ</div>
        <div id="loading-text">Fetching Content...</div>
    </div>

    <nav class="nav-bar">
        <button class="home-btn" id="btnHome" title="Home (Startpage)">üè†</button>
        <input type="text" id="urlInput" placeholder="Enter URL or Search Query" />
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" id="tabSource" onclick="switchTab('source')">Source Code</button>
        <button class="tab-btn" onclick="switchTab('logs')">System Logs</button>
    </div>

    <div class="content-area">
        
        <div id="panel-browser" class="panel active">
            <div class="browser-toolbar">
                <div id="status-indicator" style="font-size:12px; color:#6c757d;">Ready</div>
                <button class="reader-btn" id="btnReaderOpen">üìñ Read Page</button>
            </div>
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div id="reader-overlay">
                <div class="reader-header">
                    <strong>Reader Mode</strong>
                    <div style="display:flex; gap: 8px;">
                        <button class="reader-btn" onclick="startAudio()">üîä Play</button>
                        <button class="reader-btn" style="background:#dc3545; display:none;" id="btnStopAudio" onclick="stopAudio()">‚èπ Stop</button>
                        <button class="home-btn" onclick="closeReader()">Close</button>
                    </div>
                </div>
                <div id="reader-content" class="reader-body"></div>
            </div>
        </div>

        <div id="panel-source" class="panel">
            <div style="padding:10px; background:#f8f9fa; text-align:right; border-bottom:1px solid #ccc;">
                <button class="go-btn" style="padding:5px 15px;" id="btnCopySource" onclick="copySource()">Copy Code</button>
            </div>
            <textarea id="source-code" class="source-viewer" spellcheck="false"></textarea>
        </div>

        <div id="panel-logs" class="panel">
            <div class="log-container" id="log-output">
                <div class="log-entry">System Ready. v19 Unified (NPR + Google).</div>
            </div>
        </div>

    </div>

    <footer id="master-footer">
        Universal Web Tool v19.0 - 2025-12-10 03:30 PM
    </footer>

    <script>
        // --- CONFIG ---
        const PROXIES = [
            { name: "CodeTabs", url: t => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(t)}` },
            { name: "AllOrigins", url: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}` },
            { name: "CORSProxy", url: t => `https://corsproxy.io/?${encodeURIComponent(t)}` }
        ];

        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let currentAudioIndex = 0;

        // --- UTILS ---
        function log(msg, type="info") {
            const container = document.getElementById('log-output');
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? 'log-err' : (type === 'nav' ? 'log-nav' : (type === 'sys' ? 'log-sys' : ''));
            container.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span><span class="${color}">${msg}</span></div>`;
            container.scrollTop = container.scrollHeight;
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${tabName}`).classList.add('active');
            if (tabName === 'source') {
                document.getElementById('source-code').value = fetchedHtml || "Source not available.";
            }
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // --- URL LOGIC ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://') && !url.includes('localhost')) {
                // If it has spaces or looks like a query, search Google
                return `https://www.google.com/search?q=${encodeURIComponent(url)}`;
            }
            if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;
            return url;
        }

        async function loadUrl(urlOverride) {
            const raw = urlOverride || document.getElementById('urlInput').value;
            const url = fixUrl(raw);
            if(!url) return alert("Invalid URL");

            // --- RESET STATE ---
            stopAudio();
            document.getElementById('urlInput').value = url;
            document.getElementById('status-indicator').textContent = "Fetching...";
            document.getElementById('status-indicator').style.color = "#e67e22";
            toggleLoading(true);
            
            fetchedHtml = ""; 
            
            log(`Fetching: ${url}`);

            let success = false;

            for (let proxy of PROXIES) {
                if(success) break;
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 15000);
                    const res = await fetch(proxy.url(url), { signal: controller.signal });
                    clearTimeout(timeoutId);

                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let text = await res.text();
                    if(!text || text.length < 500) throw new Error("Empty/Short content");

                    // --- CLEANUP ---
                    text = cleanHTML(text);

                    // --- INJECTION ---
                    const baseTag = `<base href="${url}" target="_self">`;
                    
                    // UNIFIED INTERCEPTOR (Capture Phase + Stop Prop)
                    // This handles NPR PJAX by stopping the event
                    // This handles Google by catching the click to bubble up URL to parent
                    const navScript = `
                        <script>
                            window.addEventListener('click', function(e) {
                                const link = e.target.closest('a');
                                if (link && link.href && !link.href.startsWith('javascript') && !link.href.startsWith('#')) {
                                    // 1. Aggressively stop the site's own scripts (NPR PJAX fix)
                                    e.preventDefault();
                                    e.stopPropagation();
                                    e.stopImmediatePropagation();
                                    
                                    // 2. Send URL to parent for processing (Google Unwrap fix)
                                    console.log("Interceptor: " + link.href);
                                    window.parent.postMessage({ type: 'internal_nav', url: link.href }, '*');
                                }
                            }, true); // Capture phase is critical
                        <\/script>
                    `;

                    // UNIFIED CSS FIXES
                    // Blocks NPR OneTrust Shields AND Google Consent Walls
                    const unifiedCss = `
                        <style>
                            /* Google Blocks */
                            div[role="dialog"], div[aria-modal="true"], #lb, .bErdLd { display: none !important; }
                            
                            /* NPR / OneTrust Blocks */
                            #onetrust-consent-sdk, #onetrust-banner-sdk, .onetrust-pc-dark-filter, .optanon-alert-box-wrapper { 
                                display: none !important; 
                                pointer-events: none !important; 
                                visibility: hidden !important; 
                            }
                            
                            /* Global Scroll Fix */
                            html, body { overflow: auto !important; position: static !important; }
                        </style>
                    `;

                    if(text.includes('<head>')) {
                        fetchedHtml = text.replace('<head>', `<head>${baseTag}${navScript}${unifiedCss}`);
                    } else {
                        fetchedHtml = baseTag + navScript + unifiedCss + text;
                    }

                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    document.getElementById('status-indicator').textContent = "Proxy Active";
                    document.getElementById('status-indicator').style.color = "#28a745";
                    log(`Loaded via ${proxy.name}`, 'nav');
                    success = true;

                } catch(err) {
                    log(`${proxy.name} failed: ${err.message}`, 'error');
                }
            }

            if(!success) {
                log("All proxies failed. Fallback to direct (Reader Disabled).", 'error');
                document.getElementById('main-frame').src = url;
                document.getElementById('status-indicator').textContent = "Direct Mode (Broken Features)";
                document.getElementById('status-indicator').style.color = "#dc3545";
                document.getElementById('btnReaderOpen').disabled = true;
            } else {
                document.getElementById('btnReaderOpen').disabled = false;
            }

            toggleLoading(false);
        }

        function cleanHTML(htmlString) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(htmlString, 'text/html');
            
            // Remove Heavy Media
            ['video', 'audio', 'embed', 'object', 'iframe'].forEach(tag => {
                doc.querySelectorAll(tag).forEach(el => el.remove());
            });

            // Remove CSP (Fixes script blocking)
            doc.querySelectorAll('meta[http-equiv="Content-Security-Policy"]').forEach(el => el.remove());

            return doc.documentElement.outerHTML;
        }

        // --- NAVIGATION HUB ---
        window.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'internal_nav') {
                let targetUrl = event.data.url;
                
                // UNWRAP GOOGLE LINKS
                if (targetUrl.includes('google.com/url') || targetUrl.includes('google.co.uk/url')) {
                    try {
                        const urlObj = new URL(targetUrl);
                        const realUrl = urlObj.searchParams.get('q') || urlObj.searchParams.get('url');
                        if (realUrl) {
                            log(`Unwrapped Google Link: ${realUrl}`, 'sys');
                            targetUrl = realUrl;
                        }
                    } catch (e) {
                        log("Unwrap failed, using original.", 'error');
                    }
                }

                log(`Navigating: ${targetUrl}`, 'nav');
                loadUrl(targetUrl);
            }
        });

        document.getElementById('btnHome').onclick = () => {
            log("Home: Startpage");
            loadUrl('https://startpage.com');
        };

        // --- HYBRID READER ---
        document.getElementById('btnReaderOpen').onclick = () => {
            if(!fetchedHtml) return alert("Content unavailable.");
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');

            // Cleanup
            ['script','style','nav','footer','header','aside','svg','button','form', 'noscript'].forEach(t => doc.querySelectorAll(t).forEach(e => e.remove()));

            let contentHTML = "";
            let lastText = "";
            
            // GOOGLE SEARCH MODE
            if(document.getElementById('urlInput').value.includes('google')) {
                log("Reader: Search Mode");
                const items = doc.querySelectorAll('h3, .VwiC3b, .BNeawe'); 
                items.forEach(node => {
                    let text = node.innerText.trim();
                    if(text.length > 10 && text !== lastText) {
                        if(node.tagName === 'H3' || node.classList.contains('BNeawe')) {
                            contentHTML += `<h3>${text}</h3>`;
                        } else {
                            contentHTML += `<p>${text}</p><hr>`;
                        }
                        lastText = text;
                    }
                });
            } 
            
            // If Search Mode returned nothing, or we aren't on Google, try Article Mode
            if (!contentHTML) {
                log("Reader: Article Mode");
                // Expanded selectors for better coverage
                const nodes = doc.querySelectorAll('h1, h2, h3, p, article, .story-text, .story-body');
                const badPhrases = ["Getty Images", "Source:", "Copyright", "All rights reserved", "enlarge image", "toggle caption"];

                nodes.forEach(node => {
                    let text = node.innerText.trim().replace(/\s+/g, ' ');
                    if(text.length > 25 && !badPhrases.some(b => text.toLowerCase().includes(b.toLowerCase())) && text !== lastText) {
                        // Avoid duplicates from nested elements
                        contentHTML += `<p>${text}</p>`;
                        lastText = text;
                    }
                });
            }

            if(!contentHTML) contentHTML = "<p>No readable text found. The site may be strictly dynamic.</p>";
            document.getElementById('reader-content').innerHTML = contentHTML;
            document.getElementById('reader-overlay').style.display = 'flex';
        };

        function closeReader() {
            stopAudio();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // --- AUDIO ---
        function startAudio() {
            // Read headers too if in search mode
            const selectors = document.getElementById('urlInput').value.includes('google') ? 'h3, p' : 'p';
            const paras = document.querySelectorAll(`#reader-content ${selectors}`);
            if(paras.length === 0) return;
            
            stopAudio();
            audioQueue = Array.from(paras);
            currentAudioIndex = 0;
            isReading = true;
            document.getElementById('btnStopAudio').style.display = 'inline-block';
            playNextChunk();
        }

        function playNextChunk() {
            if(!isReading || currentAudioIndex >= audioQueue.length) {
                stopAudio();
                return;
            }
            const p = audioQueue[currentAudioIndex];
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({ behavior: "smooth", block: "center" });

            const u = new SpeechSynthesisUtterance(p.innerText);
            // Attempt to find a clear English voice
            const enVoice = synth.getVoices().find(v => v.lang.startsWith('en'));
            if(enVoice) u.voice = enVoice;

            u.onend = () => { currentAudioIndex++; playNextChunk(); };
            u.onerror = () => { currentAudioIndex++; playNextChunk(); };
            synth.speak(u);
        }

        function stopAudio() {
            isReading = false;
            synth.cancel();
            document.getElementById('btnStopAudio').style.display = 'none';
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
        }

        function copySource() {
            const el = document.getElementById('source-code');
            el.select();
            document.execCommand('copy');
            const btn = document.getElementById('btnCopySource');
            btn.innerText = "Copied!";
            setTimeout(() => btn.innerText = "Copy Code", 1500);
        }

        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl(); });

    </script>
</body>
</html>