<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Web Tool v27</title>
    <style>
        :root {
            --primary: #202124;
            --accent: #d93025;
            --bg: #f8f9fa;
            --border: #dadce0;
        }

        body {
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            overflow: hidden;
        }

        /* --- Nav Bar --- */
        .nav-bar {
            background: #fff;
            padding: 8px 12px;
            display: flex;
            gap: 8px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            z-index: 20;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .icon-btn {
            background: none;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            padding: 8px;
            font-size: 16px;
            color: #555;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 36px;
        }
        .icon-btn:hover { background: #eee; color: #000; }
        .icon-btn.active-profile { color: var(--accent); border-color: var(--accent); background: #fce8e6; }

        input[type="text"] {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
            background: #f1f3f4;
        }
        input[type="text"]:focus { background: #fff; border-color: var(--accent); }

        .go-btn {
            padding: 8px 20px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- Tabs --- */
        .tab-bar {
            display: flex;
            background: #fff;
            border-bottom: 1px solid var(--border);
            overflow-x: auto;
        }
        .tab-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background: none;
            cursor: pointer;
            font-weight: 500;
            color: #5f6368;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        .tab-btn.active { color: var(--accent); border-bottom: 3px solid var(--accent); }

        /* --- Content Areas --- */
        .content-area { flex: 1; position: relative; overflow: hidden; background: white; }
        .panel { display: none; width: 100%; height: 100%; flex-direction: column; }
        .panel.active { display: flex; }
        iframe { width: 100%; height: 100%; border: none; }

        .browser-toolbar {
            padding: 8px 15px;
            background: #fff;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
        }

        /* --- Modals --- */
        .modal {
            position: absolute;
            top: 60px;
            left: 10px;
            width: 280px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 100;
            max-height: 70vh;
            overflow-y: auto;
        }

        /* Bookmarks */
        .bookmark-item {
            display: flex; align-items: center; padding: 12px;
            border-bottom: 1px solid #f1f3f4; background: white; cursor: pointer;
        }
        .bookmark-item:hover { background: #f8f9fa; }
        .drag-handle { cursor: grab; padding-right: 12px; color: #ccc; }
        .bm-name { flex: 1; font-weight: 500; }
        .bm-delete { color: #ea4335; font-weight: bold; padding: 4px 8px; }

        /* Profiles Menu */
        #profile-modal { left: auto; right: 10px; width: 300px; }
        .profile-option {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        .profile-option:hover { background: #f8f9fa; }
        .profile-option strong { display: block; margin-bottom: 4px; color: #202124; }
        .profile-option span { font-size: 12px; color: #5f6368; }
        .profile-option.selected { background: #e8f0fe; border-left: 4px solid var(--accent); }

        /* --- Reader --- */
        #reader-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: white; z-index: 100; display: none; flex-direction: column;
        }
        .reader-body { flex: 1; padding: 20px 20px 100px 20px; overflow-y: auto; max-width: 800px; margin: 0 auto; line-height: 1.8; font-size: 18px; color: #202124; }
        .reader-controls-sticky {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: #fff; border-top: 1px solid #ccc; padding: 15px;
            display: flex; justify-content: center; gap: 20px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .audio-btn {
            background: white; border: 2px solid #ccc; border-radius: 50%;
            width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;
            font-size: 20px; cursor: pointer;
        }
        .speaking { background-color: #fce8b2; border-left: 5px solid #fbbc04; padding-left: 10px; }

        /* --- Logs/Console --- */
        .log-container { flex: 1; background: #202124; color: #5bb974; padding: 15px; font-family: monospace; overflow-y: auto; font-size: 12px; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .sys-nav { color: #fbbc04; } .sys-err { color: #ea4335; }
        
        /* Loading */
        #loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.95); z-index: 50; display: none; align-items: center; justify-content: center; font-size: 18px; color: #5f6368; flex-direction: column; gap: 15px; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div style="font-size: 40px;">üîÑ</div>
        <div id="loading-text">Fetching Content...</div>
    </div>

    <div id="bookmarks-modal" class="modal"></div>

    <div id="profile-modal" class="modal">
        <div class="profile-option" onclick="setProfile('standard')">
            <strong>1. Standard (Default)</strong>
            <span>Best for general sites (BBC, CNN). Balances compatibility and speed.</span>
        </div>
        <div class="profile-option" onclick="setProfile('shieldbreaker')">
            <strong>2. Shield Breaker (NPR)</strong>
            <span>Aggressively stops site scripts. Best for sites with audio players or PJAX navigation.</span>
        </div>
        <div class="profile-option" onclick="setProfile('redirector')">
            <strong>3. Redirector (Google News)</strong>
            <span>Unwraps tracking links and handles redirects. Fixes "Invalid Address" loops.</span>
        </div>
        <div class="profile-option" onclick="setProfile('textonly')">
            <strong>4. Text Only (Nuclear)</strong>
            <span>Strips ALL scripts/styles. Ugly, but loads almost anything.</span>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="icon-btn" onclick="toggleModal('bookmarks-modal')" title="Bookmarks">üîñ</button>
        <input type="text" id="urlInput" placeholder="Enter URL or Search Query" />
        <button class="icon-btn" id="btnProfile" onclick="toggleModal('profile-modal')" title="Extraction Method">‚öôÔ∏è</button>
        <button class="icon-btn" onclick="addCurrentToBookmarks()" title="Add Bookmark">‚ûï</button>
        <button class="go-btn" id="btnGo">Go</button>
    </nav>

    <div class="tab-bar">
        <button class="tab-btn active" onclick="switchTab('browser')">Browser</button>
        <button class="tab-btn" onclick="switchTab('console')">Console</button>
        <button class="tab-btn" onclick="switchTab('source')">Source</button>
        <button class="tab-btn" onclick="switchTab('logs')">Logs</button>
    </div>

    <div class="content-area">
        
        <div id="panel-browser" class="panel active">
            <div class="browser-toolbar">
                <div id="status-indicator">Ready</div>
                <button class="reader-btn" id="btnReaderOpen" onclick="openReader()">üìñ Read Page</button>
            </div>
            <iframe id="main-frame" sandbox="allow-same-origin allow-scripts allow-forms allow-popups"></iframe>
            
            <div id="reader-overlay">
                <button style="position:absolute; right:15px; top:15px; z-index:102; padding:10px;" onclick="closeReader()">‚úï Close</button>
                <div id="reader-content" class="reader-body"></div>
                <div class="reader-controls-sticky">
                    <button class="audio-btn" onclick="audioPrev()">‚è™</button>
                    <button class="audio-btn" id="btnPlayPause" onclick="audioToggle()">‚ñ∂</button>
                    <button class="audio-btn" onclick="audioNext()">‚è©</button>
                </div>
            </div>
        </div>

        <div id="panel-console" class="panel" style="background:#242424; padding:10px; font-family:monospace; color:#eee; overflow-y:auto;"></div>
        <div id="panel-source" class="panel"><textarea id="source-code" style="width:100%; height:100%; background:#242424; color:#aaa; border:none; padding:15px; resize:none;"></textarea></div>
        <div id="panel-logs" class="panel"><div class="log-container" id="log-output"></div></div>

    </div>

    <script>
        // --- PROFILES & CONFIG ---
        const PROXIES = {
            standard: t => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(t)}`,
            cors: t => `https://corsproxy.io/?${encodeURIComponent(t)}`,
            raw: t => `https://api.allorigins.win/raw?url=${encodeURIComponent(t)}`,
            fix: t => `https://proxy.corsfix.com/?${encodeURIComponent(t)}`
        };

        const PROFILES = {
            'standard': { name: "Standard", proxy: ['standard', 'cors'], intercept: 'standard', css: 'standard' },
            'shieldbreaker': { name: "Shield Breaker", proxy: ['raw', 'standard'], intercept: 'aggressive', css: 'aggressive' },
            'redirector': { name: "Redirector", proxy: ['fix', 'cors'], intercept: 'unwrap', css: 'standard' },
            'textonly': { name: "Text Only", proxy: ['raw'], intercept: 'none', css: 'nuclear' }
        };

        const DEFAULT_BOOKMARKS = [
            { name: "NPR", url: "https://npr.org" },
            { name: "BBC News", url: "https://bbc.com/news" },
            { name: "Google", url: "https://google.com" },
            { name: "Google News", url: "https://news.google.com" },
            { name: "PBS", url: "https://pbs.org/newshour" },
            { name: "CBC", url: "https://cbc.ca" },
            { name: "Alterslash", url: "https://alterslash.org" }
        ];

        // --- STATE ---
        let sitePrefs = JSON.parse(localStorage.getItem('uwt_site_prefs') || '{}');
        let bookmarks = JSON.parse(localStorage.getItem('uwt_bookmarks_v3') || JSON.stringify(DEFAULT_BOOKMARKS));
        let currentUrl = "";
        let fetchedHtml = "";
        let synth = window.speechSynthesis;
        let isReading = false;
        let audioQueue = [];
        let audioIndex = 0;

        // --- CORE FETCH ENGINE ---
        async function loadUrl(urlOverride) {
            const raw = urlOverride || document.getElementById('urlInput').value;
            let url = fixUrl(raw);
            if (!url) return;

            stopAudio();
            closeModals();
            document.getElementById('urlInput').value = url;
            toggleLoading(true);
            currentUrl = url;

            // Determine Profile
            const domain = new URL(url).hostname;
            // Auto-detect known difficult sites if no pref set
            if (!sitePrefs[domain]) {
                if (domain.includes('npr.org')) sitePrefs[domain] = 'shieldbreaker';
                else if (domain.includes('google.com')) sitePrefs[domain] = 'redirector';
                else if (domain.includes('alterslash')) sitePrefs[domain] = 'redirector';
                else sitePrefs[domain] = 'standard';
            }
            
            const profileKey = sitePrefs[domain];
            const profile = PROFILES[profileKey];
            
            updateProfileUI(profileKey);
            sysLog(`Loading ${domain} using [${profile.name}] profile`, 'nav');
            document.getElementById('status-indicator').innerText = `Method: ${profile.name}`;

            let success = false;
            for (let pKey of profile.proxy) {
                if(success) break;
                try {
                    const res = await fetch(PROXIES[pKey](url));
                    if(!res.ok) throw new Error(res.status);
                    let text = await res.text();
                    if(text.length < 500) throw new Error("Short/Empty");

                    // Transform
                    fetchedHtml = applyProfileTransform(text, url, profile);
                    document.getElementById('main-frame').srcdoc = fetchedHtml;
                    success = true;
                } catch(e) { sysLog(`Proxy [${pKey}] failed: ${e.message}`, 'err'); }
            }

            if(!success) {
                sysLog("All proxies failed. Using direct load.", 'err');
                document.getElementById('main-frame').src = url;
            }
            toggleLoading(false);
        }

        function applyProfileTransform(html, url, profile) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const baseTag = `<base href="${url}" target="_self">`;

            // 1. CSS Injection
            const cssBlock = document.createElement('style');
            cssBlock.textContent = `
                /* Base Shield Removal */
                #onetrust-consent-sdk, .optanon-alert-box-wrapper, div[role="dialog"] { display: none !important; }
                /* Google ReCAPTCHA Error Hide */
                .recaptcha-checkbox-border, #recaptcha_widget, .rc-anchor-error-msg-container { display: none !important; }
                html, body { overflow: auto !important; }
            `;
            doc.head.appendChild(cssBlock);

            if (profile.css === 'nuclear') {
                doc.querySelectorAll('link[rel="stylesheet"], style').forEach(e => e.remove());
            }

            // 2. Script Cleanup
            if (profile.intercept === 'aggressive' || profile.intercept === 'none') {
                doc.querySelectorAll('script').forEach(s => s.remove());
            } else {
                 // Remove heavy media scripts only
                 doc.querySelectorAll('script[src*="doubleclick"], script[src*="googlesyndication"]').forEach(s => s.remove());
            }

            // 3. Inject Interceptor
            let interceptorCode = "";
            if (profile.intercept !== 'none') {
                interceptorCode = `
                <script>
                    window.addEventListener('click', function(e) {
                        const link = e.target.closest('a');
                        if (link && link.href && !link.href.startsWith('javascript')) {
                            e.preventDefault();
                            ${profile.intercept === 'aggressive' ? 'e.stopPropagation(); e.stopImmediatePropagation();' : ''}
                            
                            let target = link.href;
                            // Unwrap Logic
                            if (target.includes('google.com/url')) {
                                try { target = new URL(target).searchParams.get('url') || target; } catch(e){}
                            }
                            
                            window.parent.postMessage({type:'nav', url: target}, '*');
                        }
                    }, true);
                    
                    // Console Spy
                    const log = (m) => window.parent.postMessage({type:'log', msg:m}, '*');
                    console.log = log; console.warn = log; console.error = log;
                <\/script>`;
            }

            return doc.documentElement.outerHTML.replace('<head>', `<head>${baseTag}${interceptorCode}`);
        }

        // --- PROFILE MANAGEMENT ---
        function setProfile(key) {
            if(!currentUrl) return;
            const domain = new URL(currentUrl).hostname;
            sitePrefs[domain] = key;
            localStorage.setItem('uwt_site_prefs', JSON.stringify(sitePrefs));
            closeModals();
            loadUrl(currentUrl); // Reload with new profile
        }

        function updateProfileUI(key) {
            document.querySelectorAll('.profile-option').forEach(el => el.classList.remove('selected'));
            // Visual feedback would go here, simplified for this file
        }

        // --- UI HELPERS ---
        function fixUrl(input) {
            let url = input.trim();
            if (!url) return null;
            if (!url.includes('.') && !url.includes('://')) return `https://www.google.com/search?q=${encodeURIComponent(url)}`;
            if (!url.startsWith('http')) return 'https://' + url;
            return url;
        }

        function toggleModal(id) {
            const el = document.getElementById(id);
            const isVis = el.style.display === 'flex';
            closeModals(); // Close others
            el.style.display = isVis ? 'none' : 'flex';
            if (id === 'bookmarks-modal' && !isVis) renderBookmarks();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        function toggleLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById(`panel-${name}`).classList.add('active');
            if(name==='source') document.getElementById('source-code').value = fetchedHtml;
        }

        function sysLog(msg, type='info') {
            const el = document.getElementById('log-output');
            el.innerHTML += `<div class="log-entry sys-${type}">[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        }

        // --- BOOKMARKS (Persist & Reorder) ---
        function renderBookmarks() {
            const c = document.getElementById('bookmarks-modal');
            c.innerHTML = '';
            bookmarks.forEach((bm, i) => {
                const row = document.createElement('div');
                row.className = 'bookmark-item';
                row.draggable = true;
                row.innerHTML = `<span class="drag-handle">‚â°</span><span class="bm-name">${bm.name}</span><span class="bm-delete">‚úï</span>`;
                row.querySelector('.bm-name').onclick = () => { loadUrl(bm.url); closeModals(); };
                row.querySelector('.bm-delete').onclick = (e) => { e.stopPropagation(); bookmarks.splice(i,1); saveBookmarks(); };
                
                // Drag Events
                row.ondragstart = e => { e.dataTransfer.setData('idx', i); row.classList.add('dragging'); };
                row.ondragend = () => row.classList.remove('dragging');
                row.ondragover = e => e.preventDefault();
                row.ondrop = e => {
                    e.preventDefault();
                    const fromIdx = e.dataTransfer.getData('idx');
                    const item = bookmarks.splice(fromIdx, 1)[0];
                    bookmarks.splice(i, 0, item);
                    saveBookmarks();
                };
                c.appendChild(row);
            });
        }

        function saveBookmarks() {
            localStorage.setItem('uwt_bookmarks_v3', JSON.stringify(bookmarks));
            renderBookmarks();
        }

        function addCurrentToBookmarks() {
            if(!currentUrl) return;
            const name = prompt("Name this bookmark:", new URL(currentUrl).hostname);
            if(name) { bookmarks.push({name, url: currentUrl}); saveBookmarks(); }
        }

        // --- MESSAGING ---
        window.addEventListener('message', e => {
            if(e.data.type === 'nav') loadUrl(e.data.url);
            if(e.data.type === 'log') {
                const c = document.getElementById('panel-console');
                c.innerHTML += `<div style="border-bottom:1px solid #333; padding:2px;">${e.data.msg}</div>`;
            }
        });

        // --- READER & AUDIO ---
        function openReader() {
            if(!fetchedHtml) return alert("Nothing loaded.");
            const parser = new DOMParser();
            const doc = parser.parseFromString(fetchedHtml, 'text/html');
            
            // Clean
            ['script','style','nav','footer','header','aside','svg','button'].forEach(t => doc.querySelectorAll(t).forEach(e => e.remove()));

            let contentHTML = "";
            let lastText = "";
            // Smart Selector: Detect Google vs Article
            const isGoogle = currentUrl.includes('google');
            const selector = isGoogle ? 'h3, .VwiC3b' : 'h1, h2, h3, p, article';

            doc.querySelectorAll(selector).forEach(node => {
                let text = node.innerText.trim();
                const bad = ["Getty", "Source:", "Copyright", "enlarge", "toggle caption"];
                if (text.length > 15 && !bad.some(b => text.includes(b)) && text !== lastText) {
                    contentHTML += `<p>${text}</p>`;
                    lastText = text;
                }
            });
            
            document.getElementById('reader-content').innerHTML = contentHTML || "<p>No text detected.</p>";
            document.getElementById('reader-overlay').style.display = 'flex';
        }

        function startAudio() {
            audioQueue = Array.from(document.querySelectorAll('#reader-content p'));
            if(audioQueue.length === 0) return;
            audioIndex = 0;
            isReading = true;
            playNextChunk();
        }

        function playNextChunk() {
            if(!isReading || audioIndex >= audioQueue.length) { stopAudio(); return; }
            const p = audioQueue[audioIndex];
            
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            p.classList.add('speaking');
            p.scrollIntoView({behavior:'smooth', block:'center'});

            const u = new SpeechSynthesisUtterance(p.innerText);
            const v = synth.getVoices().find(vo => vo.lang.startsWith('en'));
            if(v) u.voice = v;
            
            u.onend = () => { if(isReading) { audioIndex++; playNextChunk(); }};
            u.onerror = () => { if(isReading) { audioIndex++; playNextChunk(); }}; // Skip errors
            
            synth.cancel();
            synth.speak(u);
            document.getElementById('btnPlayPause').innerText = "‚è∏";
        }

        function audioToggle() {
            if(!isReading) startAudio();
            else if(synth.paused) { synth.resume(); document.getElementById('btnPlayPause').innerText = "‚è∏"; }
            else { synth.pause(); document.getElementById('btnPlayPause').innerText = "‚ñ∂"; }
        }

        function audioNext() {
            isReading = false; synth.cancel(); audioIndex++; isReading = true; playNextChunk();
        }
        
        function audioPrev() {
            isReading = false; synth.cancel(); audioIndex = Math.max(0, audioIndex-1); isReading = true; playNextChunk();
        }

        function stopAudio() {
            isReading = false; synth.cancel();
            document.querySelectorAll('.speaking').forEach(e => e.classList.remove('speaking'));
            document.getElementById('btnPlayPause').innerText = "‚ñ∂";
        }

        function closeReader() {
            stopAudio();
            document.getElementById('reader-overlay').style.display = 'none';
        }

        // Init
        document.getElementById('btnGo').onclick = () => loadUrl();
        document.getElementById('urlInput').addEventListener('keypress', e => { if(e.key==='Enter') loadUrl(); });
        window.addEventListener('DOMContentLoaded', () => loadUrl('https://npr.org'));

    </script>
</body>
</html>