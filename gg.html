<!-- GitHub-Tablet-Editor-v16-2025-08-23 11:56 PM -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GitHub Tablet Editor — v16</title>
  <style>
    :root {
      --gap: 8px; --pad: 12px; --border: 1px solid #d0d7de; --radius: 8px;
      --bg: #f6f8fa; --fg: #24292f; --muted: #57606a; --accent: #0969da; --ok: #1a7f37; --err: #d1242f;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;font-size:14px}
    .wrap{height:100vh;display:flex;flex-direction:column;gap:var(--gap);padding:var(--pad);overflow:hidden}
    .card{background:#fff;border:var(--border);border-radius:var(--radius);padding:var(--pad)}
    .row{display:flex;flex-wrap:wrap;gap:var(--gap);align-items:center}
    label{font-size:11px;color:var(--muted);display:block;margin-bottom:3px;font-weight:500}
    input[type=text],input[type=search],select{padding:8px 10px;border:var(--border);border-radius:6px;background:#fff;font-size:14px;min-width:0;flex:1}
    button{padding:8px 12px;border:var(--border);border-radius:6px;background:#f6f8fa;font-weight:500;cursor:pointer;font-size:13px;white-space:nowrap;min-height:36px; display:inline-flex; align-items:center; justify-content:center; gap: 4px;}
    button:hover:not(:disabled){border-color:#a0a5ac; background-color: #f3f4f6;}
    button:disabled{cursor:not-allowed; opacity:0.6;}
    button.primary{background:var(--ok);color:#fff;border-color:var(--ok)}
    button.primary:hover:not(:disabled){background:#176f32;}
    .icon-btn{padding:6px;min-width:36px;}
    .icon-btn svg{width:16px;height:16px;}
    .upload-btn{position:relative;overflow:hidden}
    .upload-btn input[type=file]{position:absolute;left:-9999px;opacity:0}
    .omni-wrap{position:relative;flex:1;min-width:0}
    .omni-list{position:absolute;top:100%;left:0;right:0;z-index:50;background:#fff;border:var(--border);border-radius:6px;margin-top:4px;max-height:40vh;overflow:auto;display:none}
    .omni-item{padding:8px 10px;border-bottom:var(--border);font-family:var(--mono);font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;cursor:pointer}
    .omni-item:last-child{border-bottom:none}
    .omni-item:hover{background:#f0f3f6}

    /* Main Layout */
    .grid{display:flex;flex-direction:column;gap:var(--gap);height:calc(100vh - 100px);min-height:0}
    .pane{display:flex;flex-direction:column;min-height:0;flex:1}
    .pane-header{display:flex;align-items:center;gap:var(--gap);margin-bottom:4px}
    .pane-header .chev{margin-right:auto;}
    .pane-filename{font-size:13px;font-weight:600;flex-shrink:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;padding:8px 0;}
    #filenameInput{padding:6px 10px;font-size:13px;font-weight:600;min-height:36px;}
    .chev{font-weight:700;cursor:pointer;border:none;background:transparent;font-size:16px;line-height:1;padding:4px;min-width:28px;color:var(--muted)}
    .chev:hover{color:var(--fg)}
    .textarea-wrap{position:relative;display:flex;flex-direction:column;gap:6px;min-height:0;flex:1}
    textarea{width:100%;height: calc(10 * 1.4em + 20px); border:var(--border);border-radius:6px;font-family:var(--mono);font-size:12px;line-height:1.4;resize:vertical;overflow:auto;padding:10px;padding-top:40px;}
    .collapsed .textarea-wrap, .collapsed .pane-search{display:none}

    /* Toolbar for Textareas */
    .textarea-toolbar{position:absolute;top:8px;right:8px;z-index:10;background:rgba(255,255,255,0.8);backdrop-filter:blur(4px);border-radius:6px;padding:4px;display:none;gap:4px;border:var(--border);}
    .textarea-wrap:focus-within .textarea-toolbar, .textarea-wrap.toolbar-visible .textarea-toolbar {display:flex;}
    .toolbar-btn{padding:4px 8px;font-size:11px;min-height:0;}
    .toolbar-find{display:flex;gap:4px;}
    .toolbar-find input{font-size:11px;padding:4px 6px;width:100px;}

    /* Modals */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);padding:12px;z-index:9990}
    .modal.open{display:flex}
    .panel{background:#fff;border:var(--border);border-radius:var(--radius);overflow:hidden;padding:16px;display:flex;flex-direction:column;max-height:90vh;width:90vw;max-width:1000px}
    .panel header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-shrink:0}
    .panel header h2{margin:0;font-size:16px;font-weight:600}
    .panel header .header-actions{display:flex;gap:8px;}
    .panel header button{border:none;background:transparent;font-weight:700;font-size:18px;cursor:pointer;padding:4px;min-width:32px}
    
    /* Side-by-side Diff Modal */
    #diffPanel{width:95vw;max-width:1400px;height:90vh;}
    .diff-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--gap);overflow:auto;flex-grow:1;font-size:11px;line-height:1.3;}
    .diff-col{display:flex;flex-direction:column;}
    .diff-col-header{font-weight:600;padding:4px 8px;border-bottom:var(--border);margin-bottom:4px;position:sticky;top:0;background:#fff;}
    .diff-line{white-space:pre;padding:0 8px;}
    .diff-line.del{background-color:#ffebe9;}
    .diff-line.add{background-color:#e6ffec;}
    .diff-line.context{color:var(--muted);}

    #previewFrame{width:100%;height:100%;border:none;flex-grow:1}
    .status-ok{color:var(--ok)} .status-err{color:var(--err)}
    .status-ok a{color:var(--ok);text-decoration:underline}
    .launch-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
    .launch-btn{background:var(--ok);color:#fff;border-color:var(--ok);text-decoration:none}
    .launch-btn:hover{background:#176f32;}
    .toast-wrap{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);display:grid;gap:6px;z-index:9999;max-width:90vw}
    .toast{background:#111827;color:#fff;padding:8px 12px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.2);font-size:13px;text-align:center}
    .warn{background:#c81e1e}
    .footer{text-align:center;font-size:10px;color:var(--muted);padding-top:var(--gap);border-top:var(--border);}
    
    #repoSettingsModal .row{display:flex;flex-direction:column;align-items:stretch;gap:var(--gap);}
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="row">
      <div class="omni-wrap">
        <input type="search" id="searchInput" placeholder="Search files…" autocomplete="off">
        <div id="omniList" class="omni-list" role="listbox" aria-label="File results"></div>
      </div>
      <button id="repoSettingsBtn" title="Repository Settings" type="button" class="icon-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 3.5a.5.5 0 01.5.5v.553a8.933 8.933 0 011.33.402l.45-.45a.5.5 0 01.707 0l.707.707a.5.5 0 010 .707l-.45.45c.17.41.296.843.402 1.33H12a.5.5 0 01.5.5v1a.5.5 0 01-.5.5h-.553a8.933 8.933 0 01-.402 1.33l.45.45a.5.5 0 010 .707l-.707.707a.5.5 0 01-.707 0l-.45-.45a8.933 8.933 0 01-1.33.402V12a.5.5 0 01-.5.5h-1a.5.5 0 01-.5-.5v-.553a8.933 8.933 0 01-1.33-.402l-.45.45a.5.5 0 01-.707 0l-.707-.707a.5.5 0 010-.707l.45-.45a8.933 8.933 0 01-.402-1.33H4a.5.5 0 01-.5-.5v-1a.5.5 0 01.5-.5h.553c.106-.487.232-.92.402-1.33l-.45-.45a.5.5 0 010-.707l.707-.707a.5.5 0 01.707 0l.45.45c.41-.17.843-.296 1.33-.402V4a.5.5 0 01.5-.5h1zM8 6a2 2 0 100 4 2 2 0 000-4z"/></svg>
      </button>
    </div>
  </div>
  <div class="grid">
    <!-- Original -->
    <div class="pane card collapsed" id="paneOriginal">
      <div class="row">
        <button id="copyOriginalBtn" class="icon-btn" title="Copy Content" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M4.5 1.75a.25.25 0 01.25-.25h6.5a.25.25 0 01.25.25v2.5h.25a.75.75 0 01.75.75v8.5a.75.75 0 01-.75.75h-8.5a.75.75 0 01-.75-.75v-8.5a.75.75 0 01.75-.75h.25v-2.5zM5 2.25v2h6v-2H5zm-.75 3.5v8h8v-8h-8z"/></svg></button>
        <button id="previewOriginalBtn" class="icon-btn" title="Preview" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path d="M8 1a2 2 0 00-2 2v.25a.75.75 0 01-1.5 0V3a3.5 3.5 0 017 0v.25a.75.75 0 01-1.5 0V3a2 2 0 00-2-2z"/><path fill-rule="evenodd" d="M2.5 6A1.5 1.5 0 001 7.5v6A1.5 1.5 0 002.5 15h11A1.5 1.5 0 0015 13.5v-6A1.5 1.5 0 0013.5 6h-11zM10 10.5a2 2 0 11-4 0 2 2 0 014 0z"/></svg></button>
        <button id="reloadOriginalBtn" class="icon-btn" title="Reload" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 2.5a5.487 5.487 0 00-4.131 1.869l1.204 1.204A.25.25 0 014.896 6H1.25A.25.25 0 011 5.75V2.104a.25.25 0 01.427-.177l1.38 1.38A7.001 7.001 0 0114.95 7.5a7 7 0 01-14 0 .25.25 0 01.5 0a6.5 6.5 0 0013 0 6.5 6.5 0 00-6.5-6.5z"/></svg></button>
      </div>
      <div class="pane-header">
        <button class="chev" id="chevOriginal" title="Toggle" type="button">▶</button>
        <div class="pane-filename" id="originalTitle">(no file selected)</div>
      </div>
      <div class="textarea-wrap">
        <div class="textarea-toolbar">
            <button class="toolbar-btn" id="scrollTopOriginal" title="Scroll to Top">⬆️</button>
            <div class="toolbar-find">
                <input type="search" id="findInputOriginal" placeholder="Find…">
            </div>
            <button class="toolbar-btn" id="fontSmallerOriginal">A-</button>
            <button class="toolbar-btn" id="fontLargerOriginal">A+</button>
        </div>
        <textarea id="originalBox" readonly placeholder="Original file content will appear here…"></textarea>
      </div>
    </div>
    <!-- Updated -->
    <div class="pane card" id="paneUpdated">
      <div class="row">
        <button class="upload-btn icon-btn" id="uploadBtn" type="button" title="Upload file"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M3.75 1.5a.25.25 0 00-.25.25v11.5c0 .138.112.25.25.25h8.5a.25.25 0 00.25-.25V6.19l-3.22-3.22H3.75zM2.25 1.75A1.75 1.75 0 014 0h5.25a.75.75 0 01.53.22l4.25 4.25c.141.14.22.331.22.53v6.75A1.75 1.75 0 0112 15H4a1.75 1.75 0 01-1.75-1.75V1.75zM8.5 3.75a.75.75 0 01.75.75v1.5h1.5a.75.75 0 010 1.5h-1.5v1.5a.75.75 0 01-1.5 0v-1.5h-1.5a.75.75 0 010-1.5h1.5v-1.5a.75.75 0 01.75-.75z"/></svg><input type="file" id="fileInput" accept="*/*"></button>
        <button id="pasteBtn" class="icon-btn" title="Paste" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M4.5 1.75a.25.25 0 01.25-.25h6.5a.25.25 0 01.25.25v2.5h.25a.75.75 0 01.75.75v8.5a.75.75 0 01-.75-.75h-8.5a.75.75 0 01-.75-.75v-8.5a.75.75 0 01.75-.75h.25v-2.5zM5 2.25v2h6v-2H5zm-.75 3.5v8h8v-8h-8z"/></svg></button>
        <button id="diffBtn" class="icon-btn" title="Diff" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M8 1.5a6.5 6.5 0 100 13 6.5 6.5 0 000-13zM0 8a8 8 0 1116 0A8 8 0 010 8zm7.25-3.53a.75.75 0 011.06 1.06L5.56 8l2.75 2.47a.75.75 0 11-1.06 1.06L3.97 8.53a.75.75 0 010-1.06l3.28-2.94z"/></svg></button>
        <button id="commitBtn" class="primary icon-btn" title="Commit" type="button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" d="M13.78 4.22a.75.75 0 010 1.06l-7.25 7.25a.75.75 0 01-1.06 0L2.22 9.28a.75.75 0 011.06-1.06L6 10.94l6.72-6.72a.75.75 0 011.06 0z"/></svg></button>
      </div>
      <div class="pane-header">
        <button class="chev" id="chevUpdated" title="Toggle" type="button">▶</button>
        <input type="text" id="filenameInput" class="pane-filename" placeholder="filename">
      </div>
      <div class="textarea-wrap">
         <div class="textarea-toolbar">
            <button class="toolbar-btn" id="scrollTopUpdated" title="Scroll to Top">⬆️</button>
            <div class="toolbar-find">
                <input type="search" id="findInputUpdated" placeholder="Find…">
            </div>
            <button class="toolbar-btn" id="fontSmallerUpdated">A-</button>
            <button class="toolbar-btn" id="fontLargerUpdated">A+</button>
        </div>
        <textarea id="updatedBox" placeholder="Paste updated content here or upload a file above…"></textarea>
      </div>
    </div>
  </div>
  <div class="footer" id="masterFooter">GitHub-Tablet-Editor-v15-2025-08-23 10:12 PM</div>
</div>

<!-- Modals -->
<div id="repoSettingsModal" class="modal" role="dialog" aria-modal="true" aria-label="Repository Settings"><div class="panel"><header><h2>Repository Settings</h2><button id="repoSettingsClose" title="Close" type="button">✕</button></header><div class="row"><label for="userInput">User / Organization</label><input type="text" id="userInput"><label for="repoSelect">Repository</label><select id="repoSelect" disabled><option>Enter user first</option></select></div></div></div>
<div id="commitModal" class="modal" role="dialog" aria-modal="true" aria-label="Commit status"><div class="panel"><header><h2>Commit Status</h2><button id="commitClose" title="Close" type="button">✕</button></header><ol id="commitSteps"></ol><div id="commitActions" style="margin-top: 16px;"></div></div></div>
<div id="diffModal" class="modal" role="dialog" aria-modal="true" aria-label="Diff view"><div class="panel" id="diffPanel"><header><h2>Diff Preview</h2><div class="header-actions"><button id="copyDiffBtn" type="button">Copy Diff</button><button id="diffClose" title="Close" type="button">✕</button></div></header><div id="diffOutput" class="diff-grid"></div></div></div>
<div id="previewModal" class="modal" role="dialog" aria-modal="true" aria-label="Preview"><div class="panel" style="height:90vh;width:95vw;"><header><h2>Preview</h2><button id="previewClose" title="Close" type="button">✕</button></header><iframe id="previewFrame" sandbox="allow-scripts allow-same-origin"></iframe></div></div>
<div id="pasteModal" class="modal" role="dialog" aria-modal="true" aria-label="Paste content"><div class="panel"><header><h2>Paste Content</h2><button id="pasteClose" title="Close" type="button">✕</button></header><div class="muted" style="margin-bottom:8px">Clipboard read not permitted. Paste here and confirm.</div><textarea id="pasteArea" style="width:100%;height:40vh;min-height:200px"></textarea><div style="margin-top:10px;text-align:right;"><button id="pasteConfirm" class="primary" type="button">Use This Content</button></div></div></div>
<div class="toast-wrap" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script>
(() => {
  // --- State and Constants ---
  const DEFAULT_USER = "acmeproducts";
  const DEFAULT_REPO_HINT = "stuff";
  let GITHUB_TOKEN = null;
  let currentUser = DEFAULT_USER;
  let currentRepo = null;
  let repoDefaultBranch = 'main';
  let treeCache = [];
  let currentPath = null;
  let currentSha = null;

  // --- Element Cache ---
  const $ = (id) => document.getElementById(id);
  const elements = {
    userInput: $('userInput'), repoSelect: $('repoSelect'), searchInput: $('searchInput'), omniList: $('omniList'),
    repoUserDisplay: $('repoUserDisplay'), repoNameDisplay: $('repoNameDisplay'),
    repoSettingsBtn: $('repoSettingsBtn'), repoSettingsModal: $('repoSettingsModal'), repoSettingsClose: $('repoSettingsClose'),
    paneOriginal: $('paneOriginal'), chevOriginal: $('chevOriginal'), originalTitle: $('originalTitle'), originalBox: $('originalBox'),
    copyOriginalBtn: $('copyOriginalBtn'), previewOriginalBtn: $('previewOriginalBtn'), reloadOriginalBtn: $('reloadOriginalBtn'),
    fontSmallerOriginal: $('fontSmallerOriginal'), fontLargerOriginal: $('fontLargerOriginal'), findInputOriginal: $('findInputOriginal'),
    scrollTopOriginal: $('scrollTopOriginal'),
    paneUpdated: $('paneUpdated'), chevUpdated: $('chevUpdated'), updatedBox: $('updatedBox'), filenameInput: $('filenameInput'),
    uploadBtn: $('uploadBtn'), fileInput: $('fileInput'), pasteBtn: $('pasteBtn'), diffBtn: $('diffBtn'), commitBtn: $('commitBtn'),
    fontSmallerUpdated: $('fontSmallerUpdated'), fontLargerUpdated: $('fontLargerUpdated'), findInputUpdated: $('findInputUpdated'),
    scrollTopUpdated: $('scrollTopUpdated'),
    commitModal: $('commitModal'), commitClose: $('commitClose'), commitSteps: $('commitSteps'), commitActions: $('commitActions'),
    diffModal: $('diffModal'), diffClose: $('diffClose'), diffOutput: $('diffOutput'), copyDiffBtn: $('copyDiffBtn'),
    previewModal: $('previewModal'), previewClose: $('previewClose'), previewFrame: $('previewFrame'),
    pasteModal: $('pasteModal'), pasteClose: $('pasteClose'), pasteArea: $('pasteArea'), pasteConfirm: $('pasteConfirm'),
    toasts: $('toasts')
  };

  // --- Helpers ---
  const headers = () => ({ "Authorization": "token " + GITHUB_TOKEN, "Accept": "application/vnd.github.v3+json" });
  const isSecure = window.isSecureContext;

  function toast(msg, ms=2200, cls=''){
    const div = document.createElement('div');
    div.className = 'toast' + (cls ? ' '+cls : '');
    div.textContent = msg;
    elements.toasts.appendChild(div);
    setTimeout(() => { div.remove(); }, ms);
  }

  function handleError(error, context) {
      console.error(context, error);
      const message = `${context}: ${error.message || 'An unknown error occurred.'}`;
      toast(message, 4500, 'warn');
  }

  function setPaneCollapsed(el, chev, collapsed){
    el.classList.toggle('collapsed', collapsed);
    chev.innerHTML = collapsed ? '▶' : '▼';
  }

  function b64EncodeUnicode(str) { return btoa(unescape(encodeURIComponent(str))); }
  function b64DecodeUnicode(b64) { return decodeURIComponent(escape(atob(b64))); }

  function canonicalize(text){
    if(text == null) return '';
    if(text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
    return text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
  }

  // --- GitHub API Functions ---
  async function githubFetch(url, options = {}) {
      const res = await fetch(url, { ...options, headers: headers() });
      if (!res.ok) {
          const errorBody = await res.text();
          throw new Error(`GitHub API Error (${res.status}): ${errorBody}`);
      }
      if (res.status === 204) return null;
      return res.json();
  }

  async function fetchReposForIdentity(identity){
    const collected = new Map();
    const urls = [
        `https://api.github.com/users/${encodeURIComponent(identity)}/repos?per_page=100&type=owner&sort=updated`,
        `https://api.github.com/orgs/${encodeURIComponent(identity)}/repos?per_page=100&type=all&sort=updated`
    ];
    if (identity.toLowerCase() === (localStorage.getItem('github_user') || '').toLowerCase()) {
        urls.push(`https://api.github.com/user/repos?per_page=100&sort=updated`);
    }
    const tasks = urls.map(url =>
        githubFetch(url).then(data => {
            (data || []).forEach(r => {
                if (!collected.has(r.full_name)) collected.set(r.full_name, r);
            });
        }).catch(() => {})
    );
    await Promise.all(tasks);
    return Array.from(collected.values()).sort((a,b)=> new Date(b.updated_at) - new Date(a.updated_at));
  }

  async function fetchRepoInfo(user, repo){
    return githubFetch(`https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}`);
  }

  async function fetchRepoTree(user, repo, branch){
    const data = await githubFetch(`https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/git/trees/${encodeURIComponent(branch)}?recursive=1`);
    if(!data.tree) throw new Error('Invalid tree response');
    return data.tree.filter(e=>e.type==='blob').map(e=>({path:e.path,sha:e.sha}));
  }

  async function fetchFileContent(user, repo, path, ref){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}${ref?`?ref=${encodeURIComponent(ref)}`:''}`;
    try {
        const data = await githubFetch(url);
        const content = b64DecodeUnicode(data.content);
        return {content, sha:data.sha, path:data.path};
    } catch (error) {
        if (error.message.includes("404")) return null;
        throw error;
    }
  }

  async function putFileContent(user, repo, path, message, newContent, branch, sha){
    const url = `https://api.github.com/repos/${encodeURIComponent(user)}/${encodeURIComponent(repo)}/contents/${encodeURIComponent(path)}`;
    const payload = {message, content:b64EncodeUnicode(newContent), branch};
    if (sha) payload.sha = sha;
    return githubFetch(url, { method:'PUT', body:JSON.stringify(payload) });
  }

  // --- Diff Generation ---
  function renderSideBySideDiff(oldText, newText) {
      const oldLines = canonicalize(oldText || '').split('\n');
      const newLines = canonicalize(newText || '').split('\n');
      let beforeHTML = '<div class="diff-col-header">Before</div>';
      let afterHTML = '<div class="diff-col-header">After</div>';
      const maxLines = Math.max(oldLines.length, newLines.length);

      for (let i = 0; i < maxLines; i++) {
          const oldLine = oldLines[i];
          const newLine = newLines[i];
          const oldLineExists = oldLine !== undefined;
          const newLineExists = newLine !== undefined;

          if (oldLine === newLine) {
              beforeHTML += `<div class="diff-line context">${oldLineExists ? oldLine : ''}</div>`;
              afterHTML += `<div class="diff-line context">${newLineExists ? newLine : ''}</div>`;
          } else {
              beforeHTML += `<div class="diff-line ${oldLineExists ? 'del' : ''}">${oldLineExists ? oldLine : ''}</div>`;
              afterHTML += `<div class="diff-line ${newLineExists ? 'add' : ''}">${newLineExists ? newLine : ''}</div>`;
          }
      }
      return `<div class="diff-col">${beforeHTML}</div><div class="diff-col">${afterHTML}</div>`;
  }

  // --- UI and Event Handlers ---
  function hideOmni(){ elements.omniList.style.display='none'; }
  function showOmni(){ elements.omniList.style.display='block'; }
  function clearOmni(){ elements.omniList.innerHTML=''; }

  function filterResultsInline(){
    const q=(elements.searchInput.value||'').toLowerCase().trim();
    clearOmni();
    if(!q){ hideOmni(); return; }
    let items = treeCache.filter(e=> e.path.toLowerCase().includes(q));
    items = items.slice().sort((a,b)=>{
      const qa = a.path.toLowerCase().endsWith(q) ? 0 : a.path.length;
      const qb = b.path.toLowerCase().endsWith(q) ? 0 : b.path.length;
      return qa - qb;
    }).slice(0,300);
    if(!items.length){ hideOmni(); return; }
    for(const it of items){
      const div=document.createElement('div');
      div.className='omni-item'; div.textContent=it.path; div.title=it.path;
      div.addEventListener('click',()=>{ onSelectPath(it.path); hideOmni(); });
      elements.omniList.appendChild(div);
    }
    showOmni();
  }

  function populateFilenameFields(path) {
    if (!path) { elements.filenameInput.value = ''; return; }
    const lastDot = path.lastIndexOf('.');
    elements.filenameInput.value = lastDot > -1 ? path.substring(0, lastDot) : path;
  }

  async function onSelectPath(path){
    try{
      const fileData = await fetchFileContent(currentUser, currentRepo, path, repoDefaultBranch);
      if (!fileData) throw new Error("File not found in repository.");
      currentPath = path; currentSha = fileData.sha;
      elements.originalTitle.textContent = path;
      elements.originalBox.value = fileData.content;
      elements.updatedBox.value = '';
      populateFilenameFields(path);
      setPaneCollapsed(elements.paneOriginal, elements.chevOriginal, true);
      toast('File loaded');
    }catch(e){ handleError(e, `Failed to load ${path}`); }
  }

  async function refreshRepoContext(){
    try {
        currentUser = elements.userInput.value.trim();
        currentRepo = elements.repoSelect.value.trim();
        if(!currentUser || !currentRepo){
            toast('User and repository must be selected', 2500, 'warn');
            return;
        }
        
        const info = await fetchRepoInfo(currentUser, currentRepo);
        repoDefaultBranch = info.default_branch || 'main';
        treeCache = await fetchRepoTree(currentUser, currentRepo, repoDefaultBranch);
        hideOmni(); clearOmni(); elements.searchInput.value='';
        currentPath=null; currentSha=null; elements.originalBox.value=''; elements.updatedBox.value=''; elements.originalTitle.textContent='(no file selected)';
        populateFilenameFields(null);
    } catch(e) {
        handleError(e, "Failed to refresh repository context");
    }
  }

  async function populateRepos(identity, prefer){
    elements.repoSelect.disabled = true;
    elements.repoSelect.innerHTML = '<option>Loading…</option>';
    try{
      const repos = await fetchReposForIdentity(identity);
      elements.repoSelect.innerHTML = '';
      if(!repos.length){
        elements.repoSelect.innerHTML = '<option value="">No repositories found</option>';
      } else {
        repos.forEach(r => {
          const opt = document.createElement('option');
          opt.value = r.name; opt.textContent = r.name;
          if(prefer && r.name.toLowerCase()===prefer.toLowerCase()) opt.selected = true;
          elements.repoSelect.appendChild(opt);
        });
      }
    }catch(e){
      elements.repoSelect.innerHTML = '<option value="">Error loading repos</option>';
      handleError(e, "Failed to load repositories");
    }finally{
      elements.repoSelect.disabled = false;
    }
  }

  async function handleFileUpload(file) {
    try {
      populateFilenameFields(file.name);
      const content = await file.text();
      elements.updatedBox.value = content;
      setPaneCollapsed(elements.paneUpdated, elements.chevUpdated, false);
      toast(`File "${file.name}" uploaded successfully`);
    } catch (error) {
      handleError(error, "Failed to upload file");
    }
  }

  async function robustCopy(text){
    try{
      await navigator.clipboard.writeText(text);
      toast('Copied');
    }catch{
      try {
        const ta=document.createElement('textarea'); ta.value=text; ta.style.position='fixed'; ta.style.opacity='0'; document.body.appendChild(ta);
        ta.focus(); ta.select(); document.execCommand('copy'); ta.remove();
        toast('Copied');
      } catch (e) {
        handleError(e, "Failed to copy text");
      }
    }
  }

  async function robustPaste(){
    if(isSecure && navigator.clipboard && navigator.clipboard.readText){
      try{ return await navigator.clipboard.readText(); }
      catch{ return await modalPaste(); }
    } else {
      return await modalPaste();
    }
  }

  function modalPaste(){
    elements.pasteArea.value='';
    elements.pasteModal.classList.add('open');
    return new Promise((resolve)=>{
      const onConfirm = () => { cleanup(); resolve(elements.pasteArea.value); };
      const onClose = () => { cleanup(); resolve(''); };
      const cleanup = () => {
        elements.pasteModal.classList.remove('open');
        elements.pasteConfirm.removeEventListener('click', onConfirm);
        elements.pasteClose.removeEventListener('click', onClose);
      };
      elements.pasteConfirm.addEventListener('click', onConfirm);
      elements.pasteClose.addEventListener('click', onClose);
    });
  }

  function createLaunchLink(user, repo, filePath) {
    const launchUrl = `https://${user}.github.io/${repo}/${filePath}`;
    const launchLink = document.createElement('a');
    launchLink.href = launchUrl;
    launchLink.target = '_blank';
    launchLink.rel = 'noopener noreferrer';
    launchLink.className = 'launch-btn';
    launchLink.innerHTML = '🚀 Launch';
    launchLink.title = `Open ${launchUrl}`;
    return launchLink;
  }
  
  function setupTextAreaToolbar(textarea, smallerBtn, largerBtn, findInput, scrollTopBtn) {
      let currentFontSize = 12;
      smallerBtn.addEventListener('click', () => {
          currentFontSize = Math.max(8, currentFontSize - 1);
          textarea.style.fontSize = `${currentFontSize}px`;
      });
      largerBtn.addEventListener('click', () => {
          currentFontSize = Math.min(24, currentFontSize + 1);
          textarea.style.fontSize = `${currentFontSize}px`;
      });
      if (findInput) {
        findInput.addEventListener('input', () => {
            // Placeholder for a more complex find implementation
        });
      }
      if (scrollTopBtn) {
        scrollTopBtn.addEventListener('click', () => {
            textarea.scrollTop = 0;
        });
      }
  }

  function setEventListeners() {
    elements.chevOriginal.addEventListener('click',()=> setPaneCollapsed(elements.paneOriginal, elements.chevOriginal, !elements.paneOriginal.classList.contains('collapsed')));
    elements.chevUpdated.addEventListener('click',()=> setPaneCollapsed(elements.paneUpdated, elements.chevUpdated, !elements.paneUpdated.classList.contains('collapsed')));
    elements.copyOriginalBtn.addEventListener('click', () => robustCopy(elements.originalBox.value||''));
    elements.reloadOriginalBtn.addEventListener('click', () => {
      if(currentPath) { toast('Reloading...'); onSelectPath(currentPath); } 
      else { toast('No file selected to reload', 2500, 'warn'); }
    });
    elements.previewOriginalBtn.addEventListener('click', ()=>{
      const html = elements.originalBox.value || '';
      const hasHtml = /<html[\s>]/i.test(html);
      const finalHtml = hasHtml ? html : `<!DOCTYPE html><html><head><meta charset="utf-8"><title>Preview</title></head><body>${html}</body></html>`;
      elements.previewFrame.srcdoc = finalHtml;
      elements.previewModal.classList.add('open');
    });
    elements.previewClose.addEventListener('click',()=> { elements.previewModal.classList.remove('open'); elements.previewFrame.srcdoc = ''; });
    elements.uploadBtn.addEventListener('click', () => elements.fileInput.click());
    elements.fileInput.addEventListener('change', (e) => { if (e.target.files[0]) handleFileUpload(e.target.files[0]); });
    elements.pasteBtn.addEventListener('click', async ()=>{
      setPaneCollapsed(elements.paneUpdated, elements.chevUpdated, false);
      elements.updatedBox.focus();
      const text = await robustPaste();
      if(text !== undefined && text !== null){
        elements.updatedBox.value = text;
        elements.updatedBox.scrollTop = 0;
        if(text) toast('Pasted');
      }
    });
    elements.diffBtn.addEventListener('click', ()=>{
      if(!currentPath && !elements.filenameInput.value){ toast('No file selected or named', 2500, 'warn'); return; }
      const diffHTML = renderSideBySideDiff(elements.originalBox.value||'', elements.updatedBox.value||'');
      elements.diffOutput.innerHTML = diffHTML;
      elements.diffModal.classList.add('open');
    });
    elements.diffClose.addEventListener('click',()=> elements.diffModal.classList.remove('open'));
    elements.copyDiffBtn.addEventListener('click', () => robustCopy(elements.diffOutput.innerText));
    elements.commitBtn.addEventListener('click', handleCommit);
    elements.commitClose.addEventListener('click',()=> elements.commitModal.classList.remove('open'));
    
    // Repo Settings Modal
    elements.repoSettingsBtn.addEventListener('click', () => elements.repoSettingsModal.classList.add('open'));
    elements.repoSettingsClose.addEventListener('click', () => {
        elements.repoSettingsModal.classList.remove('open');
        refreshRepoContext(); // Refresh context when closing modal
    });
    elements.userInput.addEventListener('change', () => populateRepos(elements.userInput.value.trim()));

    elements.searchInput.addEventListener('input', filterResultsInline);
    document.addEventListener('click',(e)=>{ if(!e.target.closest('.omni-wrap')) hideOmni(); });
  }

  function setStatus(text, cls){
    const li=document.createElement('li'); li.textContent=text; if(cls) li.className=cls;
    elements.commitSteps.appendChild(li); elements.commitSteps.scrollTop = elements.commitSteps.scrollHeight;
  }

  async function handleCommit() {
    const filenameBase = elements.filenameInput.value.trim();
    if (!filenameBase) { toast('Filename cannot be empty.', 2500, 'warn'); return; }
    const newPath = filenameBase + '.html';

    elements.commitSteps.innerHTML='';
    elements.commitActions.innerHTML = '';
    elements.commitModal.classList.add('open');

    setStatus('Validating selection…');
    setStatus(`Preparing commit to ${currentUser}/${currentRepo}@${repoDefaultBranch}`);

    try {
        setStatus(`Checking for existing file at "${newPath}"...`);
        const existingFile = await fetchFileContent(currentUser, currentRepo, newPath, repoDefaultBranch);
        const shaForCommit = existingFile ? existingFile.sha : null;
        const message = existingFile ? `Update ${newPath}` : `Create ${newPath}`;
        setStatus(existingFile ? `File exists. Preparing to update.` : `File does not exist. Preparing to create.`);

        setStatus('Pushing commit via GitHub API…');
        const resp = await putFileContent(currentUser, currentRepo, newPath, message, elements.updatedBox.value, repoDefaultBranch, shaForCommit);
        const csha = resp.commit && resp.commit.sha ? resp.commit.sha.substring(0,7) : 'unknown';

        const li = document.createElement('li'); li.className = 'status-ok';
        const a = document.createElement('a');
        a.href = `https://github.com/${currentUser}/${currentRepo}/commit/${resp.commit.sha}`;
        a.target = '_blank'; a.rel = 'noopener noreferrer';
        a.textContent = `Commit succeeded: ${csha}`;
        li.appendChild(a);
        elements.commitSteps.appendChild(li);

        const deployLi = document.createElement('li'); deployLi.className = 'status-ok';
        const deployLink = document.createElement('a');
        deployLink.href = `https://github.com/${currentUser}/${currentRepo}/actions/workflows/static.yml`;
        deployLink.target = '_blank'; deployLink.rel = 'noopener noreferrer';
        deployLink.textContent = `View deployment status →`;
        deployLi.appendChild(deployLink);
        elements.commitSteps.scrollTop = elements.commitSteps.scrollHeight;

        const launchActions = document.createElement('div'); launchActions.className = 'launch-actions';
        const copyBtn = document.createElement('button');
        copyBtn.textContent = 'Copy Log';
        copyBtn.addEventListener('click', () => robustCopy(elements.commitSteps.innerText));
        const launchLink = createLaunchLink(currentUser, currentRepo, newPath);
        launchActions.appendChild(copyBtn);
        launchActions.appendChild(launchLink);
        elements.commitActions.appendChild(launchActions);

        elements.originalBox.value = elements.updatedBox.value;
        currentPath = newPath;
        currentSha = resp.content.sha;
        elements.originalTitle.textContent = newPath;
        populateFilenameFields(newPath);

        fetchRepoTree(currentUser, currentRepo, repoDefaultBranch).then(tree => treeCache = tree);
        toast('Committed');
    } catch(e) {
        setStatus('Commit failed','status-err');
        setStatus(e.message||String(e),'status-err');
        handleError(e, "Commit failed");
    }
  }

  // --- Bootstrap ---
  async function init(){
    GITHUB_TOKEN = localStorage.getItem('github_pat');
    if (!GITHUB_TOKEN) {
        const input = prompt("Enter your GitHub Personal Access Token:");
        if (input && input.trim()) {
            GITHUB_TOKEN = input.trim();
            localStorage.setItem('github_pat', GITHUB_TOKEN);
        } else {
            document.body.innerHTML = '<div style="padding:20px;text-align:center;">A GitHub token is required to use this application. Please reload and provide a token.</div>';
            return;
        }
    }

    setEventListeners();
    setPaneCollapsed(elements.paneOriginal, elements.chevOriginal, true);
    setPaneCollapsed(elements.paneUpdated, elements.chevUpdated, true); // Collapse updated by default
    setupTextAreaToolbar(elements.originalBox, elements.fontSmallerOriginal, elements.fontLargerOriginal, elements.findInputOriginal, elements.scrollTopOriginal);
    setupTextAreaToolbar(elements.updatedBox, elements.fontSmallerUpdated, elements.fontLargerUpdated, elements.findInputUpdated, elements.scrollTopUpdated);
    
    try{
      elements.userInput.value = DEFAULT_USER;
      await populateRepos(DEFAULT_USER, DEFAULT_REPO_HINT);
      await refreshRepoContext();
    }catch(e){
      handleError(e, "Failed to initialize application");
    }
  }

  init();
})();
</script>
</body>
</html>
