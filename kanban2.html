<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>AI Kanban — Baseline-Preserved + Persistence</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--bg:#f7f7f9;--panel:#fff;--border:#d0d0d5;--text:#111;--accent:#1f6feb;--danger:#b3261e}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
header{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:8px 10px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{padding:6px 10px;border:1px solid var(--border);border-radius:8px;background:#fff;cursor:pointer}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.danger{background:var(--danger);color:#fff;border-color:var(--danger)}
main{padding:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px;align-items:start}
.lane{background:var(--panel);border:1px solid var(--border);border-radius:12px;display:flex;flex-direction:column;min-height:0}
.lane h2{margin:0;padding:10px;border-bottom:1px solid var(--border);font-size:16px}
.lane-body{padding:8px;display:flex;flex-direction:column;gap:8px;min-height:0}
.card{background:#fff;border:2px solid var(--border);border-radius:10px;padding:8px;cursor:grab;user-select:none}
.card.dragging{opacity:.85;border-color:#000}
footer{border-top:1px solid var(--border);padding:8px 10px;color:#555;font-size:12px;text-align:right;background:#fff}
.hidden{display:none}
dialog{border:none;border-radius:12px;padding:0;max-width:min(840px,96vw)}
.modal{padding:14px;background:#fff;border:1px solid var(--border);border-radius:12px}
.modal h3{margin:0 0 8px 0}
.list{border:1px solid var(--border);border-radius:10px;max-height:50vh;overflow:auto}
.item{padding:8px 10px;border-bottom:1px solid var(--border)}
.item:last-child{border-bottom:none}
.row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.muted{color:#666;font-size:12px}
</style>
</head>
<body>
<header>
  <button id="btnNew" class="primary">New</button>
  <button id="btnRename">Rename</button>
  <button id="btnImport">Import</button>
  <button id="btnExport">Export</button>
  <button id="btnArchive" title="Archive snapshot">Archive</button>
  <button id="btnArchiveMgr">Archive Manager</button>
  <input id="fileImport" type="file" accept="application/json" class="hidden" aria-hidden="true">
  <span id="status" style="margin-left:auto">Loading…</span>
</header>

<main id="board" aria-live="polite"></main>
<footer id="footer">Board: Default • Ready</footer>

<!-- Archive Manager -->
<dialog id="archiveDialog">
  <form method="dialog" class="modal">
    <h3>Archived Snapshots</h3>
    <div id="archiveList" class="list"></div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button value="close">Close</button>
    </div>
  </form>
</dialog>

<script>
(function(){
/* ===== Keys & helpers ===== */
const STORAGE_KEY="kanban_state_v3";      // current board state
const ARCHIVE_KEY="kanban_archive_v3";    // array of snapshots
const footer=document.getElementById("footer");
const statusEl=document.getElementById("status");
const $=s=>document.querySelector(s);

function uid(){return Math.random().toString(36).slice(2,10);}
function nowISO(){return new Date().toISOString();}
function nowLocal(){return new Date().toLocaleString();}
function tsFile(){return new Date().toISOString().replace(/[:T]/g,"_").slice(0,16);} // YYYY-MM-DD_HHMM

/* ===== State shape and compatibility =====
   v3 format:
   { meta:{name,createdAt,updatedAt}, lanes:{Next:[card],Doing:[card],Done:[card]} }
   card: {id,title,createdAt,updatedAt}
*/
function defaultState(){
  return { meta:{ name:"Default", createdAt: nowISO(), updatedAt: nowISO() },
           lanes:{ Next:[], Doing:[], Done:[] } };
}
function normalizeState(obj, importName="Imported"){
  if(!obj || typeof obj!=="object") return defaultState();
  if(obj.lanes && obj.meta){
    // v3 already
    obj.meta.name = obj.meta.name || importName;
    obj.meta.updatedAt = nowISO();
    obj.lanes.Next ||= []; obj.lanes.Doing ||= []; obj.lanes.Done ||= [];
    return obj;
  }
  // legacy likely: {cards:[{title,stage}], stages:[...]} or similar
  if(Array.isArray(obj.cards)){
    const next=[], doing=[], done=[];
    obj.cards.forEach(c=>{
      const card = { id: c.id || uid(), title: String(c.title||"(untitled)"), createdAt: c.createdAt || nowISO(), updatedAt: nowISO() };
      const st = (c.stage||"Next");
      if(st==="Done") done.push(card);
      else if(st==="Doing") doing.push(card);
      else next.push(card);
    });
    return { meta:{ name: importName, createdAt: nowISO(), updatedAt: nowISO() },
             lanes:{ Next: next, Doing: doing, Done: done } };
  }
  return defaultState();
}

function loadState(){
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    if(!raw) return defaultState();
    const obj=JSON.parse(raw);
    return normalizeState(obj, obj?.meta?.name || "Imported");
  }catch{ return defaultState(); }
}
function saveState(st){
  st.meta.updatedAt = nowISO();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
  setFooter(`Board: ${st.meta.name} • Saved ${nowLocal()}`);
}

/* Archive helpers */
function loadArchive(){
  try{
    const raw=localStorage.getItem(ARCHIVE_KEY);
    const arr= raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr : [];
  }catch{ return []; }
}
function saveArchive(arr){ localStorage.setItem(ARCHIVE_KEY, JSON.stringify(arr)); }

/* App state */
let state = loadState();

/* UI helpers */
function setFooter(t){ footer.textContent=t; }
function setStatus(t){ statusEl.textContent=t; }

/* Rendering */
const board = document.getElementById("board");
const LANES = ["Next","Doing","Done"];

function render(){
  board.innerHTML="";
  LANES.forEach(stage=>{
    const sec=document.createElement("section"); sec.className="lane";
    sec.innerHTML = `<h2>${stage}</h2><div class="lane-body" data-stage="${stage}"></div>`;
    const body=sec.querySelector(".lane-body");

    // render cards for lane
    (state.lanes[stage]||[]).forEach(c=> body.appendChild(renderCard(c)));

    // drop target
    body.addEventListener("dragover", e=> e.preventDefault());
    body.addEventListener("drop", e=>{
      e.preventDefault();
      const id = e.dataTransfer.getData("text/plain");
      if(id) moveCardTo(stage, id);
    });

    board.appendChild(sec);
  });
  setStatus(`Ready • ${totalCount()} cards`);
  setFooter(`Board: ${state.meta.name} • Updated ${new Date(state.meta.updatedAt).toLocaleString()}`);
}

function renderCard(card){
  const el=document.createElement("div");
  el.className="card";
  el.draggable=true;
  el.dataset.id=card.id;
  el.textContent=card.title;

  el.addEventListener("dragstart", e=>{
    el.classList.add("dragging");
    e.dataTransfer.setData("text/plain", card.id);
    e.dataTransfer.effectAllowed="move";
  });
  el.addEventListener("dragend", ()=> el.classList.remove("dragging"));
  el.addEventListener("click", ()=>{
    const t=prompt("Edit title", card.title);
    if(t===null) return;
    const v=String(t).trim();
    if(v && v!==card.title){
      card.title=v;
      card.updatedAt=nowISO();
      saveState(state); render();
    }
  });
  return el;
}

function totalCount(){
  return (state.lanes.Next?.length||0)+(state.lanes.Doing?.length||0)+(state.lanes.Done?.length||0);
}

/* Mutations */
function createCard(title){
  const c={ id:uid(), title:String(title||"(untitled)"), createdAt:nowISO(), updatedAt:nowISO() };
  state.lanes.Next.unshift(c);
  saveState(state); render();
}
function moveCardTo(stage, id){
  let found=null;
  for(const st of LANES){
    const idx = state.lanes[st].findIndex(x=>x.id===id);
    if(idx>-1){
      found = state.lanes[st][idx];
      state.lanes[st].splice(idx,1);
      break;
    }
  }
  if(!found) return;
  found.updatedAt = nowISO();
  state.lanes[stage].unshift(found);
  saveState(state); render();
}

/* Controls */
document.getElementById("btnNew").onclick=()=>{
  const t=prompt("Card title");
  if(!t) return;
  createCard(t.trim());
};
document.getElementById("btnRename").onclick=()=>{
  const n=prompt("Rename board", state.meta.name||"Board");
  if(!n) return;
  state.meta.name = String(n).trim();
  saveState(state); render();
};
document.getElementById("btnExport").onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download = `ai-jobs-kanban-${tsFile()}.json`;
  a.click();
  setFooter(`Board: ${state.meta.name} • Exported ${a.download}`);
};
const fileInput=document.getElementById("fileImport");
document.getElementById("btnImport").onclick=()=> fileInput.click();
fileInput.onchange=e=>{
  const file=e.target.files?.[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      const normalized = normalizeState(obj, file.name.replace(/\.json$/,""));
      state = normalized;
      saveState(state); render();
      setFooter(`Board: ${state.meta.name} • Imported ${file.name} @ ${nowLocal()}`);
    }catch(err){
      alert("Import failed: "+err.message);
    }
  };
  reader.readAsText(file);
};
document.getElementById("btnArchive").onclick=()=>{
  if(!confirm(`Archive snapshot of "${state.meta.name}"?`)) return;
  const archive = loadArchive();
  archive.unshift({
    id: uid(),
    label: `${state.meta.name} @ ${nowLocal()}`,
    savedAt: nowISO(),
    state: state
  });
  saveArchive(archive);
  setFooter(`Board: ${state.meta.name} • Snapshot archived`);
};
const archiveDialog = document.getElementById("archiveDialog");
document.getElementById("btnArchiveMgr").onclick=()=>{
  const list = document.getElementById("archiveList");
  const archive = loadArchive();
  list.innerHTML = "";
  if(!archive.length){
    list.innerHTML = `<div class="item muted">Archive is empty.</div>`;
  }else{
    archive.forEach((snap, idx)=>{
      const row=document.createElement("div"); row.className="item";
      row.innerHTML = `
        <div style="font-weight:700">${snap.label}</div>
        <div class="muted">${new Date(snap.savedAt).toLocaleString()}</div>
        <div class="row" style="margin-top:6px">
          <button data-act="restore" data-idx="${idx}">Restore</button>
          <button class="danger" data-act="delete" data-idx="${idx}">Delete</button>
        </div>`;
      row.querySelector('[data-act="restore"]').onclick=(e)=>{
        const i=Number(e.target.dataset.idx);
        const arr=loadArchive();
        const s=arr[i]; if(!s) return;
        state = normalizeState(s.state, s.state?.meta?.name || "Imported");
        saveState(state); render();
        setFooter(`Board: ${state.meta.name} • Restored snapshot`);
      };
      row.querySelector('[data-act="delete"]').onclick=(e)=>{
        const i=Number(e.target.dataset.idx);
        const arr=loadArchive();
        if(!confirm("Delete this snapshot?")) return;
        arr.splice(i,1); saveArchive(arr);
        document.getElementById("btnArchiveMgr").click(); // refresh
      };
      list.appendChild(row);
    });
  }
  archiveDialog.showModal();
};
archiveDialog.addEventListener("close", ()=>{ /* no-op */ });

/* Init */
render();
setStatus("Ready");
})();
</script>
</body>
</html>