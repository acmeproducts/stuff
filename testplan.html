<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression Test Runner</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #343a40;
            --border-radius: 0.35rem;
            --box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            font-size: 16px;
        }
        .container {
            max-width: 1200px;
            margin: auto;
            background: white;
            padding: 1.5rem 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: 1.5rem;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
            transition: all 0.2s ease-in-out;
            color: var(--secondary-color);
        }
        .tab-button:hover {
            background-color: var(--light-gray);
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Setup and Forms */
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; }
        .form-group input[type="text"], .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-family: monospace;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: background-color 0.2s ease;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #0056b3; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-group { display: flex; gap: 0.5rem; margin-top: 0.5rem; }

        /* Drop Area */
        .drop-area {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            background-color: var(--light-gray);
            margin-bottom: 1rem;
        }

        /* Test Screen Layout */
        .test-runner-container {
            display: flex;
            gap: 1.5rem;
            height: calc(100vh - 220px);
        }
        #tree-panel {
            flex: 1;
            min-width: 250px;
            max-width: 400px;
            overflow-y: auto;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
        }
        #outcome-panel {
            flex: 2;
            overflow-y: auto;
            padding: 0 1rem;
        }
        @media (max-width: 992px) {
            .test-runner-container {
                flex-direction: column;
                height: auto;
            }
            #tree-panel { max-width: 100%; height: 300px; }
        }

        /* Tree View Styling */
        #test-tree { padding-left: 0; list-style: none; }
        #test-tree ul { padding-left: 20px; list-style: none; }
        #test-tree li { margin: 5px 0; }
        .tree-node { cursor: pointer; padding: 8px; border-radius: var(--border-radius); transition: background-color 0.2s; }
        .tree-node:hover { background-color: #e9ecef; }
        .tree-node.active { background-color: var(--primary-color); color: white; }
        .tree-node.active .status-indicator { color: white !important; }
        .tree-node .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; vertical-align: middle; }
        .status-pending { background-color: var(--secondary-color); }
        .status-passed { background-color: var(--success-color); }
        .status-failed { background-color: var(--danger-color); }
        .tree-group > .tree-node { font-weight: bold; }
        .tree-group > .tree-node::before { content: 'â–¶'; display: inline-block; margin-right: 6px; transition: transform 0.2s; }
        .tree-group.expanded > .tree-node::before { transform: rotate(90deg); }
        .tree-group > ul { display: none; }
        .tree-group.expanded > ul { display: block; }

        /* Outcome Panel */
        #outcome-header { margin-top: 0; }
        #step-description { background-color: var(--light-gray); padding: 1rem; border-radius: var(--border-radius); border-left: 5px solid var(--primary-color); margin-bottom: 1.5rem; white-space: pre-wrap; }
        .pass-check { display: flex; align-items: center; font-size: 1.2rem; margin-bottom: 1.5rem; }
        .pass-check input { width: 20px; height: 20px; margin-right: 0.75rem; }
        
        /* Screenshot Area */
        .screenshot-preview { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
        .screenshot-container { position: relative; }
        .screenshot-container img { max-width: 150px; max-height: 150px; border-radius: var(--border-radius); border: 1px solid var(--medium-gray); display: block; }
        .remove-screenshot-btn { position: absolute; top: -5px; right: -5px; background: var(--danger-color); color: white; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-weight: bold; line-height: 20px; text-align: center; }
        
        /* Results Page */
        .results-controls { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
        .omni-search { flex-grow: 1; }
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stat-card { background: var(--light-gray); padding: 1.5rem; border-radius: var(--border-radius); text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: var(--box-shadow); }
        .stat-card.active-filter { border: 2px solid var(--primary-color); }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; }
        .stat-card .value.pass { color: var(--success-color); }
        .stat-card .value.fail { color: var(--danger-color); }
        .stat-card .label { font-size: 1rem; color: var(--secondary-color); }
        
        /* HTML Report */
        #html-report-output { border: 1px solid var(--medium-gray); border-radius: var(--border-radius); padding: 1.5rem; max-height: 600px; overflow-y: auto; }
        .report-step { border-bottom: 1px solid var(--medium-gray); padding: 1rem 0; }
        .report-step:last-child { border-bottom: none; }
        .report-step h4 { margin-top: 0; }
        .report-step .status-badge { padding: 0.25em 0.6em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: 0.25rem; color: #fff; }
        .report-step .badge-passed { background-color: var(--success-color); }
        .report-step .badge-failed { background-color: var(--danger-color); }
        .report-step pre, #report-appendix pre { white-space: pre-wrap; word-wrap: break-word; background-color: #f8f9fa; padding: 0.5rem; border-radius: var(--border-radius); }
        .report-step img { max-width: 200px; border-radius: var(--border-radius); margin: 5px; }

    </style>
</head>
<body>

    <div class="container">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('test-setup')">Test Setup</button>
            <button class="tab-button" id="test-screen-tab-btn" onclick="showTab('test-screen')" disabled>Test Screen</button>
            <button class="tab-button" id="results-tab-btn" onclick="showTab('results')" disabled>Results</button>
        </div>

        <!-- Test Setup Tab -->
        <div id="test-setup" class="tab-content active">
            <h2>Test Configuration</h2>
            <div class="form-group">
                <label for="test-name">Test Name</label>
                <input type="text" id="test-name" placeholder="e.g., v2.1.0 Full Regression">
            </div>
            <div class="form-group">
                <label for="program-version">Program Version (Filename)</label>
                <div id="code-file-drop-area" class="drop-area">
                    <p>Drag & drop code file here to populate version and include in report</p>
                </div>
                <input type="text" id="program-version" placeholder="e.g., orbital8-v2.1.0.zip">
            </div>
             <div class="form-group">
                <label for="start-time">Test Start Date & Time</label>
                <input type="datetime-local" id="start-time" readonly>
            </div>
            <hr style="margin: 2rem 0;">
            <h2>Test Plan</h2>
            <div class="form-group">
                 <div id="test-plan-drop-area" class="drop-area">
                    <p>Drag & drop a .txt test plan file here</p>
                </div>
                <textarea id="test-plan-editor"></textarea>
                <input type="file" id="import-plan-input" accept=".txt" style="display: none;">
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="importPlan()">Import Plan</button>
                    <button class="btn btn-secondary" onclick="exportPlan()">Export Plan</button>
                </div>
            </div>
            <button class="btn btn-primary" onclick="startTest()" style="width: 100%; padding: 1rem; font-size: 1.2rem;">Start Test</button>
        </div>

        <!-- Test Screen Tab -->
        <div id="test-screen" class="tab-content">
            <div id="test-runner-view" class="test-runner-container" style="display: none;">
                <div id="tree-panel">
                    <ul id="test-tree"></ul>
                </div>
                <div id="outcome-panel">
                    <div id="outcome-content" style="display: none;">
                        <h3 id="outcome-header"></h3>
                        <div id="step-description"></div>
                        <div class="pass-check">
                            <input type="checkbox" id="step-passed-checkbox" onchange="updateStepStatus()">
                            <label for="step-passed-checkbox">Step Passed</label>
                        </div>
                        <div class="form-group">
                            <label for="step-notes">Notes / Error Codes</label>
                            <textarea id="step-notes"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Screenshots</label>
                            <div id="screenshot-drop-area" class="drop-area">
                                <p>Drag & drop, click to upload, or paste screenshots here.</p>
                                <input type="file" id="screenshot-input" multiple accept="image/*" style="display: none;">
                            </div>
                            <div id="screenshot-preview-current" class="screenshot-preview"></div>
                        </div>
                    </div>
                     <div id="outcome-placeholder">
                        <p>Select a test step from the tree on the left to begin.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="tab-content">
            <h2>Test Results</h2>
            <div class="dashboard">
                <div id="stat-total" class="stat-card active-filter" onclick="filterReport('all')">
                    <div id="total-tests" class="value">0</div>
                    <div class="label">Total Steps</div>
                </div>
                <div id="stat-passed" class="stat-card" onclick="filterReport('passed')">
                    <div id="passed-tests" class="value pass">0</div>
                    <div class="label">Passed</div>
                </div>
                <div id="stat-failed" class="stat-card" onclick="filterReport('failed')">
                    <div id="failed-tests" class="value fail">0</div>
                    <div class="label">Failed</div>
                </div>
                 <div class="stat-card" style="cursor: default;">
                    <div id="test-duration" class="value">0m 0s</div>
                    <div class="label">Duration</div>
                </div>
            </div>
            
            <div class="results-controls">
                <div class="form-group omni-search">
                    <input type="text" id="omni-search-box" placeholder="Search report..." oninput="filterReport('search')">
                </div>
                <button class="btn btn-secondary" onclick="printReport()">Print Report</button>
                <button class="btn btn-success" onclick="finishTest()">Finish and Lock Test</button>
            </div>
            <div id="html-report-output">Select a filter or search to generate the report.</div>
        </div>
    </div>

<script>
// Default test plan content
const defaultTestPlanContent = `
1.0 Setup & Initial State
Authenticate: Successfully authenticate with the storage provider.
Folder Selection:
OneDrive: Navigate to a parent folder, then select a child folder containing multiple images.
Google Drive: Select a folder containing multiple images.
Load Folder: Verify that the folder loads successfully and the first image is displayed on the main stage in the "In" stack.
2.0 Main View & Focus Mode Interaction
Initial Sort:
Flick Image 1 up to the Priority stack.
Flick Image 2 right to the Out stack.
Flick Image 3 down to the Trash stack.
Flick Image 4 left (back to the In stack).
`;

// --- GLOBAL STATE ---
let testData = {
    testName: "",
    programVersion: "",
    startTime: null,
    endTime: null,
    tree: [],
    codeFileContent: "", // To store the code for the report appendix
    currentStep: { section: null, step: null }
};
let testTimerInterval = null;


// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    setDateTime();
    setupFileDropAreas();
    document.getElementById('test-plan-editor').value = defaultTestPlanContent.trim();
});


// --- UI CONTROL ---
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
    
    if (tabId === 'results') {
        generateDashboard();
        filterReport('all');
    }
}

function setDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('start-time').value = now.toISOString().slice(0, 16);
}

// --- TEST FLOW ---
function startTest() {
    testData.testName = document.getElementById('test-name').value.trim();
    testData.programVersion = document.getElementById('program-version').value.trim();
    const testPlan = document.getElementById('test-plan-editor').value;
    
    if (!testData.testName || !testData.programVersion || !testPlan) {
        alert("Please ensure Test Name, Program Version, and Test Plan are all filled out.");
        return;
    }
    
    parseTestPlanToTree(testPlan);

    testData.startTime = new Date();
    startTimer();

    document.getElementById('test-screen-tab-btn').disabled = false;
    document.getElementById('test-runner-view').style.display = 'flex';
    renderTree();
    showTab('test-screen');
}

function finishTest() {
    if (testData.endTime) return; // Already finished
    saveCurrentStepState();
    testData.endTime = new Date();
    clearInterval(testTimerInterval);
    updateTimerDisplay(); // Final update
    alert('Test Finished and Locked. View the results tab.');
    document.getElementById('results-tab-btn').disabled = false;
    showTab('results');
}

function startTimer() {
    testTimerInterval = setInterval(updateTimerDisplay, 1000);
}

function updateTimerDisplay() {
    const now = testData.endTime || new Date();
    const durationMs = now - testData.startTime;
    const minutes = Math.floor(durationMs / 60000);
    const seconds = Math.floor((durationMs % 60000) / 1000);
    document.getElementById('test-duration').textContent = `${minutes}m ${seconds}s`;
}

// --- PARSING & STATE MANAGEMENT ---
function parseTestPlanToTree(testPlanContent) {
    testData.tree = []; // Reset tree
    const lines = testPlanContent.trim().split('\n');
    let currentSection = null;

    lines.forEach(line => {
        line = line.trim();
        if (!line) return;

        if (/^\d+\.\d+/.test(line) || /^[A-Z][a-zA-Z\s&]+:$/.test(line) && !line.includes(': ')) {
             currentSection = {
                title: line,
                children: [],
                id: testData.tree.length
            };
            testData.tree.push(currentSection);
        } else if (currentSection) {
            const step = {
                description: line,
                status: 'pending',
                notes: "",
                screenshots: [],
                id: currentSection.children.length
            };
            currentSection.children.push(step);
        }
    });
}

function saveCurrentStepState() {
    const { section, step } = testData.currentStep;
    if (section === null || step === null) return;
    const currentStepObj = testData.tree[section].children[step];
    currentStepObj.notes = document.getElementById('step-notes').value;
}

function updateStepStatus() {
    const { section, step } = testData.currentStep;
    if (section === null || step === null) return;
    const currentStepObj = testData.tree[section].children[step];
    currentStepObj.status = document.getElementById('step-passed-checkbox').checked ? 'passed' : 'failed';
    const stepNode = document.querySelector(`.tree-node[data-section-id='${section}'][data-step-id='${step}']`);
    if (stepNode) {
        stepNode.querySelector('.status-indicator').className = `status-indicator status-${currentStepObj.status}`;
    }
}

// --- TREE & OUTCOME RENDERING ---
function renderTree() {
    const treeContainer = document.getElementById('test-tree');
    treeContainer.innerHTML = '';
    testData.tree.forEach((section, sectionIndex) => {
        const sectionLi = document.createElement('li');
        sectionLi.className = 'tree-group expanded';
        sectionLi.innerHTML = `
            <div class="tree-node" onclick="toggleTreeNode(this.parentElement)">${section.title}</div>
            <ul>
                ${section.children.map((step, stepIndex) => `
                    <li>
                        <div class="tree-node" data-section-id="${sectionIndex}" data-step-id="${stepIndex}" onclick="selectStep(${sectionIndex}, ${stepIndex})">
                            <span class="status-indicator status-${step.status}"></span>
                            ${step.description.substring(0, 40)}...
                        </div>
                    </li>
                `).join('')}
            </ul>
        `;
        treeContainer.appendChild(sectionLi);
    });
}

function toggleTreeNode(element) {
    element.classList.toggle('expanded');
}

function selectStep(sectionIndex, stepIndex) {
    saveCurrentStepState();
    testData.currentStep = { section: sectionIndex, step: stepIndex };
    const step = testData.tree[sectionIndex].children[stepIndex];
    document.querySelectorAll('.tree-node.active').forEach(n => n.classList.remove('active'));
    document.querySelector(`.tree-node[data-section-id='${sectionIndex}'][data-step-id='${stepIndex}']`).classList.add('active');
    document.getElementById('outcome-placeholder').style.display = 'none';
    document.getElementById('outcome-content').style.display = 'block';
    document.getElementById('outcome-header').textContent = `Step ${sectionIndex + 1}.${step.id + 1}`;
    document.getElementById('step-description').textContent = step.description;
    document.getElementById('step-passed-checkbox').checked = step.status === 'passed';
    document.getElementById('step-notes').value = step.notes;
    renderScreenshots(step.screenshots, 'screenshot-preview-current');
}

// --- FILE HANDLING ---
function setupFileDropAreas() {
    // Code file drop area
    const codeDropArea = document.getElementById('code-file-drop-area');
    setupGenericDropArea(codeDropArea, (file) => {
        document.getElementById('program-version').value = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
            testData.codeFileContent = e.target.result;
        };
        reader.readAsText(file);
    });

    // Test plan drop area
    const planDropArea = document.getElementById('test-plan-drop-area');
    setupGenericDropArea(planDropArea, (file) => {
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('test-plan-editor').value = e.target.result;
        };
        reader.readAsText(file);
    });

    // Screenshot drop area
    const screenshotDropArea = document.getElementById('screenshot-drop-area');
    setupGenericDropArea(screenshotDropArea, handleScreenshotFile);
    screenshotDropArea.addEventListener('click', () => document.getElementById('screenshot-input').click());
    document.getElementById('screenshot-input').addEventListener('change', (e) => Array.from(e.target.files).forEach(handleScreenshotFile));
    document.addEventListener('paste', (e) => {
        if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') return;
        Array.from(e.clipboardData.items).forEach(item => {
            if (item.type.indexOf('image') !== -1) {
                handleScreenshotFile(item.getAsFile());
            }
        });
    });
}

function setupGenericDropArea(area, fileHandler) {
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        area.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
    });
    area.addEventListener('drop', e => {
        if (e.dataTransfer.files.length > 0) {
            fileHandler(e.dataTransfer.files[0]); // Handle first file
        }
    });
}

function handleScreenshotFile(file) {
    const { section, step } = testData.currentStep;
    if (section === null || !file.type.startsWith('image/')) return;
    const stepObj = testData.tree[section].children[step];
    const reader = new FileReader();
    reader.onload = (e) => {
        stepObj.screenshots.push(e.target.result);
        renderScreenshots(stepObj.screenshots, 'screenshot-preview-current');
    };
    reader.readAsDataURL(file);
}

function renderScreenshots(screenshotArray, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    screenshotArray.forEach((src, index) => {
        const div = document.createElement('div');
        div.className = 'screenshot-container';
        div.innerHTML = `<img src="${src}" alt="Screenshot ${index + 1}"><button class="remove-screenshot-btn" onclick="removeScreenshot(${index})">&times;</button>`;
        container.appendChild(div);
    });
}

function removeScreenshot(index) {
    const { section, step } = testData.currentStep;
    if (section === null) return;
    const stepObj = testData.tree[section].children[step];
    stepObj.screenshots.splice(index, 1);
    renderScreenshots(stepObj.screenshots, 'screenshot-preview-current');
}

function importPlan() {
    const input = document.getElementById('import-plan-input');
    input.onchange = e => {
        const file = e.target.files[0];
        if (file) {
             const reader = new FileReader();
             reader.onload = (ev) => document.getElementById('test-plan-editor').value = ev.target.result;
             reader.readAsText(file);
        }
    };
    input.click();
}

function exportPlan() {
    const content = document.getElementById('test-plan-editor').value;
    const blob = new Blob([content], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'test-plan.txt';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

// --- RESULTS & REPORTING ---
function generateDashboard() {
    let total = 0, passed = 0;
    testData.tree.forEach(section => {
        section.children.forEach(step => {
            total++;
            if (step.status === 'passed') passed++;
        });
    });
    document.getElementById('total-tests').textContent = total;
    document.getElementById('passed-tests').textContent = passed;
    document.getElementById('failed-tests').textContent = total - passed;
    updateTimerDisplay();
}

function filterReport(filterType) {
    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active-filter'));
    if (filterType !== 'search') {
        document.getElementById(`stat-${filterType === 'all' ? 'total' : filterType}`).classList.add('active-filter');
    }
    renderHtmlReport(filter, document.getElementById('omni-search-box').value.toLowerCase());
}

function escapeHtml(unsafe) {
    return unsafe
         .replace(/&/g, "&amp;")
         .replace(/</g, "&lt;")
         .replace(/>/g, "&gt;")
         .replace(/"/g, "&quot;")
         .replace(/'/g, "&#039;");
}

function renderHtmlReport(filter, searchTerm = '') {
    const container = document.getElementById('html-report-output');
    let reportHtml = `<h3>${testData.testName} - ${testData.programVersion}</h3>`;
    testData.tree.forEach((section, sectionIndex) => {
        const filteredChildren = section.children.filter(step => {
            const statusMatch = (filter === 'all' || step.status === filter);
            const searchMatch = searchTerm === '' || 
                                step.description.toLowerCase().includes(searchTerm) || 
                                step.notes.toLowerCase().includes(searchTerm) ||
                                section.title.toLowerCase().includes(searchTerm);
            return (filter === 'search') ? searchMatch : (statusMatch && searchMatch);
        });
        if (filteredChildren.length > 0) {
            reportHtml += `<h4>${section.title}</h4>`;
            filteredChildren.forEach(step => {
                reportHtml += `<div class="report-step"><h5>Step ${sectionIndex + 1}.${step.id + 1}: ${step.description} <span class="status-badge badge-${step.status}">${step.status.toUpperCase()}</span></h5><p><strong>Notes:</strong></p><pre>${escapeHtml(step.notes) || 'N/A'}</pre>${step.screenshots.length > 0 ? `<p><strong>Attachments:</strong></p><div>${step.screenshots.map(src => `<img src="${src}" alt="Attachment">`).join('')}</div>` : ''}</div>`;
            });
        }
    });

    if (testData.codeFileContent) {
        reportHtml += `
            <div id="report-appendix">
                <hr style="margin: 2rem 0;">
                <h2>Appendix: Code Under Test (${escapeHtml(testData.programVersion)})</h2>
                <pre><code>${escapeHtml(testData.codeFileContent)}</code></pre>
            </div>
        `;
    }

    container.innerHTML = reportHtml;
}

function printReport() {
    const reportContent = document.getElementById('html-report-output').innerHTML;
    const styles = document.querySelector('style').innerHTML;
    const printWindow = window.open('', '', 'height=800,width=1000');
    printWindow.document.write(`<html><head><title>Test Report</title><style>${styles}</style></head><body><div class="container">${reportContent}</div></body></html>`);
    printWindow.document.close();
    printWindow.print();
}

</script>
</body>
</html>
