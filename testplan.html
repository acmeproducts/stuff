<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Regression Test Runner</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --light-gray: #f8f9fa;
            --medium-gray: #dee2e6;
            --dark-gray: #343a40;
            --border-radius: 0.25rem;
            --box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0;
            padding: 1.5rem;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            font-size: 16px;
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--medium-gray);
            margin-bottom: 1.5rem;
        }
        .tab-button {
            padding: 0.75rem 1.25rem;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1.1rem;
            border-bottom: 3px solid transparent;
            margin-bottom: -1px;
        }
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .form-group input[type="text"], .form-group input[type="datetime-local"] {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        .btn-group {
            display: flex;
            justify-content: space-between;
            margin-top: 1.5rem;
        }
        #test-step-view h3 {
            margin-top: 0;
        }
        #step-description {
            background-color: var(--light-gray);
            padding: 1rem;
            border-radius: var(--border-radius);
            border-left: 5px solid var(--primary-color);
            margin-bottom: 1.5rem;
        }
        .pass-check {
            display: flex;
            align-items: center;
            font-size: 1.2rem;
            margin-bottom: 1.5rem;
        }
        .pass-check input {
            width: 20px;
            height: 20px;
            margin-right: 0.75rem;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 0.5rem;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            box-sizing: border-box;
        }
        .screenshot-area {
            border: 2px dashed var(--medium-gray);
            border-radius: var(--border-radius);
            padding: 1rem;
            text-align: center;
            margin-top: 1rem;
            background-color: var(--light-gray);
        }
        .screenshot-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 1rem;
        }
        .screenshot-preview img {
            max-width: 150px;
            max-height: 150px;
            border-radius: var(--border-radius);
            border: 1px solid var(--medium-gray);
        }
        .archive-section {
            margin-top: 2rem;
            border-top: 1px solid var(--medium-gray);
            padding-top: 1rem;
        }
        .archive-entry {
            border: 1px solid #e9ecef;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-top: 1rem;
        }
        .archive-entry pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            background-color: #f8f9fa;
            padding: 0.5rem;
        }
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        .stat-card {
            background: var(--light-gray);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            text-align: center;
        }
        .stat-card .value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stat-card .value.pass { color: var(--success-color); }
        .stat-card .value.fail { color: var(--danger-color); }
        .stat-card .label {
            font-size: 1rem;
            color: var(--secondary-color);
        }
        #report-output {
            background-color: #2b3035;
            color: #c0c5ce;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-family: "SF Mono", "Fira Code", "Fira Mono", "Roboto Mono", monospace;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="tabs">
            <button class="tab-button active" onclick="showTab('test-screen')">Test Screen</button>
            <button class="tab-button" id="results-tab-btn" onclick="showTab('results')" disabled>Results</button>
        </div>

        <div id="test-screen" class="tab-content active">
            <div id="setup-view">
                <h2>Test Setup</h2>
                <div class="form-group">
                    <label for="test-name">Test Name</label>
                    <input type="text" id="test-name" placeholder="e.g., v2.1.0 Full Regression">
                </div>
                 <div class="form-group">
                    <label for="program-version">Program Version</label>
                    <input type="text" id="program-version" placeholder="e.g., 2.1.0-beta">
                </div>
                <div class="form-group">
                    <label for="start-time">Start Date & Time</label>
                    <input type="datetime-local" id="start-time" readonly>
                </div>
                <button class="btn btn-primary" onclick="startTest()">Go</button>
            </div>

            <div id="test-step-view" style="display: none;">
                <h3 id="step-header"></h3>
                <div id="step-description"></div>
                
                <div class="pass-check">
                    <input type="checkbox" id="step-passed-checkbox">
                    <label for="step-passed-checkbox">Step Passed</label>
                </div>

                <div class="form-group">
                    <label for="step-notes">Notes / Error Codes</label>
                    <textarea id="step-notes"></textarea>
                </div>

                <div class="form-group">
                    <label>Screenshots</label>
                    <div id="screenshot-drop-area" class="screenshot-area">
                        <p>Drag & drop, click to upload, or paste screenshots here.</p>
                        <input type="file" id="screenshot-input" multiple accept="image/*" style="display: none;">
                    </div>
                    <div id="screenshot-preview-current" class="screenshot-preview"></div>
                </div>

                <div id="archive-container"></div>

                <div class="btn-group">
                    <button id="prev-step-btn" class="btn btn-secondary" onclick="prevStep()">Previous Step</button>
                    <button id="next-step-btn" class="btn btn-primary" onclick="nextStep()">Next Step</button>
                </div>
            </div>
        </div>

        <div id="results" class="tab-content">
            <h2>Test Results</h2>
            <div class="dashboard">
                <div class="stat-card">
                    <div id="total-tests" class="value">0</div>
                    <div class="label">Total Steps</div>
                </div>
                <div class="stat-card">
                    <div id="passed-tests" class="value pass">0</div>
                    <div class="label">Passed</div>
                </div>
                <div class="stat-card">
                    <div id="failed-tests" class="value fail">0</div>
                    <div class="label">Failed</div>
                </div>
                 <div class="stat-card">
                    <div id="test-duration" class="value">0m 0s</div>
                    <div class="label">Duration</div>
                </div>
            </div>
            
            <h3>Printable Report</h3>
            <p>This report can be copied and fed back to an AI for analysis and code generation.</p>
            <button class="btn btn-secondary" style="margin-bottom: 1rem;" onclick="printReport()">Print Report</button>
            <div id="report-output">Select "Print Report" to generate the summary.</div>
        </div>
    </div>

<script>
// Raw test plan content provided by the user
const testPlanContent = `
Objective
This document outlines the standard end-to-end regression test scenario for the Orbital8 application.
This test must be executed in its entirety for both Google Drive and OneDrive providers before any new version is released to ensure core functionality remains intact and free of regressions.
1.0 Setup & Initial State
Authenticate:  Successfully authenticate with the storage provider.
Folder Selection:
OneDrive:  Navigate to a parent folder, then select a child folder containing multiple images.
Google Drive:  Select a folder containing multiple images.
Load Folder:  Verify that the folder loads successfully and the first image is displayed on the main stage in the "In" stack.
2.0 Main View & Focus Mode Interaction
Initial Sort:
Flick  Image 1  up to the  Priority  stack.
Flick  Image 2  right to the  Out  stack.
Flick  Image 3  down to the  Trash  stack.
Flick  Image 4  left (back to the  In  stack).
Focus Mode Navigation (In Stack):
Open the "In" stack grid.
Click into  Focus Mode .
Swipe  left three times  (navigating forward through the images).
Exit Focus Mode.
Stack Navigation & Validation:
Swipe to the  Priority  stack.
Swipe to the  Out  stack.
Swipe to the  Trash  stack.
Swipe back to the  In  stack.
Focus Mode Deletion:
Click back into  Focus Mode .
Swipe  right four times  (navigating backward).
Click the  delete button twice , removing two images.
Exit Focus Mode.
3.0 Details Panel Validation
Open Details:  Click the  Details  button for the current image.
Tag Management:
Navigate to the  Tags  tab.
Create a new tag. Verify the text entered in the input box is  black .
Select an existing tag from the "Tags in this Folder" list to apply it.
Remove a tag that has just been applied.
Notes & Ratings:
Navigate to the  Notes  tab.
Enter a note. Verify the text entered is  black .
Rate Quality and Content both  3 stars .
Change both ratings to  5 stars .
Change the Quality rating to  1 star .
Info & Metadata:
Navigate to the  Info  tab.
Verify the filename is a clickable link that opens the source image in a new tab.
Verify the date, time, and size are listed correctly.
Navigate to the  Metadata  tab.
Confirm that "Prompt" is the first row in the table.
Confirm that "Model", "Seed", and "Negative Prompt" are listed in that order.
Confirm that all priority fields have a functional,  orange  copy button.
Confirm the rest of the metadata fields are displayed correctly.
Close Details Panel.
4.0 Grid Mode & Bulk Actions
Stack Navigation & Grid Entry:
Navigate through the "In", "Out", "Priority", and "Trash" stacks.
Open the grid for the  Trash  stack.
Grid Move & Validation:
Verify the single image in the Trash stack is highlighted with a blue outline.
Click the  Move  button and select the  In  stack.
Verify the image is removed from the Trash grid.
Close the grid, switch to the  In  stack.
Verify the moved image is now displayed on center stage.
Flick & Grid Validation:
Flick the current image to the  Priority  stack.
Open the grid for the  Priority  stack.
Verify the image just moved is the first item in the grid.
Selection Logic:
Select the second image in the grid.
De-select the first image (which was auto-selected).
Close the grid. Verify the second image is now on center stage and is the new first item in the Priority stack.
Bulk Move & Reordering:
Switch to the  In  stack and open the grid.
De-select the first auto-selected image.
Select the next  three  images.
Click  Move  and select the  In  stack.
Verify the three selected images are now the first three items in the grid, in alphabetical order.
Verify the former first image is now the fourth item.
Search & Delete:
Search for the tag created in step 3.2.
Verify the tagged image appears by itself and is pre-selected.
Close the grid. Verify the tagged image is on center stage.
Re-open the grid and search for the same tag again.
Click the  Delete  button.
Confirm the action in the dialog box.
Verify the API request is correct for the provider's trash/delete functionality.
Verify the grid is now empty (as the only searched item was deleted).
Folder Move:
Clear the search and select the first  three  images in the "In" stack.
Click the  Folder  button and move them to a different destination folder.
Navigate to the destination folder.
Verify the three images are at the top of the "In" stack in grid mode.
Enter Focus Mode and verify they are in the correct position.
Export:
Select the next  three  images.
Click the  Export  button.
Verify the modal shows a progress counter and percentage.
Verify the CSV file is created and contains all appropriate columns, including a valid source URL and correctly parsed metadata.
Close the modal.
Advanced Selection:
Select  three  images.
Verify the selection pill counter shows "3 selected".
Click the "X" on the pill counter. Verify the selection is cleared.
Click the pill counter itself. Verify all images in the grid are now selected.
Move all images to the  Out  stack.
Empty Stack Navigation:
Verify the "stack is empty" message appears.
Click the button to change stacks.
Verify the next clockwise, non-empty stack is selected.
5.0 Final Focus Mode Validation
Navigate & Switch:
Change to the  Out  stack.
Enter Focus Mode.
Click the stack name in the top-left corner and switch to the  Priority  stack.
Verify Image:
Confirm the image displayed is the original "test" image (Image 1 -> Trash -> In -> Priority).
Final State Check:
Exit Focus Mode.
Flick the current image to the  In  stack.
Click into the  In  stack.
Verify that this same image is now displayed on center stage.
`;

// --- GLOBAL STATE ---
let testData = {
    testName: "",
    programVersion: "",
    startTime: null,
    endTime: null,
    steps: [],
    currentStepIndex: 0
};

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    setDateTime();
    setupScreenshotArea();
    parseTestPlan();
});

function parseTestPlan() {
    const lines = testPlanContent.trim().split('\n');
    let currentHeader = "";
    testData.steps = lines
        .map(line => line.replace(/\\s*/, '').trim())
        .filter(line => {
            // Filter out non-actionable lines
            return !["Objective", "This document outlines the standard end-to-end regression test scenario for the Orbital8 application.", "This test must be executed in its entirety for both Google Drive and OneDrive providers before any new version is released to ensure core functionality remains intact and free of regressions.", ""].includes(line);
        })
        .map(line => {
            if (/^\d+\.\d+/.test(line)) {
                currentHeader = line;
                return null; // This will be filtered out later
            }
            // Combine header with step description
            const description = `${currentHeader ? '[' + currentHeader + '] ' : ''}${line}`;
            
            return {
                description: description,
                status: 'pending', // pending, passed, failed
                currentData: {
                    notes: "",
                    screenshots: [] // base64 strings
                },
                archive: [] // { timestamp, notes, screenshots }
            };
        }).filter(Boolean); // Remove null entries
}


// --- UI CONTROL ---
function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(tb => tb.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');
    document.querySelector(`.tab-button[onclick="showTab('${tabId}')"]`).classList.add('active');
}

function setDateTime() {
    const now = new Date();
    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
    document.getElementById('start-time').value = now.toISOString().slice(0, 16);
}

// --- TEST FLOW ---
function startTest() {
    testData.testName = document.getElementById('test-name').value.trim();
    testData.programVersion = document.getElementById('program-version').value.trim();
    
    if (!testData.testName || !testData.programVersion) {
        alert("Please provide a Test Name and Program Version.");
        return;
    }
    
    testData.startTime = new Date();
    testData.currentStepIndex = 0;

    document.getElementById('setup-view').style.display = 'none';
    document.getElementById('test-step-view').style.display = 'block';

    renderStep(testData.currentStepIndex);
}

function nextStep() {
    saveCurrentStepState();
    if (testData.currentStepIndex < testData.steps.length - 1) {
        testData.currentStepIndex++;
        renderStep(testData.currentStepIndex);
    } else {
        finishTest();
    }
}

function prevStep() {
    // Archive the current data before moving back
    archiveCurrentData();
    saveCurrentStepState(false); // Save without clearing, as it's now archived
    
    if (testData.currentStepIndex > 0) {
        testData.currentStepIndex--;
        renderStep(testData.currentStepIndex);
    }
}

function finishTest() {
    testData.endTime = new Date();
    document.getElementById('results-tab-btn').disabled = false;
    showTab('results');
    generateDashboard();
    generateAndDisplayReport();
}

// --- STATE MANAGEMENT ---
function saveCurrentStepState(clearAfterSave = true) {
    const step = testData.steps[testData.currentStepIndex];
    if (!step) return;

    step.status = document.getElementById('step-passed-checkbox').checked ? 'passed' : 'failed';
    step.currentData.notes = document.getElementById('step-notes').value;
    // Screenshots are already in the data model from the handler
    
    if (clearAfterSave) {
        // This data has been "committed" by moving next, so it's final for this iteration
    }
}

function archiveCurrentData() {
    const step = testData.steps[testData.currentStepIndex];
    const notes = document.getElementById('step-notes').value.trim();
    const screenshots = step.currentData.screenshots;

    if (notes || screenshots.length > 0) {
        step.archive.push({
            timestamp: new Date().toISOString(),
            notes: notes,
            screenshots: screenshots
        });
    }

    // Clear the current data for new entry
    step.currentData.notes = "";
    step.currentData.screenshots = [];
}

// --- RENDERING ---
function renderStep(index) {
    const step = testData.steps[index];
    if (!step) return;

    document.getElementById('step-header').textContent = `Step ${index + 1} of ${testData.steps.length}`;
    document.getElementById('step-description').textContent = step.description;
    
    document.getElementById('step-passed-checkbox').checked = step.status === 'passed';
    document.getElementById('step-notes').value = step.currentData.notes;
    
    renderScreenshots(step.currentData.screenshots, 'screenshot-preview-current');
    renderArchive(step.archive);

    // Update button states
    document.getElementById('prev-step-btn').disabled = (index === 0);
    const nextBtn = document.getElementById('next-step-btn');
    if (index === testData.steps.length - 1) {
        nextBtn.textContent = 'Finish Test';
        nextBtn.classList.add('btn-success'); 
    } else {
        nextBtn.textContent = 'Next Step';
        nextBtn.classList.remove('btn-success');
    }
}

function renderScreenshots(screenshotArray, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    screenshotArray.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        container.appendChild(img);
    });
}

function renderArchive(archiveArray) {
    const container = document.getElementById('archive-container');
    container.innerHTML = '';
    if (archiveArray.length > 0) {
        const title = document.createElement('h4');
        title.textContent = 'Archived Documentation';
        container.appendChild(title);

        archiveArray.slice().reverse().forEach((entry, index) => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'archive-entry';
            
            const timestamp = new Date(entry.timestamp);
            entryDiv.innerHTML = `
                <p><strong>Archived:</strong> ${timestamp.toLocaleString()} (Edit #${archiveArray.length - index})</p>
                ${entry.notes ? `<p><strong>Notes:</strong><pre>${entry.notes}</pre></p>` : ''}
                ${entry.screenshots.length > 0 ? `<p><strong>Screenshots:</strong></p><div id="archive-preview-${index}" class="screenshot-preview"></div>` : ''}
            `;
            container.appendChild(entryDiv);
            if(entry.screenshots.length > 0){
                renderScreenshots(entry.screenshots, `archive-preview-${index}`);
            }
        });
    }
}


// --- SCREENSHOT HANDLING ---
function setupScreenshotArea() {
    const dropArea = document.getElementById('screenshot-drop-area');
    const fileInput = document.getElementById('screenshot-input');

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, e => {
            e.preventDefault();
            e.stopPropagation();
        });
    });

    dropArea.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));

    // Paste handler
    document.addEventListener('paste', (e) => {
        const items = e.clipboardData.items;
        const files = [];
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                files.push(items[i].getAsFile());
            }
        }
        if (files.length > 0) handleFiles(files);
    });
}

function handleFiles(files) {
    for (const file of files) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const step = testData.steps[testData.currentStepIndex];
                step.currentData.screenshots.push(e.target.result);
                renderScreenshots(step.currentData.screenshots, 'screenshot-preview-current');
            };
            reader.readAsDataURL(file);
        }
    }
}

// --- RESULTS & REPORTING ---
function generateDashboard() {
    const total = testData.steps.length;
    const passed = testData.steps.filter(s => s.status === 'passed').length;
    const failed = total - passed;

    document.getElementById('total-tests').textContent = total;
    document.getElementById('passed-tests').textContent = passed;
    document.getElementById('failed-tests').textContent = failed;
    
    // Duration
    const durationMs = testData.endTime - testData.startTime;
    const minutes = Math.floor(durationMs / 60000);
    const seconds = ((durationMs % 60000) / 1000).toFixed(0);
    document.getElementById('test-duration').textContent = `${minutes}m ${seconds}s`;
}

function generateAndDisplayReport() {
    let report = `==================================================\n`;
    report += `REGRESSION TEST REPORT\n`;
    report += `==================================================\n\n`;
    report += `Test Name: ${testData.testName}\n`;
    report += `Program Version: ${testData.programVersion}\n`;
    report += `Test Start Time: ${testData.startTime.toLocaleString()}\n`;
    report += `Test End Time: ${testData.endTime.toLocaleString()}\n`;
    const durationMs = testData.endTime - testData.startTime;
    const minutes = Math.floor(durationMs / 60000);
    const seconds = ((durationMs % 60000) / 1000).toFixed(0);
    report += `Total Duration: ${minutes}m ${seconds}s\n\n`;

    const passedCount = testData.steps.filter(s => s.status === 'passed').length;
    const totalCount = testData.steps.length;
    report += `--- SUMMARY ---\n`;
    report += `Result: ${passedCount} / ${totalCount} steps passed (${((passedCount/totalCount)*100).toFixed(1)}%)\n\n`;

    report += `--- DETAILED LOG ---\n\n`;
    testData.steps.forEach((step, index) => {
        report += `--------------------------------------------------\n`;
        report += `Step ${index + 1}: ${step.status.toUpperCase()}\n`;
        report += `--------------------------------------------------\n`;
        report += `Description: ${step.description}\n\n`;
        
        report += `LATEST DOCUMENTATION:\n`;
        report += `Notes: ${step.currentData.notes || 'N/A'}\n`;
        report += `Screenshots: ${step.currentData.screenshots.length} attached\n\n`;
        
        if (step.archive.length > 0) {
            report += `ARCHIVED DOCUMENTATION (${step.archive.length} edits):\n`;
            step.archive.forEach((entry, aIndex) => {
                const ts = new Date(entry.timestamp);
                report += `  - Archive #${aIndex + 1} (${ts.toLocaleString()}):\n`;
                report += `    Notes: ${entry.notes || 'N/A'}\n`;
                report += `    Screenshots: ${entry.screenshots.length} attached\n`;
            });
            report += `\n`;
        }
    });

    document.getElementById('report-output').textContent = report;
}

function printReport() {
    const reportContent = document.getElementById('report-output').textContent;
    const printWindow = window.open('', '', 'height=600,width=800');
    printWindow.document.write('<html><head><title>Test Report</title>');
    printWindow.document.write('<style>body { font-family: monospace; white-space: pre-wrap; }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(reportContent);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.print();
}

</script>
</body>
</html>