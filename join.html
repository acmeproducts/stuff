<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>P2P Peer Demo (No Master)</title>
<style>
  body { font-family: system-ui, sans-serif; margin: 24px; transition: background 0.3s; }
  .row { margin: 10px 0; display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  input, button { font-size: 16px; padding: 8px; }
  #log { font: 13px/1.45 monospace; white-space: pre-wrap; background:#0a0a0a; color:#00e676; padding:10px; height:200px; overflow:auto; border-radius:8px; }
</style>

<div class="row">
  <label>Room ID <input id="room" size="14" /></label>
  <button id="connect">Connect</button>
  <span id="status">disconnected</span>
</div>

<div class="row">
  <label>Shared Text <input id="text" value="Hello world" size="28" /></label>
  <button id="sendText">Send</button>
</div>

<div class="row">
  <label>Background <input id="color" type="color" value="#87cefa" /></label>
  <button id="sendColor">Send</button>
</div>

<div class="row">You: <span id="me">—</span></div>

<div id="log"></div>

<script>
(() => {
  const wsUrl = "wss://echo.websocket.events"; // public echo socket; for production use a room-capable WS server
  const roomEl = document.getElementById("room");
  const statusEl = document.getElementById("status");
  const textEl = document.getElementById("text");
  const colorEl = document.getElementById("color");
  const connectBtn = document.getElementById("connect");
  const sendTextBtn = document.getElementById("sendText");
  const sendColorBtn = document.getElementById("sendColor");
  const logEl = document.getElementById("log");
  const meEl = document.getElementById("me");

  const clientId = (crypto.randomUUID && crypto.randomUUID()) || ("c-" + Math.random().toString(16).slice(2));
  meEl.textContent = clientId.slice(0, 8);

  // restore last room if present
  roomEl.value = localStorage.getItem("p2p_room") || "demo-room";

  let ws = null;
  let room = "";
  const lastTs = { text: 0, color: 0 };

  const log = (m) => { logEl.textContent += m + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  const setStatus = (s) => statusEl.textContent = s;
  const msg = (type, value) => JSON.stringify({ type, value, room, sender: clientId, ts: Date.now() });

  function connect() {
    room = roomEl.value.trim();
    if (!room) return alert("Room required");
    localStorage.setItem("p2p_room", room);
    setStatus("connecting…");
    ws = new WebSocket(wsUrl);

    ws.onopen = () => {
      setStatus("connected");
      log("ws open");
      // send our current state so late joiners sync immediately
      ws.send(msg("text", textEl.value));
      ws.send(msg("color", colorEl.value));
    };

    ws.onmessage = (e) => {
      let m;
      try { m = JSON.parse(e.data); } catch { return; }
      if (m.room !== room) return; // ignore other rooms on public echo
      if (!m.type || m.sender === clientId) return; // ignore own echoes
      if (m.type === "text") {
        if (m.ts > lastTs.text || (m.ts === lastTs.text && m.sender > clientId)) {
          lastTs.text = m.ts;
          textEl.value = m.value;
          log(`text <- ${m.sender.slice(0,8)}: ${m.value}`);
        }
      } else if (m.type === "color") {
        if (m.ts > lastTs.color || (m.ts === lastTs.color && m.sender > clientId)) {
          lastTs.color = m.ts;
          colorEl.value = m.value;
          document.body.style.background = m.value;
          log(`color <- ${m.sender.slice(0,8)}: ${m.value}`);
        }
      }
    };

    ws.onclose = () => { setStatus("disconnected"); log("ws closed"); };
    ws.onerror = () => { setStatus("error"); log("ws error"); };
  }

  function broadcast(type, value) {
    if (!ws || ws.readyState !== 1) return alert("Not connected");
    ws.send(msg(type, value));
    // apply locally with a ts bump
    const now = Date.now();
    if (type === "text") { lastTs.text = now; }
    if (type === "color") { lastTs.color = now; document.body.style.background = value; }
    log(`${type} -> ${value}`);
  }

  connectBtn.onclick = connect;
  sendTextBtn.onclick = () => broadcast("text", textEl.value);
  sendColorBtn.onclick = () => broadcast("color", colorEl.value);
  textEl.addEventListener("keyup", (e) => { if (e.key === "Enter") sendTextBtn.click(); });
})();
</script>
</html>
