<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Orbital8 Step 3: Complete Core Image Viewer</title>
    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <style>
        :root {
            --app-accent: #f59e0b;
            --bg-dark: #1a1a1a;
            --bg-card: rgba(255, 255, 255, 0.1);
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.6);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, var(--bg-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow: hidden;
            overscroll-behavior: none;
            touch-action: none;
        }

        .app-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* ===== AUTHENTICATION SCREEN ===== */
        .auth-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .auth-title {
            color: white;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .auth-subtitle {
            color: var(--text-muted);
            font-size: 16px;
            margin-bottom: 24px;
        }

        .auth-button {
            background: linear-gradient(45deg, var(--app-accent), #d97706);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            padding: 16px 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
            width: 100%;
            margin-bottom: 16px;
        }

        .auth-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.6);
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .client-secret-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
        }

        .client-secret-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .client-secret-input:focus {
            outline: none;
            border-color: var(--app-accent);
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .auth-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .auth-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .auth-status.info {
            background: rgba(245, 158, 11, 0.2);
            color: var(--app-accent);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        /* ===== FOLDER SCREEN ===== */
        .folder-screen {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .folder-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .folder-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .folder-subtitle {
            color: var(--text-muted);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .folder-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
            max-height: 400px;
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 16px;
            margin-bottom: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
        }

        .folder-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(245, 158, 11, 0.3);
            transform: translateY(-1px);
        }

        .folder-icon {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            color: var(--app-accent);
        }

        .folder-info {
            flex: 1;
        }

        .folder-name {
            font-weight: 500;
            margin-bottom: 2px;
            font-size: 16px;
        }

        .folder-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .folder-navigation {
            display: flex;
            gap: 12px;
        }

        .folder-button {
            flex: 1;
            padding: 12px 24px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
        }

        .folder-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .folder-button.danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .folder-button.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* ===== SMART PROMPT ===== */
        .smart-prompt {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .smart-prompt-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }

        .smart-prompt-title {
            color: white;
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .smart-prompt-options {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-bottom: 16px;
        }

        .smart-option-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 500;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 120px;
        }

        .smart-option-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: var(--app-accent);
            transform: translateY(-2px);
        }

        .smart-cancel-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            color: #ef4444;
            font-size: 14px;
            padding: 10px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .smart-cancel-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* ===== LOADING SCREEN ===== */
        .loading-screen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1500;
        }

        .loading-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }

        .loading-title {
            color: white;
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
        }

        .loading-message {
            color: var(--text-muted);
            font-size: 16px;
            margin-bottom: 20px;
        }

        .loading-counter {
            color: var(--app-accent);
            font-size: 48px;
            font-weight: 700;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .loading-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .loading-progress-bar {
            height: 100%;
            background: linear-gradient(45deg, var(--app-accent), #d97706);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* ===== MAIN IMAGE VIEWER ===== */
        .image-viewer {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #0f0f0f 0%, var(--bg-dark) 100%);
            overflow: hidden;
        }

        .nav-button {
            position: absolute;
            top: 20px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 12px;
            font-size: 11px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 15;
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.7;
        }

        .nav-button:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-button.back {
            left: 20px;
        }

        .image-viewport {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1;
            overflow: hidden;
        }

        .center-image {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain;
            user-select: none;
            pointer-events: none;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.2s ease;
            transform-origin: center center;
            cursor: grab;
        }

        .center-image.dragging {
            filter: brightness(0.9);
            cursor: grabbing;
        }

        .center-image.zoomable {
            pointer-events: auto;
        }

        /* ===== EDGE GLOW SYSTEM ===== */
        .edge-glow {
            position: absolute;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2;
        }

        .edge-glow.top {
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(180deg, rgba(245, 158, 11, 0.4) 0%, transparent 100%);
        }

        .edge-glow.bottom {
            bottom: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(0deg, rgba(245, 158, 11, 0.4) 0%, transparent 100%);
        }

        .edge-glow.left {
            top: 0;
            left: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(90deg, rgba(245, 158, 11, 0.4) 0%, transparent 100%);
        }

        .edge-glow.right {
            top: 0;
            right: 0;
            bottom: 0;
            width: 8px;
            background: linear-gradient(270deg, rgba(245, 158, 11, 0.4) 0%, transparent 100%);
        }

        .edge-glow.active {
            opacity: 1;
        }

        /* ===== PILL COUNTER SYSTEM ===== */
        .pill-counter {
            position: fixed;
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 10px 18px;
            font-size: 18px;
            font-weight: 500;
            color: black;
            opacity: 0;
            transition: all 0.3s ease;
            cursor: pointer;
            z-index: 10;
            min-width: 50px;
            text-align: center;
        }

        .pill-counter.visible {
            opacity: 0.9;
        }

        .pill-counter.active {
            font-weight: 700;
            background: white;
            opacity: 1;
            border: 3px solid black;
        }

        .pill-counter:not(.active) {
            background: rgba(128, 128, 128, 0.4);
            border: none;
        }

        .pill-counter:hover {
            opacity: 1;
            transform: scale(1.05);
        }

        .pill-counter.top {
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
        }

        .pill-counter.bottom {
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
        }

        .pill-counter.left {
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        .pill-counter.right {
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
        }

        /* ===== RIPPLE EFFECTS ===== */
        .pill-counter::before, .pill-counter::after {
            content: '';
            position: absolute;
            border: 2px solid rgba(245, 158, 11, 0.8);
            border-radius: 20px;
            opacity: 0;
            pointer-events: none;
            z-index: -1;
        }

        .pill-counter.triple-ripple::before {
            animation: tripleRipple1 1.5s ease-out;
        }

        .pill-counter.triple-ripple::after {
            animation: tripleRipple2 1.5s ease-out 0.2s;
        }

        .pill-counter.triple-ripple {
            animation: tripleRipple3 1.5s ease-out 0.4s;
        }

        .pill-counter.glow-effect {
            box-shadow: 0 0 25px rgba(245, 158, 11, 0.8), 0 0 50px rgba(245, 158, 11, 0.6);
            animation: sustainedGlow 1s ease-out 1.5s;
        }

        @keyframes tripleRipple1 {
            0% {
                opacity: 0.9;
                transform: scale(1);
                top: -4px;
                left: -4px;
                right: -4px;
                bottom: -4px;
            }
            100% {
                opacity: 0;
                transform: scale(2);
                top: -20px;
                left: -20px;
                right: -20px;
                bottom: -20px;
            }
        }

        @keyframes tripleRipple2 {
            0% {
                opacity: 0.7;
                transform: scale(1);
                top: -6px;
                left: -6px;
                right: -6px;
                bottom: -6px;
            }
            100% {
                opacity: 0;
                transform: scale(2.5);
                top: -30px;
                left: -30px;
                right: -30px;
                bottom: -30px;
            }
        }

        @keyframes tripleRipple3 {
            0% {
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(245, 158, 11, 0.8);
            }
            100% {
                box-shadow: 0 0 15px rgba(245, 158, 11, 0.6);
            }
        }

        @keyframes sustainedGlow {
            0% {
                box-shadow: 0 0 25px rgba(245, 158, 11, 0.8), 0 0 50px rgba(245, 158, 11, 0.6);
            }
            50% {
                box-shadow: 0 0 35px rgba(245, 158, 11, 1), 0 0 70px rgba(245, 158, 11, 0.8);
            }
            100% {
                box-shadow: 0 0 10px rgba(245, 158, 11, 0.4);
            }
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 18px;
            font-weight: 300;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
            z-index: 5;
        }

        .empty-message {
            margin-bottom: 20px;
            font-size: 24px;
            font-weight: 400;
        }

        .new-images-button {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            border-radius: 20px;
            padding: 12px 24px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .new-images-button:hover {
            background: rgba(245, 158, 11, 0.4);
            transform: translateY(-2px);
        }

        /* ===== UTILITY CLASSES ===== */
        .hidden {
            display: none !important;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%;
            border-top-color: var(--app-accent);
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media screen and (min-width: 768px) {
            .image-viewport {
                top: -10vh;
            }
            .pill-counter {
                font-size: 16px;
                padding: 8px 16px;
                min-width: 40px;
            }
            .nav-button {
                font-size: 14px;
                padding: 10px 16px;
            }
        }

        @media screen and (max-width: 767px) {
            .nav-button {
                font-size: 16px;
                padding: 12px 20px;
                border-radius: 25px;
                min-width: 80px;
            }
            .pill-counter.bottom {
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Authentication Screen -->
        <div class="auth-screen" id="auth-screen">
            <div class="auth-card">
                <h1 class="auth-title">Orbital8</h1>
                <p class="auth-subtitle">Connect to Cloud Storage</p>
                
                <!-- Google Drive Auth -->
                <div id="google-auth-section">
                    <input type="password" id="google-client-secret" class="client-secret-input" 
                           placeholder="Enter Google Client Secret">
                    <button class="auth-button" id="google-auth-btn">Connect Google Drive</button>
                </div>
                
                <!-- OneDrive Auth -->
                <div id="onedrive-auth-section">
                    <button class="auth-button" id="onedrive-auth-btn">Connect OneDrive</button>
                </div>
                
                <div id="auth-status" class="auth-status info">
                    Choose a cloud storage provider to continue
                </div>
            </div>
        </div>

        <!-- Folder Selection Screen -->
        <div class="folder-screen hidden" id="folder-screen">
            <div class="folder-card">
                <h2 class="folder-title">Select a Folder</h2>
                <div class="folder-subtitle" id="folder-subtitle">
                    Choose a folder to browse your images
                </div>
                <div class="folder-list" id="folder-list">
                    <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                        <div class="spinner"></div>
                        <span>Loading folders...</span>
                    </div>
                </div>
                <div class="folder-navigation">
                    <button class="folder-button" id="refresh-folders">Refresh</button>
                    <button class="folder-button" id="back-folders">‚Üê Back</button>
                    <button class="folder-button danger" id="logout">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- Smart Prompt -->
        <div class="smart-prompt hidden" id="smart-prompt">
            <div class="smart-prompt-card">
                <h3 class="smart-prompt-title" id="smart-prompt-folder-name">Folder Name</h3>
                <div class="smart-prompt-options">
                    <button class="smart-option-btn" id="load-images-btn">
                        <span id="image-count">0</span> Images
                    </button>
                    <button class="smart-option-btn" id="list-subfolders-btn">
                        <span id="folder-count">0</span> Folders
                    </button>
                </div>
                <button class="smart-cancel-btn" id="cancel-prompt-btn">Cancel</button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen hidden" id="loading-screen">
            <div class="loading-card">
                <h2 class="loading-title">Loading Images</h2>
                <div class="loading-counter" id="loading-counter">0</div>
                <div class="loading-message" id="loading-message">Processing images...</div>
                <div class="loading-progress">
                    <div class="loading-progress-bar" id="loading-progress-bar"></div>
                </div>
                <div style="display: flex; align-items: center; justify-content: center; margin-top: 20px;">
                    <div class="spinner"></div>
                    <span>Please wait...</span>
                </div>
            </div>
        </div>

        <!-- Main Image Viewer -->
        <div class="image-viewer hidden" id="image-viewer">
            <div class="nav-button back" id="back-to-folders">‚Üê Folders</div>
            <div class="nav-button details" id="details-button" style="right: 20px;">Details ‚Üí</div>
            
            <div class="image-viewport" id="image-viewport">
                <img class="center-image zoomable" id="center-image" alt="Select images to start" />
            </div>
            
            <div class="edge-glow top" id="edge-top"></div>
            <div class="edge-glow bottom" id="edge-bottom"></div>
            <div class="edge-glow left" id="edge-left"></div>
            <div class="edge-glow right" id="edge-right"></div>
            
            <div class="pill-counter top" id="pill-priority" data-stack="priority">0</div>
            <div class="pill-counter bottom" id="pill-trash" data-stack="trash">0</div>
            <div class="pill-counter left active" id="pill-in" data-stack="in">0</div>
            <div class="pill-counter right" id="pill-out" data-stack="out">0</div>
            
            <div class="empty-state hidden" id="empty-state">
                <div class="empty-message">No more images in this stack</div>
                <button class="new-images-button" id="select-another-stack-btn">Select Another Stack</button>
                <button class="new-images-button" id="select-another-folder-btn" style="margin-top: 12px;">Choose Different Folder</button>
            </div>
        </div>
    </div>

    <script>
        // ===== STEP 3: COMPLETE CORE IMAGE VIEWER SYSTEM =====
        
        // ===== STACK CONSTANTS =====
        const STACK_TYPES = ['in', 'out', 'priority', 'trash'];
        const STACK_NAMES = { 'in': 'In', 'out': 'Out', 'priority': 'Priority', 'trash': 'Trash' };
        
        // ===== MAIN APPLICATION CONTROLLER =====
        class OrbitalApp {
            constructor() {
                this.providers = new ProviderManager();
                this.folderNav = new SmartFolderNavigator();
                this.imageViewer = new ImageViewerSystem();
                this.stackManager = new StackManager();
                this.gestureSystem = new GestureSystem();
                this.state = new UnifiedStateManager();
                
                this.initialize();
            }
            
            async initialize() {
                console.log('üöÄ Initializing Orbital8 Step 3 - Complete Core Image Viewer...');
                this.setupEventListeners();
                this.checkExistingAuth();
            }
            
            checkExistingAuth() {
                if (this.providers.hasValidAuth()) {
                    this.setAuthStatus('Already connected to cloud storage', 'success');
                    setTimeout(() => {
                        this.showFolderScreen();
                        this.folderNav.loadInitialFolders();
                    }, 1000);
                }
            }
            
            setupEventListeners() {
                // Authentication
                document.getElementById('google-auth-btn').addEventListener('click', () => this.authenticateGoogle());
                document.getElementById('onedrive-auth-btn').addEventListener('click', () => this.authenticateOneDrive());
                document.getElementById('logout').addEventListener('click', () => this.logout());
                
                // Folder navigation
                document.getElementById('refresh-folders').addEventListener('click', () => this.folderNav.refreshCurrentFolder());
                document.getElementById('back-folders').addEventListener('click', () => this.folderNav.navigateUp());
                
                // Smart prompt actions
                document.getElementById('load-images-btn').addEventListener('click', () => this.handleSmartChoice('loadImages'));
                document.getElementById('list-subfolders-btn').addEventListener('click', () => this.handleSmartChoice('listSubfolders'));
                document.getElementById('cancel-prompt-btn').addEventListener('click', () => this.handleSmartChoice('cancel'));
                
                // Image viewer navigation
                document.getElementById('back-to-folders').addEventListener('click', () => this.backToFolders());
                document.getElementById('details-button').addEventListener('click', () => {
                    console.log('üìã Details button clicked (Step 4 feature)');
                    alert('Image details modal (Step 4 feature)');
                });
                document.getElementById('select-another-stack-btn').addEventListener('click', () => this.selectAnotherStack());
                document.getElementById('select-another-folder-btn').addEventListener('click', () => this.backToFolders());
                
                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => this.handleKeyboard(e));
            }
            
            async authenticateGoogle() {
                const clientSecret = document.getElementById('google-client-secret').value.trim();
                
                if (!clientSecret) {
                    this.setAuthStatus('Please enter Google Client Secret', 'error');
                    return;
                }
                
                try {
                    this.setAuthStatus('Connecting to Google Drive...', 'info');
                    document.getElementById('google-auth-btn').disabled = true;
                    document.getElementById('google-auth-btn').textContent = 'Connecting...';
                    
                    const success = await this.providers.authenticateGoogle(clientSecret);
                    
                    if (success) {
                        this.setAuthStatus('‚úÖ Connected to Google Drive successfully', 'success');
                        document.getElementById('google-client-secret').value = '';
                        
                        setTimeout(() => {
                            this.showFolderScreen();
                            this.folderNav.loadInitialFolders();
                        }, 1000);
                    }
                } catch (error) {
                    this.setAuthStatus(`Google Drive authentication failed: ${error.message}`, 'error');
                } finally {
                    document.getElementById('google-auth-btn').disabled = false;
                    document.getElementById('google-auth-btn').textContent = 'Connect Google Drive';
                }
            }
            
            async authenticateOneDrive() {
                try {
                    this.setAuthStatus('Connecting to OneDrive...', 'info');
                    document.getElementById('onedrive-auth-btn').disabled = true;
                    document.getElementById('onedrive-auth-btn').textContent = 'Connecting...';
                    
                    const success = await this.providers.authenticateOneDrive();
                    
                    if (success) {
                        this.setAuthStatus('‚úÖ Connected to OneDrive successfully', 'success');
                        
                        setTimeout(() => {
                            this.showFolderScreen();
                            this.folderNav.loadInitialFolders();
                        }, 1000);
                    }
                } catch (error) {
                    this.setAuthStatus(`OneDrive authentication failed: ${error.message}`, 'error');
                } finally {
                    document.getElementById('onedrive-auth-btn').disabled = false;
                    document.getElementById('onedrive-auth-btn').textContent = 'Connect OneDrive';
                }
            }
            
            async handleSmartChoice(choice) {
                this.hideSmartPrompt();
                
                switch (choice) {
                    case 'loadImages':
                        console.log('üñºÔ∏è User chose to load images - starting image loading pipeline');
                        await this.startImageLoadingPipeline();
                        break;
                        
                    case 'listSubfolders':
                        console.log('üìÅ User chose to list subfolders');
                        await this.folderNav.showSubfoldersOnly();
                        break;
                        
                    case 'cancel':
                        console.log('‚ùå User cancelled folder selection - returning to folder view');
                        this.showFolderScreen();
                        await this.folderNav.refreshCurrentFolder();
                        break;
                }
            }
            
            async startImageLoadingPipeline() {
                console.log('üîÑ Starting complete image loading pipeline...');
                this.showLoadingScreen();
                
                try {
                    // Get the analyzed folder data from last smart prompt
                    const folderAnalysis = this.folderNav.lastAnalyzedFolder;
                    if (!folderAnalysis || !folderAnalysis.images) {
                        throw new Error('No image data available');
                    }
                    
                    const images = folderAnalysis.images;
                    console.log(`üìä Processing ${images.length} images for loading...`);
                    
                    // Update loading progress
                    document.getElementById('loading-counter').textContent = '0';
                    document.getElementById('loading-message').textContent = `Loading ${images.length} images...`;
                    document.getElementById('loading-progress-bar').style.width = '0%';
                    
                    // Process images with progress updates
                    const processedImages = [];
                    for (let i = 0; i < images.length; i++) {
                        const image = images[i];
                        
                        // Create standardized image object
                        const processedImage = {
                            id: image.id,
                            name: image.name,
                            mimeType: image.mimeType || image.file?.mimeType,
                            size: image.size || 0,
                            createdTime: image.createdTime,
                            modifiedTime: image.modifiedTime,
                            thumbnailUrl: await this.generateImageUrl(image),
                            downloadUrl: this.generateDownloadUrl(image),
                            
                            // Stack management (V3 pattern)
                            stack: 'in', // Default stack
                            tags: [],
                            qualityRating: 0,
                            contentRating: 0,
                            notes: ''
                        };
                        
                        console.log(`üìù Processed image ${i+1}/${images.length}: ${processedImage.name} - URL: ${processedImage.thumbnailUrl}`);
                        
                        processedImages.push(processedImage);
                        
                        // Update progress
                        const progress = ((i + 1) / images.length) * 100;
                        document.getElementById('loading-counter').textContent = (i + 1).toString();
                        document.getElementById('loading-progress-bar').style.width = `${progress}%`;
                        
                        // Small delay to show progress
                        if (i % 10 === 0) {
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    }
                    
                    console.log(`‚úÖ Processed ${processedImages.length} images successfully`);
                    
                    // Initialize the image viewer system
                    this.state.imageFiles = processedImages;
                    this.state.currentImageIndex = 0;
                    this.state.currentStack = 'in';
                    
                    // Initialize stacks
                    this.stackManager.updateStacks();
                    
                    // Show completion message
                    document.getElementById('loading-message').textContent = '‚úÖ Images loaded successfully!';
                    
                    // Transition to image viewer
                    setTimeout(() => {
                        this.showImageViewer();
                        this.imageViewer.displayTopImageFromStack('in');
                        this.updateActiveStackUI();
                        console.log('üéØ Image viewer initialized with first image');
                    }, 1000);
                    
                } catch (error) {
                    console.error('‚ùå Error in image loading pipeline:', error);
                    document.getElementById('loading-message').textContent = `Error loading images: ${error.message}`;
                    setTimeout(() => {
                        this.showFolderScreen();
                    }, 3000);
                }
            }
            
            async generateImageUrl(image) {
                const provider = this.providers.getCurrentProvider();
                if (provider.name === 'googledrive') {
                    return `https://drive.google.com/thumbnail?id=${image.id}&sz=w1000`;
                } else if (provider.name === 'onedrive') {
                    // For OneDrive, we need to get a direct content URL with auth
                    try {
                        const accessToken = await provider.getAccessToken();
                        return `https://graph.microsoft.com/v1.0/me/drive/items/${image.id}/content?access_token=${accessToken}`;
                    } catch (error) {
                        console.warn('Failed to get OneDrive access token for image URL');
                        return `data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150" fill="none"%3E%3Crect width="150" height="150" fill="%23E5E7EB"/%3E%3Cpath d="M65 60H85V90H65V60Z" fill="%239CA3AF"/%3E%3Ccircle cx="75" cy="45" r="10" fill="%239CA3AF"/%3E%3C/svg%3E`;
                    }
                }
                return `data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150" fill="none"%3E%3Crect width="150" height="150" fill="%23E5E7EB"/%3E%3Cpath d="M65 60H85V90H65V60Z" fill="%239CA3AF"/%3E%3Ccircle cx="75" cy="45" r="10" fill="%239CA3AF"/%3E%3C/svg%3E`;
            }
            
            generateDownloadUrl(image) {
                const provider = this.providers.getCurrentProvider();
                if (provider.name === 'googledrive') {
                    return `https://drive.google.com/file/d/${image.id}/view`;
                } else if (provider.name === 'onedrive') {
                    return `https://1drv.ms/i/s!${image.id}`;
                }
                return null;
            }
            
            selectAnotherStack() {
                const stacksWithImages = STACK_TYPES.filter(stack => this.state.stacks[stack].length > 0);
                if (stacksWithImages.length > 0) {
                    const nextStack = stacksWithImages.find(stack => stack !== this.state.currentStack) || stacksWithImages[0];
                    this.state.currentStack = nextStack;
                    this.imageViewer.displayTopImageFromStack(nextStack);
                    this.updateActiveStackUI();
                    document.getElementById('empty-state').classList.add('hidden');
                } else {
                    // No stacks with images, show folder options
                    document.getElementById('select-another-stack-btn').style.display = 'none';
                    document.getElementById('select-another-folder-btn').style.display = 'block';
                }
            }
            
            backToFolders() {
                console.log('üîô Returning to folder selection...');
                this.showFolderScreen();
                this.folderNav.refreshCurrentFolder();
            }
            
            handleKeyboard(e) {
                if (!document.getElementById('image-viewer').classList.contains('hidden')) {
                    switch (e.key) {
                        case 'ArrowLeft':
                        case 'ArrowRight':
                            this.imageViewer.moveToNextImage();
                            break;
                        case 'Escape':
                            this.backToFolders();
                            break;
                        case '1':
                            this.switchToStack('in');
                            break;
                        case '2':
                            this.switchToStack('out');
                            break;
                        case '3':
                            this.switchToStack('priority');
                            break;
                        case '4':
                            this.switchToStack('trash');
                            break;
                    }
                }
            }
            
            switchToStack(stackName) {
                console.log(`üîÑ Switching to stack: ${stackName}`);
                this.state.currentStack = stackName;
                this.updateActiveStackUI();
                this.imageViewer.displayTopImageFromStack(stackName);
                this.acknowledgePillCounter(stackName);
            }
            
            acknowledgePillCounter(stackName) {
                const pill = document.getElementById(`pill-${stackName}`);
                if (pill) {
                    pill.classList.remove('triple-ripple', 'glow-effect');
                    pill.offsetHeight; // Force reflow
                    pill.classList.add('triple-ripple');
                    
                    setTimeout(() => {
                        pill.classList.add('glow-effect');
                    }, 100);
                    
                    setTimeout(() => {
                        pill.classList.remove('triple-ripple', 'glow-effect');
                    }, 3000);
                }
            }
            
            updateActiveStackUI() {
                STACK_TYPES.forEach(stack => {
                    const pill = document.getElementById(`pill-${stack}`);
                    if (pill) {
                        pill.classList.toggle('active', stack === this.state.currentStack);
                    }
                });
            }
            
            showFolderScreen() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('folder-screen').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('image-viewer').classList.add('hidden');
                this.hideSmartPrompt();
            }
            
            showAuthScreen() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('folder-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('image-viewer').classList.add('hidden');
                this.hideSmartPrompt();
            }
            
            showLoadingScreen() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('folder-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                document.getElementById('image-viewer').classList.add('hidden');
                this.hideSmartPrompt();
            }
            
            showImageViewer() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('folder-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
                document.getElementById('image-viewer').classList.remove('hidden');
                this.hideSmartPrompt();
                
                // Initialize gesture system
                this.gestureSystem.initialize();
            }
            
            showSmartPrompt(folderData) {
                document.getElementById('smart-prompt-folder-name').textContent = folderData.folderName || 'Unknown Folder';
                
                const imageCount = folderData.images.length;
                const folderCount = folderData.subfolders.length;
                
                document.getElementById('image-count').textContent = imageCount > 999 ? '999+' : imageCount;
                document.getElementById('folder-count').textContent = folderCount > 999 ? '999+' : folderCount;
                
                document.getElementById('smart-prompt').classList.remove('hidden');
                console.log(`üìä Smart prompt shown - ${imageCount} images, ${folderCount} folders`);
            }
            
            hideSmartPrompt() {
                document.getElementById('smart-prompt').classList.add('hidden');
            }
            
            setAuthStatus(message, type) {
                const statusEl = document.getElementById('auth-status');
                statusEl.textContent = message;
                statusEl.className = `auth-status ${type}`;
                console.log(`üîê Auth: ${message}`);
            }
            
            async logout() {
                console.log('üö™ Logging out...');
                await this.providers.disconnect();
                this.showAuthScreen();
                this.setAuthStatus('Choose a cloud storage provider to continue', 'info');
            }
        }
        
        // ===== IMAGE VIEWER SYSTEM =====
        class ImageViewerSystem {
            constructor() {
                this.currentScale = 1;
                this.maxScale = 4;
                this.minScale = 0.3;
                this.panOffset = { x: 0, y: 0 };
            }
            
            async displayCurrentImage() {
                const state = window.OrbitalApp.state;
                
                if (state.imageFiles.length === 0 || state.currentImageIndex < 0 || state.currentImageIndex >= state.imageFiles.length) {
                    document.getElementById('center-image').src = '';
                    document.getElementById('center-image').alt = 'No image selected';
                    document.getElementById('empty-state').classList.remove('hidden');
                    return;
                }
                
                document.getElementById('empty-state').classList.add('hidden');
                const currentFile = state.imageFiles[state.currentImageIndex];
                
                if (!currentFile) {
                    document.getElementById('center-image').src = '';
                    document.getElementById('center-image').alt = 'Image not available';
                    console.error('‚ùå Current file not available');
                    return;
                }
                
                console.log(`üñºÔ∏è Displaying image: ${currentFile.name}`);
                await this.setImageSrc(document.getElementById('center-image'), currentFile);
                
                this.currentScale = 1;
                this.panOffset = { x: 0, y: 0 };
                this.applyTransform();
                
                window.OrbitalApp.stackManager.updateCounts();
            }
            
            async setImageSrc(img, file) {
                console.log(`üñºÔ∏è Loading image: ${file.name} from URL: ${file.thumbnailUrl}`);
                return new Promise((resolve) => {
                    img.onload = () => {
                        console.log(`‚úÖ Image loaded successfully: ${file.name}`);
                        resolve();
                    };
                    img.onerror = () => {
                        console.warn(`‚ö†Ô∏è Failed to load image: ${file.name}, using fallback`);
                        img.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="150" height="150" viewBox="0 0 150 150" fill="none"%3E%3Crect width="150" height="150" fill="%23E5E7EB"/%3E%3Cpath d="M65 60H85V90H65V60Z" fill="%239CA3AF"/%3E%3Ccircle cx="75" cy="45" r="10" fill="%239CA3AF"/%3E%3C/svg%3E';
                        resolve();
                    };
                    img.src = file.thumbnailUrl || '';
                    img.alt = file.name || 'Image';
                });
            }
            
            async displayTopImageFromStack(stackName) {
                const state = window.OrbitalApp.state;
                console.log(`üìã Displaying top image from ${stackName} stack (${state.stacks[stackName].length} images)`);
                
                if (state.stacks[stackName].length === 0) {
                    console.log(`üì≠ ${stackName} stack is empty`);
                    const centerImage = document.getElementById('center-image');
                    centerImage.style.opacity = '0';
                    setTimeout(() => {
                        centerImage.src = '';
                        centerImage.alt = 'No images in this stack';
                        this.updateEmptyStateButtons();
                        document.getElementById('empty-state').classList.remove('hidden');
                        centerImage.style.opacity = '1';
                    }, 200);
                    return;
                }
                
                document.getElementById('empty-state').classList.add('hidden');
                const topImage = state.stacks[stackName][0];
                console.log(`üéØ Found top image: ${topImage.name} with URL: ${topImage.thumbnailUrl}`);
                const imageIndex = state.imageFiles.findIndex(f => f.id === topImage.id);
                
                if (imageIndex !== -1) {
                    state.currentImageIndex = imageIndex;
                    state.currentStack = stackName;
                    await this.displayCurrentImage();
                    window.OrbitalApp.updateActiveStackUI();
                    console.log(`‚úÖ Successfully displayed image ${imageIndex + 1} of ${state.imageFiles.length}`);
                } else {
                    console.error(`‚ùå Could not find image index for ${topImage.name}`);
                }
            }
            
            async moveToNextImage() {
                const state = window.OrbitalApp.state;
                
                if (state.imageFiles.length === 0) return;
                
                const activeStackImages = state.stacks[state.currentStack];
                if (activeStackImages.length > 0) {
                    const currentImageInStack = activeStackImages.find(img => img.id === state.imageFiles[state.currentImageIndex].id);
                    if (currentImageInStack) {
                        const currentIndexInStack = activeStackImages.indexOf(currentImageInStack);
                        const nextIndexInStack = (currentIndexInStack + 1) % activeStackImages.length;
                        const nextImageInStack = activeStackImages[nextIndexInStack];
                        const nextGlobalIndex = state.imageFiles.findIndex(img => img.id === nextImageInStack.id);
                        if (nextGlobalIndex !== -1) {
                            state.currentImageIndex = nextGlobalIndex;
                        }
                    } else {
                        if (activeStackImages.length > 0) {
                            const firstImageInStack = activeStackImages[0];
                            const firstGlobalIndex = state.imageFiles.findIndex(img => img.id === firstImageInStack.id);
                            if (firstGlobalIndex !== -1) {
                                state.currentImageIndex = firstGlobalIndex;
                            }
                        }
                    }
                    await this.displayCurrentImage();
                } else {
                    const centerImage = document.getElementById('center-image');
                    centerImage.style.opacity = '0';
                    setTimeout(() => {
                        centerImage.src = '';
                        centerImage.alt = 'No images in this stack';
                        this.updateEmptyStateButtons();
                        document.getElementById('empty-state').classList.remove('hidden');
                        centerImage.style.opacity = '1';
                    }, 200);
                }
            }
            
            updateEmptyStateButtons() {
                const state = window.OrbitalApp.state;
                const stacksWithImages = STACK_TYPES.filter(stack => state.stacks[stack].length > 0);
                const hasOtherStacks = stacksWithImages.some(stack => stack !== state.currentStack);
                
                document.getElementById('select-another-stack-btn').style.display = hasOtherStacks ? 'block' : 'none';
                document.getElementById('select-another-folder-btn').style.display = hasOtherStacks ? 'none' : 'block';
            }
            
            applyTransform() {
                const transform = `scale(${this.currentScale}) translate(${this.panOffset.x}px, ${this.panOffset.y}px)`;
                document.getElementById('center-image').style.transform = transform;
            }
        }
        
        // ===== STACK MANAGER =====
        class StackManager {
            constructor() {
                this.currentSort = 'date-desc';
            }
            
            updateStacks() {
                const state = window.OrbitalApp.state;
                
                // Reset stacks
                STACK_TYPES.forEach(stack => { state.stacks[stack] = []; });
                
                // Organize files into stacks
                state.imageFiles.forEach(file => {
                    const stack = file.stack || 'in';
                    if (STACK_TYPES.includes(stack)) {
                        state.stacks[stack].push(file);
                    } else {
                        state.stacks.in.push(file);
                    }
                });
                
                // Sort each stack
                STACK_TYPES.forEach(stack => {
                    state.stacks[stack] = this.sortFiles(state.stacks[stack], this.currentSort);
                });
                
                this.updateCounts();
            }
            
            sortFiles(files, sortOrder) {
                const sorted = [...files];
                
                switch (sortOrder) {
                    case 'date-desc':
                        return sorted.sort((a, b) => new Date(b.modifiedTime || b.createdTime) - new Date(a.modifiedTime || a.createdTime));
                    case 'date-asc':
                        return sorted.sort((a, b) => new Date(a.modifiedTime || a.createdTime) - new Date(b.modifiedTime || b.createdTime));
                    case 'name-asc':
                        return sorted.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
                    case 'name-desc':
                        return sorted.sort((a, b) => (b.name || '').localeCompare(a.name || ''));
                    default:
                        return sorted;
                }
            }
            
            updateCounts() {
                const state = window.OrbitalApp.state;
                
                STACK_TYPES.forEach(stack => {
                    const count = state.stacks[stack].length;
                    const pill = document.getElementById(`pill-${stack}`);
                    if (pill) {
                        pill.textContent = count > 999 ? '999+' : count;
                        pill.classList.toggle('visible', count > 0);
                    }
                });
            }
            
            async moveFileToStack(fileId, targetStack) {
                const state = window.OrbitalApp.state;
                const file = state.imageFiles.find(f => f.id === fileId);
                if (!file) throw new Error('File not found');
                
                const currentStack = file.stack;
                
                if (currentStack === targetStack) {
                    // Same stack - move to end
                    const currentStackArray = state.stacks[currentStack];
                    const index = currentStackArray.findIndex(img => img.id === fileId);
                    if (index > -1) {
                        currentStackArray.splice(index, 1);
                        currentStackArray.push(file);
                    }
                    console.log(`üîÑ Moved ${file.name} to end of ${targetStack} stack`);
                } else {
                    // Different stack - move to new stack
                    const currentStackIndex = state.stacks[currentStack].findIndex(f => f.id === fileId);
                    if (currentStackIndex !== -1) {
                        state.stacks[currentStack].splice(currentStackIndex, 1);
                    }
                    state.stacks[targetStack].unshift(file);
                    file.stack = targetStack;
                    console.log(`üì¶ Moved ${file.name} from ${currentStack} to ${targetStack}`);
                }
                
                this.updateCounts();
                return file;
            }
        }
        
        // ===== GESTURE SYSTEM =====
        class GestureSystem {
            constructor() {
                this.isDragging = false;
                this.startPos = { x: 0, y: 0 };
                this.currentPos = { x: 0, y: 0 };
                this.gestureStarted = false;
                this.initialized = false;
            }
            
            initialize() {
                if (this.initialized) return;
                
                console.log('üëÜ Initializing gesture system...');
                
                const imageViewport = document.getElementById('image-viewport');
                
                // Mouse events
                imageViewport.addEventListener('mousedown', (e) => this.handleStart(e));
                document.addEventListener('mousemove', (e) => this.handleMove(e));
                document.addEventListener('mouseup', (e) => this.handleEnd(e));
                
                // Touch events
                imageViewport.addEventListener('touchstart', (e) => this.handleStart(e), { passive: false });
                document.addEventListener('touchmove', (e) => this.handleMove(e), { passive: false });
                document.addEventListener('touchend', (e) => this.handleEnd(e), { passive: false });
                
                // Pill counter clicks
                this.setupPillCounters();
                
                this.initialized = true;
            }
            
            setupPillCounters() {
                STACK_TYPES.forEach(stackName => {
                    const pill = document.getElementById(`pill-${stackName}`);
                    if (pill) {
                        pill.addEventListener('click', (e) => {
                            e.stopPropagation();
                            
                            if (window.OrbitalApp.state.currentStack === stackName) {
                                // Same stack - open grid view (placeholder for now)
                                console.log(`üìä Opening grid view for ${stackName} stack`);
                                alert(`Grid view for ${STACK_NAMES[stackName]} stack (Step 4 feature)`);
                                window.OrbitalApp.acknowledgePillCounter(stackName);
                                return;
                            }
                            
                            // Switch stack
                            window.OrbitalApp.switchToStack(stackName);
                        });
                    }
                });
            }
            
            handleStart(e) {
                const state = window.OrbitalApp.state;
                if (state.imageFiles.length === 0) return;
                if (e.touches && e.touches.length > 1) return; // No multi-touch
                if (window.OrbitalApp.imageViewer.currentScale > 1.1) return; // No gestures when zoomed
                
                e.preventDefault();
                const point = e.touches ? e.touches[0] : e;
                
                this.startPos = { x: point.clientX, y: point.clientY };
                this.currentPos = { x: point.clientX, y: point.clientY };
                this.gestureStarted = false;
                
                this.isDragging = true;
                document.getElementById('center-image').classList.add('dragging');
                
                console.log('üëÜ Gesture started');
            }
            
            handleMove(e) {
                if (!this.isDragging || window.OrbitalApp.state.imageFiles.length === 0) return;
                
                if (e.touches && e.touches.length > 1) {
                    this.isDragging = false;
                    document.getElementById('center-image').classList.remove('dragging');
                    this.hideAllEdgeGlows();
                    return;
                }
                
                e.preventDefault();
                const point = e.touches ? e.touches[0] : e;
                
                this.currentPos = { x: point.clientX, y: point.clientY };
                
                const deltaX = this.currentPos.x - this.startPos.x;
                const deltaY = this.currentPos.y - this.startPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > 30) { // V3 threshold
                    this.gestureStarted = true;
                    const direction = this.determineSwipeDirection(deltaX, deltaY);
                    if (direction) {
                        this.hideAllEdgeGlows();
                        this.showEdgeGlow(direction);
                    }
                } else {
                    this.hideAllEdgeGlows();
                }
            }
            
            handleEnd(e) {
                if (!this.isDragging) return;
                
                e.preventDefault();
                this.isDragging = false;
                document.getElementById('center-image').classList.remove('dragging');
                
                if (!this.gestureStarted) {
                    this.hideAllEdgeGlows();
                    return;
                }
                
                const deltaX = this.currentPos.x - this.startPos.x;
                const deltaY = this.currentPos.y - this.startPos.y;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance > 80) { // V3 execution threshold
                    const direction = this.determineSwipeDirection(deltaX, deltaY);
                    const targetStack = this.directionToStack(direction);
                    if (targetStack && direction) {
                        this.executeFlick(targetStack);
                        return;
                    }
                }
                
                this.hideAllEdgeGlows();
                console.log('üëÜ Gesture cancelled - insufficient distance');
            }
            
            determineSwipeDirection(deltaX, deltaY) {
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    return deltaX > 0 ? 'right' : 'left';
                } else {
                    return deltaY > 0 ? 'bottom' : 'top';
                }
            }
            
            directionToStack(direction) {
                const mapping = {
                    'top': 'priority',
                    'bottom': 'trash',
                    'left': 'in',
                    'right': 'out'
                };
                return mapping[direction];
            }
            
            showEdgeGlow(direction) {
                const edgeElement = document.getElementById(`edge-${direction}`);
                if (edgeElement) {
                    edgeElement.classList.add('active');
                }
            }
            
            hideAllEdgeGlows() {
                ['top', 'bottom', 'left', 'right'].forEach(direction => {
                    const edgeElement = document.getElementById(`edge-${direction}`);
                    if (edgeElement) {
                        edgeElement.classList.remove('active');
                    }
                });
            }
            
            async executeFlick(targetStack) {
                const state = window.OrbitalApp.state;
                const currentImage = state.imageFiles[state.currentImageIndex];
                const currentStack = currentImage.stack;
                
                console.log(`üéØ Executing flick: ${currentImage.name} ‚Üí ${targetStack}`);
                
                // Visual feedback
                window.OrbitalApp.acknowledgePillCounter(targetStack);
                
                try {
                    await window.OrbitalApp.stackManager.moveFileToStack(currentImage.id, targetStack);
                    
                    // Check if current stack is empty
                    if (state.stacks[state.currentStack].length === 0) {
                        const centerImage = document.getElementById('center-image');
                        centerImage.style.opacity = '0';
                        setTimeout(() => {
                            centerImage.src = '';
                            centerImage.alt = 'No images in this stack';
                            window.OrbitalApp.imageViewer.updateEmptyStateButtons();
                            document.getElementById('empty-state').classList.remove('hidden');
                            centerImage.style.opacity = '1';
                        }, 200);
                    } else {
                        window.OrbitalApp.imageViewer.moveToNextImage();
                    }
                    
                    this.hideAllEdgeGlows();
                } catch (error) {
                    console.error('‚ùå Error executing flick:', error);
                    this.hideAllEdgeGlows();
                }
            }
        }
        
        // ===== UNIFIED STATE MANAGER =====
        class UnifiedStateManager {
            constructor() {
                this.imageFiles = [];
                this.currentImageIndex = 0;
                this.currentStack = 'in';
                this.stacks = { in: [], out: [], priority: [], trash: [] };
                this.tags = new Set();
            }
        }
        
        // ===== PROVIDER MANAGER (SAME AS STEP 2) =====
        class ProviderManager {
            constructor() {
                this.currentProvider = null;
                this.googleProvider = new GoogleDriveProviderV3();
                this.oneDriveProvider = new OneDriveProvider();
            }
            
            async authenticateGoogle(clientSecret) {
                const success = await this.googleProvider.authenticate(clientSecret);
                if (success) {
                    this.currentProvider = this.googleProvider;
                    console.log('‚úÖ Google Drive authentication successful');
                }
                return success;
            }
            
            async authenticateOneDrive() {
                const success = await this.oneDriveProvider.authenticate();
                if (success) {
                    this.currentProvider = this.oneDriveProvider;
                    console.log('‚úÖ OneDrive authentication successful');
                }
                return success;
            }
            
            hasValidAuth() {
                const googleAuth = this.googleProvider.isAuthenticated();
                const oneDriveAuth = this.oneDriveProvider.isAuthenticated();
                console.log(`üîç Auth check - Google: ${googleAuth}, OneDrive: ${oneDriveAuth}`);
                return googleAuth || oneDriveAuth;
            }
            
            getCurrentProvider() {
                if (this.googleProvider.isAuthenticated()) {
                    this.currentProvider = this.googleProvider;
                } else if (this.oneDriveProvider.isAuthenticated()) {
                    this.currentProvider = this.oneDriveProvider;
                }
                return this.currentProvider;
            }
            
            async getSmartFolderContents(folderId) {
                const provider = this.getCurrentProvider();
                if (!provider) {
                    throw new Error('No authenticated provider');
                }
                
                console.log(`üìÅ Getting folder contents for ${folderId} using ${provider.name}`);
                
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timed out after 30 seconds')), 30000)
                    );
                    
                    const contentsPromise = provider.getFolderContents(folderId);
                    const contents = await Promise.race([contentsPromise, timeoutPromise]);
                    
                    console.log(`üìä Received ${contents.length} items from ${provider.name}`);
                    return this.analyzeContentsForSmartPrompt(contents);
                    
                } catch (error) {
                    console.error('‚ùå Error getting folder contents:', error);
                    throw error;
                }
            }
            
            analyzeContentsForSmartPrompt(contents) {
                const images = contents.filter(item => {
                    if (item.file && item.file.mimeType) {
                        return item.file.mimeType.startsWith('image/');
                    }
                    return item.mimeType && item.mimeType.startsWith('image/');
                });
                
                const subfolders = contents.filter(item => {
                    return item.folder || item.mimeType === 'application/vnd.google-apps.folder';
                });
                
                console.log(`üìà Analysis complete - ${images.length} images, ${subfolders.length} subfolders`);
                
                return {
                    hasImages: images.length > 0,
                    hasSubfolders: subfolders.length > 0,
                    images: images,
                    subfolders: subfolders,
                    allItems: contents,
                    needsSmartPrompt: images.length > 0 && subfolders.length > 0
                };
            }
            
            async disconnect() {
                console.log('üîå Disconnecting all providers...');
                if (this.googleProvider.isAuthenticated()) {
                    await this.googleProvider.disconnect();
                }
                if (this.oneDriveProvider.isAuthenticated()) {
                    await this.oneDriveProvider.disconnect();
                }
                this.currentProvider = null;
            }
        }
        
        // ===== GOOGLE DRIVE PROVIDER V3 (EXACT COPY) =====
        class GoogleDriveProviderV3 {
            constructor() {
                this.name = 'googledrive';
                this.clientId = '567988062464-fa6c1ovesqeudqs5398vv4mbo6q068p9.apps.googleusercontent.com';
                this.redirectUri = window.location.origin + window.location.pathname;
                this.scope = 'https://www.googleapis.com/auth/drive';
                this.apiBase = 'https://www.googleapis.com/drive/v3';
                this.accessToken = null;
                this.refreshToken = null;
                this.clientSecret = null;
                this.isAuthenticatedFlag = false;
                this.loadStoredCredentials();
                console.log('üîß GoogleDriveProviderV3 initialized');
            }
            
            loadStoredCredentials() {
                this.accessToken = localStorage.getItem('google_access_token');
                this.refreshToken = localStorage.getItem('google_refresh_token');
                this.clientSecret = localStorage.getItem('google_client_secret');
                this.isAuthenticatedFlag = !!(this.accessToken && this.refreshToken && this.clientSecret);
                
                if (this.isAuthenticatedFlag) {
                    console.log('üîë Loaded stored Google Drive credentials');
                }
            }
            
            storeCredentials() {
                if (this.accessToken) localStorage.setItem('google_access_token', this.accessToken);
                if (this.refreshToken) localStorage.setItem('google_refresh_token', this.refreshToken);
                if (this.clientSecret) localStorage.setItem('google_client_secret', this.clientSecret);
                console.log('üíæ Stored Google Drive credentials');
            }
            
            clearStoredCredentials() {
                localStorage.removeItem('google_access_token');
                localStorage.removeItem('google_refresh_token');
                localStorage.removeItem('google_client_secret');
                console.log('üóëÔ∏è Cleared Google Drive credentials');
            }
            
            async authenticate(clientSecret) {
                console.log('üîê Starting Google Drive authentication...');
                
                if (clientSecret) {
                    this.clientSecret = clientSecret;
                    this.storeCredentials();
                }
                
                if (!this.clientSecret) {
                    throw new Error('Client secret is required for Google Drive authentication');
                }
                
                if (this.accessToken && this.refreshToken) {
                    try {
                        console.log('üîç Testing existing tokens...');
                        await this.makeApiCall('/files?pageSize=1');
                        this.isAuthenticatedFlag = true;
                        console.log('‚úÖ Existing tokens are valid');
                        return true;
                    } catch (error) {
                        console.log('‚ö†Ô∏è Existing tokens invalid, need fresh auth');
                    }
                }
                
                return new Promise((resolve, reject) => {
                    const authUrl = this.buildAuthUrl();
                    console.log('üåê Opening auth popup...');
                    const popup = window.open(authUrl, 'google-auth', 'width=500,height=600,scrollbars=yes,resizable=yes');
                    
                    if (!popup) {
                        reject(new Error('Popup blocked by browser'));
                        return;
                    }
                    
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            reject(new Error('Authentication cancelled'));
                        }
                    }, 1000);
                    
                    const messageHandler = async (event) => {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
                            clearInterval(checkClosed);
                            window.removeEventListener('message', messageHandler);
                            popup.close();
                            
                            try {
                                console.log('üîÑ Exchanging code for tokens...');
                                await this.exchangeCodeForTokens(event.data.code);
                                this.isAuthenticatedFlag = true;
                                console.log('‚úÖ Google Drive authentication complete');
                                resolve(true);
                            } catch (error) {
                                console.error('‚ùå Token exchange failed:', error);
                                reject(error);
                            }
                        } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
                            clearInterval(checkClosed);
                            window.removeEventListener('message', messageHandler);
                            popup.close();
                            console.error('‚ùå Google auth error:', event.data.error);
                            reject(new Error(event.data.error));
                        }
                    };
                    
                    window.addEventListener('message', messageHandler);
                });
            }
            
            buildAuthUrl() {
                const params = new URLSearchParams({
                    client_id: this.clientId,
                    redirect_uri: this.redirectUri,
                    response_type: 'code',
                    scope: this.scope,
                    access_type: 'offline',
                    prompt: 'consent'
                });
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?${params.toString()}`;
                console.log('üîó Auth URL built');
                return authUrl;
            }
            
            async exchangeCodeForTokens(code) {
                console.log('üîÑ Exchanging authorization code...');
                
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: this.clientId,
                        client_secret: this.clientSecret,
                        code: code,
                        grant_type: 'authorization_code',
                        redirect_uri: this.redirectUri
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Token exchange failed:', errorText);
                    throw new Error('Token exchange failed');
                }
                
                const tokens = await response.json();
                this.accessToken = tokens.access_token;
                this.refreshToken = tokens.refresh_token;
                this.storeCredentials();
                console.log('üéüÔ∏è Tokens received and stored');
            }
            
            async refreshAccessToken() {
                if (!this.refreshToken || !this.clientSecret) {
                    throw new Error('No refresh token or client secret available');
                }
                
                console.log('üîÑ Refreshing access token...');
                
                const response = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: this.clientId,
                        client_secret: this.clientSecret,
                        refresh_token: this.refreshToken,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (!response.ok) {
                    console.error('‚ùå Failed to refresh access token');
                    throw new Error('Failed to refresh access token');
                }
                
                const tokens = await response.json();
                this.accessToken = tokens.access_token;
                this.storeCredentials();
                console.log('‚úÖ Access token refreshed');
                return this.accessToken;
            }
            
            async makeApiCall(endpoint, options = {}) {
                if (!this.accessToken) {
                    throw new Error('Not authenticated');
                }
                
                const url = `${this.apiBase}${endpoint}`;
                const headers = {
                    'Authorization': `Bearer ${this.accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                let response = await fetch(url, { ...options, headers });
                
                if (response.status === 401 && this.refreshToken && this.clientSecret) {
                    try {
                        await this.refreshAccessToken();
                        headers['Authorization'] = `Bearer ${this.accessToken}`;
                        response = await fetch(url, { ...options, headers });
                    } catch (refreshError) {
                        this.isAuthenticatedFlag = false;
                        this.clearStoredCredentials();
                        throw new Error('Authentication expired. Please reconnect.');
                    }
                }
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.statusText}`);
                }
                
                return await response.json();
            }
            
            async getFolderContents(folderId = 'root') {
                console.log(`üìÅ Google Drive: Getting contents for folder ${folderId}`);
                
                try {
                    const query = `'${folderId}' in parents and trashed=false`;
                    console.log(`üîç Query: ${query}`);
                    
                    const response = await this.makeApiCall(
                        `/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,size,createdTime,modifiedTime,parents)&pageSize=100`
                    );
                    
                    console.log(`üìä Google Drive API returned ${response.files.length} items`);
                    
                    const processedFiles = response.files.map(file => ({
                        id: file.id,
                        name: file.name,
                        mimeType: file.mimeType,
                        size: file.size ? parseInt(file.size) : 0,
                        createdTime: file.createdTime,
                        modifiedTime: file.modifiedTime,
                        parents: file.parents,
                        folder: file.mimeType === 'application/vnd.google-apps.folder' ? {} : null,
                        file: file.mimeType !== 'application/vnd.google-apps.folder' ? { mimeType: file.mimeType } : null
                    }));
                    
                    console.log(`‚úÖ Processed ${processedFiles.length} files for smart analysis`);
                    return processedFiles;
                    
                } catch (error) {
                    console.error('‚ùå Google Drive error getting folder contents:', error);
                    throw error;
                }
            }
            
            isAuthenticated() {
                return this.isAuthenticatedFlag;
            }
            
            async disconnect() {
                console.log('üîå Disconnecting Google Drive...');
                this.isAuthenticatedFlag = false;
                this.accessToken = null;
                this.refreshToken = null;
                this.clientSecret = null;
                this.clearStoredCredentials();
            }
        }
        
        // ===== ONEDRIVE PROVIDER (SAME AS STEP 2) =====
        class OneDriveProvider {
            constructor() {
                this.name = 'onedrive';
                this.clientId = 'b407fd45-c551-4dbb-9da5-cab3a2c5a949';
                this.apiBase = 'https://graph.microsoft.com/v1.0';
                this.authenticated = false;
                this.activeAccount = null;
                this.msalInstance = null;
                this.initMSAL();
                console.log('üîß OneDriveProvider initialized');
            }
            
            initMSAL() {
                const msalConfig = {
                    auth: {
                        clientId: this.clientId,
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: window.location.origin + window.location.pathname
                    },
                    cache: { cacheLocation: 'sessionStorage' }
                };
                this.msalInstance = new msal.PublicClientApplication(msalConfig);
                console.log('üîß MSAL initialized for OneDrive');
            }
            
            async authenticate() {
                try {
                    console.log('üîê Starting OneDrive authentication...');
                    const loginResponse = await this.msalInstance.loginPopup({
                        scopes: ['Files.ReadWrite.AppFolder', 'User.Read']
                    });
                    this.activeAccount = loginResponse.account;
                    this.msalInstance.setActiveAccount(this.activeAccount);
                    this.authenticated = true;
                    console.log('‚úÖ OneDrive authentication successful');
                    return true;
                } catch (error) {
                    this.authenticated = false;
                    console.error('‚ùå OneDrive authentication failed:', error);
                    throw new Error(`OneDrive authentication failed: ${error.message}`);
                }
            }
            
            async getAccessToken() {
                if (!this.activeAccount) {
                    throw new Error('No active account');
                }
                
                try {
                    const response = await this.msalInstance.acquireTokenSilent({
                        scopes: ['Files.ReadWrite.AppFolder'],
                        account: this.activeAccount
                    });
                    return response.accessToken;
                } catch (silentError) {
                    const response = await this.msalInstance.acquireTokenPopup({
                        scopes: ['Files.ReadWrite.AppFolder'],
                        account: this.activeAccount
                    });
                    return response.accessToken;
                }
            }
            
            async makeApiCall(endpoint, options = {}) {
                const accessToken = await this.getAccessToken();
                const url = `${this.apiBase}${endpoint}`;
                const headers = {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                const response = await fetch(url, { ...options, headers });
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.statusText}`);
                }
                
                return response;
            }
            
            async getFolderContents(folderId = 'root') {
                console.log(`üìÅ OneDrive: Getting contents for folder ${folderId}`);
                
                try {
                    const endpoint = folderId === 'root' ? 
                        '/me/drive/root/children' : 
                        `/me/drive/items/${folderId}/children`;
                    
                    console.log(`üîç OneDrive endpoint: ${endpoint}`);
                    
                    const response = await this.makeApiCall(endpoint);
                    const data = await response.json();
                    
                    console.log(`üìä OneDrive API returned ${data.value.length} items`);
                    
                    const processedFiles = data.value.map(item => ({
                        id: item.id,
                        name: item.name,
                        size: item.size || 0,
                        createdTime: item.createdDateTime,
                        modifiedTime: item.lastModifiedDateTime,
                        folder: item.folder || null,
                        file: item.file || null,
                        mimeType: item.file ? item.file.mimeType : null
                    }));
                    
                    console.log(`‚úÖ Processed ${processedFiles.length} OneDrive items`);
                    return processedFiles;
                    
                } catch (error) {
                    console.error('‚ùå OneDrive error getting folder contents:', error);
                    throw error;
                }
            }
            
            isAuthenticated() {
                return this.authenticated;
            }
            
            async disconnect() {
                console.log('üîå Disconnecting OneDrive...');
                this.authenticated = false;
                this.activeAccount = null;
                if (this.msalInstance) {
                    await this.msalInstance.logoutPopup();
                }
            }
        }
        
        // ===== SMART FOLDER NAVIGATOR (SAME AS STEP 2) =====
        class SmartFolderNavigator {
            constructor() {
                this.currentFolderId = 'root';
                this.folderHistory = [{ id: 'root', name: 'Root' }];
                this.lastAnalyzedFolder = null;
                console.log('üß≠ SmartFolderNavigator initialized');
            }
            
            async loadInitialFolders() {
                try {
                    console.log('üìÅ Loading initial folders...');
                    this.resetNavigation();
                    await this.loadFolder('root');
                } catch (error) {
                    console.error('‚ùå Failed to load initial folders:', error);
                    this.showErrorMessage('Failed to load folders. Please try again.');
                }
            }
            
            resetNavigation() {
                this.currentFolderId = 'root';
                this.folderHistory = [{ id: 'root', name: 'Root' }];
                this.lastAnalyzedFolder = null;
                this.updateBreadcrumbs();
                console.log('üîÑ Navigation reset to root');
            }
            
            async loadFolder(folderId) {
                try {
                    console.log(`üìÇ Loading folder: ${folderId}`);
                    this.showLoadingState();
                    
                    const folderAnalysis = await window.OrbitalApp.providers.getSmartFolderContents(folderId);
                    console.log('üìä Folder analysis result:', folderAnalysis);
                    this.lastAnalyzedFolder = folderAnalysis;
                    
                    const currentFolderName = this.folderHistory[this.folderHistory.length - 1]?.name || 'Unknown Folder';
                    folderAnalysis.folderName = currentFolderName;
                    
                    if (folderAnalysis.needsSmartPrompt) {
                        console.log('ü§î Mixed content detected - showing smart prompt');
                        window.OrbitalApp.showSmartPrompt(folderAnalysis);
                    } else if (folderAnalysis.hasImages && !folderAnalysis.hasSubfolders) {
                        console.log('üñºÔ∏è Only images found - proceeding to image loading');
                        await window.OrbitalApp.startImageLoadingPipeline();
                    } else if (folderAnalysis.hasSubfolders && !folderAnalysis.hasImages) {
                        console.log('üìÅ Only subfolders found - displaying folder list');
                        this.displayFolders(folderAnalysis.subfolders);
                    } else {
                        console.log('üì≠ Empty folder detected');
                        this.displayFolders([]);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading folder:', error);
                    this.showErrorMessage(`Error loading folder: ${error.message}`);
                }
            }
            
            showLoadingState() {
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                        <div class="spinner"></div>
                        <span>Loading folders...</span>
                    </div>
                `;
            }
            
            showErrorMessage(message) {
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <span>${message}</span>
                    </div>
                `;
            }
            
            async showSubfoldersOnly() {
                console.log('üìÅ Showing subfolders only');
                if (this.lastAnalyzedFolder && this.lastAnalyzedFolder.hasSubfolders) {
                    this.displayFolders(this.lastAnalyzedFolder.subfolders);
                } else {
                    console.error('‚ùå No subfolder data available');
                    this.showErrorMessage('No subfolder data available');
                }
            }
            
            displayFolders(folders) {
                console.log(`üìã Displaying ${folders.length} folders`);
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = '';
                
                if (folders.length === 0) {
                    folderList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                            <span>No folders found</span>
                        </div>
                    `;
                    return;
                }
                
                folders.forEach(folder => {
                    const div = document.createElement('div');
                    div.className = 'folder-item';
                    div.innerHTML = `
                        <svg class="folder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <div class="folder-info">
                            <div class="folder-name">${folder.name}</div>
                            <div class="folder-date">${new Date(folder.modifiedTime || folder.createdTime).toLocaleDateString()}</div>
                        </div>
                    `;
                    
                    div.addEventListener('click', () => {
                        this.selectFolder(folder);
                    });
                    
                    folderList.appendChild(div);
                });
            }
            
            async selectFolder(folder) {
                console.log(`üìÇ Selecting folder: ${folder.name} (${folder.id})`);
                
                this.folderHistory.push({ id: folder.id, name: folder.name });
                this.currentFolderId = folder.id;
                this.updateBreadcrumbs();
                
                await this.loadFolder(folder.id);
            }
            
            async navigateUp() {
                console.log('‚¨ÜÔ∏è Navigating up');
                if (this.folderHistory.length > 1) {
                    this.folderHistory.pop(); // Remove current folder
                    const parentFolder = this.folderHistory[this.folderHistory.length - 1];
                    this.currentFolderId = parentFolder.id;
                    this.updateBreadcrumbs();
                    await this.loadFolder(parentFolder.id);
                } else {
                    console.log('üìç Already at root level');
                }
            }
            
            async refreshCurrentFolder() {
                console.log('üîÑ Refreshing current folder');
                await this.loadFolder(this.currentFolderId);
            }
            
            updateBreadcrumbs() {
                const pathText = this.folderHistory.map(f => f.name).join(' / ');
                document.getElementById('folder-subtitle').textContent = `Current: ${pathText}`;
                console.log(`üçû Breadcrumbs: ${pathText}`);
            }
        }
        
        // Handle OAuth callback for Google Drive (V3 EXACT)
        if (window.location.search.includes('code=') || window.location.search.includes('error=')) {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (window.opener) {
                if (error) {
                    console.error('‚ùå OAuth error:', error);
                    window.opener.postMessage({ type: 'GOOGLE_AUTH_ERROR', error: error }, window.location.origin);
                } else if (code) {
                    console.log('‚úÖ OAuth success, code received');
                    window.opener.postMessage({ type: 'GOOGLE_AUTH_SUCCESS', code: code }, window.location.origin);
                }
                window.close();
            }
        }
        
        // ===== INITIALIZE APPLICATION =====
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM loaded, initializing Orbital8 Step 3...');
            window.OrbitalApp = new OrbitalApp();
        });
    </script>
</body>
</html>
