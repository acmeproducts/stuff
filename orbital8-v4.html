<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Orbital8 V14B - OneDrive Enhanced</title>
    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <style>
        :root {
            --app-accent: #0078d4;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text-primary: white;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --bg-gradient: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
        }

        * { box-sizing: border-box; }
        
        body, html {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden; background: #000;
            overscroll-behavior: none; touch-action: none;
        }
        
        .screen {
            position: fixed; inset: 0; background: var(--bg-gradient);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }
        
        .screen.hidden { display: none; }
        
        .card {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 120, 212, 0.3); border-radius: 20px;
            padding: 40px; text-align: center; max-width: 500px; width: 90%;
        }
        
        .title {
            color: var(--text-primary); font-size: 24px; font-weight: 600; margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
        
        .subtitle {
            color: var(--text-secondary); font-size: 16px; margin-bottom: 24px;
        }
        
        .input, .tag-input, .notes-textarea {
            width: 100%; padding: 12px 16px;
            border: 1px solid var(--glass-border); border-radius: 12px;
            background: var(--glass-bg); color: var(--text-primary);
            font-size: 14px; margin-bottom: 16px; backdrop-filter: blur(10px);
        }
        
        .input::placeholder, .tag-input::placeholder, .notes-textarea::placeholder { 
            color: rgba(255, 255, 255, 0.5); 
        }
        
        .input:focus, .tag-input:focus, .notes-textarea:focus {
            outline: none; border-color: var(--app-accent);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
        }
        
        .button, .folder-button, .btn {
            background: linear-gradient(45deg, var(--app-accent), #106ebe);
            border: none; border-radius: 15px; color: var(--text-primary);
            font-size: 18px; font-weight: 600; padding: 16px 32px;
            cursor: pointer; transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
        }
        
        .button:hover, .folder-button:hover, .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(0, 120, 212, 0.5);
        }
        
        .status {
            color: var(--text-secondary); font-size: 14px; margin-top: 16px;
        }
        
        .main-container {
            position: fixed; inset: 0; background: var(--bg-gradient);
            display: flex; flex-direction: column;
        }
        
        .header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 20px; background: var(--glass-bg);
            backdrop-filter: blur(20px); border-bottom: 1px solid var(--glass-border);
            z-index: 100;
        }
        
        .nav-section {
            display: flex; align-items: center; gap: 12px;
        }
        
        .nav-controls { display: flex; gap: 8px; }
        
        .nav-button {
            background: var(--glass-bg); border: 1px solid var(--glass-border);
            border-radius: 8px; color: var(--text-primary); padding: 8px 12px;
            cursor: pointer; transition: all 0.2s ease;
        }
        
        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--app-accent);
        }
        
        .nav-button:disabled {
            opacity: 0.5; cursor: not-allowed;
        }
        
        .breadcrumb {
            display: flex; align-items: center; gap: 8px;
            max-width: 300px; overflow: hidden;
        }
        
        .breadcrumb-item {
            color: var(--text-secondary); cursor: pointer;
            padding: 4px 8px; border-radius: 6px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            transition: all 0.2s ease;
        }
        
        .breadcrumb-item:hover { color: var(--text-primary); background: var(--glass-bg); }
        .breadcrumb-item.current { color: var(--app-accent); font-weight: 500; }
        
        .actions-section { display: flex; align-items: center; gap: 12px; }
        
        .logout { 
            background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5; 
        }
        
        .content-area {
            flex: 1; position: relative; overflow: hidden;
        }
        
        .image-viewer {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
        }
        
        .image-viewport {
            position: relative; width: 100%; height: 100%; overflow: hidden;
            cursor: grab; user-select: none;
        }
        
        .image-viewport.dragging { cursor: grabbing; }
        
        .center-image {
            max-width: 100%; max-height: 100%; object-fit: contain;
            transform-origin: center; transition: transform 0.3s ease;
        }
        
        .empty-state {
            text-align: center; color: var(--text-secondary); padding: 40px;
        }
        
        .empty-title { font-size: 24px; font-weight: 600; margin-bottom: 16px; color: var(--text-primary); }
        .empty-message { font-size: 16px; margin-bottom: 24px; }
        
        .edge-area {
            position: absolute; background: linear-gradient(45deg, var(--app-accent), #106ebe);
            opacity: 0; transition: opacity 0.2s ease; pointer-events: none;
        }
        
        .edge-area.active { opacity: 0.8; }
        
        .edge-top, .edge-bottom { left: 0; right: 0; height: 100px; }
        .edge-top { top: 0; }
        .edge-bottom { bottom: 0; }
        .edge-left, .edge-right { top: 0; bottom: 0; width: 100px; }
        .edge-left { left: 0; }
        .edge-right { right: 0; }
        
        .stack-pills {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 8px; z-index: 1000;
        }
        
        .pill {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            color: var(--text-primary); padding: 8px 16px; font-size: 14px; font-weight: 500;
            cursor: pointer; transition: all 0.3s ease;
        }
        
        .pill:hover, .pill.active {
            background: var(--app-accent); border-color: var(--app-accent);
            transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 120, 212, 0.4);
        }
        
        .loading-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 2000; backdrop-filter: blur(10px);
        }
        
        .loading-content {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 30px; text-align: center; max-width: 400px; width: 90%;
        }
        
        .loading-spinner {
            width: 40px; height: 40px; border: 3px solid var(--glass-border);
            border-top: 3px solid var(--app-accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .loading-message { color: var(--text-primary); font-size: 16px; margin-bottom: 16px; }
        .loading-counter { color: var(--text-secondary); font-size: 14px; margin-bottom: 16px; }
        
        .progress-bar {
            width: 100%; height: 4px; background: var(--glass-bg);
            border-radius: 2px; overflow: hidden; margin-bottom: 16px;
        }
        
        .progress-fill {
            height: 100%; background: var(--app-accent);
            transition: width 0.3s ease; width: 0%;
        }
        
        .cancel-btn {
            background: rgba(220, 38, 38, 0.2); border: 1px solid rgba(220, 38, 38, 0.3);
            color: #fca5a5; padding: 8px 16px; border-radius: 8px; cursor: pointer;
        }
        
        .modal {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8);
            display: flex; align-items: center; justify-content: center;
            z-index: 3000; backdrop-filter: blur(10px);
        }
        
        .modal.hidden { display: none; }
        
        .modal-content {
            background: var(--glass-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;
        }
        
        .modal-title {
            color: var(--text-primary); font-size: 20px; font-weight: 600; margin-bottom: 20px;
        }
        
        .modal-actions {
            display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;
        }
        
        .modal-btn {
            padding: 10px 20px; border-radius: 8px; font-weight: 500; cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .modal-btn.cancel {
            background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--text-secondary);
        }
        
        .modal-btn.confirm {
            background: var(--app-accent); border: 1px solid var(--app-accent); color: var(--text-primary);
        }
        
        .grid-container {
            display: grid; gap: 8px; padding: 20px;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            max-height: 60vh; overflow-y: auto;
        }
        
        .grid-item {
            aspect-ratio: 1; border-radius: 8px; overflow: hidden;
            position: relative; cursor: pointer; border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .grid-item:hover { transform: scale(1.05); }
        .grid-item.selected { border-color: var(--app-accent); }
        
        .grid-thumbnail {
            width: 100%; height: 100%; object-fit: cover;
        }
        
        .selection-overlay {
            position: absolute; inset: 0; background: rgba(0, 120, 212, 0.3);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s ease;
        }
        
        .grid-item.selected .selection-overlay { opacity: 1; }
        
        .checkmark {
            width: 24px; height: 24px; background: var(--app-accent);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: white; font-weight: bold;
        }
        
        .toast {
            position: fixed; top: 20px; right: 20px; background: var(--glass-bg);
            backdrop-filter: blur(20px); border: 1px solid var(--glass-border);
            border-radius: 12px; padding: 16px; color: var(--text-primary);
            z-index: 4000; transform: translateX(400px); transition: transform 0.3s ease;
        }
        
        .toast.show { transform: translateX(0); }
        
        .details-tabs {
            display: flex; border-bottom: 1px solid var(--glass-border); margin-bottom: 20px;
        }
        
        .tab-button {
            background: none; border: none; color: var(--text-secondary);
            padding: 12px 16px; cursor: pointer; border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            color: var(--app-accent); border-bottom-color: var(--app-accent);
        }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .star-rating {
            display: flex; gap: 4px; margin-bottom: 16px;
        }
        
        .star {
            width: 24px; height: 24px; cursor: pointer; color: #374151;
            transition: color 0.2s ease;
        }
        
        .star:hover, .star.active { color: #fbbf24; }
        
        .tag-container {
            display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;
        }
        
        .tag {
            background: var(--app-accent); color: var(--text-primary);
            padding: 4px 8px; border-radius: 12px; font-size: 12px;
            display: flex; align-items: center; gap: 4px;
        }
        
        .tag-remove {
            background: rgba(255, 255, 255, 0.2); border-radius: 50%;
            width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 10px;
        }
        
        .metadata-table {
            width: 100%; border-collapse: collapse;
        }
        
        .metadata-table th, .metadata-table td {
            text-align: left; padding: 8px; border-bottom: 1px solid var(--glass-border);
        }
        
        .metadata-table th {
            color: var(--text-primary); font-weight: 600;
        }
        
        .metadata-table td {
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .header { padding: 8px 16px; }
            .breadcrumb { max-width: 200px; }
            .stack-pills { bottom: 80px; }
            .grid-container { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
            .modal-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div id="auth-screen" class="screen">
        <div class="card">
            <div class="title">Orbital8 V14B</div>
            <div class="subtitle">OneDrive Enhanced Image Organizer</div>
            <button id="auth-button" class="button">Connect to OneDrive</button>
            <div id="auth-status" class="status">Ready to connect</div>
        </div>
    </div>

    <div id="folder-screen" class="screen hidden">
        <div class="card">
            <div class="title">Select Image Folder</div>
            <div class="subtitle">Choose a folder containing your images</div>
            <div id="folder-list"></div>
            <div id="folder-status" class="status">Loading folders...</div>
        </div>
    </div>

    <div id="main-container" class="main-container hidden">
        <div class="header">
            <div class="nav-section">
                <div class="nav-controls">
                    <button id="back-button" class="nav-button">←</button>
                    <button id="up-button" class="nav-button">↑</button>
                </div>
                <div class="breadcrumb" id="breadcrumb"></div>
            </div>
            <div class="actions-section">
                <button id="grid-view-btn" class="nav-button">Grid</button>
                <button id="details-button" class="nav-button">Details</button>
                <button id="logout" class="nav-button logout">Logout</button>
            </div>
        </div>
        
        <div class="content-area">
            <div class="image-viewer">
                <div id="image-viewport" class="image-viewport">
                    <img id="center-image" class="center-image" alt="Current image">
                </div>
                
                <div id="empty-state" class="empty-state hidden">
                    <div class="empty-title">No Images Found</div>
                    <div class="empty-message">This folder doesn't contain any supported images.</div>
                    <button id="select-another-folder-btn" class="button">Choose Another Folder</button>
                </div>
            </div>
        </div>
        
        <div class="edge-area edge-top" id="edge-top"></div>
        <div class="edge-area edge-bottom" id="edge-bottom"></div>
        <div class="edge-area edge-left" id="edge-left"></div>
        <div class="edge-area edge-right" id="edge-right"></div>
        
        <div class="stack-pills">
            <div class="pill" id="pill-priority" data-stack="priority">Priority</div>
            <div class="pill" id="pill-in" data-stack="in">In</div>
            <div class="pill" id="pill-out" data-stack="out">Out</div>
            <div class="pill" id="pill-trash" data-stack="trash">Trash</div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div id="loading-message" class="loading-message">Loading images...</div>
            <div id="loading-counter" class="loading-counter">0 of 0</div>
            <div class="progress-bar">
                <div id="loading-progress-bar" class="progress-fill"></div>
            </div>
            <button id="cancel-loading" class="cancel-btn">Cancel</button>
        </div>
    </div>

    <div id="action-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="action-title" class="modal-title">Action</h3>
            <div id="action-content"></div>
            <div class="modal-actions">
                <button id="action-cancel" class="modal-btn cancel">Cancel</button>
                <button id="action-confirm" class="modal-btn confirm">Confirm</button>
            </div>
        </div>
    </div>

    <div id="grid-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="grid-title" class="modal-title">Grid View</h3>
            <div class="modal-actions">
                <button id="select-all-btn" class="modal-btn">Select All</button>
                <button id="deselect-all-btn" class="modal-btn">Deselect All</button>
                <div id="selection-text" style="color: var(--text-secondary); margin: 0 auto;">0 selected</div>
                <button id="close-grid" class="modal-btn cancel">Close</button>
            </div>
            <div id="grid-container" class="grid-container"></div>
        </div>
    </div>

    <div id="details-modal" class="modal hidden">
        <div class="modal-content">
            <h3 class="modal-title">Image Details</h3>
            <div class="details-tabs">
                <button class="tab-button active" data-tab="annotations">Annotations</button>
                <button class="tab-button" data-tab="metadata">Metadata</button>
            </div>
            
            <div id="tab-annotations" class="tab-content active">
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; display: block;">Tags:</label>
                    <input type="text" id="tag-input" class="tag-input" placeholder="Enter tags separated by commas">
                    <div id="tag-container" class="tag-container"></div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <label style="font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px; display: block;">Notes:</label>
                    <textarea id="notes-textarea" class="notes-textarea" rows="4" placeholder="Add your notes here..."></textarea>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;">Quality Rating:</div>
                    <div class="star-rating" id="quality-rating">
                        <svg class="star" data-rating="1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 14px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;">Content Rating:</div>
                    <div class="star-rating" id="content-rating">
                        <svg class="star" data-rating="1" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="2" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="3" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="4" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        <svg class="star" data-rating="5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                    </div>
                </div>
            </div>
            
            <div id="tab-metadata" class="tab-content">
                <table class="metadata-table" id="metadata-table"></table>
            </div>
            
            <div class="modal-actions">
                <button id="close-details" class="modal-btn cancel">Close</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">
        <div id="toast-message"></div>
    </div>

    <script>
        // ===== ORBITAL8 V14B - REFACTORED VERSION =====
        
        const STACK_TYPES = ['in', 'out', 'priority', 'trash'];
        const STACK_NAMES = { 'in': 'In', 'out': 'Out', 'priority': 'Priority', 'trash': 'Trash' };
        const CACHE_DURATION = 60 * 60 * 1000;
        
        const utils = {
            elements: {},
            
            init() {
                this.elements = {
                    authScreen: document.getElementById('auth-screen'),
                    folderScreen: document.getElementById('folder-screen'),
                    mainContainer: document.getElementById('main-container'),
                    authButton: document.getElementById('auth-button'),
                    authStatus: document.getElementById('auth-status'),
                    folderList: document.getElementById('folder-list'),
                    folderStatus: document.getElementById('folder-status'),
                    breadcrumb: document.getElementById('breadcrumb'),
                    backButton: document.getElementById('back-button'),
                    upButton: document.getElementById('up-button'),
                    gridViewBtn: document.getElementById('grid-view-btn'),
                    logout: document.getElementById('logout'),
                    detailsButton: document.getElementById('details-button'),
                    imageViewport: document.getElementById('image-viewport'),
                    centerImage: document.getElementById('center-image'),
                    emptyState: document.getElementById('empty-state'),
                    selectAnotherFolderBtn: document.getElementById('select-another-folder-btn'),
                    toast: document.getElementById('toast'),
                    toastMessage: document.getElementById('toast-message'),
                    loadingOverlay: document.getElementById('loading-overlay'),
                    loadingCounter: document.getElementById('loading-counter'),
                    loadingMessage: document.getElementById('loading-message'),
                    loadingProgressBar: document.getElementById('loading-progress-bar'),
                    cancelLoading: document.getElementById('cancel-loading'),
                    edgeTop: document.getElementById('edge-top'),
                    edgeBottom: document.getElementById('edge-bottom'),
                    edgeLeft: document.getElementById('edge-left'),
                    edgeRight: document.getElementById('edge-right'),
                    pillPriority: document.getElementById('pill-priority'),
                    pillTrash: document.getElementById('pill-trash'),
                    pillIn: document.getElementById('pill-in'),
                    pillOut: document.getElementById('pill-out'),
                    actionModal: document.getElementById('action-modal'),
                    actionTitle: document.getElementById('action-title'),
                    actionContent: document.getElementById('action-content'),
                    actionCancel: document.getElementById('action-cancel'),
                    actionConfirm: document.getElementById('action-confirm'),
                    gridModal: document.getElementById('grid-modal'),
                    gridTitle: document.getElementById('grid-title'),
                    gridContainer: document.getElementById('grid-container'),
                    selectAllBtn: document.getElementById('select-all-btn'),
                    deselectAllBtn: document.getElementById('deselect-all-btn'),
                    selectionText: document.getElementById('selection-text'),
                    closeGrid: document.getElementById('close-grid'),
                    detailsModal: document.getElementById('details-modal'),
                    closeDetails: document.getElementById('close-details'),
                    tagInput: document.getElementById('tag-input'),
                    tagContainer: document.getElementById('tag-container'),
                    notesTextarea: document.getElementById('notes-textarea'),
                    qualityRating: document.getElementById('quality-rating'),
                    contentRating: document.getElementById('content-rating'),
                    metadataTable: document.getElementById('metadata-table')
                };
            },
            
            showScreen(screenName) {
                ['auth-screen', 'folder-screen', 'main-container'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
                document.getElementById(screenName).classList.remove('hidden');
            },
            
            showToast(message, duration = 3000) {
                this.elements.toastMessage.textContent = message;
                this.elements.toast.classList.add('show');
                setTimeout(() => this.elements.toast.classList.remove('show'), duration);
            }
        };

        class ModalManager {
            constructor() {
                this.currentType = null;
                this.currentOptions = null;
            }
            
            show(type, options = {}) {
                this.currentType = type;
                this.currentOptions = options;
                
                switch (type) {
                    case 'move':
                        this.setupMoveAction(options);
                        break;
                    case 'tag':
                        this.setupTagAction(options);
                        break;
                    case 'delete':
                        this.setupDeleteAction(options);
                        break;
                }
                
                utils.elements.actionModal.classList.remove('hidden');
            }
            
            hide() {
                utils.elements.actionModal.classList.add('hidden');
                this.currentType = null;
                this.currentOptions = null;
            }
            
            setupMoveAction(options) {
                utils.elements.actionTitle.textContent = 'Move to Stack';
                utils.elements.actionContent.innerHTML = `
                    <select id="stack-select" style="width: 100%; padding: 8px; border-radius: 4px; background: var(--glass-bg); color: var(--text-primary); border: 1px solid var(--glass-border);">
                        ${STACK_TYPES.map(stack => 
                            `<option value="${stack}" ${stack === options.currentStack ? 'selected' : ''}>${STACK_NAMES[stack]}</option>`
                        ).join('')}
                    </select>
                `;
                utils.elements.actionConfirm.textContent = 'Move';
            }
            
            setupTagAction(options) {
                utils.elements.actionTitle.textContent = 'Add Tags';
                utils.elements.actionContent.innerHTML = `
                    <input type="text" id="modal-tag-input" placeholder="Enter tags separated by commas" 
                           style="width: 100%; padding: 8px; border-radius: 4px; background: var(--glass-bg); color: var(--text-primary); border: 1px solid var(--glass-border);">
                `;
                utils.elements.actionConfirm.textContent = 'Add Tags';
            }
            
            setupDeleteAction(options) {
                utils.elements.actionTitle.textContent = 'Confirm Delete';
                utils.elements.actionContent.innerHTML = `
                    <p style="color: var(--text-secondary);">Are you sure you want to delete ${options.count || 1} image(s)?</p>
                `;
                utils.elements.actionConfirm.textContent = 'Delete';
                utils.elements.actionConfirm.style.background = 'rgba(220, 38, 38, 0.8)';
            }
        }

        class EnhancedFileCache {
            constructor() {
                this.db = null;
            }
            
            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('Orbital8Cache', 3);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve();
                    };
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('files')) {
                            db.createObjectStore('files', { keyPath: 'folderId' });
                        }
                        if (!db.objectStoreNames.contains('metadata')) {
                            db.createObjectStore('metadata', { keyPath: 'id' });
                        }
                        if (!db.objectStoreNames.contains('userdata')) {
                            db.createObjectStore('userdata', { keyPath: 'id' });
                        }
                    };
                });
            }
            
            async get(store, key) {
                if (!this.db) return null;
                try {
                    const transaction = this.db.transaction([store], 'readonly');
                    const objectStore = transaction.objectStore(store);
                    const request = objectStore.get(key);
                    return new Promise((resolve) => {
                        request.onsuccess = () => resolve(request.result);
                        request.onerror = () => resolve(null);
                    });
                } catch { return null; }
            }
            
            async set(store, data) {
                if (!this.db) return;
                try {
                    const transaction = this.db.transaction([store], 'readwrite');
                    const objectStore = transaction.objectStore(store);
                    objectStore.put(data);
                } catch {}
            }
            
            isCacheValid(time) {
                return (Date.now() - time) < CACHE_DURATION;
            }
        }

        class OneDriveProvider {
            constructor() {
                this.msalInstance = new msal.PublicClientApplication({
                    auth: {
                        clientId: '478cc089-89e2-4728-a7a6-9d85b17f6cb7',
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: window.location.origin
                    },
                    cache: { cacheLocation: 'localStorage', storeAuthStateInCookie: false }
                });
                this.accessToken = null;
                this.breadcrumb = [];
                this.currentFolder = { id: null, name: 'OneDrive' };
            }
            
            async authenticate() {
                try {
                    const loginRequest = {
                        scopes: ['https://graph.microsoft.com/Files.ReadWrite.All'],
                        prompt: 'select_account'
                    };
                    
                    const response = await this.msalInstance.loginPopup(loginRequest);
                    this.accessToken = response.accessToken;
                    return true;
                } catch (error) {
                    throw new Error('Authentication failed');
                }
            }
            
            async makeApiCall(endpoint, options = {}) {
                if (!this.accessToken) throw new Error('Not authenticated');
                
                const response = await fetch(`https://graph.microsoft.com/v1.0${endpoint}`, {
                    ...options,
                    headers: {
                        'Authorization': `Bearer ${this.accessToken}`,
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                if (!response.ok) throw new Error(`API call failed: ${response.status}`);
                return response.json();
            }
            
            async getInitialFolders() {
                const data = await this.makeApiCall('/me/drive/root/children?$filter=folder ne null&$select=id,name,folder');
                return data.value || [];
            }
            
            async drillIntoFolder(folder) {
                this.breadcrumb.push({ ...this.currentFolder });
                this.currentFolder = { id: folder.id, name: folder.name };
                this.updateBreadcrumb();
                return await this.getFolderContents(folder.id);
            }
            
            async navigateUp() {
                if (this.breadcrumb.length > 0) {
                    this.currentFolder = this.breadcrumb.pop();
                    this.updateBreadcrumb();
                    return await this.getFolderContents(this.currentFolder.id);
                }
                return [];
            }
            
            async getFolderContents(folderId) {
                const endpoint = folderId ? 
                    `/me/drive/items/${folderId}/children` : 
                    '/me/drive/root/children';
                const data = await this.makeApiCall(endpoint);
                return data.value || [];
            }
            
            updateBreadcrumb() {
                const nav = utils.elements.breadcrumb;
                nav.innerHTML = '';
                
                const fullPath = [...this.breadcrumb, this.currentFolder];
                fullPath.forEach((item, index) => {
                    const breadcrumbItem = document.createElement('div');
                    breadcrumbItem.className = `breadcrumb-item ${index === fullPath.length - 1 ? 'current' : ''}`;
                    breadcrumbItem.textContent = item.name;
                    
                    if (index < fullPath.length - 1) {
                        breadcrumbItem.addEventListener('click', () => {
                            this.breadcrumb = this.breadcrumb.slice(0, index);
                            this.currentFolder = item;
                            this.updateBreadcrumb();
                            app.loadFolderImages(item.id);
                        });
                    }
                    
                    nav.appendChild(breadcrumbItem);
                });
            }
        }

        class UserMetadataManager {
            constructor(provider) {
                this.provider = provider;
                this.cache = new Map();
                this.cacheTimestamp = 0;
            }
            
            async loadMetadata() {
                if (Date.now() - this.cacheTimestamp < CACHE_DURATION && this.cache.size > 0) {
                    return;
                }
                
                try {
                    const response = await this.provider.makeApiCall('/me/drive/special/approot:/tags.json:/content');
                    const data = JSON.parse(response);
                    
                    this.cache.clear();
                    Object.entries(data.files || {}).forEach(([id, metadata]) => {
                        this.cache.set(id, metadata);
                    });
                    this.cacheTimestamp = Date.now();
                } catch {}
            }
            
            async saveMetadata() {
                try {
                    const data = {
                        version: 1,
                        lastModified: new Date().toISOString(),
                        files: Object.fromEntries(this.cache)
                    };
                    
                    await this.provider.makeApiCall('/me/drive/special/approot:/tags.json:/content', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data, null, 2)
                    });
                    
                    this.cacheTimestamp = Date.now();
                } catch {}
            }
            
            getUserMetadata(fileId) {
                return this.cache.get(fileId) || {
                    stack: 'in', tags: [], qualityRating: 0, contentRating: 0, notes: ''
                };
            }
            
            async setUserMetadata(fileId, metadata) {
                const updated = { ...metadata, lastUpdated: new Date().toISOString() };
                this.cache.set(fileId, updated);
                await this.saveMetadata();
                return updated;
            }
            
            async updateUserMetadata(fileId, updates) {
                const current = this.getUserMetadata(fileId);
                const updated = { ...current, ...updates };
                return await this.setUserMetadata(fileId, updated);
            }
        }

        const appState = {
            cloudStorage: null,
            userMetadataManager: null,
            fileCache: null,
            modalManager: null,
            currentFolder: { id: null, name: '' },
            imageFiles: [],
            currentImageIndex: 0,
            currentStack: 'in',
            stacks: { in: [], out: [], priority: [], trash: [] },
            isDragging: false,
            currentScale: 1,
            maxScale: 4,
            minScale: 0.3,
            panOffset: { x: 0, y: 0 },
            grid: { stack: null, selected: [] },
            tags: new Set(),
            imageCache: new Map(),
            loadingProgress: { current: 0, total: 0 },
            isProcessing: false,
            abortController: null
        };

        const app = {
            async init() {
                utils.init();
                appState.fileCache = new EnhancedFileCache();
                appState.modalManager = new ModalManager();
                await appState.fileCache.init();
                this.setupEventListeners();
                utils.showScreen('auth-screen');
            },
            
            setupEventListeners() {
                utils.elements.authButton.addEventListener('click', () => this.authenticate());
                utils.elements.logout.addEventListener('click', () => this.logout());
                utils.elements.backButton.addEventListener('click', () => this.navigateBack());
                utils.elements.upButton.addEventListener('click', () => this.navigateUp());
                utils.elements.selectAnotherFolderBtn.addEventListener('click', () => this.showFolderSelection());
                utils.elements.gridViewBtn.addEventListener('click', () => this.showGridView());
                utils.elements.detailsButton.addEventListener('click', () => this.showDetailsModal());
                utils.elements.cancelLoading.addEventListener('click', () => this.cancelLoading());
                
                utils.elements.actionCancel.addEventListener('click', () => appState.modalManager.hide());
                utils.elements.actionConfirm.addEventListener('click', () => this.handleModalConfirm());
                utils.elements.closeGrid.addEventListener('click', () => this.hideGridView());
                utils.elements.closeDetails.addEventListener('click', () => this.hideDetailsModal());
                
                STACK_TYPES.forEach(stack => {
                    const pill = document.querySelector(`[data-stack="${stack}"]`);
                    if (pill) {
                        pill.addEventListener('click', () => this.switchStack(stack));
                    }
                });
                
                this.setupImageViewerEvents();
                this.setupDetailsModalEvents();
            },
            
            setupImageViewerEvents() {
                const viewport = utils.elements.imageViewport;
                const image = utils.elements.centerImage;
                
                viewport.addEventListener('wheel', (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? 0.9 : 1.1;
                    appState.currentScale = Math.min(Math.max(appState.currentScale * delta, appState.minScale), appState.maxScale);
                    image.style.transform = `scale(${appState.currentScale}) translate(${appState.panOffset.x}px, ${appState.panOffset.y}px)`;
                });
                
                let startX, startY;
                viewport.addEventListener('mousedown', (e) => {
                    if (e.button === 0) {
                        appState.isDragging = true;
                        startX = e.clientX - appState.panOffset.x;
                        startY = e.clientY - appState.panOffset.y;
                        viewport.classList.add('dragging');
                    }
                });
                
                viewport.addEventListener('mousemove', (e) => {
                    if (appState.isDragging) {
                        appState.panOffset.x = e.clientX - startX;
                        appState.panOffset.y = e.clientY - startY;
                        image.style.transform = `scale(${appState.currentScale}) translate(${appState.panOffset.x}px, ${appState.panOffset.y}px)`;
                    }
                });
                
                viewport.addEventListener('mouseup', () => {
                    appState.isDragging = false;
                    viewport.classList.remove('dragging');
                });
                
                document.addEventListener('keydown', (e) => {
                    if (utils.elements.actionModal.classList.contains('hidden') && 
                        utils.elements.gridModal.classList.contains('hidden') &&
                        utils.elements.detailsModal.classList.contains('hidden')) {
                        
                        switch (e.key) {
                            case 'ArrowLeft':
                                this.previousImage();
                                break;
                            case 'ArrowRight':
                                this.nextImage();
                                break;
                            case '1':
                                this.moveCurrentImageToStack('priority');
                                break;
                            case '2':
                                this.moveCurrentImageToStack('in');
                                break;
                            case '3':
                                this.moveCurrentImageToStack('out');
                                break;
                            case '4':
                                this.moveCurrentImageToStack('trash');
                                break;
                        }
                    }
                });
            },
            
            setupDetailsModalEvents() {
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', () => {
                        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        button.classList.add('active');
                        document.getElementById(`tab-${button.dataset.tab}`).classList.add('active');
                    });
                });
                
                utils.elements.tagInput.addEventListener('keypress', async (e) => {
                    if (e.key === 'Enter') {
                        await this.addTags();
                    }
                });
                
                [utils.elements.qualityRating, utils.elements.contentRating].forEach(rating => {
                    rating.addEventListener('click', async (e) => {
                        if (e.target.classList.contains('star')) {
                            const value = parseInt(e.target.dataset.rating);
                            const type = rating.id.includes('quality') ? 'qualityRating' : 'contentRating';
                            await this.updateRating(type, value);
                        }
                    });
                });
                
                utils.elements.notesTextarea.addEventListener('blur', () => this.saveNotes());
            },
            
            async authenticate() {
                try {
                    utils.elements.authStatus.textContent = 'Connecting...';
                    appState.cloudStorage = new OneDriveProvider();
                    await appState.cloudStorage.authenticate();
                    appState.userMetadataManager = new UserMetadataManager(appState.cloudStorage);
                    await appState.userMetadataManager.loadMetadata();
                    this.showFolderSelection();
                } catch (error) {
                    utils.elements.authStatus.textContent = 'Connection failed. Please try again.';
                    utils.showToast('Authentication failed');
                }
            },
            
            async showFolderSelection() {
                utils.showScreen('folder-screen');
                utils.elements.folderStatus.textContent = 'Loading folders...';
                
                try {
                    const folders = await appState.cloudStorage.getInitialFolders();
                    this.renderFolderList(folders);
                    utils.elements.folderStatus.textContent = `Found ${folders.length} folders`;
                } catch (error) {
                    utils.elements.folderStatus.textContent = 'Failed to load folders';
                }
            },
            
            renderFolderList(folders) {
                utils.elements.folderList.innerHTML = '';
                folders.forEach(folder => {
                    const folderElement = document.createElement('button');
                    folderElement.className = 'folder-button';
                    folderElement.textContent = folder.name;
                    folderElement.style.cssText = 'width: 100%; margin-bottom: 8px;';
                    folderElement.addEventListener('click', () => this.selectFolder(folder));
                    utils.elements.folderList.appendChild(folderElement);
                });
            },
            
            async selectFolder(folder) {
                appState.currentFolder = folder;
                appState.cloudStorage.currentFolder = { id: folder.id, name: folder.name };
                appState.cloudStorage.breadcrumb = [];
                appState.cloudStorage.updateBreadcrumb();
                utils.showScreen('main-container');
                await this.loadFolderImages(folder.id);
            },
            
            async loadFolderImages(folderId) {
                this.showLoading('Loading images...', 0, 0);
                
                try {
                    const files = await appState.cloudStorage.getFolderContents(folderId);
                    const imageFiles = files.filter(file => 
                        file.file && /\.(jpg|jpeg|png|gif|bmp|webp)$/i.test(file.name)
                    );
                    
                    if (imageFiles.length === 0) {
                        this.hideLoading();
                        this.showEmptyState();
                        return;
                    }
                    
                    await appState.userMetadataManager.loadMetadata();
                    
                    appState.imageFiles = imageFiles.map(file => ({
                        ...file,
                        userMetadata: appState.userMetadataManager.getUserMetadata(file.id)
                    }));
                    
                    this.organizeImagesIntoStacks();
                    this.hideLoading();
                    this.hideEmptyState();
                    this.switchStack('in');
                    
                } catch (error) {
                    this.hideLoading();
                    utils.showToast('Failed to load images');
                }
            },
            
            organizeImagesIntoStacks() {
                appState.stacks = { in: [], out: [], priority: [], trash: [] };
                
                appState.imageFiles.forEach(file => {
                    const stack = file.userMetadata.stack || 'in';
                    if (appState.stacks[stack]) {
                        appState.stacks[stack].push(file);
                    }
                });
                
                this.updateStackPills();
            },
            
            updateStackPills() {
                STACK_TYPES.forEach(stack => {
                    const pill = document.querySelector(`[data-stack="${stack}"]`);
                    if (pill) {
                        const count = appState.stacks[stack].length;
                        pill.textContent = `${STACK_NAMES[stack]} (${count})`;
                    }
                });
            },
            
            switchStack(stack) {
                appState.currentStack = stack;
                appState.currentImageIndex = 0;
                
                document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
                document.querySelector(`[data-stack="${stack}"]`).classList.add('active');
                
                if (appState.stacks[stack].length > 0) {
                    this.showImage(0);
                } else {
                    this.showEmptyState();
                }
            },
            
            showImage(index) {
                const currentStack = appState.stacks[appState.currentStack];
                if (index >= 0 && index < currentStack.length) {
                    appState.currentImageIndex = index;
                    const file = currentStack[index];
                    
                    if (file['@microsoft.graph.downloadUrl']) {
                        utils.elements.centerImage.src = file['@microsoft.graph.downloadUrl'];
                        this.resetImageTransform();
                    }
                }
            },
            
            resetImageTransform() {
                appState.currentScale = 1;
                appState.panOffset = { x: 0, y: 0 };
                utils.elements.centerImage.style.transform = 'scale(1) translate(0px, 0px)';
            },
            
            nextImage() {
                const currentStack = appState.stacks[appState.currentStack];
                if (appState.currentImageIndex < currentStack.length - 1) {
                    this.showImage(appState.currentImageIndex + 1);
                }
            },
            
            previousImage() {
                if (appState.currentImageIndex > 0) {
                    this.showImage(appState.currentImageIndex - 1);
                }
            },
            
            async moveCurrentImageToStack(newStack) {
                const currentStack = appState.stacks[appState.currentStack];
                if (currentStack.length === 0) return;
                
                const file = currentStack[appState.currentImageIndex];
                await appState.userMetadataManager.updateUserMetadata(file.id, { stack: newStack });
                
                currentStack.splice(appState.currentImageIndex, 1);
                appState.stacks[newStack].push({ ...file, userMetadata: { ...file.userMetadata, stack: newStack } });
                
                this.updateStackPills();
                
                if (currentStack.length === 0) {
                    this.showEmptyState();
                } else {
                    if (appState.currentImageIndex >= currentStack.length) {
                        appState.currentImageIndex = currentStack.length - 1;
                    }
                    this.showImage(appState.currentImageIndex);
                }
                
                utils.showToast(`Moved to ${STACK_NAMES[newStack]}`);
            },
            
            showGridView() {
                const currentStack = appState.stacks[appState.currentStack];
                utils.elements.gridTitle.textContent = `${STACK_NAMES[appState.currentStack]} (${currentStack.length})`;
                
                utils.elements.gridContainer.innerHTML = '';
                currentStack.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'grid-item';
                    item.innerHTML = `
                        <img class="grid-thumbnail" src="${file['@microsoft.graph.downloadUrl']}" alt="${file.name}">
                        <div class="selection-overlay">
                            <div class="checkmark">✓</div>
                        </div>
                    `;
                    
                    item.addEventListener('click', () => {
                        item.classList.toggle('selected');
                        this.updateSelectionText();
                    });
                    
                    utils.elements.gridContainer.appendChild(item);
                });
                
                appState.grid.selected = [];
                this.updateSelectionText();
                utils.elements.gridModal.classList.remove('hidden');
            },
            
            hideGridView() {
                utils.elements.gridModal.classList.add('hidden');
            },
            
            updateSelectionText() {
                const selected = document.querySelectorAll('.grid-item.selected');
                utils.elements.selectionText.textContent = `${selected.length} selected`;
            },
            
            showDetailsModal() {
                const currentStack = appState.stacks[appState.currentStack];
                if (currentStack.length === 0) return;
                
                const file = currentStack[appState.currentImageIndex];
                this.populateDetailsModal(file);
                utils.elements.detailsModal.classList.remove('hidden');
            },
            
            hideDetailsModal() {
                utils.elements.detailsModal.classList.add('hidden');
            },
            
            populateDetailsModal(file) {
                const metadata = file.userMetadata;
                
                utils.elements.tagInput.value = '';
                this.renderTags(metadata.tags || []);
                utils.elements.notesTextarea.value = metadata.notes || '';
                
                this.updateStarRating(utils.elements.qualityRating, metadata.qualityRating || 0);
                this.updateStarRating(utils.elements.contentRating, metadata.contentRating || 0);
                
                this.populateMetadataTable(file);
            },
            
            renderTags(tags) {
                utils.elements.tagContainer.innerHTML = '';
                tags.forEach(tag => {
                    const tagElement = document.createElement('div');
                    tagElement.className = 'tag';
                    tagElement.innerHTML = `
                        ${tag}
                        <div class="tag-remove" data-tag="${tag}">×</div>
                    `;
                    
                    tagElement.querySelector('.tag-remove').addEventListener('click', () => this.removeTag(tag));
                    utils.elements.tagContainer.appendChild(tagElement);
                });
            },
            
            updateStarRating(container, rating) {
                const stars = container.querySelectorAll('.star');
                stars.forEach((star, index) => {
                    star.classList.toggle('active', index < rating);
                });
            },
            
            populateMetadataTable(file) {
                const table = utils.elements.metadataTable;
                table.innerHTML = '';
                
                const metadata = [
                    ['Name', file.name],
                    ['Size', this.formatFileSize(file.size)],
                    ['Modified', new Date(file.lastModifiedDateTime).toLocaleString()],
                    ['Type', file.file?.mimeType || 'Unknown']
                ];
                
                metadata.forEach(([key, value]) => {
                    const row = table.insertRow();
                    row.insertCell(0).textContent = key;
                    row.insertCell(1).textContent = value;
                });
            },
            
            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            },
            
            async addTags() {
                const input = utils.elements.tagInput;
                const newTags = input.value.split(',').map(tag => tag.trim()).filter(tag => tag);
                
                if (newTags.length > 0) {
                    const currentStack = appState.stacks[appState.currentStack];
                    const file = currentStack[appState.currentImageIndex];
                    const currentTags = file.userMetadata.tags || [];
                    const updatedTags = [...new Set([...currentTags, ...newTags])];
                    
                    await appState.userMetadataManager.updateUserMetadata(file.id, { tags: updatedTags });
                    file.userMetadata.tags = updatedTags;
                    
                    this.renderTags(updatedTags);
                    input.value = '';
                    utils.showToast('Tags added');
                }
            },
            
            async removeTag(tagToRemove) {
                const currentStack = appState.stacks[appState.currentStack];
                const file = currentStack[appState.currentImageIndex];
                const updatedTags = (file.userMetadata.tags || []).filter(tag => tag !== tagToRemove);
                
                await appState.userMetadataManager.updateUserMetadata(file.id, { tags: updatedTags });
                file.userMetadata.tags = updatedTags;
                
                this.renderTags(updatedTags);
                utils.showToast('Tag removed');
            },
            
            async updateRating(type, value) {
                const currentStack = appState.stacks[appState.currentStack];
                const file = currentStack[appState.currentImageIndex];
                
                await appState.userMetadataManager.updateUserMetadata(file.id, { [type]: value });
                file.userMetadata[type] = value;
                
                const container = type === 'qualityRating' ? utils.elements.qualityRating : utils.elements.contentRating;
                this.updateStarRating(container, value);
                
                utils.showToast(`${type === 'qualityRating' ? 'Quality' : 'Content'} rating updated`);
            },
            
            async saveNotes() {
                const currentStack = appState.stacks[appState.currentStack];
                if (currentStack.length === 0) return;
                
                const file = currentStack[appState.currentImageIndex];
                const notes = utils.elements.notesTextarea.value;
                
                await appState.userMetadataManager.updateUserMetadata(file.id, { notes });
                file.userMetadata.notes = notes;
                
                utils.showToast('Notes saved');
            },
            
            handleModalConfirm() {
                const type = appState.modalManager.currentType;
                
                switch (type) {
                    case 'move':
                        const newStack = document.getElementById('stack-select').value;
                        this.moveCurrentImageToStack(newStack);
                        break;
                    case 'tag':
                        const tags = document.getElementById('modal-tag-input').value;
                        utils.elements.tagInput.value = tags;
                        this.addTags();
                        break;
                    case 'delete':
                        this.deleteCurrentImage();
                        break;
                }
                
                appState.modalManager.hide();
            },
            
            navigateBack() {
                if (appState.cloudStorage.breadcrumb.length > 0) {
                    appState.cloudStorage.navigateUp().then(files => {
                        this.loadFolderImages(appState.cloudStorage.currentFolder.id);
                    });
                } else {
                    this.showFolderSelection();
                }
            },
            
            navigateUp() {
                this.navigateBack();
            },
            
            showLoading(message, current, total) {
                utils.elements.loadingMessage.textContent = message;
                utils.elements.loadingCounter.textContent = total > 0 ? 
                    `${current} of ${total}` : `${current}`;
                
                if (total > 0) {
                    const percentage = (current / total) * 100;
                    utils.elements.loadingProgressBar.style.width = `${percentage}%`;
                }
                
                utils.elements.loadingOverlay.classList.remove('hidden');
            },
            
            hideLoading() {
                utils.elements.loadingOverlay.classList.add('hidden');
            },
            
            showEmptyState() {
                utils.elements.emptyState.classList.remove('hidden');
                utils.elements.centerImage.style.display = 'none';
            },
            
            hideEmptyState() {
                utils.elements.emptyState.classList.add('hidden');
                utils.elements.centerImage.style.display = 'block';
            },
            
            cancelLoading() {
                if (appState.abortController) {
                    appState.abortController.abort();
                }
                this.hideLoading();
            },
            
            logout() {
                appState.cloudStorage = null;
                appState.userMetadataManager = null;
                appState.imageFiles = [];
                appState.stacks = { in: [], out: [], priority: [], trash: [] };
                utils.showScreen('auth-screen');
                utils.elements.authStatus.textContent = 'Ready to connect';
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
