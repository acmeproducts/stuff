<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orbital8 Step 2: Fixed Navigation</title>
    <style>
        :root {
            --app-accent: #f59e0b;
            --bg-dark: #1a1a1a;
            --bg-card: rgba(255, 255, 255, 0.1);
            --text-light: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.6);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f0f0f 0%, var(--bg-dark) 100%);
            color: var(--text-light);
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-screen, .folder-screen, .loading-screen {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .auth-card, .folder-card, .loading-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .hidden {
            display: none !important;
        }

        .auth-title, .folder-title, .loading-title {
            color: white;
            font-size: 32px;
            font-weight: 600;
            margin-bottom: 16px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }

        .auth-subtitle, .folder-subtitle {
            color: var(--text-muted);
            font-size: 16px;
            margin-bottom: 24px;
        }

        .auth-button, .folder-button {
            background: linear-gradient(45deg, var(--app-accent), #d97706);
            border: none;
            border-radius: 15px;
            color: white;
            font-size: 18px;
            font-weight: 600;
            padding: 16px 32px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
            width: 100%;
            margin-bottom: 16px;
        }

        .auth-button:hover, .folder-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.6);
        }

        .folder-button.danger {
            background: linear-gradient(45deg, #ef4444, #dc2626);
            box-shadow: 0 4px 20px rgba(239, 68, 68, 0.4);
        }

        .folder-button.danger:hover {
            box-shadow: 0 6px 25px rgba(239, 68, 68, 0.6);
        }

        .auth-status {
            padding: 12px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            font-weight: 500;
        }

        .auth-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .auth-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .auth-status.info {
            background: rgba(245, 158, 11, 0.2);
            color: var(--app-accent);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .folder-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.2);
        }

        .folder-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid rgba(245, 158, 11, 0.1);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .folder-item:hover {
            background: rgba(245, 158, 11, 0.1);
            border-left: 3px solid var(--app-accent);
            padding-left: 17px;
        }

        .folder-item:last-child {
            border-bottom: none;
        }

        .folder-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            color: var(--app-accent);
        }

        .folder-info {
            flex: 1;
            text-align: left;
        }

        .folder-name {
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text-light);
        }

        .folder-date {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .folder-navigation {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .folder-navigation .folder-button {
            flex: 1;
            margin: 0;
        }

        .breadcrumb {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .smart-prompt {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .smart-prompt-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .smart-prompt-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--app-accent);
        }

        .smart-prompt-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .smart-option-btn {
            flex: 1;
            padding: 20px;
            background: linear-gradient(45deg, var(--app-accent), #d97706);
            color: white;
            border: none;
            border-radius: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
        }

        .smart-option-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }

        .smart-cancel-btn {
            padding: 15px 30px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .smart-cancel-btn:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(245, 158, 11, 0.3);
            border-radius: 50%;
            border-top-color: var(--app-accent);
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-message {
            margin-top: 20px;
            color: var(--text-muted);
            font-size: 16px;
        }

        .loading-counter {
            font-size: 48px;
            font-weight: 700;
            color: var(--app-accent);
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Authentication Screen -->
        <div class="auth-screen" id="auth-screen">
            <div class="auth-card">
                <h1 class="auth-title">Orbital8</h1>
                <p class="auth-subtitle">Connect your cloud storage to browse images</p>
                
                <div id="google-auth-section">
                    <button class="auth-button" id="google-auth-btn">Connect Google Drive</button>
                </div>
                
                <div id="onedrive-auth-section">
                    <button class="auth-button" id="onedrive-auth-btn">Connect OneDrive</button>
                </div>
                
                <div id="auth-status" class="auth-status info">
                    Choose a cloud storage provider to continue
                </div>
            </div>
        </div>

        <!-- Folder Selection Screen -->
        <div class="folder-screen hidden" id="folder-screen">
            <div class="folder-card">
                <h2 class="folder-title">Select a Folder</h2>
                <div class="folder-subtitle" id="folder-subtitle">
                    Choose a folder to browse your images
                </div>
                <div class="breadcrumb" id="breadcrumb">
                    Root
                </div>
                <div class="folder-list" id="folder-list">
                    <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                        <div class="spinner"></div>
                        <span>Loading folders...</span>
                    </div>
                </div>
                <div class="folder-navigation">
                    <button class="folder-button" id="refresh-folders">Refresh</button>
                    <button class="folder-button" id="back-folders">← Back</button>
                    <button class="folder-button" id="home-folders">🏠 Home</button>
                    <button class="folder-button danger" id="logout">Switch Provider</button>
                </div>
            </div>
        </div>

        <!-- Smart Prompt -->
        <div class="smart-prompt hidden" id="smart-prompt">
            <div class="smart-prompt-card">
                <h3 class="smart-prompt-title" id="smart-prompt-folder-name">Folder Name</h3>
                <div class="smart-prompt-options">
                    <button class="smart-option-btn" id="load-images-btn">
                        <div><span id="image-count">0</span> Images</div>
                    </button>
                    <button class="smart-option-btn" id="list-subfolders-btn">
                        <div><span id="folder-count">0</span> Folders</div>
                    </button>
                </div>
                <button class="smart-cancel-btn" id="cancel-prompt-btn">Cancel</button>
            </div>
        </div>

        <!-- Loading Screen -->
        <div class="loading-screen hidden" id="loading-screen">
            <div class="loading-card">
                <h2 class="loading-title">Loading Images</h2>
                <div class="loading-counter" id="loading-counter">0</div>
                <div class="loading-message" id="loading-message">Processing images...</div>
            </div>
        </div>
    </div>

    <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
    <script>
        // ===== FIXED NAVIGATION STATE MANAGER =====
        class NavigationStateManager {
            constructor() {
                this.reset();
            }
            
            reset() {
                this.currentFolderId = 'root';
                this.folderHistory = [{ id: 'root', name: 'Root' }];
                this.lastAnalyzedFolder = null;
                this.isNavigating = false;
                console.log('🔄 Navigation state reset');
            }
            
            pushFolder(folder) {
                this.folderHistory.push(folder);
                this.currentFolderId = folder.id;
                console.log(`📂 Pushed folder: ${folder.name} (${folder.id})`);
            }
            
            popFolder() {
                if (this.folderHistory.length > 1) {
                    const popped = this.folderHistory.pop();
                    this.currentFolderId = this.folderHistory[this.folderHistory.length - 1].id;
                    console.log(`📂 Popped folder: ${popped.name}`);
                    return true;
                }
                return false;
            }
            
            getCurrentFolder() {
                return this.folderHistory[this.folderHistory.length - 1];
            }
            
            getBreadcrumbPath() {
                return this.folderHistory.map(f => f.name).join(' / ');
            }
            
            isAtRoot() {
                return this.folderHistory.length === 1;
            }
        }

        // ===== GOOGLE DRIVE PROVIDER =====
        class GoogleDriveProvider {
            constructor() {
                this.name = 'google-drive';
                this.clientId = '1071677394815-3k6ifdofq1l5rr9jbpmhqm8a9b3g5a31.apps.googleusercontent.com';
                this.clientSecret = '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';
                this.redirectUri = window.location.origin + window.location.pathname;
                this.scope = 'https://www.googleapis.com/auth/drive.readonly';
                this.apiBase = 'https://www.googleapis.com/drive/v3';
                this.isAuthenticatedFlag = false;
                this.accessToken = null;
                this.refreshToken = null;
                
                this.loadStoredCredentials();
            }
            
            loadStoredCredentials() {
                const stored = localStorage.getItem('google_drive_auth');
                if (stored) {
                    const creds = JSON.parse(stored);
                    this.accessToken = creds.accessToken;
                    this.refreshToken = creds.refreshToken;
                    this.isAuthenticatedFlag = !!this.accessToken;
                    console.log('📁 Google Drive: Loaded stored credentials');
                }
            }
            
            storeCredentials() {
                localStorage.setItem('google_drive_auth', JSON.stringify({
                    accessToken: this.accessToken,
                    refreshToken: this.refreshToken
                }));
            }
            
            clearStoredCredentials() {
                localStorage.removeItem('google_drive_auth');
            }
            
            async authenticate() {
                const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${this.clientId}&` +
                    `redirect_uri=${encodeURIComponent(this.redirectUri)}&` +
                    `response_type=code&` +
                    `scope=${encodeURIComponent(this.scope)}&` +
                    `access_type=offline&` +
                    `prompt=consent`;
                
                console.log('🔐 Opening Google OAuth window...');
                const popup = window.open(authUrl, 'google-auth', 'width=600,height=700');
                
                return new Promise((resolve, reject) => {
                    window.addEventListener('message', async (event) => {
                        if (event.origin !== window.location.origin) return;
                        
                        if (event.data.type === 'GOOGLE_AUTH_SUCCESS') {
                            popup.close();
                            try {
                                await this.exchangeCodeForTokens(event.data.code);
                                resolve(true);
                            } catch (error) {
                                reject(error);
                            }
                        } else if (event.data.type === 'GOOGLE_AUTH_ERROR') {
                            popup.close();
                            reject(new Error(event.data.error));
                        }
                    });
                    
                    const checkClosed = setInterval(() => {
                        if (popup.closed) {
                            clearInterval(checkClosed);
                            reject(new Error('Authentication cancelled'));
                        }
                    }, 1000);
                });
            }
            
            async exchangeCodeForTokens(code) {
                const tokenUrl = 'https://oauth2.googleapis.com/token';
                const response = await fetch(tokenUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        client_id: this.clientId,
                        client_secret: this.clientSecret,
                        code: code,
                        grant_type: 'authorization_code',
                        redirect_uri: this.redirectUri
                    })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error_description);
                
                this.accessToken = data.access_token;
                this.refreshToken = data.refresh_token;
                this.isAuthenticatedFlag = true;
                this.storeCredentials();
                console.log('✅ Google Drive authenticated successfully');
            }
            
            async makeApiCall(endpoint) {
                if (!this.isAuthenticatedFlag) {
                    throw new Error('Not authenticated');
                }
                
                const url = `${this.apiBase}${endpoint}`;
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${this.accessToken}` }
                });
                
                if (response.status === 401) {
                    console.log('🔄 Access token expired, need re-authentication');
                    this.isAuthenticatedFlag = false;
                    throw new Error('Authentication expired. Please reconnect.');
                }
                
                if (!response.ok) {
                    throw new Error(`API call failed: ${response.statusText}`);
                }
                
                return await response.json();
            }
            
            async getFolderContents(folderId = 'root') {
                console.log(`📁 Google Drive: Getting contents for folder ${folderId}`);
                
                try {
                    const query = `'${folderId}' in parents and trashed=false`;
                    const response = await this.makeApiCall(
                        `/files?q=${encodeURIComponent(query)}&fields=files(id,name,mimeType,size,createdTime,modifiedTime,parents)&pageSize=100`
                    );
                    
                    const processedFiles = response.files.map(file => ({
                        id: file.id,
                        name: file.name,
                        mimeType: file.mimeType,
                        size: file.size ? parseInt(file.size) : 0,
                        createdTime: file.createdTime,
                        modifiedTime: file.modifiedTime,
                        parents: file.parents,
                        folder: file.mimeType === 'application/vnd.google-apps.folder' ? {} : null,
                        file: file.mimeType !== 'application/vnd.google-apps.folder' ? { mimeType: file.mimeType } : null
                    }));
                    
                    console.log(`✅ Processed ${processedFiles.length} files for smart analysis`);
                    return processedFiles;
                    
                } catch (error) {
                    console.error('❌ Google Drive error getting folder contents:', error);
                    throw error;
                }
            }
            
            isAuthenticated() {
                return this.isAuthenticatedFlag;
            }
            
            async disconnect() {
                console.log('🔌 Disconnecting Google Drive...');
                this.isAuthenticatedFlag = false;
                this.accessToken = null;
                this.refreshToken = null;
                this.clearStoredCredentials();
            }
        }

        // ===== ONEDRIVE PROVIDER =====
        class OneDriveProvider {
            constructor() {
                this.name = 'onedrive';
                this.clientId = 'b407fd45-c551-4dbb-9da5-cab3a2c5a949';
                this.apiBase = 'https://graph.microsoft.com/v1.0';
                this.authenticated = false;
                this.activeAccount = null;
                this.msalInstance = null;
                this.initMSAL();
            }
            
            initMSAL() {
                const msalConfig = {
                    auth: {
                        clientId: this.clientId,
                        authority: 'https://login.microsoftonline.com/common',
                        redirectUri: window.location.origin + window.location.pathname
                    },
                    cache: { cacheLocation: 'sessionStorage' }
                };
                this.msalInstance = new msal.PublicClientApplication(msalConfig);
                console.log('🔧 MSAL initialized for OneDrive');
            }
            
            async authenticate() {
                try {
                    console.log('🔐 Starting OneDrive authentication...');
                    const loginResponse = await this.msalInstance.loginPopup({
                        scopes: ['Files.ReadWrite.AppFolder', 'User.Read']
                    });
                    this.activeAccount = loginResponse.account;
                    this.msalInstance.setActiveAccount(this.activeAccount);
                    this.authenticated = true;
                    console.log('✅ OneDrive authentication successful');
                    return true;
                } catch (error) {
                    this.authenticated = false;
                    console.error('❌ OneDrive authentication failed:', error);
                    throw new Error(`OneDrive authentication failed: ${error.message}`);
                }
            }
            
            async getAccessToken() {
                if (!this.activeAccount) {
                    throw new Error('No active account');
                }
                
                try {
                    const response = await this.msalInstance.acquireTokenSilent({
                        scopes: ['Files.ReadWrite.AppFolder'],
                        account: this.activeAccount
                    });
                    return response.accessToken;
                } catch (silentError) {
                    const response = await this.msalInstance.acquireTokenPopup({
                        scopes: ['Files.ReadWrite.AppFolder'],
                        account: this.activeAccount
                    });
                    return response.accessToken;
                }
            }
            
            async makeApiCall(endpoint) {
                if (!this.authenticated) {
                    throw new Error('Not authenticated');
                }
                
                try {
                    const accessToken = await this.getAccessToken();
                    const url = endpoint.startsWith('http') ? endpoint : `${this.apiBase}${endpoint}`;
                    const response = await fetch(url, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API call failed: ${response.statusText}`);
                    }
                    
                    return response;
                } catch (error) {
                    console.error('❌ OneDrive API call failed:', error);
                    throw error;
                }
            }
            
            async getFolderContents(folderId = 'root') {
                console.log(`📁 OneDrive: Getting contents for folder ${folderId}`);
                
                try {
                    const endpoint = folderId === 'root' ? 
                        '/me/drive/root/children' : 
                        `/me/drive/items/${folderId}/children`;
                    
                    const response = await this.makeApiCall(endpoint);
                    const data = await response.json();
                    
                    const processedFiles = data.value.map(item => ({
                        id: item.id,
                        name: item.name,
                        mimeType: item.file ? item.file.mimeType : 'application/vnd.onedrive.folder',
                        size: item.size || 0,
                        createdTime: item.createdDateTime,
                        modifiedTime: item.lastModifiedDateTime,
                        folder: item.folder ? {} : null,
                        file: item.file ? { mimeType: item.file.mimeType } : null
                    }));
                    
                    console.log(`✅ Processed ${processedFiles.length} OneDrive items`);
                    return processedFiles;
                    
                } catch (error) {
                    console.error('❌ OneDrive error getting folder contents:', error);
                    throw error;
                }
            }
            
            isAuthenticated() {
                return this.authenticated;
            }
            
            async disconnect() {
                console.log('🔌 Disconnecting OneDrive...');
                this.authenticated = false;
                this.activeAccount = null;
                if (this.msalInstance) {
                    await this.msalInstance.logoutPopup();
                }
            }
        }

        // ===== PROVIDER MANAGER =====
        class ProviderManager {
            constructor() {
                this.googleProvider = new GoogleDriveProvider();
                this.oneDriveProvider = new OneDriveProvider();
                this.currentProvider = null;
            }
            
            hasValidAuth() {
                return this.googleProvider.isAuthenticated() || this.oneDriveProvider.isAuthenticated();
            }
            
            getCurrentProvider() {
                if (this.googleProvider.isAuthenticated()) {
                    this.currentProvider = this.googleProvider;
                } else if (this.oneDriveProvider.isAuthenticated()) {
                    this.currentProvider = this.oneDriveProvider;
                }
                return this.currentProvider;
            }
            
            async getSmartFolderContents(folderId) {
                const provider = this.getCurrentProvider();
                if (!provider) {
                    throw new Error('No authenticated provider');
                }
                
                console.log(`Getting smart folder contents for ${folderId} using ${provider.name}`);
                
                try {
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timed out after 30 seconds')), 30000)
                    );
                    
                    const contentsPromise = provider.getFolderContents(folderId);
                    const contents = await Promise.race([contentsPromise, timeoutPromise]);
                    
                    return this.analyzeContentsForSmartPrompt(contents);
                } catch (error) {
                    console.error('Error getting folder contents:', error);
                    throw error;
                }
            }
            
            analyzeContentsForSmartPrompt(contents) {
                const images = contents.filter(item => 
                    item.file && item.file.mimeType && item.file.mimeType.startsWith('image/')
                );
                const subfolders = contents.filter(item => item.folder);
                
                console.log(`📊 Analysis: ${images.length} images, ${subfolders.length} subfolders`);
                
                return {
                    hasImages: images.length > 0,
                    hasSubfolders: subfolders.length > 0,
                    images: images,
                    subfolders: subfolders,
                    needsSmartPrompt: images.length > 0 && subfolders.length > 0,
                    isEmpty: images.length === 0 && subfolders.length === 0
                };
            }
            
            async disconnectAll() {
                console.log('🔌 Disconnecting all providers...');
                await this.googleProvider.disconnect();
                await this.oneDriveProvider.disconnect();
                this.currentProvider = null;
            }
        }

        // ===== FIXED FOLDER NAVIGATOR =====
        class FolderNavigator {
            constructor(app) {
                this.app = app;
                this.navState = new NavigationStateManager();
                this.lastAnalyzedFolder = null;
                this.isLoading = false;
            }
            
            async loadInitialFolders() {
                console.log('📁 Loading initial folders...');
                this.navState.reset();
                await this.loadFolder('root');
            }
            
            async loadFolder(folderId) {
                if (this.isLoading) {
                    console.log('⏳ Already loading, skipping...');
                    return;
                }
                
                try {
                    this.isLoading = true;
                    console.log(`📂 Loading folder: ${folderId}`);
                    this.showLoadingState();
                    
                    const folderAnalysis = await this.app.providers.getSmartFolderContents(folderId);
                    this.lastAnalyzedFolder = folderAnalysis;
                    
                    const currentFolderName = this.navState.getCurrentFolder()?.name || 'Unknown Folder';
                    folderAnalysis.folderName = currentFolderName;
                    
                    this.updateBreadcrumbs();
                    
                    if (folderAnalysis.needsSmartPrompt) {
                        console.log('🤔 Mixed content detected - showing smart prompt');
                        this.app.showSmartPrompt(folderAnalysis);
                    } else if (folderAnalysis.hasImages && !folderAnalysis.hasSubfolders) {
                        console.log('🖼️ Only images found - proceeding to image loading');
                        this.app.showLoadingScreen();
                        setTimeout(() => {
                            this.app.showLoadingComplete();
                        }, 2000);
                    } else if (folderAnalysis.hasSubfolders && !folderAnalysis.hasImages) {
                        console.log('📁 Only subfolders found - displaying folder list');
                        this.displayFolders(folderAnalysis.subfolders);
                    } else {
                        console.log('📭 Empty folder detected');
                        this.displayFolders([]);
                    }
                } catch (error) {
                    console.error('❌ Error loading folder:', error);
                    this.showErrorMessage(`Error loading folder: ${error.message}`);
                } finally {
                    this.isLoading = false;
                }
            }
            
            async navigateUp() {
                if (this.isLoading) return;
                
                console.log('📈 Navigating up');
                if (this.navState.popFolder()) {
                    await this.loadFolder(this.navState.currentFolderId);
                } else {
                    console.log('📍 Already at root level');
                }
            }
            
            async navigateHome() {
                if (this.isLoading) return;
                
                console.log('🏠 Navigating to home');
                this.navState.reset();
                await this.loadFolder('root');
            }
            
            async refreshCurrentFolder() {
                if (this.isLoading) return;
                
                console.log('🔄 Refreshing current folder');
                await this.loadFolder(this.navState.currentFolderId);
            }
            
            async selectFolder(folder) {
                if (this.isLoading) return;
                
                console.log(`Selecting folder: ${folder.name} (${folder.id})`);
                this.navState.pushFolder({ id: folder.id, name: folder.name });
                await this.loadFolder(folder.id);
            }
            
            async showSubfoldersOnly() {
                console.log('📁 Showing subfolders only');
                if (this.lastAnalyzedFolder && this.lastAnalyzedFolder.hasSubfolders) {
                    this.displayFolders(this.lastAnalyzedFolder.subfolders);
                } else {
                    this.showErrorMessage('No subfolder data available');
                }
            }
            
            updateBreadcrumbs() {
                const breadcrumbElement = document.getElementById('breadcrumb');
                breadcrumbElement.textContent = this.navState.getBreadcrumbPath();
            }
            
            showLoadingState() {
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
                        <div class="spinner"></div>
                        <span>Loading folders...</span>
                    </div>
                `;
            }
            
            showErrorMessage(message) {
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        <span>${message}</span>
                    </div>
                `;
            }
            
            displayFolders(folders) {
                console.log(`📋 Displaying ${folders.length} folders`);
                const folderList = document.getElementById('folder-list');
                folderList.innerHTML = '';
                
                if (folders.length === 0) {
                    folderList.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                            <span>No folders found</span>
                        </div>
                    `;
                    return;
                }
                
                folders.forEach(folder => {
                    const div = document.createElement('div');
                    div.className = 'folder-item';
                    div.innerHTML = `
                        <svg class="folder-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path>
                        </svg>
                        <div class="folder-info">
                            <div class="folder-name">${folder.name}</div>
                            <div class="folder-date">${new Date(folder.modifiedTime).toLocaleDateString()}</div>
                        </div>
                    `;
                    
                    div.addEventListener('click', () => {
                        this.selectFolder(folder);
                    });
                    
                    folderList.appendChild(div);
                });
            }
        }

        // ===== MAIN APPLICATION =====
        class OrbitalApp {
            constructor() {
                this.providers = new ProviderManager();
                this.folderNav = new FolderNavigator(this);
                this.initialize();
            }
            
            async initialize() {
                console.log('🚀 Initializing Orbital8 with fixed navigation...');
                this.setupEventListeners();
                this.checkExistingAuth();
            }
            
            checkExistingAuth() {
                if (this.providers.hasValidAuth()) {
                    this.setAuthStatus('Already connected to cloud storage', 'success');
                    setTimeout(() => {
                        this.showFolderScreen();
                        this.folderNav.loadInitialFolders();
                    }, 1000);
                }
            }
            
            setupEventListeners() {
                // Authentication
                document.getElementById('google-auth-btn').addEventListener('click', () => this.authenticateGoogle());
                document.getElementById('onedrive-auth-btn').addEventListener('click', () => this.authenticateOneDrive());
                document.getElementById('logout').addEventListener('click', () => this.logout());
                
                // Navigation
                document.getElementById('refresh-folders').addEventListener('click', () => this.folderNav.refreshCurrentFolder());
                document.getElementById('back-folders').addEventListener('click', () => this.folderNav.navigateUp());
                document.getElementById('home-folders').addEventListener('click', () => this.folderNav.navigateHome());
                
                // Smart prompt
                document.getElementById('load-images-btn').addEventListener('click', () => this.handleSmartChoice('loadImages'));
                document.getElementById('list-subfolders-btn').addEventListener('click', () => this.handleSmartChoice('listSubfolders'));
                document.getElementById('cancel-prompt-btn').addEventListener('click', () => this.handleSmartChoice('cancel'));
            }
            
            async authenticateGoogle() {
                try {
                    this.setAuthStatus('Connecting to Google Drive...', 'info');
                    await this.providers.googleProvider.authenticate();
                    this.setAuthStatus('Connected to Google Drive successfully!', 'success');
                    setTimeout(() => {
                        this.showFolderScreen();
                        this.folderNav.loadInitialFolders();
                    }, 1500);
                } catch (error) {
                    this.setAuthStatus(`Connection failed: ${error.message}`, 'error');
                }
            }
            
            async authenticateOneDrive() {
                try {
                    this.setAuthStatus('Connecting to OneDrive...', 'info');
                    await this.providers.oneDriveProvider.authenticate();
                    this.setAuthStatus('Connected to OneDrive successfully!', 'success');
                    setTimeout(() => {
                        this.showFolderScreen();
                        this.folderNav.loadInitialFolders();
                    }, 1500);
                } catch (error) {
                    this.setAuthStatus(`Connection failed: ${error.message}`, 'error');
                }
            }
            
            async logout() {
                console.log('🔌 Switching providers...');
                await this.providers.disconnectAll();
                this.folderNav.navState.reset();
                this.hideSmartPrompt();
                this.showAuthScreen();
                this.setAuthStatus('Choose a cloud storage provider to continue', 'info');
            }
            
            async handleSmartChoice(choice) {
                this.hideSmartPrompt();
                
                switch (choice) {
                    case 'loadImages':
                        console.log('User chose to load images');
                        this.showLoadingScreen();
                        setTimeout(() => {
                            this.showLoadingComplete();
                        }, 2000);
                        break;
                        
                    case 'listSubfolders':
                        console.log('User chose to list subfolders');
                        await this.folderNav.showSubfoldersOnly();
                        break;
                        
                    case 'cancel':
                        console.log('User cancelled - returning to folder view');
                        this.showFolderScreen();
                        break;
                }
            }
            
            setAuthStatus(message, type) {
                const statusElement = document.getElementById('auth-status');
                statusElement.textContent = message;
                statusElement.className = `auth-status ${type}`;
            }
            
            showAuthScreen() {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('folder-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            }
            
            showFolderScreen() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('folder-screen').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('hidden');
            }
            
            showLoadingScreen() {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('folder-screen').classList.add('hidden');
                document.getElementById('loading-screen').classList.remove('hidden');
                this.hideSmartPrompt();
            }
            
            showLoadingComplete() {
                document.getElementById('loading-message').textContent = 'Images loaded successfully! (Step 3 will continue from here)';
            }
            
            showSmartPrompt(folderData) {
                document.getElementById('smart-prompt-folder-name').textContent = folderData.folderName || 'Folder Name';
                
                const imageCount = folderData.images.length;
                const folderCount = folderData.subfolders.length;
                
                document.getElementById('image-count').textContent = imageCount > 999 ? '999+' : imageCount;
                document.getElementById('folder-count').textContent = folderCount > 999 ? '999+' : folderCount;
                
                document.getElementById('smart-prompt').classList.remove('hidden');
            }
            
            hideSmartPrompt() {
                document.getElementById('smart-prompt').classList.add('hidden');
            }
        }

        // Handle OAuth callback for Google Drive
        if (window.location.search.includes('code=') || window.location.search.includes('error=')) {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (window.opener) {
                if (error) {
                    console.error('❌ OAuth error:', error);
                    window.opener.postMessage({ type: 'GOOGLE_AUTH_ERROR', error: error }, window.location.origin);
                } else if (code) {
                    console.log('✅ OAuth success, code received');
                    window.opener.postMessage({ type: 'GOOGLE_AUTH_SUCCESS', code: code }, window.location.origin);
                }
                window.close();
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 DOM loaded, initializing Orbital8...');
            window.OrbitalApp = new OrbitalApp();
        });
    </script>
</body>
</html>
