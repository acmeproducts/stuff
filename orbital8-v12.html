<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no, maximum-scale=1.0" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>Orbital8 – OneDrive</title>
  <script src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js"></script>
  <style>
    :root {
      --app-accent: #0078d4;
      --microsoft-blue: #0078d4;
    }

    * {
      box-sizing: border-box;
    }

    body,
    html {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      overflow: hidden;
      background: #000;
      overscroll-behavior: none;
      touch-action: none;
    }

    /* ===== Screen Styles ===== */
    .screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .screen.hidden {
      display: none;
    }

    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 120, 212, 0.3);
      border-radius: 20px;
      padding: 40px;
      text-align: center;
      max-width: 500px;
      width: 90%;
    }

    .title {
      color: white;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    .subtitle {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
      margin-bottom: 24px;
    }

    .input {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
    }

    .input::placeholder {
      color: rgba(255, 255, 255, 0.5);
    }

    .input:focus {
      outline: none;
      border-color: var(--microsoft-blue);
      box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.2);
    }

    .button {
      background: linear-gradient(45deg, var(--microsoft-blue), #106ebe);
      border: none;
      border-radius: 15px;
      color: white;
      font-size: 18px;
      font-weight: 600;
      padding: 16px 32px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 20px rgba(0, 120, 212, 0.4);
      width: 100%;
      margin-bottom: 16px;
    }

    .button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 25px rgba(0, 120, 212, 0.6);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .status {
      padding: 12px;
      border-radius: 8px;
      margin-top: 16px;
      font-size: 14px;
      font-weight: 500;
    }

    .status.success {
      background: rgba(16, 185, 129, 0.2);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status.error {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .status.info {
      background: rgba(0, 120, 212, 0.2);
      color: var(--microsoft-blue);
      border: 1px solid rgba(0, 120, 212, 0.3);
    }

    /* ===== Folder List ===== */
    .folder-list {
      flex: 1;
      overflow-y: auto;
      margin-bottom: 20px;
      max-height: 400px;
    }

    .folder-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: white;
    }

    .folder-item:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(0, 120, 212, 0.3);
      transform: translateY(-1px);
    }

    .folder-icon {
      width: 20px;
      height: 20px;
      margin-right: 12px;
      color: var(--microsoft-blue);
    }

    .folder-info {
      flex: 1;
    }

    .folder-name {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .folder-date {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.6);
    }

    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 120, 212, 0.3);
      border-radius: 50%;
      border-top-color: var(--microsoft-blue);
      animation: spin 1s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .folder-actions {
      display: flex;
      gap: 12px;
    }

    .folder-button {
      flex: 1;
      padding: 12px 24px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s ease;
      backdrop-filter: blur(10px);
    }

    .folder-button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .folder-button.danger {
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }

    .folder-button.danger:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* ===== Loading Screen ===== */
    .loading-counter {
      color: var(--microsoft-blue);
      font-size: 48px;
      font-weight: 700;
      margin: 20px 0;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
    }

    .loading-message {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
      margin-bottom: 20px;
    }

    .loading-progress {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .loading-progress-bar {
      height: 100%;
      background: linear-gradient(45deg, var(--microsoft-blue), #106ebe);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }

    /* ===== Status Log ===== */
    .status-log {
      background: rgba(0, 0, 0, 0.3);
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      max-height: 150px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }

    .status-log-entry {
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 4px;
    }

    .status-log-entry.success {
      color: #10b981;
    }

    .status-log-entry.error {
      color: #ef4444;
    }

    .status-log-entry.info {
      color: var(--microsoft-blue);
    }

    /* ===== Main App ===== */
    .app-container {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      overflow: hidden;
    }

    .nav-button {
      position: absolute;
      top: 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 8px 12px;
      font-size: 11px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      z-index: 15;
      display: flex;
      align-items: center;
      gap: 6px;
      opacity: 0.7;
    }

    .nav-button:hover {
      opacity: 1;
      background: rgba(255, 255, 255, 0.2);
    }

    .nav-button.back {
      left: 20px;
    }

    .nav-button.details {
      right: 20px;
    }

    .image-viewport {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      overflow: hidden;
    }

    .center-image {
      max-width: 100vw;
      max-height: 100vh;
      width: auto;
      height: auto;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.2s ease;
      transform-origin: center center;
      cursor: grab;
    }

    .center-image.dragging {
      filter: brightness(0.9);
      cursor: grabbing;
    }

    .center-image.zoomable {
      pointer-events: auto;
    }

    .edge-glow {
      position: absolute;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 2;
    }

    .edge-glow.top {
      top: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(180deg, rgba(0, 120, 212, 0.4) 0%, transparent 100%);
    }

    .edge-glow.bottom {
      bottom: 0;
      left: 0;
      right: 0;
      height: 8px;
      background: linear-gradient(0deg, rgba(0, 120, 212, 0.4) 0%, transparent 100%);
    }

    .edge-glow.left {
      top: 0;
      left: 0;
      bottom: 0;
      width: 8px;
      background: linear-gradient(90deg, rgba(0, 120, 212, 0.4) 0%, transparent 100%);
    }

    .edge-glow.right {
      top: 0;
      right: 0;
      bottom: 0;
      width: 8px;
      background: linear-gradient(270deg, rgba(0, 120, 212, 0.4) 0%, transparent 100%);
    }

    .edge-glow.active {
      opacity: 1;
    }

    /* ===== Pill Counters ===== */
    .pill-counter {
      position: fixed;
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 12px 20px;
      font-size: 18px;
      font-weight: 500;
      color: black;
      opacity: 0;
      transition: all 0.3s ease;
      cursor: pointer;
      z-index: 10;
      min-width: 50px;
      text-align: center;
    }

    .pill-counter.visible {
      opacity: 0.9;
    }

    .pill-counter.active {
      font-weight: 700;
      background: white;
      opacity: 1;
      border: 3px solid black;
    }

    .pill-counter:not(.active) {
      background: rgba(128, 128, 128, 0.4);
      border: none;
    }

    .pill-counter:hover {
      opacity: 1;
      transform: scale(1.05);
    }

    .pill-counter.top {
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
    }

    .pill-counter.bottom {
      bottom: 60px;
      left: 50%;
      transform: translateX(-50%);
    }

    .pill-counter.left {
      left: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    .pill-counter.right {
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
    }

    /* ===== Ripple Effects ===== */
    .pill-counter::before,
    .pill-counter::after {
      content: "";
      position: absolute;
      border: 2px solid rgba(0, 120, 212, 0.8);
      border-radius: 16px;
      opacity: 0;
      pointer-events: none;
      z-index: -1;
    }

    .pill-counter.triple-ripple::before {
      animation: tripleRipple1 1.5s ease-out;
    }

    .pill-counter.triple-ripple::after {
      animation: tripleRipple2 1.5s ease-out 0.2s;
    }

    .pill-counter.triple-ripple {
      animation: tripleRipple3 1.5s ease-out 0.4s;
    }

    .pill-counter.glow-effect {
      box-shadow: 0 0 25px rgba(0, 120, 212, 0.8), 0 0 50px rgba(0, 120, 212, 0.6);
      animation: sustainedGlow 1s ease-out 1.5s;
    }

    @keyframes tripleRipple1 {
      0% {
        opacity: 0.9;
        transform: scale(1);
        top: -4px;
        left: -4px;
        right: -4px;
        bottom: -4px;
      }

      100% {
        opacity: 0;
        transform: scale(2);
        top: -20px;
        left: -20px;
        right: -20px;
        bottom: -20px;
      }
    }

    @keyframes tripleRipple2 {
      0% {
        opacity: 0.7;
        transform: scale(1);
        top: -6px;
        left: -6px;
        right: -6px;
        bottom: -6px;
      }

      100% {
        opacity: 0;
        transform: scale(2.5);
        top: -30px;
        left: -30px;
        right: -30px;
        bottom: -30px;
      }
    }

    @keyframes tripleRipple3 {
      0% {
        box-shadow: 0 0 10px rgba(0, 120, 212, 0.5);
      }
      50% {
        box-shadow: 0 0 20px rgba(0, 120, 212, 0.8);
      }
      100% {
        box-shadow: 0 0 15px rgba(0, 120, 212, 0.6);
      }
    }

    @keyframes sustainedGlow {
      0% {
        box-shadow: 0 0 25px rgba(0, 120, 212, 0.8), 0 0 50px rgba(0, 120, 212, 0.6);
      }
      50% {
        box-shadow: 0 0 35px rgba(0, 120, 212, 1), 0 0 70px rgba(0, 120, 212, 0.8);
      }
      100% {
        box-shadow: 0 0 10px rgba(0, 120, 212, 0.4);
      }
    }

    /* ===== Empty State ===== */
    .empty-state {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      color: rgba(255, 255, 255, 0.7);
      font-size: 18px;
      font-weight: 300;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      z-index: 5;
    }

    .empty-message {
      margin-bottom: 20px;
      font-size: 24px;
      font-weight: 400;
    }

    .new-images-button {
      background: rgba(0, 120, 212, 0.2);
      border: 1px solid rgba(0, 120, 212, 0.4);
      border-radius: 20px;
      padding: 12px 24px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .new-images-button:hover {
      background: rgba(0, 120, 212, 0.4);
      transform: translateY(-2px);
    }

    /* ===== Grid Modal ===== */
    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .modal.hidden {
      display: none !important;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      width: 100%;
      height: 100%;
      max-width: 1152px;
      max-height: 90vh;
      margin: 16px;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      position: sticky;
      top: 0;
      background: white;
      z-index: 10;
      border-bottom: 1px solid #e5e7eb;
    }

    .modal-header-main {
      padding: 16px;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 500;
      color: #1f2937;
      line-height: 1.5;
    }

    .select-all-btn {
      background-color: #e5e7eb;
      color: #4b5563;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 14px;
      font-weight: 500;
      display: inline-block;
      min-width: 36px;
      text-align: center;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .select-all-btn:hover {
      background-color: #d1d5db;
    }

    .close-btn {
      color: #6b7280;
      transition: all 0.2s;
      cursor: pointer;
      background: transparent;
      border: none;
      border-radius: 6px;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #374151;
      background: rgba(0, 0, 0, 0.05);
    }

    .close-btn svg {
      width: 24px;
      height: 24px;
    }

    .selection-info-row {
      padding: 8px 16px;
      border-bottom: 1px solid #f3f4f6;
      min-height: 48px;
      display: flex;
      align-items: center;
    }

    .selection-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .selection-count {
      background-color: #dbeafe;
      color: #1e40af;
      padding: 4px 12px;
      border-radius: 9999px;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .deselect-all-btn {
      margin-left: 4px;
      transition: all 0.2s;
      cursor: pointer;
      background: transparent;
      border: none;
      border-radius: 4px;
      padding: 2px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .deselect-all-btn:hover {
      color: #1e3a8a;
      background: rgba(0, 0, 0, 0.05);
    }

    .deselect-all-btn svg {
      width: 16px;
      height: 16px;
    }

    .controls-row {
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .grid-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .control-group {
      display: flex;
      align-items: center;
    }

    .control-label {
      margin-right: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .grid-slider {
      width: 96px;
    }

    .grid-value {
      margin-left: 8px;
      font-size: 14px;
      color: #4b5563;
    }

    .grid-select {
      padding: 4px 8px;
      border: 1px solid #d1d5db;
      border-radius: 4px;
      font-size: 14px;
      color: #4b5563;
      background: white;
    }

    .action-buttons {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 4px 12px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      outline: none;
    }

    .btn-primary {
      background-color: #3b82f6;
      color: white;
    }

    .btn-primary:hover {
      background-color: #2563eb;
    }

    .btn-danger {
      background-color: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background-color: #dc2626;
    }

    .btn-secondary {
      background-color: #e5e7eb;
      color: #4b5563;
    }

    .btn-secondary:hover {
      background-color: #d1d5db;
    }

    .grid-content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 16px;
    }

    .grid-item {
      position: relative;
      aspect-ratio: 1;
      overflow: hidden;
      border-radius: 8px;
      cursor: pointer;
    }

    .grid-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .grid-item.selected {
      box-shadow: 0 0 0 4px #3b82f6;
    }

    .btn.hidden {
      display: none;
    }

    /* ===== Action Modals ===== */
    .action-modal {
      max-width: 448px;
      padding: 24px;
    }

    .action-title {
      font-size: 18px;
      font-weight: 500;
      color: #1f2937;
      margin-bottom: 16px;
    }

    .action-buttons-row {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 16px;
    }

    .move-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .move-option {
      width: 100%;
      text-align: left;
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .move-option:hover {
      background-color: #f3f4f6;
    }

    .tag-input-group {
      margin-bottom: 16px;
    }

    .tag-input-label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 4px;
    }

    .tag-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      outline: none;
    }

    .tag-input:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .tag-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
    }

    .tag-suggestion {
      background-color: #e5e7eb;
      color: #374151;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .tag-suggestion:hover {
      background-color: #d1d5db;
    }

    .delete-message {
      color: #4b5563;
      margin-bottom: 16px;
    }

    /* ===== Details Modal ===== */
    .details-modal-content {
      max-width: 800px;
      max-height: 95vh;
      height: 95vh;
      display: flex;
      flex-direction: column;
    }

    .details-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      flex-shrink: 0;
    }

    .details-title {
      font-size: 18px;
      font-weight: 500;
      color: #1f2937;
    }

    .tab-nav {
      display: flex;
      border-bottom: 1px solid #e5e7eb;
      background: #f8fafc;
      flex-shrink: 0;
    }

    .tab-button {
      flex: 1;
      padding: 16px;
      border: none;
      background: transparent;
      color: #6b7280;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }

    .tab-button:hover {
      color: #374151;
      background: rgba(0, 0, 0, 0.02);
    }

    .tab-button.active {
      color: #3b82f6;
      border-bottom-color: #3b82f6;
      background: white;
    }

    .details-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      min-height: 0;
    }

    .tab-content {
      display: none;
      padding: 20px;
      height: 100%;
    }

    .tab-content.active {
      display: block;
    }

    .info-section {
      margin-bottom: 20px;
    }

    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      gap: 12px;
    }

    .info-label {
      font-size: 14px;
      color: #6b7280;
      min-width: 80px;
      font-weight: 500;
    }

    .info-value {
      font-size: 14px;
      color: #374151;
      flex: 1;
      word-break: break-word;
    }

    .info-link {
      color: #3b82f6;
      text-decoration: none;
    }

    .info-link:hover {
      text-decoration: underline;
    }

    .tags-section {
      margin-bottom: 20px;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 16px;
      min-height: 40px;
    }

    .tag-item {
      display: inline-flex;
      align-items: center;
      background: #dbeafe;
      color: #1e40af;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      gap: 6px;
    }

    .tag-remove {
      background: transparent;
      border: none;
      color: #1e40af;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      padding: 0;
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background-color 0.2s;
    }

    .tag-remove:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .add-tag-btn {
      background: #f3f4f6;
      border: 1px dashed #d1d5db;
      border-radius: 12px;
      padding: 4px 12px;
      font-size: 12px;
      color: #6b7280;
      cursor: pointer;
      transition: all 0.2s;
    }

    .add-tag-btn:hover {
      background: #e5e7eb;
      color: #374151;
    }

    .notes-section {
      margin-bottom: 24px;
    }

    .notes-textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      resize: vertical;
      outline: none;
    }

    .notes-textarea:focus {
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .rating-section {
      margin-bottom: 20px;
    }

    .rating-label {
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 8px;
    }

    .star-rating {
      display: flex;
      gap: 4px;
    }

    .star {
      width: 24px;
      height: 24px;
      cursor: pointer;
      color: #d1d5db;
      transition: color 0.2s;
    }

    .star:hover,
    .star.active {
      color: #fbbf24;
    }

    .metadata-table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .metadata-table td {
      padding: 8px 12px;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
      word-wrap: break-word;
    }

    .metadata-table .key-cell {
      font-weight: 500;
      color: #374151;
      width: 25%;
      border-right: 1px solid #e5e7eb;
      background: #f9fafb;
      min-width: 120px;
    }

    .metadata-table .value-cell {
      color: #6b7280;
      white-space: pre-wrap;
      position: relative;
      max-width: 0;
      word-break: break-all;
    }

    .copy-button {
      background: var(--microsoft-blue);
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 11px;
      color: white;
      cursor: pointer;
      transition: all 0.2s;
      margin-left: 8px;
      vertical-align: top;
      font-weight: 500;
    }

    .copy-button:hover {
      background: #106ebe;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 120, 212, 0.3);
    }

    .copy-button:active {
      transform: translateY(0);
      box-shadow: 0 1px 2px rgba(0, 120, 212, 0.3);
    }

    .copy-button.copied {
      background: #10b981;
      transform: scale(1.1);
    }

    /* ===== Toast ===== */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .toast.show {
      opacity: 1;
    }

    .toast.success {
      background: rgba(16, 185, 129, 0.9);
    }

    .toast.info {
      background: rgba(0, 120, 212, 0.9);
    }

    .toast.error {
      background: rgba(239, 68, 68, 0.9);
    }

    .hidden {
      display: none !important;
    }

    @media screen and (min-width: 768px) {
      .image-viewport {
        top: -10vh;
      }
      .pill-counter {
        font-size: 16px;
        padding: 8px 16px;
        min-width: 40px;
      }
      .nav-button {
        font-size: 14px;
        padding: 10px 16px;
      }
    }

    @media screen and (max-width: 767px) {
      .nav-button {
        font-size: 16px;
        padding: 12px 20px;
        border-radius: 25px;
        min-width: 80px;
      }
      .pill-counter.bottom {
        bottom: 80px;
      }

      .details-modal-content {
        max-width: 100vw;
        max-height: 100vh;
        height: 100vh;
        margin: 0;
        border-radius: 0;
      }

      .metadata-table .key-cell {
        width: 30%;
        min-width: 80px;
        font-size: 12px;
      }

      .metadata-table .value-cell {
        font-size: 12px;
      }

      .copy-button {
        font-size: 10px;
        padding: 3px 6px;
      }
    }
  </style>
</head>
<body>
  <!-- Authentication Screen -->
  <div class="screen" id="auth-screen">
    <div class="card">
      <h1 class="title" style="font-size: 32px;">Orbital8</h1>
      <p class="subtitle">Connect to OneDrive</p>
      <button class="button" id="auth-button">Connect OneDrive</button>
      <div id="auth-status" class="status info">Click to sign in with your Microsoft account</div>
    </div>
  </div>

  <!-- Folder Selection Screen -->
  <div class="screen hidden" id="folder-screen">
    <div class="card" style="max-height: 80vh; display: flex; flex-direction: column;">
      <h2 class="title">Select a Folder</h2>
      <div class="folder-list" id="folder-list">
        <div
          style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
          <div class="spinner"></div>
          <span>Loading folders...</span>
        </div>
      </div>
      <div class="folder-actions">
        <button class="folder-button" id="refresh-folders">Refresh</button>
        <button class="folder-button danger" id="logout">Disconnect</button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div class="screen hidden" id="loading-screen" style="z-index: 1500;">
    <div class="card">
      <h2 class="title">Loading Images</h2>
      <div class="loading-counter" id="loading-counter">0</div>
      <div class="loading-message" id="loading-message">Processing files...</div>
      <div class="loading-progress">
        <div class="loading-progress-bar" id="loading-progress-bar"></div>
      </div>
      <div class="status-log" id="status-log">
        <div class="status-log-entry info">Starting image processing...</div>
      </div>
    </div>
  </div>

  <!-- Main App Container -->
  <div class="app-container hidden" id="app-container">
    <div class="nav-button back" id="back-button">← Folders</div>
    <div class="nav-button details" id="details-button">Details →</div>

    <div class="image-viewport" id="image-viewport">
      <img class="center-image zoomable" id="center-image" alt="Select a folder to start" />
    </div>

    <div class="edge-glow top" id="edge-top"></div>
    <div class="edge-glow bottom" id="edge-bottom"></div>
    <div class="edge-glow left" id="edge-left"></div>
    <div class="edge-glow right" id="edge-right"></div>

    <div class="pill-counter top" id="pill-priority" data-stack="priority">0</div>
    <div class="pill-counter bottom" id="pill-trash" data-stack="trash">0</div>
    <div class="pill-counter left active" id="pill-in" data-stack="in">0</div>
    <div class="pill-counter right" id="pill-out" data-stack="out">0</div>

    <div class="empty-state hidden" id="empty-state">
      <div class="empty-message">No more images in this stack</div>
      <button class="new-images-button" id="select-another-stack-btn">Select Another Stack</button>
      <button class="new-images-button" id="select-another-folder-btn" style="margin-top: 12px;">Choose Different
        Folder</button>
    </div>

    <div id="toast" class="toast"></div>
  </div>

  <!-- Grid Modal -->
  <div id="grid-modal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-header-main">
          <div class="modal-header-left">
            <h2 id="grid-title" class="modal-title">Grid View</h2>
            <button id="select-all-btn" class="select-all-btn">0</button>
          </div>
          <button id="close-grid" class="close-btn">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
        <div class="selection-info-row">
          <div class="selection-info">
            <span class="selection-count">
              <span id="selection-text">0 selected</span>
              <button id="deselect-all-btn" class="deselect-all-btn">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M6 18L18 6M6 6l12 12" />
                </svg>
              </button>
            </span>
          </div>
        </div>
        <div class="controls-row">
          <div class="grid-controls">
            <div class="control-group">
              <span class="control-label">Grid Size:</span>
              <input type="range" id="grid-size" class="grid-slider" min="1" max="10" value="4" />
              <span id="grid-size-value" class="grid-value">4</span>
            </div>
            <div class="control-group">
              <span class="control-label">Sort:</span>
              <select id="grid-sort" class="grid-select">
                <option value="date-desc">Date (newest first)</option>
                <option value="date-asc">Date (oldest first)</option>
                <option value="name-asc">Name (A-Z)</option>
                <option value="name-desc">Name (Z-A)</option>
              </select>
            </div>
          </div>
          <div class="action-buttons">
            <button id="tag-selected" class="btn btn-primary hidden">Tag</button>
            <button id="move-selected" class="btn btn-primary hidden">Move</button>
            <button id="delete-selected" class="btn btn-danger hidden">Delete</button>
          </div>
        </div>
      </div>
      <div class="grid-content">
        <div id="grid-container" class="grid-container"></div>
      </div>
    </div>
  </div>

  <!-- Action Modals -->
  <div id="move-modal" class="modal hidden">
    <div class="modal-content action-modal">
      <h3 class="action-title">Move to Stack</h3>
      <div class="move-options">
        <button class="move-option" data-stack="in">In</button>
        <button class="move-option" data-stack="out">Out</button>
        <button class="move-option" data-stack="priority">Priority</button>
        <button class="move-option" data-stack="trash">Trash</button>
      </div>
      <div class="action-buttons-row">
        <button id="cancel-move" class="btn btn-secondary">Cancel</button>
      </div>
    </div>
  </div>

  <div id="tag-modal" class="modal hidden">
    <div class="modal-content action-modal">
      <h3 class="action-title">Add Tags</h3>
      <div class="tag-input-group">
        <label for="tag-input" class="tag-input-label">Enter tags (comma separated)</label>
        <input type="text" id="tag-input" class="tag-input"
               placeholder="nature, landscape, vacation" />
      </div>
      <div id="tag-suggestions" class="tag-suggestions"></div>
      <div class="action-buttons-row">
        <button id="cancel-tag" class="btn btn-secondary">Cancel</button>
        <button id="apply-tag" class="btn btn-primary">Apply</button>
      </div>
    </div>
  </div>

  <div id="delete-modal" class="modal hidden">
    <div class="modal-content action-modal">
      <h3 class="action-title">Confirm Delete</h3>
      <p id="delete-message" class="delete-message">Are you sure you want to move the selected images to
        Trash?</p>
      <div class="action-buttons-row">
        <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
        <button id="confirm-delete" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="details-modal" class="modal hidden">
    <div class="modal-content details-modal-content">
      <div class="details-header">
        <h3 class="details-title">Image Details</h3>
        <button id="details-close" class="close-btn">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>

      <div class="tab-nav">
        <button class="tab-button active" data-tab="info">Info</button>
        <button class="tab-button" data-tab="tags">Tags</button>
        <button class="tab-button" data-tab="notes">Notes</button>
        <button class="tab-button" data-tab="metadata">Metadata</button>
      </div>

      <div class="details-content">
        <div id="tab-info" class="tab-content active">
          <div class="info-section">
            <div class="info-item">
              <span class="info-label">Filename:</span>
              <a id="detail-filename-link" class="info-value info-link" href="#" target="_blank">
                <span id="detail-filename"></span>
              </a>
            </div>
            <div class="info-item">
              <span class="info-label">Date:</span>
              <span class="info-value" id="detail-date"></span>
            </div>
            <div class="info-item">
              <span class="info-label">Size:</span>
              <span class="info-value" id="detail-size"></span>
            </div>
          </div>
        </div>

        <div id="tab-tags" class="tab-content">
          <div class="tags-section">
            <div class="tags-container" id="detail-tags"></div>
          </div>
        </div>

        <div id="tab-notes" class="tab-content">
          <div class="notes-section">
            <label for="detail-notes" class="info-label">Notes:</label>
            <textarea id="detail-notes" class="notes-textarea" placeholder="Add your notes here..."></textarea>
          </div>

          <div class="rating-section">
            <div class="rating-label">Quality Rating:</div>
            <div class="star-rating" id="quality-rating">
              <svg class="star" data-rating="1" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="2" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="3" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="4" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="5" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
            </div>
          </div>

          <div class="rating-section">
            <div class="rating-label">Content Rating:</div>
            <div class="star-rating" id="content-rating">
              <svg class="star" data-rating="1" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="2" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="3" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="4" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
              <svg class="star" data-rating="5" fill="currentColor" viewBox="0 0 24 24">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
            </div>
          </div>
        </div>

        <div id="tab-metadata" class="tab-content">
          <table class="metadata-table" id="metadata-table"></table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== ORBITAL8 ONEDRIVE VERSION (FIXED) =====

    // ===== Configuration & Constants =====
    const STACK_TYPES = ["in", "out", "priority", "trash"];
    const STACK_NAMES = { in: "In", out: "Out", priority: "Priority", trash: "Trash" };

    // ===== Core Utilities =====
    const utils = {
      elements: {},

      init() {
        this.elements = {
          // Screens
          authScreen: document.getElementById("auth-screen"),
          folderScreen: document.getElementById("folder-screen"),
          loadingScreen: document.getElementById("loading-screen"),
          appContainer: document.getElementById("app-container"),

          // Auth elements
          authButton: document.getElementById("auth-button"),
          authStatus: document.getElementById("auth-status"),

          // Folder elements
          folderList: document.getElementById("folder-list"),
          refreshFolders: document.getElementById("refresh-folders"),
          logout: document.getElementById("logout"),

          // App elements
          backButton: document.getElementById("back-button"),
          detailsButton: document.getElementById("details-button"),
          imageViewport: document.getElementById("image-viewport"),
          centerImage: document.getElementById("center-image"),
          emptyState: document.getElementById("empty-state"),
          selectAnotherStackBtn: document.getElementById("select-another-stack-btn"),
          selectAnotherFolderBtn: document.getElementById("select-another-folder-btn"),
          toast: document.getElementById("toast"),

          // Loading elements
          loadingCounter: document.getElementById("loading-counter"),
          loadingMessage: document.getElementById("loading-message"),
          loadingProgressBar: document.getElementById("loading-progress-bar"),
          statusLog: document.getElementById("status-log"),

          // Edge glows
          edgeTop: document.getElementById("edge-top"),
          edgeBottom: document.getElementById("edge-bottom"),
          edgeLeft: document.getElementById("edge-left"),
          edgeRight: document.getElementById("edge-right"),

          // Pill counters
          pillPriority: document.getElementById("pill-priority"),
          pillTrash: document.getElementById("pill-trash"),
          pillIn: document.getElementById("pill-in"),
          pillOut: document.getElementById("pill-out"),

          // Grid modal
          gridModal: document.getElementById("grid-modal"),
          gridTitle: document.getElementById("grid-title"),
          gridContainer: document.getElementById("grid-container"),
          selectAllBtn: document.getElementById("select-all-btn"),
          deselectAllBtn: document.getElementById("deselect-all-btn"),
          selectionText: document.getElementById("selection-text"),
          closeGrid: document.getElementById("close-grid"),
          gridSize: document.getElementById("grid-size"),
          gridSizeValue: document.getElementById("grid-size-value"),
          gridSort: document.getElementById("grid-sort"),
          tagSelected: document.getElementById("tag-selected"),
          moveSelected: document.getElementById("move-selected"),
          deleteSelected: document.getElementById("delete-selected"),

          // Action modals
          moveModal: document.getElementById("move-modal"),
          tagModal: document.getElementById("tag-modal"),
          deleteModal: document.getElementById("delete-modal"),
          tagInput: document.getElementById("tag-input"),
          tagSuggestions: document.getElementById("tag-suggestions"),
          deleteMessage: document.getElementById("delete-message"),
          confirmDelete: document.getElementById("confirm-delete"),

          // Details modal
          detailsModal: document.getElementById("details-modal"),
          detailsClose: document.getElementById("details-close"),
          detailFilename: document.getElementById("detail-filename"),
          detailFilenameLink: document.getElementById("detail-filename-link"),
          detailDate: document.getElementById("detail-date"),
          detailSize: document.getElementById("detail-size"),
          detailTags: document.getElementById("detail-tags"),
          detailNotes: document.getElementById("detail-notes"),
          qualityRating: document.getElementById("quality-rating"),
          contentRating: document.getElementById("content-rating"),
          metadataTable: document.getElementById("metadata-table"),
        };
      },

      modal: {
        show(id) {
          document.getElementById(id).classList.remove("hidden");
        },
        hide(id) {
          document.getElementById(id).classList.add("hidden");
        },
      },

      showScreen(screenId) {
        ["auth-screen", "folder-screen", "loading-screen", "app-container"].forEach((id) => {
          document.getElementById(id).classList.toggle("hidden", id !== screenId);
        });
      },

      showToast(message, type = "success", important = false) {
        if (!important && Math.random() < 0.7) return;

        const toast = this.elements.toast;
        toast.textContent = message;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove("show"), 3000);
      },

      async withErrorHandling(operation, errorMessage = "Operation failed") {
        try {
          return await operation();
        } catch (error) {
          this.showToast(`${errorMessage}: ${error.message}`, "error", true);
          throw error;
        }
      },

      async setImageSrc(img, file) {
        let imageUrl = appState.imageCache.get(file.id);

        if (!imageUrl) {
          if (file.thumbnails && file.thumbnails.large) {
            imageUrl = file.thumbnails.large.url;
          } else if (file.downloadUrl) {
            imageUrl = file.downloadUrl;
          } else {
            imageUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`;
          }

          if (imageUrl) appState.imageCache.set(file.id, imageUrl);
        }

        return new Promise((resolve) => {
          img.onload = resolve;
          img.onerror = () => {
            img.src =
              "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150' viewBox='0 0 150 150' fill='none'%3E%3Crect width='150' height='150' fill='%23E5E7EB'/%3E%3Cpath d='M65 60H85V90H65V60Z' fill='%239CA3AF'/%3E%3Ccircle cx='75' cy='45' r='10' fill='%239CA3AF'/%3E%3C/svg%3E";
            resolve();
          };
          img.src = imageUrl || "";
          img.alt = file.name || "Image";
        });
      },

      formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";
        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      },

      updateLoadingProgress(current, total) {
        appState.loadingProgress = { current, total };
        this.elements.loadingCounter.textContent = current;
        this.elements.loadingMessage.textContent = total
          ? `Processing ${current} of ${total} images...`
          : `Found ${current} images`;

        if (total > 0) {
          const percentage = (current / total) * 100;
          this.elements.loadingProgressBar.style.width = `${percentage}%`;
        }
      },
    };

    // ===== Application State =====
    const appState = {
      cloudStorage: null,
      metadataExtractor: null,
      userMetadataCache: null,
      metadataCache: null,
      currentFolder: { id: null, name: "" },
      imageFiles: [],
      currentImageIndex: 0,
      currentStack: "in",
      stacks: { in: [], out: [], priority: [], trash: [] },
      isDragging: false,
      isPinching: false,
      initialDistance: 0,
      currentScale: 1,
      maxScale: 4,
      minScale: 0.3,
      panOffset: { x: 0, y: 0 },
      grid: { stack: null, selected: [] },
      tags: new Set(),
      imageCache: new Map(),
      loadingProgress: { current: 0, total: 0 },
    };

    // ===== User Metadata Cache System =====
    class UserMetadataCache {
      constructor() {
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open("Orbital8OneDriveUserData", 2);
          request.onerror = () => reject(request.error);
          request.onsuccess = () => {
            this.db = request.result;
            resolve();
          };
          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // Create user metadata store
            if (!db.objectStoreNames.contains("userMetadata")) {
              db.createObjectStore("userMetadata", { keyPath: "id" });
            }

            // Create PNG metadata store
            if (!db.objectStoreNames.contains("metadata")) {
              db.createObjectStore("metadata", { keyPath: "id" });
            }
          };
        });
      }

      async getUserMetadata(fileId) {
        if (!this.db) return null;
        try {
          const transaction = this.db.transaction(["userMetadata"], "readonly");
          const store = transaction.objectStore("userMetadata");
          const result = await new Promise((resolve, reject) => {
            const request = store.get(fileId);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });

          return result ? result.metadata : null;
        } catch (error) {
          console.warn("Error getting user metadata:", error);
          return null;
        }
      }

      async setUserMetadata(fileId, metadata) {
        if (!this.db) return;
        try {
          const transaction = this.db.transaction(["userMetadata"], "readwrite");
          const store = transaction.objectStore("userMetadata");
          await new Promise((resolve, reject) => {
            const request = store.put({
              id: fileId,
              metadata,
              updated: Date.now(),
            });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.warn("Error setting user metadata:", error);
        }
      }

      // PNG metadata methods (for compatibility)
      async getMetadata(fileId, modifiedTime) {
        if (!this.db) return null;
        try {
          const transaction = this.db.transaction(["metadata"], "readonly");
          const store = transaction.objectStore("metadata");
          const result = await new Promise((resolve, reject) => {
            const request = store.get(fileId);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
          });

          if (result && result.modifiedTime === modifiedTime) {
            return result.metadata;
          }
        } catch (error) {
          console.warn("Error getting PNG metadata:", error);
        }
        return null;
      }

      async setMetadata(fileId, modifiedTime, metadata) {
        if (!this.db) return;
        try {
          const transaction = this.db.transaction(["metadata"], "readwrite");
          const store = transaction.objectStore("metadata");
          await new Promise((resolve, reject) => {
            const request = store.put({
              id: fileId,
              modifiedTime,
              metadata,
              cached: Date.now(),
            });
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
          });
        } catch (error) {
          console.warn("Error setting PNG metadata:", error);
        }
      }
    }

    // ===== Metadata System (Simplified for OneDrive) =====
    class SimpleMetadataExtractor {
      constructor() {
        this.statusLog = null;
      }

      setStatusLog(logElement) {
        this.statusLog = logElement;
      }

      log(message, type = "info") {
        if (this.statusLog) {
          const entry = document.createElement("div");
          entry.className = `status-log-entry ${type}`;
          entry.textContent = message;
          this.statusLog.appendChild(entry);
          this.statusLog.scrollTop = this.statusLog.scrollHeight;
        }
      }

      async extract(buffer) {
        if (!buffer) return {};

        const metadata = {};
        const view = new DataView(buffer);
        let pos = 8;

        try {
          while (pos < buffer.byteLength - 12) {
            const chunkLength = view.getUint32(pos, false);
            pos += 4;

            let chunkType = "";
            for (let i = 0; i < 4; i++) {
              chunkType += String.fromCharCode(view.getUint8(pos + i));
            }
            pos += 4;

            if (chunkType === "tEXt") {
              let keyword = "";
              let value = "";
              let nullFound = false;

              for (let i = 0; i < chunkLength; i++) {
                const byte = view.getUint8(pos + i);

                if (!nullFound) {
                  if (byte === 0) {
                    nullFound = true;
                  } else {
                    keyword += String.fromCharCode(byte);
                  }
                } else {
                  value += String.fromCharCode(byte);
                }
              }

              metadata[keyword] = value;
            } else if (chunkType === "IHDR") {
              const width = view.getUint32(pos, false);
              const height = view.getUint32(pos + 4, false);
              metadata._dimensions = { width, height };
            }

            pos += chunkLength + 4;
          }
        } catch (error) {
          // Simplified error handling
        }

        return metadata;
      }

      async fetchMetadata(file) {
        if (file.mimeType !== "image/png") {
          return { error: "Not a PNG file" };
        }

        try {
          const accessToken = await appState.cloudStorage.currentProvider.getAccessToken();
          const response = await utils.withErrorHandling(
            () =>
              fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`, {
                headers: { Authorization: `Bearer ${accessToken}` },
              }),
            "Failed to fetch PNG metadata"
          );

          const buffer = await response.arrayBuffer();
          return await this.extract(buffer);
        } catch (error) {
          return { error: error.message };
        }
      }
    }

    // ===== Cloud Storage Module for OneDrive =====
    class CloudStorageModule {
      constructor() {
        this.currentProvider = new OneDriveProvider();
      }

      async authenticate() {
        return await this.currentProvider.authenticate();
      }

      isAuthenticated() {
        return this.currentProvider?.isAuthenticated || false;
      }

      async getFiles(folderId = "root") {
        return await this.currentProvider.getFiles(folderId);
      }

      async getFolders() {
        return await this.currentProvider.getFolders();
      }

      async deleteFile(fileId) {
        return await this.currentProvider.deleteFile(fileId);
      }

      async disconnect() {
        await this.currentProvider.disconnect();
      }
    }

    class OneDriveProvider {
      constructor() {
        this.name = "onedrive";
        this.apiBase = "https://graph.microsoft.com/v1.0";
        this.isAuthenticated = false;
        this.activeAccount = null;
        this.msalInstance = null;
        this.initMSAL();
      }

      initMSAL() {
        const msalConfig = {
          auth: {
            clientId: "b407fd45-c551-4dbb-9da5-cab3a2c5a949",
            authority: "https://login.microsoftonline.com/common",
            redirectUri: window.location.origin + window.location.pathname,
          },
          cache: { cacheLocation: "sessionStorage" },
        };
        this.msalInstance = new msal.PublicClientApplication(msalConfig);
      }

      async authenticate() {
        try {
          const loginResponse = await this.msalInstance.loginPopup({
            scopes: ["Files.ReadWrite", "User.Read"],
          });
          this.activeAccount = loginResponse.account;
          this.msalInstance.setActiveAccount(this.activeAccount);
          this.isAuthenticated = true;
          return true;
        } catch (error) {
          this.isAuthenticated = false;
          throw new Error(`Authentication failed: ${error.message}`);
        }
      }

      async getAccessToken() {
        if (!this.activeAccount) {
          throw new Error("No active account");
        }

        try {
          const response = await this.msalInstance.acquireTokenSilent({
            scopes: ["Files.ReadWrite"],
            account: this.activeAccount,
          });
          return response.accessToken;
        } catch (silentError) {
          const response = await this.msalInstance.acquireTokenPopup({
            scopes: ["Files.ReadWrite"],
            account: this.activeAccount,
          });
          return response.accessToken;
        }
      }

      async makeApiCall(endpoint, options = {}) {
        const accessToken = await this.getAccessToken();
        const url = `${this.apiBase}${endpoint}`;
        const headers = {
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
          ...options.headers,
        };

        const response = await fetch(url, { ...options, headers });

        if (!response.ok) {
          throw new Error(`API call failed: ${response.statusText}`);
        }

        return await response.json();
      }

      async getFolders() {
        const response = await this.makeApiCall("/me/drive/root/children");
        return response.value
          .filter((item) => item.folder)
          .map((folder) => ({
            id: folder.id,
            name: folder.name,
            type: "folder",
            createdTime: folder.createdDateTime,
            modifiedTime: folder.lastModifiedDateTime,
          }));
      }

      async getFiles(folderId = "root") {
        const allFiles = [];
        let nextLink = null;
        let endpoint =
          folderId === "root"
            ? "/me/drive/root/children"
            : `/me/drive/items/${folderId}/children`;

        do {
          const url = nextLink || endpoint;
          const response = nextLink
            ? await this.makeApiCall(nextLink.replace(this.apiBase, ""))
            : await this.makeApiCall(url);

          const files = response.value
            .filter(
              (item) =>
                item.file &&
                item.file.mimeType &&
                item.file.mimeType.startsWith("image/")
            )
            .map((item) => {
              return {
                id: item.id,
                name: item.name,
                type: "file",
                mimeType: item.file.mimeType,
                size: item.size || 0,
                createdTime: item.createdDateTime,
                modifiedTime: item.lastModifiedDateTime,
                thumbnailUrl: item.thumbnails?.[0]?.large?.url,
                downloadUrl: item["@microsoft.graph.downloadUrl"],
                oneDriveTags: item.tags || [], // OneDrive suggested tags
              };
            });

          allFiles.push(...files);
          nextLink = response["@odata.nextLink"];

          if (this.onProgressCallback) {
            this.onProgressCallback(allFiles.length);
          }
        } while (nextLink);

        return { folders: [], files: allFiles };
      }

      async deleteFile(fileId) {
        await this.makeApiCall(`/me/drive/items/${fileId}`, {
          method: "DELETE",
        });
        return true;
      }

      async disconnect() {
        this.isAuthenticated = false;
        this.activeAccount = null;
        if (this.msalInstance) {
          await this.msalInstance.logoutPopup();
        }
      }
    }

    // ===== Authentication Manager =====
    const authManager = {
      async authenticate() {
        utils.elements.authButton.disabled = true;
        utils.elements.authButton.textContent = "Connecting...";
        this.setStatus("Connecting to OneDrive...", "info");

        try {
          const success = await appState.cloudStorage.authenticate();

          if (success) {
            this.setStatus("✅ Connected to OneDrive!", "success");
            setTimeout(() => {
              utils.showScreen("folder-screen");
              folderManager.loadFolders();
            }, 1000);
          }
        } catch (error) {
          this.setStatus(`Authentication failed: ${error.message}`, "error");
        } finally {
          utils.elements.authButton.disabled = false;
          utils.elements.authButton.textContent = "Connect OneDrive";
        }
      },

      setStatus(message, type) {
        utils.elements.authStatus.textContent = message;
        utils.elements.authStatus.className = `status ${type}`;
      },

      logout() {
        appState.cloudStorage.disconnect();
        utils.showScreen("auth-screen");
        this.setStatus(
          "Click to sign in with your Microsoft account",
          "info"
        );
      },
    };

    // ===== Folder Manager =====
    const folderManager = {
      async loadFolders() {
        utils.elements.folderList.innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; padding: 40px; color: rgba(255, 255, 255, 0.7);">
            <div class="spinner"></div>
            <span>Loading folders...</span>
          </div>
        `;
        try {
          const folders = await appState.cloudStorage.getFolders();
          if (folders.length === 0) {
            utils.elements.folderList.innerHTML = `<p style="text-align:center; color:rgba(255,255,255,0.7);">No folders found in OneDrive.</p>`;
            return;
          }

          // Sort folders by name
          folders.sort((a, b) => a.name.localeCompare(b.name));

          utils.elements.folderList.innerHTML = "";
          folders.forEach((folder) => {
            const div = document.createElement("div");
            div.className = "folder-item";
            div.innerHTML = `
              <svg class="folder-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M3 7a2 2 0 012-2h4.586a1 1 0 01.707.293l1 1A1 1 0 0012.414 6H19a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V7z" />
              </svg>
              <div class="folder-info">
                <div class="folder-name">${folder.name}</div>
                <div class="folder-date">${new Date(
              folder.modifiedTime
            ).toLocaleDateString()}</div>
              </div>
            `;
            div.addEventListener("click", () => {
              this.selectFolder(folder.id, folder.name);
            });
            utils.elements.folderList.appendChild(div);
          });
        } catch (error) {
          utils.showToast(`Failed to load folders: ${error.message}`, "error", true);
        }
      },

      async selectFolder(folderId, folderName) {
        appState.currentFolder.id = folderId;
        appState.currentFolder.name = folderName;
        utils.showScreen("loading-screen");
        appState.metadataExtractor.log(
          `Fetching images from "${folderName}"...`,
          "info"
        );

        try {
          // Subscribe to progress updates
          appState.cloudStorage.currentProvider.onProgressCallback = (count) => {
            utils.updateLoadingProgress(count, 0);
          };

          const { files } = await appState.cloudStorage.getFiles(folderId);
          appState.imageFiles = files.map((file) => ({
            ...file,
            stack: "in", // default stack
            userMetadata: {},
          }));

          // Initialize stacks
          STACK_TYPES.forEach((stack) => {
            appState.stacks[stack] = [];
          });
          appState.imageFiles.forEach((f) => appState.stacks.in.push(f.id));

          // Display first image in "in" stack
          appState.currentImageIndex = 0;
          appState.currentStack = "in";
          updatePillCounters();
          showImageByStack("in", 0);

          utils.showScreen("app-container");
        } catch (error) {
          utils.showToast(
            `Error fetching images: ${error.message}`,
            "error",
            true
          );
          utils.showScreen("folder-screen");
        }
      },
    };

    // ===== Image Display & Navigation =====
    function showImageByStack(stack, index) {
      const ids = appState.stacks[stack];
      if (!ids || ids.length === 0) {
        utils.elements.centerImage.src = "";
        utils.elements.emptyState.classList.remove("hidden");
        return;
      }
      utils.elements.emptyState.classList.add("hidden");
      const fileId = ids[index];
      const file = appState.imageFiles.find((f) => f.id === fileId);
      const img = utils.elements.centerImage;
      utils.setImageSrc(img, file);
      updateDetailsModal(file);
      highlightEdges(index, ids.length);
      updatePillCounters();
    }

    function highlightEdges(currentIndex, total) {
      ["edgeTop", "edgeBottom", "edgeLeft", "edgeRight"].forEach((id) => {
        utils.elements[id].classList.remove("active");
      });
      if (currentIndex > 0) utils.elements.edgeLeft.classList.add("active");
      if (currentIndex < total - 1) utils.elements.edgeRight.classList.add("active");
      // Up/down swipes could navigate stacks, if implemented.
    }

    function updatePillCounters() {
      STACK_TYPES.forEach((stack) => {
        utils.elements[`pill-${stack}`].textContent =
          appState.stacks[stack].length;
        utils.elements[`pill-${stack}`].classList.toggle(
          "active",
          stack === appState.currentStack
        );
        utils.elements[`pill-${stack}`].classList.toggle(
          "visible",
          appState.stacks[stack].length > 0
        );
      });
    }

    // ===== Stack & Swipe Handling =====
    let startX = 0,
      startY = 0;
    let isTouch = false;

    function onPointerDown(e) {
      e.preventDefault();
      isTouch = e.type === "touchstart";
      const point = isTouch ? e.touches[0] : e;
      startX = point.clientX;
      startY = point.clientY;
      appState.isDragging = true;
      utils.elements.centerImage.classList.add("dragging");
    }

    function onPointerMove(e) {
      if (!appState.isDragging) return;
      const point = isTouch ? e.touches[0] : e;
      const dx = point.clientX - startX;
      const dy = point.clientY - startY;
      // Apply simple translation for feedback:
      utils.elements.centerImage.style.transform = `translate(${dx}px, ${dy}px) scale(${appState.currentScale})`;
    }

    function onPointerUp(e) {
      if (!appState.isDragging) return;
      appState.isDragging = false;
      utils.elements.centerImage.classList.remove("dragging");

      const point = isTouch ? (e.changedTouches[0] || e) : e;
      const dx = point.clientX - startX;
      const dy = point.clientY - startY;
      utils.elements.centerImage.style.transform = `translate(0,0) scale(${appState.currentScale})`;

      const absDx = Math.abs(dx);
      const absDy = Math.abs(dy);
      const threshold = 50; // minimum pixels to trigger a swipe

      if (absDx > absDy && absDx > threshold) {
        // left/right swipe → next/previous image in same stack
        const ids = appState.stacks[appState.currentStack];
        const currentIndex = ids.indexOf(
          appState.imageFiles[appState.currentImageIndex].id
        );
        if (dx < 0 && currentIndex < ids.length - 1) {
          // swipe left → next image
          appState.currentImageIndex = currentIndex + 1;
          showImageByStack(appState.currentStack, appState.currentImageIndex);
        } else if (dx > 0 && currentIndex > 0) {
          // swipe right → prev image
          appState.currentImageIndex = currentIndex - 1;
          showImageByStack(appState.currentStack, appState.currentImageIndex);
        }
      } else if (absDy > absDx && absDy > threshold) {
        // up/down swipe → move to another stack
        if (dy < 0) {
          // swipe up → next stack
          cycleStack(1);
        } else {
          // swipe down → prev stack
          cycleStack(-1);
        }
      }
    }

    function cycleStack(delta) {
      const currentIdx = STACK_TYPES.indexOf(appState.currentStack);
      let newIdx = (currentIdx + delta + STACK_TYPES.length) % STACK_TYPES.length;
      const newStack = STACK_TYPES[newIdx];
      appState.currentStack = newStack;
      const ids = appState.stacks[newStack];
      if (ids.length > 0) {
        appState.currentImageIndex = 0;
        showImageByStack(newStack, 0);
      } else {
        // show empty state in that stack
        utils.elements.centerImage.src = "";
        utils.elements.emptyState.classList.remove("hidden");
        updatePillCounters();
      }
    }

    // ===== Zoom & Pan Handling =====
    function onWheel(e) {
      e.preventDefault();
      const scaleAmount = e.deltaY < 0 ? 1.1 : 0.9;
      let newScale = appState.currentScale * scaleAmount;
      newScale = Math.max(appState.minScale, Math.min(newScale, appState.maxScale));
      appState.currentScale = newScale;
      utils.elements.centerImage.style.transform = `scale(${newScale}) translate(${appState.panOffset.x}px, ${appState.panOffset.y}px)`;
    }

    let lastTouchDist = 0;
    function onTouchStart(e) {
      if (e.touches.length === 2) {
        appState.isPinching = true;
        lastTouchDist = getTouchDist(e.touches);
      } else {
        onPointerDown(e);
      }
    }

    function onTouchMove(e) {
      if (appState.isPinching && e.touches.length === 2) {
        const newDist = getTouchDist(e.touches);
        const scaleAmount = newDist / lastTouchDist;
        let newScale = appState.currentScale * scaleAmount;
        newScale = Math.max(appState.minScale, Math.min(newScale, appState.maxScale));
        appState.currentScale = newScale;
        lastTouchDist = newDist;
        utils.elements.centerImage.style.transform = `scale(${newScale}) translate(${appState.panOffset.x}px, ${appState.panOffset.y}px)`;
      } else if (!appState.isPinching) {
        onPointerMove(e);
      }
    }

    function onTouchEnd(e) {
      if (appState.isPinching && e.touches.length < 2) {
        appState.isPinching = false;
      } else {
        onPointerUp(e);
      }
    }

    function getTouchDist(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx * dx + dy * dy);
    }

    // ===== Grid View Handling =====
    function openGridView() {
      appState.grid.stack = appState.currentStack;
      appState.grid.selected = [];
      renderGrid();
      utils.modal.show("grid-modal");
    }

    function closeGridView() {
      utils.modal.hide("grid-modal");
      appState.grid.stack = null;
      appState.grid.selected = [];
    }

    function renderGrid() {
      const stack = appState.grid.stack;
      const ids = appState.stacks[stack];
      utils.elements.gridTitle.textContent = `Grid View – ${STACK_NAMES[stack]}`;
      utils.elements.gridContainer.innerHTML = "";
      ids.forEach((id) => {
        const file = appState.imageFiles.find((f) => f.id === id);
        const div = document.createElement("div");
        div.className = "grid-item";
        div.dataset.id = id;
        const img = document.createElement("img");
        img.className = "grid-image";
        utils.setImageSrc(img, file);
        div.appendChild(img);
        div.addEventListener("click", () => toggleGridSelection(div, id));
        utils.elements.gridContainer.appendChild(div);
      });
      updateGridControls();
    }

    function toggleGridSelection(div, id) {
      if (appState.grid.selected.includes(id)) {
        appState.grid.selected = appState.grid.selected.filter((x) => x !== id);
        div.classList.remove("selected");
      } else {
        appState.grid.selected.push(id);
        div.classList.add("selected");
      }
      updateGridControls();
    }

    function updateGridControls() {
      const count = appState.grid.selected.length;
      utils.elements.selectionText.textContent = `${count} selected`;
      utils.elements.selectAllBtn.textContent = count === appState.stacks[appState.grid.stack].length ? "Unselect All" : "Select All";
      [
        utils.elements.tagSelected,
        utils.elements.moveSelected,
        utils.elements.deleteSelected,
      ].forEach((btn) => {
        btn.classList.toggle("hidden", count === 0);
      });
    }

    function toggleSelectAll() {
      const allIds = appState.stacks[appState.grid.stack];
      if (appState.grid.selected.length === allIds.length) {
        appState.grid.selected = [];
      } else {
        appState.grid.selected = [...allIds];
      }
      // Update DOM classes
      utils.elements.gridContainer.querySelectorAll(".grid-item").forEach((div) => {
        const id = div.dataset.id;
        if (appState.grid.selected.includes(id)) {
          div.classList.add("selected");
        } else {
          div.classList.remove("selected");
        }
      });
      updateGridControls();
    }

    // ===== Bulk Actions in Grid =====
    function moveSelectedInGrid() {
      utils.modal.show("move-modal");
      utils.elements.moveModal.querySelectorAll(".move-option").forEach((btn) => {
        btn.addEventListener("click", () => {
          const targetStack = btn.dataset.stack;
          appState.grid.selected.forEach((id) => {
            moveFileToStack(id, targetStack);
          });
          utils.modal.hide("move-modal");
          closeGridView();
          // Refresh current image if needed
          const currentIds = appState.stacks[appState.currentStack];
          if (!currentIds.includes(appState.imageFiles[appState.currentImageIndex].id)) {
            // If current image was moved, show first in stack
            appState.currentImageIndex = 0;
            if (currentIds.length === 0) {
              utils.elements.centerImage.src = "";
              utils.elements.emptyState.classList.remove("hidden");
            } else {
              showImageByStack(appState.currentStack, 0);
            }
          }
        });
      });
    }

    function deleteSelectedInGrid() {
      utils.modal.show("delete-modal");
      utils.elements.confirmDelete.onclick = async () => {
        for (const id of appState.grid.selected) {
          await moveFileToStack(id, "trash");
        }
        utils.modal.hide("delete-modal");
        closeGridView();
        // Refresh as above
        const currentIds = appState.stacks[appState.currentStack];
        if (!currentIds.includes(appState.imageFiles[appState.currentImageIndex].id)) {
          appState.currentImageIndex = 0;
          if (currentIds.length === 0) {
            utils.elements.centerImage.src = "";
            utils.elements.emptyState.classList.remove("hidden");
          } else {
            showImageByStack(appState.currentStack, 0);
          }
        }
      };
    }

    function applyTagsInGrid() {
      utils.modal.show("tag-modal");
      utils.elements.tagInput.value = "";
      utils.elements.tagSuggestions.innerHTML = "";
      utils.elements.applyTag.onclick = () => {
        const raw = utils.elements.tagInput.value.trim();
        if (raw === "") return;
        const newTags = raw.split(",").map((t) => t.trim()).filter(Boolean);
        appState.grid.selected.forEach((id) => {
          const file = appState.imageFiles.find((f) => f.id === id);
          file.userMetadata.tags = {
            ...file.userMetadata.tags,
            ...(file.userMetadata.tags || {}),
          };
          newTags.forEach((t) => file.userMetadata.tags[t] = true);
          // Persist in IndexedDB if desired:
          appState.userMetadataCache.setUserMetadata(id, file.userMetadata);
        });
        utils.modal.hide("tag-modal");
        closeGridView();
      };
    }

    // ===== Move a single file to a different stack =====
    async function moveFileToStack(fileId, targetStack) {
      // Remove from any existing stack
      STACK_TYPES.forEach((stack) => {
        appState.stacks[stack] = appState.stacks[stack].filter((id) => id !== fileId);
      });
      // Add to target stack
      appState.stacks[targetStack].push(fileId);

      // Update file’s own .stack property
      const file = appState.imageFiles.find((f) => f.id === fileId);
      if (file) file.stack = targetStack;

      // Persist user metadata if needed
      const metadata = await appState.userMetadataCache.getUserMetadata(fileId) || {};
      metadata.stack = targetStack;
      await appState.userMetadataCache.setUserMetadata(fileId, metadata);
    }

    // ===== Details Modal Handling =====
    function updateDetailsModal(file) {
      utils.elements.detailFilename.textContent = file.name;
      utils.elements.detailFilenameLink.href = file.downloadUrl || "#";
      utils.elements.detailDate.textContent = new Date(file.modifiedTime).toLocaleString();
      utils.elements.detailSize.textContent = utils.formatFileSize(file.size);

      // Populate tags section:
      utils.elements.detailTags.innerHTML = "";
      const existingTags = file.userMetadata.tags || {};
      Object.keys(existingTags).forEach((tag) => {
        const span = document.createElement("span");
        span.className = "tag-item";
        span.textContent = tag;
        const removeBtn = document.createElement("button");
        removeBtn.className = "tag-remove";
        removeBtn.innerHTML = "&times;";
        removeBtn.addEventListener("click", () => {
          delete file.userMetadata.tags[tag];
          appState.userMetadataCache.setUserMetadata(file.id, file.userMetadata);
          updateDetailsModal(file);
        });
        span.appendChild(removeBtn);
        utils.elements.detailTags.appendChild(span);
      });
      const addBtn = document.createElement("button");
      addBtn.className = "add-tag-btn";
      addBtn.textContent = "Add Tag";
      addBtn.addEventListener("click", () => {
        const t = prompt("Enter new tag:");
        if (t && t.trim()) {
          file.userMetadata.tags = file.userMetadata.tags || {};
          file.userMetadata.tags[t.trim()] = true;
          appState.userMetadataCache.setUserMetadata(file.id, file.userMetadata);
          updateDetailsModal(file);
        }
      });
      utils.elements.detailTags.appendChild(addBtn);

      // Populate notes:
      utils.elements.detailNotes.value = file.userMetadata.notes || "";
      utils.elements.detailNotes.onchange = () => {
        file.userMetadata.notes = utils.elements.detailNotes.value;
        appState.userMetadataCache.setUserMetadata(file.id, file.userMetadata);
      };

      // Set up star ratings:
      setUpRatings(utils.elements.qualityRating, (rating) => {
        file.userMetadata.qualityRating = rating;
        appState.userMetadataCache.setUserMetadata(file.id, file.userMetadata);
      }, file.userMetadata.qualityRating || 0);

      setUpRatings(utils.elements.contentRating, (rating) => {
        file.userMetadata.contentRating = rating;
        appState.userMetadataCache.setUserMetadata(file.id, file.userMetadata);
      }, file.userMetadata.contentRating || 0);

      // Populate metadata table (PNG tEXt chunks):
      populateMetadataTable(file);
    }

    function setUpRatings(container, callback, initialValue) {
      const stars = container.querySelectorAll(".star");
      stars.forEach((starElem) => {
        const r = parseInt(starElem.dataset.rating, 10);
        starElem.classList.toggle("active", r <= initialValue);
        starElem.onmouseenter = () => highlightTemporary(stars, r);
        starElem.onmouseleave = () => highlightTemporary(stars, initialValue);
        starElem.onclick = () => {
          initialValue = r;
          callback(r);
          highlightTemporary(stars, r);
        };
      });
    }

    function highlightTemporary(stars, upTo) {
      stars.forEach((starElem) => {
        const r = parseInt(starElem.dataset.rating, 10);
        starElem.classList.toggle("active", r <= upTo);
      });
    }

    async function populateMetadataTable(file) {
      const table = utils.elements.metadataTable;
      table.innerHTML = "";
      let pngMeta = await appState.userMetadataCache.getMetadata(
        file.id,
        file.modifiedTime
      );
      if (!pngMeta) {
        pngMeta = await appState.metadataExtractor.fetchMetadata(file);
        if (!pngMeta.error) {
          appState.userMetadataCache.setMetadata(
            file.id,
            file.modifiedTime,
            pngMeta
          );
        }
      }
      if (pngMeta.error) {
        table.innerHTML = `<tr><td class="key-cell">Error</td><td class="value-cell">${pngMeta.error}</td></tr>`;
        return;
      }
      Object.entries(pngMeta).forEach(([key, value]) => {
        if (key === "_dimensions") {
          const dim = value;
          const row = document.createElement("tr");
          row.innerHTML = `<td class="key-cell">Dimensions</td>
                           <td class="value-cell">${dim.width}×${dim.height}</td>`;
          table.appendChild(row);
        } else {
          const row = document.createElement("tr");
          row.innerHTML = `<td class="key-cell">${key}</td>
                           <td class="value-cell">${value}</td>`;
          table.appendChild(row);
        }
      });
      if (table.rows.length === 0) {
        table.innerHTML = `<tr><td class="key-cell">No PNG metadata</td><td class="value-cell"></td></tr>`;
      }
    }

    // ===== Folder → Back Button =====
    function backToFolders() {
      utils.showScreen("folder-screen");
      utils.elements.centerImage.src = "";
      utils.elements.emptyState.classList.add("hidden");
    }

    // ===== DOMContentLoaded & Initialization =====
    window.addEventListener("DOMContentLoaded", async () => {
      // 1) Initialize utility element references
      utils.init();

      // 2) Instantiate CloudStorageModule
      appState.cloudStorage = new CloudStorageModule();

      // 3) Initialize IndexedDB caches & metadata extractor
      appState.userMetadataCache = new UserMetadataCache();
      await appState.userMetadataCache.init();
      appState.metadataExtractor = new SimpleMetadataExtractor();
      appState.metadataExtractor.setStatusLog(utils.elements.statusLog);

      // 4) Hook up authentication buttons
      utils.elements.authButton.addEventListener("click", () => {
        authManager.authenticate();
      });
      utils.elements.logout.addEventListener("click", () => {
        authManager.logout();
      });

      // 5) Hook up navigation within the app
      utils.elements.backButton.addEventListener("click", () => backToFolders());
      utils.elements.detailsButton.addEventListener("click", () =>
        utils.modal.show("details-modal")
      );
      utils.elements.detailsClose.addEventListener("click", () =>
        utils.modal.hide("details-modal")
      );

      // 6) Swipe / pointer / zoom event listeners on the image viewport
      const viewport = utils.elements.imageViewport;
      viewport.addEventListener("mousedown", onPointerDown);
      viewport.addEventListener("mousemove", onPointerMove);
      viewport.addEventListener("mouseup", onPointerUp);
      viewport.addEventListener("mouseleave", onPointerUp);
      viewport.addEventListener("touchstart", onTouchStart, { passive: false });
      viewport.addEventListener("touchmove", onTouchMove, { passive: false });
      viewport.addEventListener("touchend", onTouchEnd);
      viewport.addEventListener("wheel", onWheel, { passive: false });

      // 7) Pill counter click to switch stacks
      STACK_TYPES.forEach((stack) => {
        utils.elements[`pill-${stack}`].addEventListener("click", () => {
          if (appState.stacks[stack].length > 0) {
            appState.currentStack = stack;
            appState.currentImageIndex = 0;
            showImageByStack(stack, 0);
          }
        });
      });

      // 8) Open Grid View
      utils.elements.centerImage.addEventListener("dblclick", openGridView);
      utils.elements.closeGrid.addEventListener("click", closeGridView);
      utils.elements.selectAllBtn.addEventListener("click", toggleSelectAll);
      utils.elements.moveSelected.addEventListener("click", moveSelectedInGrid);
      utils.elements.deleteSelected.addEventListener("click", deleteSelectedInGrid);
      utils.elements.tagSelected.addEventListener("click", applyTagsInGrid);
      utils.elements.cancelMove.addEventListener("click", () =>
        utils.modal.hide("move-modal")
      );
      utils.elements.cancelDelete.addEventListener("click", () =>
        utils.modal.hide("delete-modal")
      );
      utils.elements.cancelTag.addEventListener("click", () =>
        utils.modal.hide("tag-modal")
      );

      // 9) Show initial auth screen
      utils.showScreen("auth-screen");
    });
  </script>
</body>
</html>
