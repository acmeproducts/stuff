<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>voice reader â€” mobile v11</title>
<style>
  :root{
    --bg:#0b0f14; --panel:#0f172a; --text:#e5e7eb; --muted:#9aa4b2; --border:#1f2937; --accent:#3b82f6;
    --radius:14px; --pad:14px; --maxw:440px;
  }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;height:100%;}
  .app{min-height:100svh; display:flex; flex-direction:column; align-items:center;}

  /* Top tabs */
  .tabs-top{position:sticky; top:0; left:0; right:0; z-index:10;
            backdrop-filter:saturate(120%) blur(8px); background:rgba(15,23,42,.92);
            border-bottom:1px solid var(--border); width:100%; display:flex; justify-content:center;
            padding:calc(env(safe-area-inset-top) + 6px) var(--pad) 8px;}
  .tabs-top .bar{width:100%; max-width:var(--maxw); display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px;}
  .tabbtn{appearance:none; border:1px solid var(--border); background:#0b1220; color:#e5e7eb;
          border-radius:12px; padding:10px; font-weight:700; min-height:44px;}
  .tabbtn.active{background:#3b82f6; border-color:#2563eb;}

  /* Screens */
  .screen{width:100%; max-width:var(--maxw); padding:12px var(--pad) var(--pad);
          box-sizing:border-box; flex:1; display:flex; flex-direction:column; gap:12px; min-height:0;}
  .card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
        padding:12px; display:flex; flex-direction:column; gap:12px; flex:1; min-height:0;}

  /* Controls */
  .btn{appearance:none; border:1px solid var(--border); background:#111827; color:#e5e7eb;
       border-radius:16px; padding:14px 18px; font-weight:800; font-size:16px;
       width:100%; touch-action:manipulation; min-height:48px;}
  .btn.primary{background:#3b82f6; border-color:#2563eb;}
  .btn.toggle{max-width:160px;}
  .btn.small{padding:10px 12px; font-weight:700; min-height:40px; width:auto;}
  .row{display:flex; gap:10px; align-items:center; flex-wrap:nowrap;}
  .input, .paste{width:100%; background:#0b1220; border:1px solid var(--border); color:#e5e7eb;
                 border-radius:14px; padding:14px; font-size:16px; box-sizing:border-box;}
  .paste{min-height:180px; resize:vertical; flex:1; overflow:auto;}
  .display{white-space:pre-wrap; background:#0b1220; border:1px solid var(--border);
           border-radius:14px; padding:12px; min-height:140px; flex:1; overflow:auto; position:relative;}
  .slider{width:100%;}
  
  /* Toggle switches */
  .toggle-switch{display:flex; align-items:center; gap:8px; padding:8px; background:#0b1220; 
                 border:1px solid var(--border); border-radius:12px;}
  .toggle-switch label{flex:1; font-weight:600;}
  .toggle-switch input[type="checkbox"]{appearance:none; width:48px; height:28px; background:#374151;
                                        border-radius:14px; position:relative; cursor:pointer; transition:background 0.2s;}
  .toggle-switch input[type="checkbox"]:checked{background:#3b82f6;}
  .toggle-switch input[type="checkbox"]::before{content:''; position:absolute; width:24px; height:24px;
                                                 border-radius:50%; background:white; top:2px; left:2px;
                                                 transition:transform 0.2s;}
  .toggle-switch input[type="checkbox"]:checked::before{transform:translateX(20px);}
  
  /* Radio buttons for API sources */
  .radio-group{display:flex; flex-direction:column; gap:8px;}
  .radio-option{display:flex; align-items:center; gap:8px; padding:8px; background:#0b1220;
                border:1px solid var(--border); border-radius:12px; cursor:pointer;}
  .radio-option:has(input:checked){background:#1e293b; border-color:#3b82f6;}
  .radio-option input[type="radio"]{appearance:none; width:20px; height:20px; border:2px solid var(--border);
                                    border-radius:50%; position:relative; cursor:pointer;}
  .radio-option input[type="radio"]:checked{border-color:#3b82f6;}
  .radio-option input[type="radio"]:checked::before{content:''; position:absolute; width:10px; height:10px;
                                                     background:#3b82f6; border-radius:50%; top:3px; left:3px;}
  .radio-option label{flex:1; cursor:pointer; font-weight:600;}
  
  /* API Key section */
  .api-section{background:#0b1220; border:1px solid var(--border); border-radius:12px; padding:12px;}
  .api-section h3{margin:0 0 8px 0; font-size:14px; color:var(--muted);}
  .api-key-input{display:flex; gap:8px; margin-bottom:8px;}
  .api-key-input input{flex:1; font-size:14px; padding:10px;}
  .api-key-input button{min-height:36px; padding:8px 12px; font-size:14px;}
  
  /* Modal/Popup */
  .modal{display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8);
         z-index:100; align-items:center; justify-content:center; padding:20px;}
  .modal.show{display:flex;}
  .modal-content{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius);
                 padding:20px; max-width:320px; width:100%;}
  .modal-content h3{margin:0 0 16px 0;}
  .modal-buttons{display:flex; gap:10px; margin-top:16px;}
  .modal-buttons button{flex:1;}
  
  /* Copy button */
  .copy-btn{position:absolute; top:8px; right:8px; padding:6px 12px; font-size:12px; min-height:32px;}
  
  /* Status footer */
  .statusbar{position:sticky; bottom:0; left:0; right:0; width:100%;
             display:flex; justify-content:center; pointer-events:none; margin-top:8px;}
  .statusbar .inner{pointer-events:auto; width:100%; max-width:var(--maxw); margin:0 var(--pad);
                    background:#0b1220; border:1px solid var(--border); border-radius:12px;
                    padding:8px 12px; color:#9aa4b2; font-size:12px;}
</style>
</head>
<body>
<div class="app">
  <!-- TOP TABS -->
  <div class="tabs-top">
    <div class="bar">
      <button id="tab-url" class="tabbtn active" type="button">URL</button>
      <button id="tab-search" class="tabbtn" type="button">search</button>
      <button id="tab-aloud" class="tabbtn" type="button">aloud</button>
    </div>
  </div>

  <!-- URL TAB -->
  <div id="url-screen" class="screen">
    <div class="card">
      <div class="toggle-switch">
        <label for="transcribe-toggle">Transcribe</label>
        <input type="checkbox" id="transcribe-toggle" checked>
      </div>
      <div class="toggle-switch">
        <label for="readout-toggle">Read Out Loud</label>
        <input type="checkbox" id="readout-toggle" checked>
      </div>
      
      <div class="row">
        <input id="url-input" class="input" type="url" placeholder="Enter or paste URLâ€¦">
        <button id="url-paste-btn" class="btn small" type="button">Paste</button>
      </div>
      
      <div id="transcript-display" class="display" style="display:none;">
        <button id="copy-transcript" class="btn small copy-btn" type="button">Copy</button>
        <div id="transcript-text"></div>
      </div>
    </div>
  </div>

  <!-- SEARCH -->
  <div id="search-screen" class="screen" style="display:none;">
    <div class="card">
      <!-- API Keys Section -->
      <div class="api-section">
        <h3>API Configuration</h3>
        
        <div class="radio-group">
          <div class="radio-option">
            <input type="radio" id="source-gemini" name="api-source" value="gemini">
            <label for="source-gemini">Gemini</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="source-perplexity" name="api-source" value="perplexity" checked>
            <label for="source-perplexity">Perplexity</label>
          </div>
          <div class="radio-option">
            <input type="radio" id="source-venice" name="api-source" value="venice">
            <label for="source-venice">Venice.ai</label>
          </div>
        </div>
        
        <div style="margin-top:12px;">
          <div class="api-key-input">
            <input id="api-key-input" type="password" placeholder="Enter API key for selected sourceâ€¦">
            <button id="save-api-key" class="btn small" type="button">Save</button>
          </div>
          <div style="font-size:12px; color:var(--muted);">Keys stored locally in browser</div>
        </div>
      </div>
      
      <button id="ptt" class="btn primary" title="click to talk" type="button">Push to Talk</button>

      <form id="search-form" action="#" method="get" autocomplete="off" style="display:flex; flex-direction:column; gap:12px;">
        <input id="q" class="input" type="search" inputmode="search" enterkeyhint="search" aria-label="search query"
               placeholder="enter query and press Enterâ€¦">
        <div class="row">
          <button id="search-toggle" class="btn toggle" type="button">pause</button>
          <input id="search-rate" class="slider" type="range" min="0.5" max="3.0" step="0.1" value="1.2" aria-label="speech rate">
        </div>
      </form>

      <div id="search-display" class="display" aria-live="polite" aria-atomic="true"></div>
    </div>
  </div>

  <!-- ALOUD -->
  <div id="aloud-screen" class="screen" style="display:none;">
    <div class="card">
      <div class="row">
        <button id="aloud-toggle" class="btn toggle" type="button">pause</button>
        <input id="aloud-rate" class="slider" type="range" min="0.5" max="3.0" step="0.1" value="1.2" aria-label="speech rate">
        <button id="paste-btn" class="btn small" title="Paste from clipboard" type="button">Paste</button>
      </div>
      <textarea id="pastebox" class="paste" placeholder="paste text hereâ€¦"></textarea>
    </div>
  </div>

  <!-- Footer status -->
  <div class="statusbar"><div id="status" class="inner">ready</div></div>
</div>

<!-- PTT Listening Modal -->
<div id="ptt-modal" class="modal">
  <div class="modal-content">
    <h3>ðŸŽ¤ Listening...</h3>
    <div id="ptt-interim" style="min-height:60px; color:var(--muted); font-style:italic;"></div>
    <div class="modal-buttons">
      <button id="ptt-cancel" class="btn" type="button">Cancel</button>
      <button id="ptt-ok" class="btn primary" type="button">OK</button>
    </div>
  </div>
</div>

<script>
(function(){
  'use strict';
  const $ = s => document.querySelector(s);
  const statusEl=$('#status'); const setStatus=t=>statusEl.textContent=t;

  /* Tabs */
  const tabUrl=$('#tab-url'), tabSearch=$('#tab-search'), tabAloud=$('#tab-aloud');
  const urlScreen=$('#url-screen'), searchScreen=$('#search-screen'), aloudScreen=$('#aloud-screen');
  
  function showTab(tab){
    [tabUrl, tabSearch, tabAloud].forEach(t => t.classList.remove('active'));
    [urlScreen, searchScreen, aloudScreen].forEach(s => s.style.display='none');
    
    if(tab === 'url'){ tabUrl.classList.add('active'); urlScreen.style.display='flex'; }
    else if(tab === 'search'){ tabSearch.classList.add('active'); searchScreen.style.display='flex'; }
    else if(tab === 'aloud'){ tabAloud.classList.add('active'); aloudScreen.style.display='flex'; }
  }
  
  tabUrl.addEventListener('click', ()=>showTab('url'));
  tabSearch.addEventListener('click', ()=>showTab('search'));
  tabAloud.addEventListener('click', ()=>showTab('aloud'));

  /* -------- Robust Reader (state machine + chunking + boundary fallback) ------- */
  class Reader {
    constructor(){
      this.state = 'idle';
      this.text  = '';
      this.rate  = 1.2;
      this.idx   = 0;
      this._u    = null;
      this._interrupted = false;
      this._boundarySeen = false;
    }

    setRate(v){
      this.rate = v;
      if(this.state === 'playing'){
        this._interrupted = true;
        speechSynthesis.cancel();
        this._startChunk();
        this._interrupted = false;
      }
    }

    setText(t){
      this.text = String(t || '');
      this.idx  = 0;
      if(!this.text) { this.stop(); return; }
      this.play();
    }

    play(){
      if(!this.text){ return; }
      if(this.state === 'playing'){ return; }
      this.state = 'playing';
      this._startChunk();
      syncUI();
    }

    pause(){
      if(this.state !== 'playing') return;
      this.state = 'paused';
      this._interrupted = true;
      try { speechSynthesis.cancel(); } catch(_) {}
      setStatus('paused');
      syncUI();
    }

    toggle(){
      if(this.state === 'playing'){ this.pause(); }
      else if(this.state === 'paused'){ this.play(); }
      else if(this.state === 'idle' && this.text){ this.play(); }
    }

    stop(){
      this.state = 'idle';
      this.text  = '';
      this.idx   = 0;
      this._interrupted = false;
      try { speechSynthesis.cancel(); } catch(_) {}
      setStatus('done');
      syncUI();
    }

    _startChunk(){
      if(this.state !== 'playing'){ return; }
      if(this.idx >= this.text.length){ this.stop(); return; }

      const end = this._findNextBreak(this.idx);
      const chunk = this.text.slice(this.idx, end);
      if(!chunk){ this.stop(); return; }

      setStatus(`speaking ${Math.round((this.idx/this.text.length)*100)}%`);
      this._boundarySeen = false;

      const u = new SpeechSynthesisUtterance(chunk);
      u.rate = this.rate;
      u.pitch = 1.0;
      u.volume = 1.0;
      this._u = u;

      u.onboundary = () => { this._boundarySeen = true; };
      u.onend = () => {
        if(this._interrupted){ this._interrupted = false; return; }
        this._u = null;
        this.idx = end;
        if(this.state === 'playing'){ this._startChunk(); }
        else { setStatus('idle'); }
      };
      u.onerror = (e) => {
        this._u = null;
        setStatus('tts error');
        if(this.state === 'playing'){
          this.idx = end;
          this._startChunk();
        }
      };

      speechSynthesis.speak(u);
    }

    _findNextBreak(from){
      const maxSpan = 280;
      const hardCap = Math.min(this.text.length, from + maxSpan);
      const slice = this.text.slice(from, hardCap);
      const m = /[\.!?â€¦](?:\s|$)|\n{1,2}/g;
      let match, lastBreak = -1;
      while((match = m.exec(slice)) !== null){
        lastBreak = match.index + match[0].length;
      }
      if(lastBreak > 0) return from + lastBreak;
      return hardCap;
    }
  }

  const tts = new Reader();

  /* --- UI sync --- */
  function syncUI(){
    const label =
      (tts.state === 'paused') ? 'go' :
      (tts.state === 'playing') ? 'pause' : 'pause';
    $('#search-toggle').textContent = label;
    $('#aloud-toggle').textContent  = label;
  }
  setInterval(syncUI, 300);

  /* -------- API Key Management -------- */
  const API_KEYS_KEY = 'voice_reader_api_keys';
  
  function getApiKeys(){
    try{
      const stored = localStorage.getItem(API_KEYS_KEY);
      return stored ? JSON.parse(stored) : {};
    }catch(e){ return {}; }
  }
  
  function saveApiKey(source, key){
    const keys = getApiKeys();
    keys[source] = key;
    localStorage.setItem(API_KEYS_KEY, JSON.stringify(keys));
  }
  
  function getActiveSource(){
    const checked = document.querySelector('input[name="api-source"]:checked');
    return checked ? checked.value : 'perplexity';
  }
  
  $('#save-api-key').addEventListener('click', ()=>{
    const source = getActiveSource();
    const key = $('#api-key-input').value.trim();
    if(key){
      saveApiKey(source, key);
      setStatus(`${source} API key saved`);
      $('#api-key-input').value = '';
    }
  });
  
  // Load saved API key when source changes
  document.querySelectorAll('input[name="api-source"]').forEach(radio => {
    radio.addEventListener('change', ()=>{
      const source = getActiveSource();
      const keys = getApiKeys();
      $('#api-key-input').value = keys[source] || '';
      $('#api-key-input').placeholder = `Enter API key for ${source}â€¦`;
    });
  });

  /* -------- URL TAB -------- */
  const urlInput = $('#url-input');
  const urlPasteBtn = $('#url-paste-btn');
  const transcribeToggle = $('#transcribe-toggle');
  const readoutToggle = $('#readout-toggle');
  const transcriptDisplay = $('#transcript-display');
  const transcriptText = $('#transcript-text');
  const copyTranscript = $('#copy-transcript');
  
  async function fetchAndProcessUrl(url){
    if(!url) return;
    setStatus('fetching URL...');
    
    try{
      const response = await fetch(url);
      const html = await response.text();
      
      // Basic text extraction (you can enhance this)
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      
      // Remove script and style elements
      doc.querySelectorAll('script, style').forEach(el => el.remove());
      
      const text = doc.body.textContent || '';
      const cleaned = text.replace(/\s+/g, ' ').trim();
      
      if(transcribeToggle.checked){
        transcriptDisplay.style.display = 'block';
        transcriptText.textContent = cleaned;
      }
      
      if(readoutToggle.checked){
        tts.setText(cleaned);
      }
      
      setStatus('URL processed');
    }catch(e){
      setStatus('error fetching URL: ' + e.message);
    }
  }
  
  urlPasteBtn.addEventListener('click', async ()=>{
    try{
      if(navigator.clipboard && navigator.clipboard.readText){
        const text = await navigator.clipboard.readText();
        if(text){
          urlInput.value = text;
          fetchAndProcessUrl(text);
        }
      }
    }catch(e){ setStatus('clipboard blocked'); }
  });
  
  urlInput.addEventListener('keydown', (e)=>{
    if(e.key === 'Enter'){
      e.preventDefault();
      fetchAndProcessUrl(urlInput.value.trim());
    }
  });
  
  copyTranscript.addEventListener('click', async ()=>{
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(transcriptText.textContent);
        setStatus('transcript copied');
      }
    }catch(e){ setStatus('copy failed'); }
  });

  /* -------- SEARCH wiring -------- */
  const form=$('#search-form'), q=$('#q'), sDisp=$('#search-display');
  const sToggle=$('#search-toggle'), sRate=$('#search-rate');

  form.addEventListener('submit', (e)=>{ e.preventDefault(); runQuery(q.value.trim()); });
  q.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); form.requestSubmit ? form.requestSubmit() : form.dispatchEvent(new Event('submit',{cancelable:true})); } });
  sToggle.addEventListener('click', ()=>tts.toggle());
  sRate.addEventListener('input', ()=>tts.setRate(parseFloat(sRate.value)));

  function renderResult(obj){
    const text = [obj.title?('** '+obj.title+' **\n'):'', obj.extract||'', obj._src?('\n['+obj._src+(obj.url?(' | '+obj.url):'')+']'):(obj.url?('\n'+obj.url):'')].join('').trim();
    sDisp.textContent = text || 'no result';
    if(text){ tts.setText(text); } else { setStatus(''); }
  }

  async function runQuery(raw){
    const v=(raw||'').trim(); if(!v) return;
    const res = await fetchFromSource(v);
    renderResult(res);
  }
  
  /* -------- API Source Integration -------- */
  async function fetchFromSource(query){
    const source = getActiveSource();
    const keys = getApiKeys();
    const apiKey = keys[source];
    
    if(!apiKey){
      return { title:'API Key Required', extract:`Please add an API key for ${source} in the settings above.`, _src:source };
    }
    
    try{
      setStatus(`querying ${source}...`);
      
      if(source === 'gemini'){
        return await queryGemini(query, apiKey);
      } else if(source === 'perplexity'){
        return await queryPerplexity(query, apiKey);
      } else if(source === 'venice'){
        return await queryVenice(query, apiKey);
      }
    }catch(e){
      return { title:'Error', extract:'Query failed: ' + e.message, _src:source };
    }
  }
  
  async function queryGemini(query, apiKey){
    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:gene