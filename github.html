<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GitHub Tablet Editor</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }
    header {
      padding: 10px;
      background: #333;
      color: #fff;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    header input, header select {
      font-size: 1em;
      padding: 4px;
    }
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
    }
    .row {
      display: flex;
      flex-direction: row;
      gap: 10px;
      flex: 1;
    }
    .column {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    textarea {
      width: 100%;
      resize: none;
      font-family: monospace;
      font-size: 14px;
    }
    .collapsed {
      height: 24px;
      overflow: hidden;
    }
    .expanded-10 {
      height: 200px;
    }
    .expanded-20 {
      height: 400px;
    }
    .button-row {
      display: flex;
      gap: 10px;
      margin: 5px 0;
      flex-wrap: wrap;
    }
    button {
      font-size: 1em;
      padding: 6px 12px;
    }
    #diffModal, #commitModal {
      position: fixed;
      top: 10%;
      left: 10%;
      width: 80%;
      max-height: 50%;
      overflow-y: auto;
      background: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      display: none;
      flex-direction: column;
    }
    .modal-header {
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .toast {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: #444;
      color: #fff;
      padding: 8px 16px;
      border-radius: 4px;
      display: none;
    }
    #debugOutput {
      position: fixed;
      bottom: 0;
      width: 100%;
      max-height: 100px;
      overflow-y: auto;
      background: #000;
      color: #0f0;
      font-size: 12px;
      padding: 5px;
    }
    @media (orientation: landscape) {
      .main {
        flex-direction: row;
      }
      .column {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <header>
    <input id="userInput" placeholder="GitHub Username" value="acmeproducts">
    <select id="repoSelect"><option>Loading...</option></select>
    <input id="searchInput" placeholder="Search files...">
  </header>
  <div class="main">
    <div class="row">
      <div class="column">
        <textarea id="originalBox" class="collapsed"></textarea>
        <div class="button-row">
          <button id="copyBtn">Copy</button>
          <button id="previewBtn">Preview</button>
        </div>
      </div>
      <div class="column">
        <div class="button-row">
          <button id="pasteBtn">Paste</button>
          <button id="diffBtn">Diff</button>
          <button id="commitBtn">Commit</button>
        </div>
        <textarea id="updatedBox" class="collapsed"></textarea>
      </div>
    </div>
  </div>

  <div id="diffModal">
    <div class="modal-header">
      Diff Output
      <button onclick="document.getElementById('diffModal').style.display='none'">X</button>
    </div>
    <pre id="diffOutput"></pre>
  </div>

  <div id="commitModal">
    <div class="modal-header">
      Commit Progress
      <button onclick="document.getElementById('commitModal').style.display='none'">X</button>
    </div>
    <ul id="commitSteps"></ul>
  </div>

  <div class="toast" id="toastBox">Copied</div>
  <pre id="debugOutput"></pre>

  <script>
    const DEFAULT_USER = "acmeproducts";
    const DEFAULT_REPO = "stuff";
    const PAT_KEY = "github_pat";

    let githubToken = localStorage.getItem(PAT_KEY);
    if (!githubToken) {
      githubToken = prompt("Enter GitHub Personal Access Token:");
      if (githubToken) localStorage.setItem(PAT_KEY, githubToken);
    }

    const userInput = document.getElementById('userInput');
    const repoSelect = document.getElementById('repoSelect');
    const searchInput = document.getElementById('searchInput');
    const originalBox = document.getElementById('originalBox');
    const updatedBox = document.getElementById('updatedBox');
    const toastBox = document.getElementById('toastBox');
    const debugOutput = document.getElementById('debugOutput');

    function debug(msg) {
      debugOutput.textContent += "[DEBUG] " + msg + "\n";
      debugOutput.scrollTop = debugOutput.scrollHeight;
    }

    function toast(msg) {
      toastBox.textContent = msg;
      toastBox.style.display = 'block';
      setTimeout(() => toastBox.style.display = 'none', 2000);
    }

    async function githubGet(url) {
      debug("GET " + url);
      const resp = await fetch(url, {
        headers: { Authorization: "token " + githubToken }
      });
      if (!resp.ok) throw new Error(await resp.text());
      return await resp.json();
    }

    async function loadRepos() {
      const user = userInput.value;
      const data = await githubGet("https://api.github.com/user/repos?per_page=100");
      const options = data.filter(r => r.owner.login === user).map(r => `<option>${r.name}</option>`).join("");
      repoSelect.innerHTML = options;
      repoSelect.value = DEFAULT_REPO;
    }

    async function searchFiles() {
      const repo = repoSelect.value;
      const user = userInput.value;
      const data = await githubGet(`https://api.github.com/repos/${user}/${repo}/git/trees/HEAD?recursive=1`);
      const files = data.tree.filter(f => f.type === "blob").map(f => f.path);
      const input = searchInput.value.toLowerCase();
      const match = files.find(f => f.toLowerCase().includes(input));
      if (match) {
        const content = await githubGet(`https://api.github.com/repos/${user}/${repo}/contents/${match}`);
        const decoded = atob(content.content.replace(/\n/g, ''));
        originalBox.value = decoded;
        originalBox.className = "expanded-10";
        toast("File loaded: " + match);
      }
    }

    searchInput.addEventListener('input', () => {
      if (searchInput.value.length > 2) searchFiles().catch(e => debug(e.message));
    });

    document.getElementById('copyBtn').addEventListener('click', () => {
      navigator.clipboard.writeText(originalBox.value);
      toast("Copied");
    });

    document.getElementById('pasteBtn').addEventListener('click', async () => {
      const text = await navigator.clipboard.readText();
      updatedBox.value = text;
      updatedBox.className = "expanded-20";
      updatedBox.focus();
      toast("Pasted");
    });

    document.getElementById('previewBtn').addEventListener('click', () => {
      const w = window.open();
      w.document.write(`<pre>${originalBox.value.replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}</pre>`);
      w.document.close();
    });

    document.getElementById('diffBtn').addEventListener('click', () => {
      const a = originalBox.value.split("\n");
      const b = updatedBox.value.split("\n");
      let out = "";
      for (let i = 0; i < Math.max(a.length, b.length); i++) {
        if (a[i] !== b[i]) {
          out += `- ${a[i]||''}\n+ ${b[i]||''}\n`;
        }
      }
      document.getElementById('diffOutput').textContent = out || "No changes.";
      document.getElementById('diffModal').style.display = 'flex';
    });

    loadRepos().catch(e => debug(e.message));
  </script>
</body>
</html>
