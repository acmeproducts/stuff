
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Orbital8 - Metadata with Debug Logs</title>
<style>
  body { font-family: Arial, sans-serif; background: #121212; color: #fff; margin: 0; padding: 0; }
  .container { padding: 20px; max-width: 800px; margin: auto; }
  h1 { font-size: 24px; margin-bottom: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #444; padding: 8px; word-break: break-word; }
  th { background: #222; }
  .copy-btn { background: #f59e0b; border: none; color: #000; padding: 4px 8px; cursor: pointer; }
  #debug-log { background: #000; color: #0f0; font-family: monospace; padding: 10px; max-height: 200px; overflow: auto; }
</style>
</head>
<body>
<div class="container">
  <h1>Orbital8 - Metadata Viewer with Debug Logs</h1>
  <table id="metadata-table"></table>
  <div id="debug-log"></div>
</div>
<button id="signin-button" onclick="signIn()" style="position:fixed;top:10px;right:10px;z-index:999;display:none;">Sign In with Google</button>
<script src="https://apis.google.com/js/api.js"></script>
<script>
function log(msg) {
  const logDiv = document.getElementById('debug-log');
  logDiv.innerHTML += msg + '<br>';
  logDiv.scrollTop = logDiv.scrollHeight;
}

function initGoogleAPI() {
  gapi.load('client:auth2', () => {
    gapi.client.init({
      clientId: 'YOUR_CLIENT_ID.apps.googleusercontent.com',
      discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
      scope: 'https://www.googleapis.com/auth/drive.readonly'
    }).then(() => {
      const authInstance = gapi.auth2.getAuthInstance();
      if (authInstance.isSignedIn.get()) {
        const user = authInstance.currentUser.get();
        const accessToken = user.getAuthResponse().access_token;
        localStorage.setItem('google_access_token', accessToken);
        document.getElementById('signin-button').style.display = 'none';
        startMetadataExtraction();
      } else {
        document.getElementById('signin-button').style.display = 'block';
      }
    });
  });
}

function signIn() {
  const authInstance = gapi.auth2.getAuthInstance();
  authInstance.signIn().then(() => {
    const user = authInstance.currentUser.get();
    const accessToken = user.getAuthResponse().access_token;
    localStorage.setItem('google_access_token', accessToken);
    document.getElementById('signin-button').style.display = 'none';
    startMetadataExtraction();
  });
}

async function startMetadataExtraction() {
  const currentFile = appState.imageFiles[appState.currentImageIndex];
  if (!currentFile || !currentFile.id) {
    log('⚠️ No current file.');
    return;
  }
  log('🚀 Starting extraction for file: ' + currentFile.name);

  const accessToken = localStorage.getItem('google_access_token');
  if (!accessToken) {
    log('🚨 No access token found.');
    return;
  }

  try {
    log('🔗 Requesting binary data from Google Drive API...');
    const response = await gapi.client.request({
      path: `/drive/v3/files/${currentFile.id}`,
      method: 'GET',
      params: { alt: 'media' },
      headers: { Authorization: `Bearer ${accessToken}` },
      responseType: 'arraybuffer'
    });
    const arrayBuffer = response.body;
    log('📦 Binary data received. Length: ' + (arrayBuffer ? arrayBuffer.byteLength : 0));

    log('🔍 Parsing metadata from PNG...');
    const metadata = extractPNGMetadata(arrayBuffer);
    log('📋 Extracted Metadata: ' + JSON.stringify(metadata));

    log('💾 Saving metadata to appData...');
    const appData = JSON.parse(localStorage.getItem('appData') || '{}');
    appData[currentFile.name] = { metadata };
    localStorage.setItem('appData', JSON.stringify(appData));
    log('✅ Metadata saved to appData.');

    log('📦 Retrieving metadata from appData for display...');
    const storedData = JSON.parse(localStorage.getItem('appData') || '{}');
    const storedMetadata = storedData[currentFile.name].metadata;
    log('📄 Stored Metadata: ' + JSON.stringify(storedMetadata));

    displayMetadata(storedMetadata);
  } catch (err) {
    log('❌ Error: ' + err.message);
  }
}

function extractPNGMetadata(arrayBuffer) {
  const view = new DataView(arrayBuffer);
  const metadata = {};
  let pos = 8;
  while (pos < arrayBuffer.byteLength - 12) {
    const length = view.getUint32(pos, false);
    pos += 4;
    let chunkType = '';
    for (let i = 0; i < 4; i++) chunkType += String.fromCharCode(view.getUint8(pos + i));
    pos += 4;
    log('🔎 Chunk: ' + chunkType + ', Length: ' + length);
    if (chunkType === 'tEXt') {
      let keyword = '', value = '', nullFound = false;
      for (let i = 0; i < length; i++) {
        const byte = view.getUint8(pos + i);
        if (!nullFound) {
          if (byte === 0) nullFound = true;
          else keyword += String.fromCharCode(byte);
        } else {
          value += String.fromCharCode(byte);
        }
      }
      log('✅ Found tEXt chunk - Key: ' + keyword + ', Value: ' + value);
      if (keyword && value) metadata[keyword] = value;
    }
    pos += length + 4;
  }
  return metadata;
}

function displayMetadata(metadata) {
  const table = document.getElementById('metadata-table');
  table.innerHTML = '';
  Object.entries(metadata).forEach(([key, value]) => {
    const row = document.createElement('tr');
    row.innerHTML = '<td>' + key + '</td><td>' + value + (['prompt', 'Seed', 'Negative_Prompt'].includes(key) ?
      ' <button class="copy-btn" onclick="navigator.clipboard.writeText(\'' + value.replace(/'/g, "\'") + '\')">Copy</button>' : '') + '</td>';
    table.appendChild(row);
  });
  log('🟩 Metadata displayed in table.');
}

window.addEventListener('load', () => {
  initGoogleAPI();
});
</script>
</body>
</html>
