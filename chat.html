<!DOCTYPE html>
<html lang="en" translate="no">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport">
    <meta name="google" content="notranslate">
    <meta name="googlebot" content="notranslate">
    <title>Chat Tabletop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <style>
        :root {
            --bubble-local-bg: #eff6ff;
            --bubble-local-text: #1f2937;
            --bubble-peer-bg: #ffffff;
            --bubble-peer-text: #0f172a;
            --bubble-font-size: 14px;
            --chat-bg-color: #ffffff;
        }
        body {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            min-height: 100dvh;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .modal { transition: opacity 0.2s ease, visibility 0.2s ease; }
        .modal.invisible { opacity: 0; visibility: hidden; pointer-events: none; }
        .modal.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .modal-content { transition: transform 0.2s ease; }
        .scale-in { transform: scale(1); }
        .scale-out { transform: scale(0.98); }
        .tabletop-view {
            position: relative;
            display: grid;
            grid-template-rows: minmax(0, 1fr) auto minmax(0, 1fr);
            height: 100dvh;
            gap: 12px;
        }
        .tabletop-half {
            display: flex;
            align-items: stretch;
            justify-content: center;
            padding: 16px;
            min-height: 0;
        }
        .tabletop-north { transform: rotate(180deg); }
        .client-shell {
            width: min(92%, 520px);
            height: 100%;
            border-radius: 28px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(255, 255, 255, 0.9);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .tabletop-transcript {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background-color: var(--chat-bg-color);
        }
        .tabletop-composer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-top: 1px solid rgba(226, 232, 240, 0.9);
            background: rgba(255, 255, 255, 0.98);
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        .tabletop-input {
            flex: 1;
            min-width: 0;
            padding: 8px 12px;
            border-radius: 999px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            background: white;
            font-size: 0.95rem;
        }
        .tabletop-talk {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 999px;
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.95), rgba(59, 130, 246, 0.95));
            color: white;
            border: none;
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.25);
        }
        .tabletop-talk:active { transform: scale(0.98); }
        .message-row {
            display: flex;
        }
        .message-row.peer { justify-content: flex-start; }
        .message-row.local { justify-content: flex-end; }
        .message-bubble {
            max-width: 90%;
            border-radius: 20px;
            padding: 10px 14px;
            border: 1px solid rgba(226, 232, 240, 0.9);
            box-shadow: 0 10px 24px rgba(15, 23, 42, 0.08);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            font-size: var(--bubble-font-size, 0.95rem);
        }
        .message-bubble.latest-bubble { border-width: 3px; font-weight: 600; }
        .message-bubble.local {
            background: var(--bubble-local-bg);
            color: var(--bubble-local-text);
        }
        .message-bubble.peer {
            background: var(--bubble-peer-bg);
            color: var(--bubble-peer-text);
        }
        .message-bubble .bubble-col {
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 6px;
            word-break: break-word;
        }
        .message-bubble .bubble-col + .bubble-col {
            border-left: 1px solid rgba(226, 232, 240, 0.9);
            padding-left: 12px;
        }
        .speaker-indicator {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            height: 56px;
        }
        .speaker-indicator::before {
            content: '';
            position: absolute;
            left: 18px;
            right: 18px;
            top: 50%;
            height: 2px;
            background: rgba(148, 163, 184, 0.6);
        }
        #speaker-toggle {
            pointer-events: auto;
            width: 52px;
            height: 52px;
            border-radius: 999px;
            border: 1px solid rgba(226, 232, 240, 0.8);
            background: rgba(255, 255, 255, 0.85);
            box-shadow: 0 12px 25px rgba(148, 163, 184, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.25s ease;
        }
        #speaker-toggle .speaker-arrow {
            font-size: 28px;
            color: rgba(59, 130, 246, 0.9);
            transition: transform 0.25s ease;
        }
        #speaker-toggle[data-active="peer"] .speaker-arrow { transform: rotate(180deg); }
    </style>
</head>
<body class="min-h-screen text-slate-800">
    <main class="tabletop-view">
        <div class="tabletop-half tabletop-north">
            <div class="client-shell">
                <div id="peer-transcript" class="tabletop-transcript no-scrollbar"></div>
                <div class="tabletop-composer">
                    <textarea id="peer-input" rows="1" class="tabletop-input" placeholder="Enter peer text"></textarea>
                    <button id="peer-send" class="tabletop-talk" type="button" aria-label="Send peer message">
                        <span class="material-symbols-outlined text-base">send</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="speaker-indicator">
            <button id="speaker-toggle" type="button" data-active="local" aria-label="Toggle active speaker">
                <span class="material-symbols-outlined speaker-arrow">arrow_upward</span>
            </button>
        </div>
        <div class="tabletop-half tabletop-south">
            <div class="client-shell">
                <div id="local-transcript" class="tabletop-transcript no-scrollbar"></div>
                <div class="tabletop-composer">
                    <textarea id="local-input" rows="1" class="tabletop-input" placeholder="Enter local text"></textarea>
                    <button id="local-send" class="tabletop-talk" type="button" aria-label="Send local message">
                        <span class="material-symbols-outlined text-base">send</span>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <button id="gear-fab" class="fixed bottom-5 right-5 w-12 h-12 rounded-full bg-white/90 border border-slate-200 shadow-lg flex items-center justify-center text-slate-600 hover:text-slate-800 hover:bg-white" aria-label="Open controls">
        <span class="material-symbols-outlined text-[22px]">settings</span>
    </button>

    <input id="drawer-import-input" type="file" accept="application/json" class="hidden">

    <div id="controls-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center invisible modal">
        <div id="controls-content" class="bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6 transform scale-out modal-content flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-xl font-bold text-gray-800">Controls</h3>
                <button id="close-controls" class="text-gray-400 hover:text-gray-800 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="grid gap-3 text-sm flex-1 overflow-y-auto pr-1">
                <div class="grid gap-3">
                    <div class="flex items-center gap-2 text-slate-600">
                        <span class="material-symbols-outlined text-base">arrow_upward</span>
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Peer</span>
                    </div>
                    <select id="peer-language-select" class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 bg-white">
                        <option value="en">English</option>
                        <option value="zh">Chinese</option>
                        <option value="km">Cambodian</option>
                        <option value="id">Indonesian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="lo">Lao</option>
                        <option value="ms">Malay</option>
                        <option value="th">Thai</option>
                        <option value="vi">Vietnamese</option>
                    </select>
                </div>
                <div class="grid gap-3">
                    <div class="flex items-center gap-2 text-slate-600">
                        <span class="material-symbols-outlined text-base">arrow_downward</span>
                        <span class="text-xs font-semibold text-slate-500 uppercase tracking-wide">Local</span>
                    </div>
                    <select id="local-language-select" class="px-3 py-2 text-sm border border-slate-200 rounded-lg focus:ring-2 focus:ring-blue-300 focus:border-blue-300 bg-white">
                        <option value="en">English</option>
                        <option value="zh">Chinese</option>
                        <option value="km">Cambodian</option>
                        <option value="id">Indonesian</option>
                        <option value="ja">Japanese</option>
                        <option value="ko">Korean</option>
                        <option value="lo">Lao</option>
                        <option value="ms">Malay</option>
                        <option value="th">Thai</option>
                        <option value="vi">Vietnamese</option>
                    </select>
                </div>
                <label class="flex items-center justify-between gap-3 px-3 py-2 rounded-lg border border-slate-200 text-slate-600">
                    <span class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-base">timer</span>
                        Typing pause (seconds)
                    </span>
                    <input id="typing-pause-input" type="number" min="1" max="10" step="0.5" class="w-20 px-2 py-1 text-xs border border-slate-200 rounded-lg text-slate-700">
                </label>
                <div class="border border-slate-200/70 rounded-xl p-3 grid gap-3">
                    <div class="text-[11px] uppercase tracking-wide text-slate-400">UI colors</div>
                    <div class="grid gap-3">
                        <label class="flex items-center justify-between text-xs text-slate-500">
                            Local bubble
                            <input id="style-local-bg" type="color" class="h-8 w-20 border border-slate-200 rounded-lg">
                        </label>
                        <label class="flex items-center justify-between text-xs text-slate-500">
                            Local text
                            <input id="style-local-text" type="color" class="h-8 w-20 border border-slate-200 rounded-lg">
                        </label>
                        <label class="flex items-center justify-between text-xs text-slate-500">
                            Peer bubble
                            <input id="style-peer-bg" type="color" class="h-8 w-20 border border-slate-200 rounded-lg">
                        </label>
                        <label class="flex items-center justify-between text-xs text-slate-500">
                            Peer text
                            <input id="style-peer-text" type="color" class="h-8 w-20 border border-slate-200 rounded-lg">
                        </label>
                    </div>
                    <label class="flex items-center justify-between text-xs text-slate-500">
                        UI size
                        <input id="style-font-size" type="range" min="12" max="36" step="1" class="w-40">
                    </label>
                    <label class="flex items-center justify-between text-xs text-slate-500">
                        Background
                        <input id="style-chat-bg" type="color" class="h-8 w-20 border border-slate-200 rounded-lg">
                    </label>
                    <div class="flex justify-end gap-2">
                        <button id="style-reset" class="px-3 py-2 bg-slate-100 text-slate-700 text-xs font-semibold rounded-lg hover:bg-slate-200 transition">Reset</button>
                        <button id="style-save" class="px-3 py-2 bg-blue-600 text-white text-xs font-semibold rounded-lg hover:bg-blue-700 transition">Save</button>
                    </div>
                </div>
                <button id="drawer-import" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:text-slate-800 hover:bg-slate-50">
                    <span class="material-symbols-outlined text-base">upload_file</span>
                    Import chat
                </button>
                <button id="drawer-export" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-slate-200 text-slate-600 hover:text-slate-800 hover:bg-slate-50">
                    <span class="material-symbols-outlined text-base">download</span>
                    Export chat
                </button>
                <button id="drawer-clear" class="flex items-center gap-3 px-3 py-2 rounded-lg border border-rose-100 text-rose-500 hover:text-rose-600 hover:bg-rose-50">
                    <span class="material-symbols-outlined text-base">delete_sweep</span>
                    Export &amp; clear
                </button>
            </div>
        </div>
    </div>

    <script>
        const STORAGE_KEYS = {
            history: 'tabletop_chat_history',
            settings: 'tabletop_chat_settings',
            styles: 'tabletop_chat_styles',
            background: 'tabletop_chat_background'
        };
        const DEFAULT_SETTINGS = {
            peerLanguage: 'en',
            localLanguage: 'en',
            typingPauseMs: 3000,
            activeSpeaker: 'local'
        };
        const DEFAULT_STYLES = {
            localBg: '#eff6ff',
            localText: '#1f2937',
            peerBg: '#ffffff',
            peerText: '#0f172a',
            fontSize: 14
        };
        const DEFAULT_BACKGROUND = {
            color: '#ffffff'
        };

        const peerTranscript = document.getElementById('peer-transcript');
        const localTranscript = document.getElementById('local-transcript');
        const peerInput = document.getElementById('peer-input');
        const localInput = document.getElementById('local-input');
        const peerSend = document.getElementById('peer-send');
        const localSend = document.getElementById('local-send');
        const speakerToggle = document.getElementById('speaker-toggle');
        const gearFab = document.getElementById('gear-fab');
        const controlsModal = document.getElementById('controls-modal');
        const controlsContent = document.getElementById('controls-content');
        const closeControls = document.getElementById('close-controls');
        const peerLanguageSelect = document.getElementById('peer-language-select');
        const localLanguageSelect = document.getElementById('local-language-select');
        const typingPauseInput = document.getElementById('typing-pause-input');
        const styleLocalBg = document.getElementById('style-local-bg');
        const styleLocalText = document.getElementById('style-local-text');
        const stylePeerBg = document.getElementById('style-peer-bg');
        const stylePeerText = document.getElementById('style-peer-text');
        const styleFontSize = document.getElementById('style-font-size');
        const styleChatBg = document.getElementById('style-chat-bg');
        const styleReset = document.getElementById('style-reset');
        const styleSave = document.getElementById('style-save');
        const drawerImport = document.getElementById('drawer-import');
        const drawerExport = document.getElementById('drawer-export');
        const drawerClear = document.getElementById('drawer-clear');
        const drawerImportInput = document.getElementById('drawer-import-input');

        let chatHistory = [];
        let settings = { ...DEFAULT_SETTINGS };
        let styles = { ...DEFAULT_STYLES };
        let background = { ...DEFAULT_BACKGROUND };
        let typingTimer = null;
        const translationCache = new Map();
        const pendingTranslations = new Map();

        function readStorage(key) {
            try {
                return localStorage.getItem(key);
            } catch (_) {
                return null;
            }
        }

        function writeStorage(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (_) {}
        }

        function loadSettings() {
            const raw = readStorage(STORAGE_KEYS.settings);
            if (!raw) return { ...DEFAULT_SETTINGS };
            try {
                return { ...DEFAULT_SETTINGS, ...JSON.parse(raw) };
            } catch (_) {
                return { ...DEFAULT_SETTINGS };
            }
        }

        function saveSettings() {
            writeStorage(STORAGE_KEYS.settings, JSON.stringify(settings));
        }

        function loadHistory() {
            const raw = readStorage(STORAGE_KEYS.history);
            if (!raw) return [];
            try {
                const parsed = JSON.parse(raw);
                return Array.isArray(parsed) ? parsed : [];
            } catch (_) {
                return [];
            }
        }

        function saveHistory() {
            writeStorage(STORAGE_KEYS.history, JSON.stringify(chatHistory.slice(-200)));
        }

        function loadStyles() {
            const raw = readStorage(STORAGE_KEYS.styles);
            if (!raw) return { ...DEFAULT_STYLES };
            try {
                return { ...DEFAULT_STYLES, ...JSON.parse(raw) };
            } catch (_) {
                return { ...DEFAULT_STYLES };
            }
        }

        function saveStyles() {
            writeStorage(STORAGE_KEYS.styles, JSON.stringify(styles));
        }

        function loadBackground() {
            const raw = readStorage(STORAGE_KEYS.background);
            if (!raw) return { ...DEFAULT_BACKGROUND };
            try {
                return { ...DEFAULT_BACKGROUND, ...JSON.parse(raw) };
            } catch (_) {
                return { ...DEFAULT_BACKGROUND };
            }
        }

        function saveBackground() {
            writeStorage(STORAGE_KEYS.background, JSON.stringify(background));
        }

        function applyStyles() {
            const root = document.documentElement;
            root.style.setProperty('--bubble-local-bg', styles.localBg);
            root.style.setProperty('--bubble-local-text', styles.localText);
            root.style.setProperty('--bubble-peer-bg', styles.peerBg);
            root.style.setProperty('--bubble-peer-text', styles.peerText);
            root.style.setProperty('--bubble-font-size', `${styles.fontSize}px`);
        }

        function applyBackground() {
            const root = document.documentElement;
            root.style.setProperty('--chat-bg-color', background.color || DEFAULT_BACKGROUND.color);
        }

        function updateControls() {
            peerLanguageSelect.value = settings.peerLanguage;
            localLanguageSelect.value = settings.localLanguage;
            typingPauseInput.value = (settings.typingPauseMs / 1000).toFixed(1).replace(/\.0$/, '');
            styleLocalBg.value = styles.localBg;
            styleLocalText.value = styles.localText;
            stylePeerBg.value = styles.peerBg;
            stylePeerText.value = styles.peerText;
            styleFontSize.value = styles.fontSize;
            styleChatBg.value = background.color;
            updateSpeakerIndicator();
        }

        function toggleModal(isOpen) {
            if (!controlsModal || !controlsContent) return;
            if (isOpen) {
                controlsModal.classList.remove('invisible');
                controlsModal.classList.add('visible');
                controlsContent.classList.remove('scale-out');
                controlsContent.classList.add('scale-in');
            } else {
                controlsModal.classList.add('invisible');
                controlsModal.classList.remove('visible');
                controlsContent.classList.add('scale-out');
                controlsContent.classList.remove('scale-in');
            }
        }

        function updateSpeakerIndicator() {
            if (!speakerToggle) return;
            speakerToggle.dataset.active = settings.activeSpeaker;
        }

        function scheduleAutoFlip() {
            if (typingTimer) {
                clearTimeout(typingTimer);
            }
            typingTimer = setTimeout(() => {
                settings.activeSpeaker = settings.activeSpeaker === 'local' ? 'peer' : 'local';
                updateSpeakerIndicator();
                saveSettings();
                scrollTranscriptsToBottom();
            }, settings.typingPauseMs);
        }

        function scrollTranscriptsToBottom() {
            [peerTranscript, localTranscript].forEach(column => {
                if (!column) return;
                if (typeof column.scrollTo === 'function') {
                    column.scrollTo({ top: column.scrollHeight, behavior: 'smooth' });
                } else {
                    column.scrollTop = column.scrollHeight;
                }
            });
        }

        function createEntryId() {
            return (crypto.randomUUID ? crypto.randomUUID() : `entry_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`);
        }

        async function translateText(text, target, source = 'auto') {
            if (!text || !target) return null;
            const cacheKey = `${source}|${target}|${text}`;
            if (translationCache.has(cacheKey)) return translationCache.get(cacheKey);
            if (pendingTranslations.has(cacheKey)) return pendingTranslations.get(cacheKey);
            const pendingPromise = (async () => {
                try {
                    const res = await fetch('https://libretranslate.de/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ q: text, source, target, format: 'text' })
                    });
                    if (!res.ok) throw new Error('Translation failed');
                    const data = await res.json();
                    const translated = data?.translatedText || null;
                    if (translated) {
                        translationCache.set(cacheKey, translated);
                    }
                    return translated;
                } catch (_) {
                    try {
                        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${encodeURIComponent(source)}&tl=${encodeURIComponent(target)}&dt=t&q=${encodeURIComponent(text)}`);
                        if (!res.ok) throw new Error('Translation fallback failed');
                        const data = await res.json();
                        const translated = Array.isArray(data?.[0])
                            ? data[0].map(part => part?.[0]).filter(Boolean).join('')
                            : null;
                        if (translated) {
                            translationCache.set(cacheKey, translated);
                        }
                        return translated;
                    } catch (_) {
                        return null;
                    }
                } finally {
                    pendingTranslations.delete(cacheKey);
                }
            })();
            pendingTranslations.set(cacheKey, pendingPromise);
            return pendingPromise;
        }

        function escapeHtml(text) {
            return (text || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderMarkdown(text) {
            let html = escapeHtml(text || '');
            html = html.replace(/```([\s\S]*?)```/g, (_, code) => `<pre class="bg-slate-900 text-slate-100 rounded p-2 text-[11px] overflow-auto"><code>${code}</code></pre>`);
            html = html.replace(/`([^`]+)`/g, '<code class="bg-slate-100 px-1 rounded">$1</code>');
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            html = html.replace(/_([^_]+)_/g, '<em>$1</em>');
            html = html.replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function renderChat() {
            const transcripts = [peerTranscript, localTranscript].filter(Boolean);
            transcripts.forEach(column => {
                column.innerHTML = '';
            });
            const lastEntryId = chatHistory.length ? chatHistory[chatHistory.length - 1].id : null;
            let shouldSaveHistory = false;
            chatHistory.forEach(entry => {
                const speaker = entry.speaker;
                const bubbleClass = speaker === 'local' ? 'local' : 'peer';
                const defaultSource = speaker === 'local' ? settings.localLanguage : settings.peerLanguage;
                const defaultTarget = speaker === 'local' ? settings.peerLanguage : settings.localLanguage;
                const sourceLanguage = entry.sourceLanguage || defaultSource;
                const targetLanguage = entry.targetLanguage || defaultTarget;
                if (!entry.sourceLanguage || !entry.targetLanguage) {
                    entry.sourceLanguage = sourceLanguage;
                    entry.targetLanguage = targetLanguage;
                    shouldSaveHistory = true;
                }
                const text = entry.message || '';
                const translationKey = `${sourceLanguage}|${targetLanguage}`;
                entry.translations = entry.translations || {};
                const cached = entry.translations[translationKey] || translationCache.get(`${sourceLanguage}|${targetLanguage}|${text}`);
                const translationCols = [];

                transcripts.forEach(column => {
                    const row = document.createElement('div');
                    row.className = `message-row ${bubbleClass}`;
                    const bubble = document.createElement('div');
                    bubble.className = `message-bubble ${bubbleClass}${entry.id === lastEntryId ? ' latest-bubble' : ''}`;

                    const sourceCol = document.createElement('div');
                    sourceCol.className = 'bubble-col';
                    const translationCol = document.createElement('div');
                    translationCol.className = 'bubble-col';
                    bubble.append(sourceCol, translationCol);
                    row.appendChild(bubble);

                    sourceCol.innerHTML = renderMarkdown(text);
                    if (sourceLanguage === targetLanguage || !targetLanguage) {
                        translationCol.innerHTML = renderMarkdown(text);
                    } else if (cached) {
                        translationCol.innerHTML = renderMarkdown(cached);
                    } else {
                        translationCol.textContent = 'â€¦';
                    }

                    translationCols.push(translationCol);
                    column.appendChild(row);
                });

                if (sourceLanguage !== targetLanguage && !cached) {
                    translateText(text, targetLanguage, sourceLanguage).then(translated => {
                        if (!translated) {
                            translationCols.forEach(col => {
                                col.textContent = 'Translation unavailable.';
                            });
                            return;
                        }
                        entry.translations[translationKey] = translated;
                        saveHistory();
                        translationCols.forEach(col => {
                            col.innerHTML = renderMarkdown(translated);
                        });
                    });
                }
            });
            if (shouldSaveHistory) {
                saveHistory();
            }
            scrollTranscriptsToBottom();
        }

        function addChatEntry(message, speaker) {
            const trimmed = (message || '').trim();
            if (!trimmed) return;
            const sourceLanguage = speaker === 'local' ? settings.localLanguage : settings.peerLanguage;
            const targetLanguage = speaker === 'local' ? settings.peerLanguage : settings.localLanguage;
            chatHistory.push({
                id: createEntryId(),
                message: trimmed,
                speaker,
                ts: Date.now(),
                translations: {},
                sourceLanguage,
                targetLanguage
            });
            saveHistory();
            renderChat();
            scrollTranscriptsToBottom();
        }

        function handleSubmit(input, speaker) {
            const value = input.value || '';
            if (!value.trim()) return;
            settings.activeSpeaker = speaker;
            updateSpeakerIndicator();
            saveSettings();
            addChatEntry(value, speaker);
            input.value = '';
            scheduleAutoFlip();
        }

        function handleTyping(speaker) {
            settings.activeSpeaker = speaker;
            updateSpeakerIndicator();
            saveSettings();
            scheduleAutoFlip();
        }

        function exportChat() {
            const payload = {
                history: chatHistory,
                settings,
                styles,
                background
            };
            const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'tabletop-chat.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
        }

        function importChat(file) {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const payload = JSON.parse(reader.result);
                    if (Array.isArray(payload?.history)) {
                        chatHistory = payload.history;
                        saveHistory();
                    }
                    if (payload?.settings) {
                        settings = { ...DEFAULT_SETTINGS, ...payload.settings };
                        saveSettings();
                    }
                    if (payload?.styles) {
                        styles = { ...DEFAULT_STYLES, ...payload.styles };
                        saveStyles();
                    }
                    if (payload?.background) {
                        background = { ...DEFAULT_BACKGROUND, ...payload.background };
                        saveBackground();
                    }
                    applyStyles();
                    applyBackground();
                    updateControls();
                    renderChat();
                } catch (_) {}
            };
            reader.readAsText(file);
        }

        function clearChat() {
            chatHistory = [];
            saveHistory();
            renderChat();
        }

        settings = loadSettings();
        styles = loadStyles();
        background = loadBackground();
        chatHistory = loadHistory();
        applyStyles();
        applyBackground();
        updateControls();
        renderChat();

        speakerToggle.addEventListener('click', () => {
            settings.activeSpeaker = settings.activeSpeaker === 'local' ? 'peer' : 'local';
            updateSpeakerIndicator();
            saveSettings();
        });

        gearFab.addEventListener('click', () => toggleModal(true));
        closeControls.addEventListener('click', () => toggleModal(false));
        controlsModal.addEventListener('click', event => {
            if (event.target === controlsModal) toggleModal(false);
        });

        peerSend.addEventListener('click', () => handleSubmit(peerInput, 'peer'));
        localSend.addEventListener('click', () => handleSubmit(localInput, 'local'));

        peerInput.addEventListener('keydown', event => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSubmit(peerInput, 'peer');
            }
        });
        localInput.addEventListener('keydown', event => {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                handleSubmit(localInput, 'local');
            }
        });

        peerInput.addEventListener('input', () => handleTyping('peer'));
        localInput.addEventListener('input', () => handleTyping('local'));

        peerLanguageSelect.addEventListener('change', () => {
            settings.peerLanguage = peerLanguageSelect.value;
            saveSettings();
            renderChat();
        });
        localLanguageSelect.addEventListener('change', () => {
            settings.localLanguage = localLanguageSelect.value;
            saveSettings();
            renderChat();
        });

        typingPauseInput.addEventListener('change', () => {
            const value = Number(typingPauseInput.value);
            if (Number.isFinite(value) && value > 0) {
                settings.typingPauseMs = Math.min(10000, Math.max(1000, Math.round(value * 1000)));
                saveSettings();
            }
        });

        styleReset.addEventListener('click', () => {
            styles = { ...DEFAULT_STYLES };
            background = { ...DEFAULT_BACKGROUND };
            applyStyles();
            applyBackground();
            updateControls();
            saveStyles();
            saveBackground();
        });

        styleSave.addEventListener('click', () => {
            styles = {
                localBg: styleLocalBg.value,
                localText: styleLocalText.value,
                peerBg: stylePeerBg.value,
                peerText: stylePeerText.value,
                fontSize: Number(styleFontSize.value)
            };
            background = {
                color: styleChatBg.value
            };
            applyStyles();
            applyBackground();
            saveStyles();
            saveBackground();
        });

        drawerImport.addEventListener('click', () => drawerImportInput.click());
        drawerImportInput.addEventListener('change', event => {
            const file = event.target.files?.[0];
            if (file) {
                importChat(file);
                drawerImportInput.value = '';
            }
        });

        drawerExport.addEventListener('click', () => exportChat());
        drawerClear.addEventListener('click', () => {
            exportChat();
            clearChat();
        });
    </script>
</body>
</html>
